<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="theme-color" content="#222"><meta name="generator" content="Hexo 7.3.0">

  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">



<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.7.2/css/all.min.css" integrity="sha256-dABdfBfUoC8vJUBOwGVdm8L9qlMWaHTIfXt+7GnZCIo=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/3.1.1/animate.min.css" integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin="anonymous">

<script class="next-config" data-name="main" type="application/json">{"hostname":"hmxyl.github.io","root":"/","images":"/images","scheme":"Muse","darkmode":false,"version":"8.23.1","exturl":false,"sidebar":{"position":"left","width_expanded":320,"width_dual_column":240,"display":"post","padding":18,"offset":12},"hljswrap":true,"codeblock":{"theme":{"light":"default","dark":"stackoverflow-dark"},"prism":{"light":"prism","dark":"prism-dark"},"copy_button":{"enable":false,"style":null},"fold":{"enable":false,"height":500},"language":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"stickytabs":false,"motion":{"enable":true,"async":false,"duration":200,"transition":{"menu_item":"fadeInDown","post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"i18n":{"placeholder":"搜索...","empty":"没有找到任何搜索结果：${query}","hits_time":"找到 ${hits} 个搜索结果（用时 ${time} 毫秒）","hits":"找到 ${hits} 个搜索结果"},"path":"/search.xml","localsearch":{"enable":true,"top_n_per_article":1,"unescape":false,"preload":false}}</script><script src="/js/config.js" defer></script>

    <meta name="description" content="Java并发工具包">
<meta property="og:type" content="article">
<meta property="og:title" content="Java并发包">
<meta property="og:url" content="https://hmxyl.github.io/20221101/3c508c34.html">
<meta property="og:site_name" content="Alisa&#39;s Home">
<meta property="og:description" content="Java并发工具包">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://hmxyl-image.oss-cn-hangzhou.aliyuncs.com/note/7126254-55d47d5ebef3b1e2-16380810237142.webp">
<meta property="og:image" content="https://hmxyl-image.oss-cn-hangzhou.aliyuncs.com/note/image-20220222105628308-1667231117133-83.png">
<meta property="og:image" content="https://hmxyl-image.oss-cn-hangzhou.aliyuncs.com/note/image-20220222105835195-1667231117133-84.png">
<meta property="og:image" content="https://hmxyl-image.oss-cn-hangzhou.aliyuncs.com/note/image-20220222113453875-1667231117133-86.png">
<meta property="og:image" content="https://hmxyl-image.oss-cn-hangzhou.aliyuncs.com/note/image-20220222113625291-1667231117133-85.png">
<meta property="og:image" content="https://hmxyl-image.oss-cn-hangzhou.aliyuncs.com/note/CountDown.drawio-1667231117133-87.png">
<meta property="og:image" content="https://hmxyl-image.oss-cn-hangzhou.aliyuncs.com/note/arrive.drawio-1667231117133-89.png">
<meta property="og:image" content="https://hmxyl-image.oss-cn-hangzhou.aliyuncs.com/note/Executor%E6%A1%86%E6%9E%B6-16588299109821-1667231117133-88.png">
<meta property="og:image" content="https://hmxyl-image.oss-cn-hangzhou.aliyuncs.com/note/image-20220725112237287-1667231117133-90.png">
<meta property="og:image" content="https://hmxyl-image.oss-cn-hangzhou.aliyuncs.com/note/image-20220725171152798-1667231117133-91.png">
<meta property="og:image" content="https://hmxyl-image.oss-cn-hangzhou.aliyuncs.com/note/1620-1667231117133-93.png">
<meta property="og:image" content="https://hmxyl-image.oss-cn-hangzhou.aliyuncs.com/note/image-20220726163319524-1667231117133-92.png">
<meta property="og:image" content="https://hmxyl-image.oss-cn-hangzhou.aliyuncs.com/note/BlockingDeque-1667231117133-94.png">
<meta property="article:published_time" content="2022-10-31T22:52:00.000Z">
<meta property="article:modified_time" content="2025-06-20T12:32:20.894Z">
<meta property="article:author" content="Alisa">
<meta property="article:tag" content="Java">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://hmxyl-image.oss-cn-hangzhou.aliyuncs.com/note/7126254-55d47d5ebef3b1e2-16380810237142.webp">


<link rel="canonical" href="https://hmxyl.github.io/20221101/3c508c34.html">


<script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":false,"isPost":true,"lang":"zh-CN","comments":true,"permalink":"https://hmxyl.github.io/20221101/3c508c34.html","path":"20221101/3c508c34.html","title":"Java并发包"}</script>

<script class="next-config" data-name="calendar" type="application/json">""</script>
<title>Java并发包 | Alisa's Home</title>
  








  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous" defer></script>
<script src="/js/utils.js" defer></script><script src="/js/motion.js" defer></script><script src="/js/sidebar.js" defer></script><script src="/js/next-boot.js" defer></script>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/hexo-generator-searchdb/1.4.1/search.js" integrity="sha256-1kfA5uHPf65M5cphT2dvymhkuyHPQp5A53EGZOnOLmc=" crossorigin="anonymous" defer></script>
<script src="/js/third-party/search/local-search.js" defer></script>







  





  <noscript>
    <link rel="stylesheet" href="/css/noscript.css">
  </noscript>

<style>.github-emoji { position: relative; display: inline-block; width: 1.2em; min-height: 1.2em; overflow: hidden; vertical-align: top; color: transparent; }  .github-emoji > span { position: relative; z-index: 10; }  .github-emoji img, .github-emoji .fancybox { margin: 0 !important; padding: 0 !important; border: none !important; outline: none !important; text-decoration: none !important; user-select: none !important; cursor: auto !important; }  .github-emoji img { height: 1.2em !important; width: 1.2em !important; position: absolute !important; left: 50% !important; top: 50% !important; transform: translate(-50%, -50%) !important; user-select: none !important; cursor: auto !important; } .github-emoji-fallback { color: inherit; } .github-emoji-fallback img { opacity: 0 !important; }</style>
</head>

<body itemscope itemtype="http://schema.org/WebPage" class="use-motion">
  <div class="headband"></div>

  <main class="main">
    <div class="column">
      <header class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏" role="button">
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <p class="site-title">Alisa's Home</p>
      <i class="logo-line"></i>
    </a>
      <p class="site-subtitle" itemprop="description">Alisa's Home</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger" aria-label="搜索" role="button">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>



<nav class="site-nav">
  <ul class="main-menu menu"><li class="menu-item menu-item-home"><a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a></li><li class="menu-item menu-item-tags"><a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>标签</a></li><li class="menu-item menu-item-categories"><a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>分类</a></li><li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档</a></li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>搜索
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup">
      <div class="search-header">
        <span class="search-icon">
          <i class="fa fa-search"></i>
        </span>
        <div class="search-input-container">
          <input autocomplete="off" autocapitalize="off" maxlength="80"
                placeholder="搜索..." spellcheck="false"
                type="search" class="search-input">
        </div>
        <span class="popup-btn-close" role="button">
          <i class="fa fa-times-circle"></i>
        </span>
      </div>
      <div class="search-result-container">
        <div class="search-result-icon">
          <i class="fa fa-spinner fa-pulse fa-5x"></i>
        </div>
      </div>
    </div>
  </div>

</header>
        
  
  <aside class="sidebar">

    <div class="sidebar-inner sidebar-nav-active sidebar-toc-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
            <div class="post-toc animated"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link"><span class="nav-number">1.</span> <span class="nav-text">Atomic包</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#CAS-Compare-And-Swap-%EF%BC%9A%E6%AF%94%E8%BE%83%E5%B9%B6%E4%BA%A4%E6%8D%A2"><span class="nav-number">1.1.</span> <span class="nav-text">CAS(Compare And Swap)：比较并交换</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Unsafe%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90"><span class="nav-number">1.1.1.</span> <span class="nav-text">Unsafe源码分析</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#CAS%E7%9A%84%E7%BC%BA%E7%82%B9%EF%BC%9AABA"><span class="nav-number">1.1.2.</span> <span class="nav-text">CAS的缺点：ABA</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#CAS%E7%9A%84%E7%BC%BA%E7%82%B9%EF%BC%9A%E5%BE%AA%E7%8E%AF%E6%97%B6%E9%97%B4%E9%95%BF%E5%BC%80%E9%94%80%E5%A4%A7"><span class="nav-number">1.1.3.</span> <span class="nav-text">CAS的缺点：循环时间长开销大</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#CAS%E7%9A%84%E7%BC%BA%E7%82%B9%EF%BC%9A%E5%8F%AA%E8%83%BD%E4%BF%9D%E8%AF%81%E4%B8%80%E4%B8%AA%E5%85%B1%E4%BA%AB%E5%8F%98%E9%87%8F%E7%9A%84%E5%8E%9F%E5%AD%90%E6%93%8D%E4%BD%9C"><span class="nav-number">1.1.4.</span> <span class="nav-text">CAS的缺点：只能保证一个共享变量的原子操作</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#CAS%E7%9A%84%E5%BA%94%E7%94%A8"><span class="nav-number">1.1.5.</span> <span class="nav-text">CAS的应用</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#AtomicLong"><span class="nav-number">1.2.</span> <span class="nav-text">AtomicLong</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#AtomicReference"><span class="nav-number">1.3.</span> <span class="nav-text">AtomicReference</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#AtomicXXXFieldUpdater"><span class="nav-number">1.4.</span> <span class="nav-text">AtomicXXXFieldUpdater</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Unsafe"><span class="nav-number">1.5.</span> <span class="nav-text">Unsafe</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%87%A0%E7%A7%8DCounter%E6%96%B9%E6%A1%88%E7%9A%84%E6%80%A7%E8%83%BD%E5%AF%B9%E6%AF%94%E3%80%82"><span class="nav-number">1.5.1.</span> <span class="nav-text">几种Counter方案的性能对比。</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Java-%E8%B0%83%E7%94%A8-C-%E6%B5%81%E7%A8%8B%EF%BC%88JNI-%EF%BC%89"><span class="nav-number">1.5.2.</span> <span class="nav-text">Java 调用 C 流程（JNI ）</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%BA%95%E5%B1%82%E6%B1%87%E7%BC%96%E7%9B%B8%E5%85%B3%E6%8C%87%E4%BB%A4"><span class="nav-number">1.6.</span> <span class="nav-text">底层汇编相关指令</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link"><span class="nav-number">2.</span> <span class="nav-text">CountDownLatch</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E9%80%80%E5%87%BA%E6%9D%A1%E4%BB%B6"><span class="nav-number">2.1.</span> <span class="nav-text">退出条件</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%BD%BF%E7%94%A8%E5%9C%BA%E6%99%AF"><span class="nav-number">2.2.</span> <span class="nav-text">使用场景</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%AD%89%E5%BE%85%E6%89%80%E6%9C%89%E7%BA%BF%E7%A8%8B%E6%89%A7%E8%A1%8C%E5%AE%8C%E6%88%90"><span class="nav-number">2.2.1.</span> <span class="nav-text">等待所有线程执行完成</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%BB%BB%E5%8A%A1%E6%8B%86%E5%88%86%E7%A6%BB%E6%95%A3%E5%B9%B6%E8%A1%8C%E5%8C%96%E5%A4%84%E7%90%86"><span class="nav-number">2.2.2.</span> <span class="nav-text">任务拆分离散并行化处理</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%9F%BA%E6%9C%AC%E4%BF%A1%E6%81%AF%E5%AE%9A%E4%B9%89"><span class="nav-number">2.2.2.1.</span> <span class="nav-text">基本信息定义</span></a></li></ol></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link"><span class="nav-number">3.</span> <span class="nav-text">CyclicBarrier</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E7%A4%BA%E4%BE%8B2%EF%BC%9A%E4%BD%BF%E7%94%A8reset-%E9%87%8D%E7%BD%AE"><span class="nav-number">3.1.</span> <span class="nav-text">示例2：使用reset()重置</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#CountDownLatch-%E5%92%8C-CyclicBarrier-%E7%9A%84%E5%8C%BA%E5%88%AB"><span class="nav-number">3.2.</span> <span class="nav-text">CountDownLatch 和 CyclicBarrier 的区别</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link"><span class="nav-number">4.</span> <span class="nav-text">Exchanger</span></a></li><li class="nav-item nav-level-1"><a class="nav-link"><span class="nav-number">5.</span> <span class="nav-text">Semaphore</span></a></li><li class="nav-item nav-level-1"><a class="nav-link"><span class="nav-number">6.</span> <span class="nav-text">Lock包</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#ReentrantLock"><span class="nav-number">6.1.</span> <span class="nav-text">ReentrantLock</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#ReadWriteLock"><span class="nav-number">6.2.</span> <span class="nav-text">ReadWriteLock</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Condition"><span class="nav-number">6.3.</span> <span class="nav-text">Condition</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%BD%93%E4%B8%AA%E7%AD%89%E5%BE%85%E9%94%81%E9%98%9F%E5%88%97"><span class="nav-number">6.3.1.</span> <span class="nav-text">当个等待锁队列</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%A4%9A%E4%B8%AA%E7%AD%89%E5%BE%85%E9%94%81%E9%98%9F%E5%88%97"><span class="nav-number">6.3.2.</span> <span class="nav-text">多个等待锁队列</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#StampedLock"><span class="nav-number">6.4.</span> <span class="nav-text">StampedLock</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%BA%A7%E7%94%9F%E8%83%8C%E6%99%AF"><span class="nav-number">6.4.1.</span> <span class="nav-text">产生背景</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#StampedLock%E7%9A%84%E4%B8%BB%E8%A6%81%E7%89%B9%E7%82%B9"><span class="nav-number">6.4.2.</span> <span class="nav-text">StampedLock的主要特点</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%82%B2%E8%A7%82%E8%AF%BB%EF%BC%88%E8%AF%BB%E9%94%81%E5%92%8C%E5%86%99%E9%94%81%E4%BA%92%E6%96%A5%EF%BC%89"><span class="nav-number">6.4.3.</span> <span class="nav-text">悲观读（读锁和写锁互斥）</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%B9%90%E8%A7%82%E8%AF%BB%EF%BC%9AOptimistic-reading"><span class="nav-number">6.4.4.</span> <span class="nav-text">乐观读：Optimistic reading</span></a></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link"><span class="nav-number">7.</span> <span class="nav-text">Fork&#x2F;Join框架</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#RecursiveTask%EF%BC%9A%E6%9C%89%E8%BF%94%E5%9B%9E"><span class="nav-number">7.1.</span> <span class="nav-text">RecursiveTask：有返回</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#RecursiveAction%EF%BC%9A%E6%97%A0%E8%BF%94%E5%9B%9E"><span class="nav-number">7.2.</span> <span class="nav-text">RecursiveAction：无返回</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link"><span class="nav-number">8.</span> <span class="nav-text">Phaser</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E7%9B%91%E6%8E%A7%E6%96%B9%E6%B3%95"><span class="nav-number">8.1.</span> <span class="nav-text">监控方法</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%8A%A8%E6%80%81%E6%B3%A8%E5%86%8C%E7%89%B9%E6%80%A7"><span class="nav-number">8.2.</span> <span class="nav-text">动态注册特性</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E9%87%8D%E5%A4%8D%E4%BD%BF%E7%94%A8%E8%AE%A1%E6%95%B0%E5%99%A8"><span class="nav-number">8.3.</span> <span class="nav-text">重复使用计数器</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%87%8F%E5%B0%91%E8%AE%A1%E6%95%B0%E5%99%A8%EF%BC%88%E5%8A%A8%E6%80%81%E9%94%80%E6%88%B7%EF%BC%89"><span class="nav-number">8.4.</span> <span class="nav-text">减少计数器（动态销户）</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%BA%BA%E4%B8%BA%E6%8E%A7%E5%88%B6Phase%E7%9A%84%E7%BB%88%E7%BB%93%EF%BC%9AonAdvance"><span class="nav-number">8.5.</span> <span class="nav-text">人为控制Phase的终结：onAdvance</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%88%B0%E8%BE%BE%E4%B9%8B%E5%90%8E%EF%BC%8C%E4%B8%8D%E9%98%BB%E5%A1%9E%E7%AD%89%E5%BE%85%EF%BC%9Aarrive"><span class="nav-number">8.6.</span> <span class="nav-text">到达之后，不阻塞等待：arrive</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%BB%85%E5%AE%8C%E6%88%90%E7%9B%91%E6%8E%A7%E4%BB%BB%E5%8A%A1%EF%BC%9AawaitAdvance"><span class="nav-number">8.7.</span> <span class="nav-text">仅完成监控任务：awaitAdvance</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%89%93%E6%96%AD-%E8%B6%85%E6%97%B6-%E7%BB%88%E6%AD%A2%EF%BC%9AawaitAdvanceInterruptibly"><span class="nav-number">8.8.</span> <span class="nav-text">打断&#x2F;超时 终止：awaitAdvanceInterruptibly</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%BC%BA%E5%88%B6%E9%94%80%E6%AF%81%EF%BC%9AforceTermination"><span class="nav-number">8.9.</span> <span class="nav-text">强制销毁：forceTermination</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link"><span class="nav-number">9.</span> <span class="nav-text">Executor框架</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#ExecutorService%E6%8E%A5%E5%8F%A3"><span class="nav-number">9.1.</span> <span class="nav-text">ExecutorService接口</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#ExecutorService-%E7%BB%A7%E6%89%BF%E6%A0%91"><span class="nav-number">9.1.1.</span> <span class="nav-text">ExecutorService 继承树</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#ExecutorService%E7%9A%84%E5%88%9B%E5%BB%BA"><span class="nav-number">9.1.2.</span> <span class="nav-text">ExecutorService的创建</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#ExecutorService%E7%9A%84%E6%89%A7%E8%A1%8C"><span class="nav-number">9.1.3.</span> <span class="nav-text">ExecutorService的执行</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#ExecutorService%E7%9A%84%E5%85%B3%E9%97%AD"><span class="nav-number">9.1.4.</span> <span class="nav-text">ExecutorService的关闭</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Executors%E5%B7%A5%E5%85%B7"><span class="nav-number">9.2.</span> <span class="nav-text">Executors工具</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#ThreadPoolExecutor"><span class="nav-number">9.3.</span> <span class="nav-text">ThreadPoolExecutor</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%9B%9B%E4%B8%AA%E5%86%85%E7%BD%AE%E6%8B%92%E7%BB%9D%E7%AD%96%E7%95%A5"><span class="nav-number">9.3.1.</span> <span class="nav-text">四个内置拒绝策略</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E8%87%AA%E5%AE%9A%E4%B9%89ThreadFactory"><span class="nav-number">9.3.2.</span> <span class="nav-text">自定义ThreadFactory</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%85%81%E8%AE%B8%E5%9B%9E%E6%94%B6%E6%89%A7%E8%A1%8C%E7%BA%BF%E7%A8%8B%EF%BC%9AallowCoreThreadTimeOut"><span class="nav-number">9.3.3.</span> <span class="nav-text">允许回收执行线程：allowCoreThreadTimeOut</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%88%A0%E9%99%A4%E4%BB%BB%E5%8A%A1%EF%BC%9Aremove"><span class="nav-number">9.3.4.</span> <span class="nav-text">删除任务：remove</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#prestartCoreThread-%EF%BC%9A-%E5%90%AF%E5%8A%A8%E4%B8%80%E4%B8%AA%E6%89%A7%E8%A1%8C%E7%BA%BF%E7%A8%8B"><span class="nav-number">9.3.5.</span> <span class="nav-text">prestartCoreThread ： 启动一个执行线程</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#prestartAllCoreThreads%EF%BC%9A%E5%90%AF%E5%8A%A8%E6%89%80%E6%9C%89%E6%89%A7%E8%A1%8C%E7%BA%BF%E7%A8%8B"><span class="nav-number">9.3.6.</span> <span class="nav-text">prestartAllCoreThreads：启动所有执行线程</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#beforeExecute-afterExecute"><span class="nav-number">9.3.7.</span> <span class="nav-text">beforeExecute&#x2F;afterExecute</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Future%E4%B8%8EFutureTask"><span class="nav-number">9.4.</span> <span class="nav-text">Future与FutureTask</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Future-%E6%8E%A5%E5%8F%A3"><span class="nav-number">9.4.1.</span> <span class="nav-text">Future 接口</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#FutureTask%E7%B1%BB"><span class="nav-number">9.4.2.</span> <span class="nav-text">FutureTask类</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#CompletionService%E6%8E%A5%E5%8F%A3"><span class="nav-number">9.5.</span> <span class="nav-text">CompletionService接口</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#ScheduledExecutorService"><span class="nav-number">9.6.</span> <span class="nav-text">ScheduledExecutorService</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link"><span class="nav-number">10.</span> <span class="nav-text">CompletableFuture</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%88%9B%E5%BB%BA%E5%AF%B9%E8%B1%A1"><span class="nav-number">10.0.1.</span> <span class="nav-text">创建对象</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#runAsync"><span class="nav-number">10.0.1.1.</span> <span class="nav-text">runAsync</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#supplyAsync"><span class="nav-number">10.0.1.2.</span> <span class="nav-text">supplyAsync</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%BB%93%E6%9E%9C%E5%A4%84%E7%90%86"><span class="nav-number">10.0.2.</span> <span class="nav-text">结果处理</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#whenComplete"><span class="nav-number">10.0.2.1.</span> <span class="nav-text">whenComplete</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#exceptionally"><span class="nav-number">10.0.2.2.</span> <span class="nav-text">exceptionally</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#handle"><span class="nav-number">10.0.2.3.</span> <span class="nav-text">handle</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%BB%93%E6%9E%9C%E8%BD%AC%E6%8D%A2%EF%BC%88Function%EF%BC%89"><span class="nav-number">10.0.3.</span> <span class="nav-text">结果转换（Function）</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#thenApply"><span class="nav-number">10.0.3.1.</span> <span class="nav-text">thenApply</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#thenCompose"><span class="nav-number">10.0.3.2.</span> <span class="nav-text">thenCompose</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%BB%93%E6%9E%9C%E6%B6%88%E8%B4%B9%EF%BC%88Consumer%EF%BC%89"><span class="nav-number">10.0.4.</span> <span class="nav-text">结果消费（Consumer）</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#thenAccept"><span class="nav-number">10.0.4.1.</span> <span class="nav-text">thenAccept</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#thenAcceptBoth"><span class="nav-number">10.0.4.2.</span> <span class="nav-text">thenAcceptBoth</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#thenRun"><span class="nav-number">10.0.4.3.</span> <span class="nav-text">thenRun</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%BB%93%E6%9E%9C%E7%BB%84%E5%90%88"><span class="nav-number">10.0.5.</span> <span class="nav-text">结果组合</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#thenCombine"><span class="nav-number">10.0.5.1.</span> <span class="nav-text">thenCombine</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%BB%BB%E5%8A%A1%E4%BA%A4%E4%BA%92"><span class="nav-number">10.0.6.</span> <span class="nav-text">任务交互</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#applyToEither%EF%BC%88%E8%BD%AC%E6%8D%A2%EF%BC%89"><span class="nav-number">10.0.6.1.</span> <span class="nav-text">applyToEither（转换）</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#acceptEither%EF%BC%88%E6%B6%88%E8%B4%B9%EF%BC%89"><span class="nav-number">10.0.6.2.</span> <span class="nav-text">acceptEither（消费）</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#runAfterEither"><span class="nav-number">10.0.6.3.</span> <span class="nav-text">runAfterEither</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#runAfterBoth"><span class="nav-number">10.0.6.4.</span> <span class="nav-text">runAfterBoth</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#anyOf"><span class="nav-number">10.0.6.5.</span> <span class="nav-text">anyOf</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#allOf"><span class="nav-number">10.0.6.6.</span> <span class="nav-text">allOf</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#CompletableFuture%EF%BC%9A%E5%85%B6%E4%BB%96"><span class="nav-number">10.0.7.</span> <span class="nav-text">CompletableFuture：其他</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#getNow%EF%BC%9A%E6%8F%90%E4%BA%A4%E4%BB%BB%E5%8A%A1%E7%BB%A7%E7%BB%AD%E8%BF%90%E8%A1%8C"><span class="nav-number">10.0.7.1.</span> <span class="nav-text">getNow：提交任务继续运行</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#complete%EF%BC%9A%E6%8F%90%E4%BA%A4%E4%BB%BB%E5%8A%A1%E4%B8%8D%E4%BC%9A%E7%BB%A7%E7%BB%AD%E8%BF%90%E8%A1%8C"><span class="nav-number">10.0.7.2.</span> <span class="nav-text">complete：提交任务不会继续运行</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#completeExceptionally"><span class="nav-number">10.0.7.3.</span> <span class="nav-text">completeExceptionally</span></a></li></ol></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link"><span class="nav-number">11.</span> <span class="nav-text">并发集合</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#BlockingQueue%E9%9B%86%E5%90%88%E7%B1%BB%E5%85%B3%E7%B3%BB%E5%9B%BE"><span class="nav-number">11.1.</span> <span class="nav-text">BlockingQueue集合类关系图</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#BlockingQueue%E7%9A%847%E4%B8%AA%E5%AD%90%E7%B1%BB"><span class="nav-number">11.2.</span> <span class="nav-text">BlockingQueue的7个子类</span></a></li></ol></li></ol></div>
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-author animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">Alisa</p>
  <div class="site-description" itemprop="description">学习笔记、工作心得</div>
</div>
<div class="site-state-wrap animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
        <a href="/archives/">
          <span class="site-state-item-count">89</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
          <a href="/categories/">
        <span class="site-state-item-count">47</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
      <div class="site-state-item site-state-tags">
          <a href="/tags/">
        <span class="site-state-item-count">29</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>

        </div>
      </div>
    </div>

    
  </aside>


    </div>

    <div class="main-inner post posts-expand">


  


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://hmxyl.github.io/20221101/3c508c34.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Alisa">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Alisa's Home">
      <meta itemprop="description" content="学习笔记、工作心得">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="Java并发包 | Alisa's Home">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          Java并发包
        </h1>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2022-11-01 06:52:00" itemprop="dateCreated datePublished" datetime="2022-11-01T06:52:00+08:00">2022-11-01</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2025-06-20 20:32:20" itemprop="dateModified" datetime="2025-06-20T20:32:20+08:00">2025-06-20</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E5%90%8E%E7%AB%AF/" itemprop="url" rel="index"><span itemprop="name">后端</span></a>
        </span>
          ，
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E5%90%8E%E7%AB%AF/Java/" itemprop="url" rel="index"><span itemprop="name">Java</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody"><h1>Atomic包</h1>
<h2 id="CAS-Compare-And-Swap-：比较并交换">CAS(Compare And Swap)：比较并交换</h2>
<p><code>CAS</code>即<code>Compare And Swap</code>的缩写，翻译成中文就是<strong>比较并交换</strong>，其作用是让CPU比较内存中某个值是否和预期的值相同，如果相同则将这个值更新为新值，不相同则不做更新，也就是CAS是<strong>原子性</strong>的操作(读和写两者同时具有原子性)，其实现方式是通过借助<code>C/C++</code>调用CPU指令完成的，所以效率很高。(使用的是最快失败策略)<br>
<code>CAS</code>的原理很简单，这里使用一段<code>Java</code>代码来描述</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">compareAndSwap</span><span class="params">(<span class="type">int</span> value, <span class="type">int</span> expect, <span class="type">int</span> update)</span> {</span><br><span class="line">    <span class="comment">// 如果内存中的值value和期望值expect一样 则将值更新为新值update</span></span><br><span class="line">    <span class="keyword">if</span> (value == expect) {</span><br><span class="line">        value = update;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    } <span class="keyword">else</span> {</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<p>大致过程是将内存中的值、我们的期望值、新值交给CPU进行运算，如果内存中的值和我们的期望值相同则将值更新为新值，否则不做任何操作。这个过程是在CPU中完成的，这里不好描述CPU的工作过程，就拿Java代码来描述了。</p>
<h3 id="Unsafe源码分析">Unsafe源码分析</h3>
<p>​    Java是在<code>Unsafe(sun.misc.Unsafe)</code>类实现<code>CAS</code>的操作，而我们知道Java是无法直接访问操作系统底层的API的（原因是Java的跨平台性限制了Java不能和操作系统耦合），所以Java并没有在<code>Unsafe</code>类直接实现<code>CAS</code>的操作，而是通过**JDI(Java Native Interface)**本地调用<code>C/C++</code>语言来实现<code>CAS</code>操作的。</p>
<p><code>Unsafe</code>有很多个<code>CAS</code>操作的相关方法，这里举例几个</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">native</span> <span class="type">boolean</span> <span class="title function_">compareAndSwapObject</span><span class="params">(Object var1, <span class="type">long</span> var2, Object var4, Object var5)</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">native</span> <span class="type">boolean</span> <span class="title function_">compareAndSwapInt</span><span class="params">(Object var1, <span class="type">long</span> var2, <span class="type">int</span> var4, <span class="type">int</span> var5)</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">native</span> <span class="type">boolean</span> <span class="title function_">compareAndSwapLong</span><span class="params">(Object var1, <span class="type">long</span> var2, <span class="type">long</span> var4, <span class="type">long</span> var6)</span>;</span><br></pre></td></tr></tbody></table></figure>
<p>我们拿<code>public final native boolean compareAndSwapInt(Object var1, long var2, int var4, int var5);</code>进行分析</p>
<p>这个方法是比较内存中的一个值（整型）和我们的期望值（var4）是否一样，如果一样则将内存中的这个值更新为<code>var5</code>，参数中的<code>var1</code>是值所在的对象，<code>var2</code>是值在对象(var1)中的内存偏移量，<strong>参数var1和参数var2是为了定位出值所在内存的地址</strong>。</p>
<p><img src="https://hmxyl-image.oss-cn-hangzhou.aliyuncs.com/note/7126254-55d47d5ebef3b1e2-16380810237142.webp" alt="img"></p>
<p><strong>Unsafe.java在这里发挥的作用有：</strong></p>
<ol>
<li>将对象引用、值在对象中的偏移量、期望的值和欲更新的新值传递给<code>Unsafe.cpp</code></li>
<li>如果值更新成功则返回<code>true</code>给开发者，没有更新则返回<code>false</code></li>
</ol>
<p><strong>Unsafe.cpp在这里发挥的作用有：</strong></p>
<ol>
<li>接受从<code>Unsafe</code>传递过来的对象引用、偏移量、期望的值和欲更新的新值，根据对象引用和偏移量<strong>计算出值的地址</strong>，然后将值的地址、期望的值、欲更新的新值传递给CPU</li>
<li>如果值更新成功则返回<code>true</code>给<code>Unsafe.java</code>，没有更新则返回<code>false</code></li>
</ol>
<p><strong>CPU在这里发挥的作用：</strong></p>
<ol>
<li>接受从<code>Unsafe.cpp</code>传递过来的地址、期望的值和欲更新的新值，执行指令<code>cmpxchg</code>，比较地址中的值是否和期望的值一样，一样则将值更新为新的值，不一样则不做任何操作</li>
<li>将操作结果返回给<code>Unsafe.cpp</code></li>
</ol>
<h3 id="CAS的缺点：ABA">CAS的缺点：ABA</h3>
<p><strong><code>ABA</code>说明</strong></p>
<blockquote>
<p>在多线程场景下<code>CAS</code>会出现<code>ABA</code>问题，关于ABA问题这里简单科普下，例如有2个线程同时对同一个值(初始值为A)进行CAS操作，这三个线程如下</p>
<ol>
<li>线程1，期望值为A，欲更新的值为B</li>
<li>线程2，期望值为A，欲更新的值为B</li>
<li>线程3，期望值为B，欲更新的值为A</li>
</ol>
<p>线程<code>1</code>抢先获得CPU时间片，而线程<code>2</code>因为其他原因阻塞了；线程<code>1</code>取值与期望的A值比较，发现相等然后将值更新为B；</p>
<p>这个时候<strong>出现了线程<code>3</code></strong>，线程3取值与期望的值B比较，发现相等则将值更新为A；</p>
<p>此时线程<code>2</code>从阻塞中恢复，并且获得了CPU时间片，这时候线程<code>2</code>取值与期望的值A比较，发现相等则将值更新为B</p>
<p>虽然线程<code>2</code>也完成了操作，但是线程<code>2</code>并不知道值已经经过了<code>A-&gt;B-&gt;A</code>的变化过程。</p>
</blockquote>
<p><strong><code>ABA</code>问题带来的危害</strong></p>
<blockquote>
<p>小明在提款机，提取了50元，因为提款机问题，有两个线程，同时把余额从100变为50</p>
<ul>
<li>
<p>线程1（提款机）：获取当前值100，期望更新为50，</p>
</li>
<li>
<p>线程2（提款机）：获取当前值100，期望更新为50，</p>
</li>
</ul>
<p>线程1成功执行，线程2某种原因block了，这时，某人给小明汇款50</p>
<ul>
<li>线程3（某人）：获取当前值50，期望更新为100，</li>
</ul>
<p>这时候线程3成功执行，余额变为100，<br>
线程2从Block中恢复，获取到的也是100，compare之后，继续更新余额为50</p>
<p><strong>此时可以看到，实际余额应该为100（100-50+50），但是实际上变为了50（100-50+50-50）这就是ABA问题带来的成功提交。</strong></p>
</blockquote>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">testAtomicReference</span><span class="params">()</span> <span class="keyword">throws</span> InterruptedException {</span><br><span class="line">  <span class="keyword">final</span> <span class="type">Integer</span> <span class="variable">moneyTotal</span> <span class="operator">=</span> <span class="number">100</span>;</span><br><span class="line">  <span class="type">AtomicInteger</span> <span class="variable">money</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">AtomicInteger</span>(moneyTotal);</span><br><span class="line"></span><br><span class="line">  <span class="type">Thread</span> <span class="variable">t1</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Thread</span>(() -&gt; {</span><br><span class="line">    money.getAndAdd(-<span class="number">50</span>);</span><br><span class="line">    System.out.printf(Thread.currentThread().getName() + <span class="string">"-更新成功（%d-&gt;%d）.\n"</span>, moneyTotal, money.get());</span><br><span class="line">  });</span><br><span class="line">  t1.start();</span><br><span class="line"></span><br><span class="line">  <span class="type">Thread</span> <span class="variable">t2</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Thread</span>(() -&gt; {</span><br><span class="line">    <span class="keyword">try</span> {</span><br><span class="line">      TimeUnit.SECONDS.sleep(<span class="number">2</span>);</span><br><span class="line">    } <span class="keyword">catch</span> (InterruptedException e) {</span><br><span class="line">      e.printStackTrace();</span><br><span class="line">    }</span><br><span class="line">    money.getAndAdd(-<span class="number">50</span>);</span><br><span class="line">    System.out.printf(Thread.currentThread().getName() + <span class="string">"-更新成功（%d-&gt;%d）.\n"</span>, moneyTotal, money.get());</span><br><span class="line">  });</span><br><span class="line">  t2.start();</span><br><span class="line"></span><br><span class="line">  <span class="type">Thread</span> <span class="variable">t3</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Thread</span>(() -&gt; {</span><br><span class="line">    money.getAndAdd(<span class="number">50</span>);</span><br><span class="line">    System.out.printf(Thread.currentThread().getName() + <span class="string">"-更新成功（%d-&gt;%d）.\n"</span>, moneyTotal, money.get());</span><br><span class="line">  });</span><br><span class="line">  t3.start();</span><br><span class="line"></span><br><span class="line">  t1.join();</span><br><span class="line">  t2.join();</span><br><span class="line">  t3.join();</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 输出50，钱数错误</span></span><br><span class="line">  System.out.println(money.get());</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line">输出：</span><br><span class="line">Thread-<span class="number">0</span>-更新成功（<span class="number">100</span>-&gt;<span class="number">50</span>）.</span><br><span class="line">Thread-<span class="number">2</span>-更新成功（<span class="number">100</span>-&gt;<span class="number">100</span>）.</span><br><span class="line">Thread-<span class="number">1</span>-更新成功（<span class="number">100</span>-&gt;<span class="number">50</span>）.</span><br><span class="line"><span class="number">50</span></span><br></pre></td></tr></tbody></table></figure>
<p><strong><code>ABA</code>问题解决：AtomicStampedReference</strong></p>
<p><strong>解决方法</strong>： 在变量前面加上版本号（int），每次变量更新的时候变量的<strong>版本号都<code>+1</code></strong>，即<code>A-&gt;B-&gt;A</code>就变成了<code>1A-&gt;2B-&gt;3A</code>。</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">testAtomicStampedReference</span><span class="params">()</span> <span class="keyword">throws</span> InterruptedException {</span><br><span class="line">    <span class="keyword">final</span> <span class="type">AtomicInteger</span> <span class="variable">stamp</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">AtomicInteger</span>();</span><br><span class="line">    <span class="keyword">final</span> <span class="type">Integer</span> <span class="variable">moneyTotal</span> <span class="operator">=</span> <span class="number">100</span>;</span><br><span class="line">    <span class="type">AtomicStampedReference</span> <span class="variable">money</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">AtomicStampedReference</span>(moneyTotal, <span class="number">0</span>);</span><br><span class="line">    <span class="comment">// step1：取款50</span></span><br><span class="line">    <span class="keyword">final</span> <span class="type">Integer</span> <span class="variable">moneyStep1</span> <span class="operator">=</span> moneyTotal - <span class="number">50</span>;</span><br><span class="line">    <span class="type">Thread</span> <span class="variable">t1</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Thread</span>(() -&gt; {</span><br><span class="line">        <span class="keyword">if</span> (money.compareAndSet(moneyTotal, moneyStep1, stamp.get(), stamp.incrementAndGet())) {</span><br><span class="line">            System.out.printf(Thread.currentThread().getName() + <span class="string">"-更新成功（%d-&gt;%d）:%d.\n"</span>, moneyTotal,</span><br><span class="line">                              money.getReference(), money.getStamp());</span><br><span class="line">        } <span class="keyword">else</span> {</span><br><span class="line">            System.out.printf(Thread.currentThread().getName() + <span class="string">"-更新失败（%d-&gt;%d）:%d.\n"</span>, moneyTotal,</span><br><span class="line">                              money.getReference(), money.getStamp());</span><br><span class="line">        }</span><br><span class="line">    }, <span class="string">"T1"</span>);</span><br><span class="line">    t1.start();</span><br><span class="line"></span><br><span class="line">    <span class="type">Thread</span> <span class="variable">t2</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Thread</span>(() -&gt; {</span><br><span class="line"></span><br><span class="line">        TaskFactory.spend(<span class="number">2</span>, TimeUnit.SECONDS);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (money.compareAndSet(moneyTotal, moneyStep1, stamp.get(), stamp.incrementAndGet())) {</span><br><span class="line">            System.out.printf(Thread.currentThread().getName() + <span class="string">"-更新成功（%d-&gt;%d）:%d.\n"</span>, moneyTotal,</span><br><span class="line">                              money.getReference(), money.getStamp());</span><br><span class="line">        } <span class="keyword">else</span> {</span><br><span class="line">            System.out.printf(Thread.currentThread().getName() + <span class="string">"-更新失败（%d-&gt;%d）:%d.\n"</span>, moneyTotal,</span><br><span class="line">                              money.getReference(), money.getStamp());</span><br><span class="line">        }</span><br><span class="line">    }, <span class="string">"T2"</span>);</span><br><span class="line">    t2.start();</span><br><span class="line">    <span class="comment">// step2. 他人转入50</span></span><br><span class="line">    <span class="keyword">final</span> <span class="type">Integer</span> <span class="variable">moneyStep2</span> <span class="operator">=</span> moneyStep1 + <span class="number">50</span>;</span><br><span class="line">    <span class="type">Thread</span> <span class="variable">t3</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Thread</span>(() -&gt; {</span><br><span class="line">        <span class="keyword">if</span> (money.compareAndSet(moneyStep1, moneyStep2, <span class="number">1</span>, <span class="number">2</span>)) {</span><br><span class="line">            System.out.printf(Thread.currentThread().getName() + <span class="string">"-更新成功（%d-&gt;%d）:%d.\n"</span>, moneyTotal,</span><br><span class="line">                              money.getReference(), money.getStamp());</span><br><span class="line">        } <span class="keyword">else</span> {</span><br><span class="line">            System.out.printf(Thread.currentThread().getName() + <span class="string">"-更新成功（%d-&gt;%d）:%d.\n"</span>, moneyTotal,</span><br><span class="line">                              money.getReference(), money.getStamp());</span><br><span class="line">        }</span><br><span class="line">    }, <span class="string">"T3"</span>);</span><br><span class="line">    t3.start();</span><br><span class="line"></span><br><span class="line">    t1.join();</span><br><span class="line">    t2.join();</span><br><span class="line">    t3.join();</span><br><span class="line">    System.out.printf(Thread.currentThread().getName() + <span class="string">"-最终（%d）:%d.\n"</span>, money.getReference(), money.getStamp());</span><br><span class="line"></span><br><span class="line">}</span><br><span class="line"></span><br><span class="line">输出</span><br><span class="line">T1-更新成功（<span class="number">100</span>-&gt;<span class="number">50</span>）:<span class="number">1.</span></span><br><span class="line">T3-更新成功（<span class="number">100</span>-&gt;<span class="number">100</span>）:<span class="number">2.</span></span><br><span class="line">T2-更新失败（<span class="number">100</span>-&gt;<span class="number">100</span>）:<span class="number">2.</span></span><br><span class="line">main-最终（<span class="number">100</span>）:<span class="number">2.</span></span><br></pre></td></tr></tbody></table></figure>
<h3 id="CAS的缺点：循环时间长开销大">CAS的缺点：循环时间长开销大</h3>
<p>如果<code>CAS</code>操作失败，就需要循环进行<code>CAS</code>操作(循环同时将期望值更新为最新的)，如果长时间都不成功的话，那么会造成CPU极大的开销。</p>
<blockquote>
<p>这种循环也称为自旋</p>
</blockquote>
<p><strong>解决方法</strong>： 限制自旋次数，防止进入死循环。</p>
<h3 id="CAS的缺点：只能保证一个共享变量的原子操作">CAS的缺点：只能保证一个共享变量的原子操作</h3>
<p><code>CAS</code>的原子操作只能针对一个共享变量。</p>
<p><strong>解决方法</strong>： 如果需要对多个共享变量进行操作，可以使用加锁方式(悲观锁)保证原子性，或者可以把多个共享变量合并成一个共享变量进行<code>CAS</code>操作。</p>
<h3 id="CAS的应用">CAS的应用</h3>
<p>我们知道<code>CAS</code>操作并不会锁住共享变量，也就是一种<strong>非阻塞</strong>的同步机制，<code>CAS</code>就是乐观锁的实现。</p>
<ol>
<li><strong>乐观锁</strong>总是假设最好的情况，每次去操作数据都认为不会被别的线程修改数据，<strong>所以在每次操作数据的时候都不会给数据加锁</strong>，即在线程对数据进行操作的时候，<strong>别的线程不会阻塞</strong>仍然可以对数据进行操作，只有在需要更新数据的时候才会去判断数据是否被别的线程修改过，如果数据被修改过则会拒绝操作并且返回错误信息给用户。</li>
<li><strong>悲观锁</strong>总是假设最坏的情况，每次去操作数据时候都认为会被的线程修改数据，<strong>所以在每次操作数据的时候都会给数据加锁</strong>，让别的线程无法操作这个数据，别的线程会一直阻塞直到获取到这个数据的锁。这样的话就会影响效率，比如当有个线程发生一个很耗时的操作的时候，别的线程只是想获取这个数据的值而已都要等待很久。</li>
</ol>
<p><code>Java</code>利用<code>CAS</code>的乐观锁、原子性的特性高效解决了多线程的安全性问题，例如JDK1.8中的集合类<code>ConcurrentHashMap</code>、关键字<code>volatile</code>、<code>ReentrantLock</code>等。</p>
<h2 id="AtomicLong">AtomicLong</h2>
<ul>
<li>
<p>区别于AtomicInteger：VM_SUPPORTS_LONG_CAS：虚拟机是否支持 CAS 操作</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Records whether the underlying JVM supports lockless</span></span><br><span class="line"><span class="comment"> * compareAndSwap for longs. While the Unsafe.compareAndSwapLong</span></span><br><span class="line"><span class="comment"> * method works in either case, some constructions should be</span></span><br><span class="line"><span class="comment"> * handled at Java level to avoid locking user-visible locks.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">final</span> <span class="type">boolean</span> <span class="variable">VM_SUPPORTS_LONG_CAS</span> <span class="operator">=</span> VMSupportsCS8();</span><br><span class="line">  </span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Returns whether underlying JVM supports lockless CompareAndSet</span></span><br><span class="line"><span class="comment"> * for longs. Called only once and cached in VM_SUPPORTS_LONG_CAS.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">native</span> <span class="type">boolean</span> <span class="title function_">VMSupportsCS8</span><span class="params">()</span>;</span><br></pre></td></tr></tbody></table></figure>
</li>
</ul>
<h2 id="AtomicReference">AtomicReference</h2>
<p>reference的地址为int类型</p>
<h2 id="AtomicXXXFieldUpdater">AtomicXXXFieldUpdater</h2>
<p>使用AtomicXXXFieldUpdater的原因：</p>
<ul>
<li>
<p>想让类的操作属性具备原子性的条件</p>
<ol>
<li>类的属性是volatile（ Must be volatile type）</li>
<li>==非当前类调用，则非private、protected==</li>
<li>类型必须一致</li>
</ol>
</li>
<li>
<p>不想使用锁（包括显示锁、重量级锁Synchronized）</p>
</li>
<li>
<p>大量需要原子类型修饰的对象，比较消耗资源</p>
</li>
</ul>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">AtomicIntegerFieldUpdaterTest</span> {</span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">test</span><span class="params">()</span> {</span><br><span class="line">        AtomicIntegerFieldUpdater&lt;TestBean&gt; updater = AtomicIntegerFieldUpdater.newUpdater(TestBean.class, <span class="string">"param"</span>);</span><br><span class="line">        <span class="type">TestBean</span> <span class="variable">test</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TestBean</span>();</span><br><span class="line">        updater.incrementAndGet(test);</span><br><span class="line">        System.out.println(updater.get(test));</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="keyword">class</span> <span class="title class_">TestBean</span> {</span><br><span class="line">        <span class="comment">// 非本类调用，param 不可设置未private、protected</span></span><br><span class="line">        <span class="keyword">volatile</span> <span class="type">int</span> param;</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<h2 id="Unsafe">Unsafe</h2>
<p>​	 java 调用C++/C 再 调用汇编</p>
<h3 id="几种Counter方案的性能对比。">几种Counter方案的性能对比。</h3>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> sun.misc.Unsafe;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Field;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.ExecutorService;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.Executors;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.TimeUnit;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.atomic.AtomicInteger;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.locks.Lock;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.locks.ReentrantLock;</span><br><span class="line"><span class="keyword">import</span> java.util.function.Consumer;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">UnsafeTest</span> {</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">int</span> <span class="variable">THREAD_COUNT</span> <span class="operator">=</span> <span class="number">1000</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">int</span> <span class="variable">MAX_NUM</span> <span class="operator">=</span> <span class="number">10000</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> {</span><br><span class="line">        doAction(getAction(), <span class="keyword">new</span> <span class="title class_">VolatileCounter</span>(), <span class="string">"Volatile"</span>);</span><br><span class="line">        doAction(getAction(), <span class="keyword">new</span> <span class="title class_">AtomicCounter</span>(), <span class="string">"Executors"</span>);</span><br><span class="line">        doAction(getAction(), <span class="keyword">new</span> <span class="title class_">SynCounter</span>(), <span class="string">"Sync"</span>);</span><br><span class="line">        doAction(getAction(), <span class="keyword">new</span> <span class="title class_">LockCounter</span>(), <span class="string">"Lock"</span>);</span><br><span class="line">        doAction(getAction(), <span class="keyword">new</span> <span class="title class_">CasCounter</span>(), <span class="string">"Cas"</span>);</span><br><span class="line"></span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> Consumer&lt;Counter&gt; <span class="title function_">getAction</span><span class="params">()</span> {</span><br><span class="line">        Consumer&lt;Counter&gt; action = param -&gt; {</span><br><span class="line">            <span class="type">ExecutorService</span> <span class="variable">executorService</span> <span class="operator">=</span> Executors.newFixedThreadPool(THREAD_COUNT);</span><br><span class="line">            <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; THREAD_COUNT; i++) {</span><br><span class="line">                executorService.submit(<span class="keyword">new</span> <span class="title class_">CounterRunnable</span>(param, MAX_NUM));</span><br><span class="line">            }</span><br><span class="line">            executorService.shutdown();</span><br><span class="line">            <span class="keyword">try</span> {</span><br><span class="line">                <span class="comment">// 不可省略，需要等待执行线程运行结束</span></span><br><span class="line">                <span class="comment">// 一般情况下awaitTermination和shutdown配合使用，shutdown之后调用awaitTermination</span></span><br><span class="line">                <span class="comment">// 如果注释掉shutdown方法，则awaitTermination不会监视到线程池关闭的信息 所以在这个地方代码会堵塞，</span></span><br><span class="line">                <span class="comment">// 如果注释掉awaitTermination方法，则后面的代码不会得到线程执行过的结果</span></span><br><span class="line">                executorService.awaitTermination(<span class="number">1</span>, TimeUnit.HOURS);</span><br><span class="line">            } <span class="keyword">catch</span> (InterruptedException e) {</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            }</span><br><span class="line">        };</span><br><span class="line">        <span class="keyword">return</span> action;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 统计运行时长</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> action</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> counter</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">doAction</span><span class="params">(Consumer&lt;Counter&gt; action, Counter counter, String tag)</span> {</span><br><span class="line">        <span class="type">long</span> <span class="variable">begin</span> <span class="operator">=</span> System.currentTimeMillis();</span><br><span class="line">        <span class="comment">// 任务执行</span></span><br><span class="line">        action.accept(counter);</span><br><span class="line">        <span class="type">long</span> <span class="variable">end</span> <span class="operator">=</span> System.currentTimeMillis();</span><br><span class="line">        System.out.println(tag + <span class="string">" counter result: "</span> + counter.getCounter() + <span class="string">" and time passed in ms: "</span> + (end - begin));</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="keyword">interface</span> <span class="title class_">Counter</span> {</span><br><span class="line">        <span class="keyword">void</span> <span class="title function_">increment</span><span class="params">()</span>;</span><br><span class="line"></span><br><span class="line">        <span class="type">long</span> <span class="title function_">getCounter</span><span class="params">()</span>;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">VolatileCounter</span> <span class="keyword">implements</span> <span class="title class_">Counter</span> {</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">volatile</span> <span class="type">int</span> counter;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">increment</span><span class="params">()</span> {</span><br><span class="line">            ++counter;</span><br><span class="line">        }</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> <span class="type">long</span> <span class="title function_">getCounter</span><span class="params">()</span> {</span><br><span class="line">            <span class="keyword">return</span> counter;</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">AtomicCounter</span> <span class="keyword">implements</span> <span class="title class_">Counter</span> {</span><br><span class="line">        <span class="keyword">private</span> <span class="type">AtomicInteger</span> <span class="variable">counter</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">AtomicInteger</span>(<span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">increment</span><span class="params">()</span> {</span><br><span class="line">            counter.incrementAndGet();</span><br><span class="line">        }</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> <span class="type">long</span> <span class="title function_">getCounter</span><span class="params">()</span> {</span><br><span class="line">            <span class="keyword">return</span> counter.get();</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">SynCounter</span> <span class="keyword">implements</span> <span class="title class_">Counter</span> {</span><br><span class="line">        <span class="keyword">private</span> <span class="type">int</span> <span class="variable">counter</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title function_">increment</span><span class="params">()</span> {</span><br><span class="line">            ++counter;</span><br><span class="line">        }</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> <span class="type">long</span> <span class="title function_">getCounter</span><span class="params">()</span> {</span><br><span class="line">            <span class="keyword">return</span> counter;</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">LockCounter</span> <span class="keyword">implements</span> <span class="title class_">Counter</span> {</span><br><span class="line">        <span class="keyword">private</span> <span class="type">int</span> <span class="variable">counter</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">private</span> <span class="type">Lock</span> <span class="variable">lock</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ReentrantLock</span>();</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">increment</span><span class="params">()</span> {</span><br><span class="line">            <span class="keyword">try</span> {</span><br><span class="line">                lock.lock();</span><br><span class="line">                ++counter;</span><br><span class="line">            } <span class="keyword">finally</span> {</span><br><span class="line">                lock.unlock();</span><br><span class="line">            }</span><br><span class="line">        }</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> <span class="type">long</span> <span class="title function_">getCounter</span><span class="params">()</span> {</span><br><span class="line">            <span class="keyword">return</span> counter;</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">CasCounter</span> <span class="keyword">implements</span> <span class="title class_">Counter</span> {</span><br><span class="line">        <span class="keyword">private</span> <span class="type">int</span> <span class="variable">counter</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">Unsafe</span> <span class="variable">unsafe</span> <span class="operator">=</span> getUnsafe();</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">long</span> valueOffset;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">static</span> {</span><br><span class="line">            <span class="keyword">try</span> {</span><br><span class="line">                valueOffset = unsafe.objectFieldOffset(CasCounter.class.getDeclaredField(<span class="string">"counter"</span>));</span><br><span class="line">            } <span class="keyword">catch</span> (Exception ex) {</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">Error</span>(ex);</span><br><span class="line">            }</span><br><span class="line">        }</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">increment</span><span class="params">()</span> {</span><br><span class="line">            <span class="type">int</span> <span class="variable">expect</span> <span class="operator">=</span> counter;</span><br><span class="line">            <span class="keyword">while</span> (!unsafe.compareAndSwapInt(<span class="built_in">this</span>, valueOffset, expect, expect + <span class="number">1</span>)) {</span><br><span class="line">                expect = counter;</span><br><span class="line">            }</span><br><span class="line">        }</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> <span class="type">long</span> <span class="title function_">getCounter</span><span class="params">()</span> {</span><br><span class="line">            <span class="keyword">return</span> counter;</span><br><span class="line">        }</span><br><span class="line"></span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">static</span> Unsafe <span class="title function_">getUnsafe</span><span class="params">()</span> {</span><br><span class="line">            <span class="keyword">try</span> {</span><br><span class="line">                <span class="type">Field</span> <span class="variable">unsafe</span> <span class="operator">=</span> Unsafe.class.getDeclaredField(<span class="string">"theUnsafe"</span>);</span><br><span class="line">                unsafe.setAccessible(<span class="literal">true</span>);</span><br><span class="line">                <span class="keyword">return</span> (Unsafe) unsafe.get(<span class="literal">null</span>);</span><br><span class="line">            } <span class="keyword">catch</span> (Exception e) {</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(e);</span><br><span class="line">            }</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">CounterRunnable</span> <span class="keyword">implements</span> <span class="title class_">Runnable</span> {</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">final</span> Counter counter;</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">final</span> <span class="type">int</span> num;</span><br><span class="line"></span><br><span class="line">        CounterRunnable(Counter counter, <span class="type">int</span> num) {</span><br><span class="line">            <span class="built_in">this</span>.counter = counter;</span><br><span class="line">            <span class="built_in">this</span>.num = num;</span><br><span class="line">        }</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> {</span><br><span class="line">            <span class="keyword">synchronized</span> (counter) {</span><br><span class="line">                <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; num; i++) {</span><br><span class="line">                    counter.increment();</span><br><span class="line">                }</span><br><span class="line">            }</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<p>执行结果</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">Volatile counter result: <span class="number">10000000</span> and time passed in ms: <span class="number">177</span></span><br><span class="line">Executors counter result: <span class="number">10000000</span> and time passed in ms: <span class="number">183</span></span><br><span class="line">Sync counter result: <span class="number">10000000</span> and time passed in ms: <span class="number">1111</span></span><br><span class="line">Lock counter result: <span class="number">10000000</span> and time passed in ms: <span class="number">204</span></span><br><span class="line">Cas counter result: <span class="number">10000000</span> and time passed in ms: <span class="number">114</span></span><br></pre></td></tr></tbody></table></figure>
<h3 id="Java-调用-C-流程（JNI-）">Java 调用 C 流程（JNI ）</h3>
<ol>
<li>
<p>创建目录<code>jni</code></p>
</li>
<li>
<p>创建文件<code>Hello.java</code></p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Hello</span>{</span><br><span class="line">	<span class="keyword">static</span>{</span><br><span class="line">		<span class="comment">// 加载动态链接库</span></span><br><span class="line">		System.loadLibrary(<span class="string">"hello"</span>);</span><br><span class="line">	}</span><br><span class="line">	</span><br><span class="line">	<span class="comment">// 本地方法</span></span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">native</span> <span class="keyword">void</span> <span class="title function_">hi</span><span class="params">()</span>;</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span>{</span><br><span class="line">		<span class="keyword">new</span> <span class="title class_">Hello</span>().hi();</span><br><span class="line">	}</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
</li>
<li>
<p>编译Java文件<code>javac Hello.java</code></p>
<p><img src="https://hmxyl-image.oss-cn-hangzhou.aliyuncs.com/note/image-20220222105628308-1667231117133-83.png" alt="image-20220222105628308"></p>
</li>
<li>
<p>使用命令<code>javah -jni Hello</code>生成头文件<code>Hello.h</code>（C的header文件）</p>
<p><img src="https://hmxyl-image.oss-cn-hangzhou.aliyuncs.com/note/image-20220222105835195-1667231117133-84.png" alt="image-20220222105835195"></p>
<p>Hello.h内容如下</p>
<figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* DO NOT EDIT THIS FILE - it is machine generated */</span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;jni.h&gt;</span></span></span><br><span class="line"><span class="comment">/* Header for class Hello */</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">ifndef</span> _Included_Hello</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> _Included_Hello</span></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> __cplusplus</span></span><br><span class="line"><span class="keyword">extern</span> <span class="string">"C"</span> {</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * Class:     Hello</span></span><br><span class="line"><span class="comment"> * Method:    hi</span></span><br><span class="line"><span class="comment"> * Signature: ()V</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">JNIEXPORT <span class="type">void</span> JNICALL <span class="title function_">Java_Hello_hi</span></span><br><span class="line">  <span class="params">(JNIEnv *, jobject)</span>;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> __cplusplus</span></span><br><span class="line">}</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"></span><br></pre></td></tr></tbody></table></figure>
</li>
<li>
<p>编写C程序：<code>Hello.c</code>，也就是上面header文件中方法的实现</p>
<figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;jni.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">"Hello.h"</span></span></span><br><span class="line"></span><br><span class="line">JNIEXPORT <span class="type">void</span> JNICALL <span class="title function_">Java_Hello_hi</span> <span class="params">(JNIEnv * env, jobject o)</span>{</span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">"Say hi.\n"</span>);</span><br><span class="line">};</span><br></pre></td></tr></tbody></table></figure>
</li>
<li>
<p>查看<code>ls -l $JAVA_HOME/include</code></p>
</li>
<li>
<p>编译C文件<code>gcc -fPIC  -I"$JAVA_HOME/include" -I"$JAVA_HOME/include/linux" -c Hello.c</code>，生成了<code>Hello.o</code>的目标文件</p>
</li>
<li>
<p>生成"hello" 的动态链接库 <code>gcc -shared Hello.o -o libhello.so</code>， 生成了<code>libhello.so</code>（<code>lib</code> 是linux约定俗成的前缀）</p>
</li>
<li>
<p>运行java文件：<code>java Hello</code>，报错</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">Exception in thread <span class="string">"main"</span> java.lang.UnsatisfiedLinkError: no hello in java.library.path</span><br><span class="line">	at java.lang.ClassLoader.loadLibrary(ClassLoader.java:<span class="number">1867</span>)</span><br><span class="line">	at java.lang.Runtime.loadLibrary0(Runtime.java:<span class="number">870</span>)</span><br><span class="line">	at java.lang.System.loadLibrary(System.java:<span class="number">1122</span>)</span><br><span class="line">	at Hello.&lt;clinit&gt;(Hello.java:<span class="number">4</span>)</span><br></pre></td></tr></tbody></table></figure>
</li>
<li>
<p>配置<code>java.library.path</code>. 临时生效：<code>export LD_LIBRARY_PATH=.</code></p>
<p><img src="https://hmxyl-image.oss-cn-hangzhou.aliyuncs.com/note/image-20220222113453875-1667231117133-86.png" alt="image-20220222113453875"></p>
</li>
<li>
<p>重新运行：<code>java Hello</code></p>
<p><img src="https://hmxyl-image.oss-cn-hangzhou.aliyuncs.com/note/image-20220222113625291-1667231117133-85.png" alt="image-20220222113625291"></p>
</li>
</ol>
<h2 id="底层汇编相关指令">底层汇编相关指令</h2>
<blockquote>
<p>compareAndSwapInt -&gt; cmpxchg1</p>
<p>compareAndSwapLong -&gt; cmpxchg</p>
<p>putOrderedInt -&gt; xchg1</p>
<p>compareAndSwapObject -&gt; cmpxchgq</p>
</blockquote>
<h1>CountDownLatch</h1>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">A synchronization aid that allows one or more threads to wait until a set of operations being performed in other threads completes.</span><br><span class="line">“允许一个或多个线程等待，直到在其他线程中执行的一组操作完成”的同步算法</span><br></pre></td></tr></tbody></table></figure>
<h2 id="退出条件">退出条件</h2>
<ol>
<li>countDown() 减到0：<code>await()</code></li>
<li>等待时间到了截止时间：<code>await(long timeout, TimeUnit unit)</code></li>
</ol>
<h2 id="使用场景">使用场景</h2>
<h3 id="等待所有线程执行完成">等待所有线程执行完成</h3>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> hots.utils;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.Random;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.CountDownLatch;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.ExecutorService;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.Executors;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.atomic.AtomicInteger;</span><br><span class="line"><span class="keyword">import</span> java.util.stream.IntStream;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CountDownLatchTest</span> {</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">static</span> <span class="type">AtomicInteger</span> <span class="variable">count</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">AtomicInteger</span>();</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">static</span> <span class="type">Random</span> <span class="variable">random</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Random</span>();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> CountDownLatch latch;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="type">ExecutorService</span> <span class="variable">executorService</span> <span class="operator">=</span> Executors.newFixedThreadPool(<span class="number">2</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> InterruptedException {</span><br><span class="line">        <span class="comment">// step1: 获取查询数据</span></span><br><span class="line">        <span class="type">int</span>[] data = IntStream.rangeClosed(<span class="number">1</span>, <span class="number">5</span>).map(e -&gt; random.nextInt(<span class="number">1_000</span>)).toArray();</span><br><span class="line">        latch = <span class="keyword">new</span> <span class="title class_">CountDownLatch</span>(data.length);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// step2：根据查询数据分配多个线程执行</span></span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; data.length; i++) {</span><br><span class="line">            executorService.submit(<span class="keyword">new</span> <span class="title class_">SimpleRunnable</span>(latch, count, i, data[i]));</span><br><span class="line">        }</span><br><span class="line">        System.out.printf(<span class="string">"All works submitted.\n"</span>);</span><br><span class="line">        latch.await();</span><br><span class="line"></span><br><span class="line">        executorService.shutdown();</span><br><span class="line">        <span class="comment">// step3</span></span><br><span class="line">        System.out.printf(<span class="string">"All works finished. Support with [%d] threads.\n"</span>, count.get());</span><br><span class="line"></span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">SimpleRunnable</span> <span class="keyword">implements</span> <span class="title class_">Runnable</span> {</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">final</span> <span class="type">int</span> index;</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">final</span> <span class="type">int</span> param;</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">final</span> CountDownLatch latch;</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">final</span> AtomicInteger count;</span><br><span class="line"></span><br><span class="line">        SimpleRunnable(CountDownLatch latch, AtomicInteger count, <span class="type">int</span> index, <span class="type">int</span> param) {</span><br><span class="line">            <span class="built_in">this</span>.index = index;</span><br><span class="line">            <span class="built_in">this</span>.param = param;</span><br><span class="line">            <span class="built_in">this</span>.count = count;</span><br><span class="line">            <span class="built_in">this</span>.latch = latch;</span><br><span class="line">        }</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> {</span><br><span class="line">            <span class="keyword">try</span> {</span><br><span class="line">                Thread.sleep(<span class="number">100</span>);</span><br><span class="line">                System.out.printf(<span class="string">"%s deal with [%d]-[%d] \n"</span>, Thread.currentThread().getName(), index, param);</span><br><span class="line">            } <span class="keyword">catch</span> (InterruptedException e) {</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            } <span class="keyword">finally</span> {</span><br><span class="line">                count.incrementAndGet();</span><br><span class="line">                latch.countDown();</span><br><span class="line">            }</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">All works submitted.</span><br><span class="line">pool-<span class="number">1</span>-thread-<span class="number">2</span> deal with [<span class="number">1</span>]-[<span class="number">546</span>] </span><br><span class="line">pool-<span class="number">1</span>-thread-<span class="number">1</span> deal with [<span class="number">0</span>]-[<span class="number">833</span>] </span><br><span class="line">pool-<span class="number">1</span>-thread-<span class="number">2</span> deal with [<span class="number">2</span>]-[<span class="number">11</span>] </span><br><span class="line">pool-<span class="number">1</span>-thread-<span class="number">1</span> deal with [<span class="number">3</span>]-[<span class="number">247</span>] </span><br><span class="line">pool-<span class="number">1</span>-thread-<span class="number">2</span> deal with [<span class="number">4</span>]-[<span class="number">191</span>] </span><br><span class="line">All works finished. Support with [<span class="number">5</span>] threads.</span><br></pre></td></tr></tbody></table></figure>
<h3 id="任务拆分离散并行化处理">任务拆分离散并行化处理</h3>
<p>业务流程如下</p>
<p><img src="https://hmxyl-image.oss-cn-hangzhou.aliyuncs.com/note/CountDown.drawio-1667231117133-87.png" alt="CountDown.drawio"></p>
<h4 id="基本信息定义">基本信息定义</h4>
<ul>
<li>统计表</li>
</ul>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Getter</span></span><br><span class="line"><span class="meta">@Setter</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Table</span> {</span><br><span class="line">    <span class="comment">// 表名</span></span><br><span class="line">    <span class="keyword">private</span> String tableName;</span><br><span class="line">    <span class="comment">// 原始记录条数</span></span><br><span class="line">    <span class="keyword">private</span> <span class="type">long</span> <span class="variable">sourceRecordCount</span> <span class="operator">=</span> <span class="number">10</span>;</span><br><span class="line">    <span class="comment">// 传输完成后的记录条数：验证1</span></span><br><span class="line">    <span class="keyword">private</span> <span class="type">long</span> targetCount;</span><br><span class="line">    <span class="comment">// 原始schema</span></span><br><span class="line">    <span class="keyword">private</span> <span class="type">String</span> <span class="variable">sourceColumnSchema</span> <span class="operator">=</span> <span class="string">"&lt;table name='a'&gt;&lt;column name='c1' type='varchar'&gt;&lt;/column&gt;&lt;/table&gt;"</span>;</span><br><span class="line">    <span class="comment">// 传输完成之后的schema：验证2</span></span><br><span class="line">    <span class="keyword">private</span> <span class="type">String</span> <span class="variable">targetColumnSchema</span> <span class="operator">=</span> <span class="string">""</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">Table</span><span class="params">(String tableName, <span class="type">long</span> sourceRecordCount)</span> {</span><br><span class="line">        <span class="built_in">this</span>.tableName = tableName;</span><br><span class="line">        <span class="built_in">this</span>.sourceRecordCount = sourceRecordCount;</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<ul>
<li>监控工具</li>
</ul>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">abstract</span> <span class="keyword">class</span> <span class="title class_">Watcher</span> {</span><br><span class="line">    <span class="keyword">final</span> CountDownLatch countDownLatch;</span><br><span class="line"></span><br><span class="line">    Watcher(CountDownLatch countDownLatch) {</span><br><span class="line">        <span class="built_in">this</span>.countDownLatch = countDownLatch;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="keyword">abstract</span> <span class="keyword">void</span> <span class="title function_">done</span><span class="params">()</span>;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<ul>
<li>事件定义（对应一次批处理任务）</li>
</ul>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Getter</span></span><br><span class="line"><span class="meta">@Setter</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Event</span> {</span><br><span class="line">    <span class="keyword">private</span> String eventName;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">Event</span><span class="params">(String eventName)</span> {</span><br><span class="line">        <span class="built_in">this</span>.eventName = eventName;</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<ul>
<li>批处理任务完成验证</li>
</ul>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">EventTaskBatch</span> <span class="keyword">extends</span> <span class="title class_">Watcher</span> {</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Event event;</span><br><span class="line"></span><br><span class="line">    EventTaskBatch(Event event, <span class="type">int</span> taskSize) {</span><br><span class="line">        <span class="built_in">super</span>(<span class="keyword">new</span> <span class="title class_">CountDownLatch</span>(taskSize));</span><br><span class="line">        <span class="built_in">this</span>.event = event;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">done</span><span class="params">()</span> {</span><br><span class="line">        countDownLatch.countDown();</span><br><span class="line">        <span class="keyword">if</span> (countDownLatch.getCount() == <span class="number">0</span>) {</span><br><span class="line">            <span class="comment">// Event涉及到的所有Table任务完成</span></span><br><span class="line">            System.out.println(<span class="string">"All table of event "</span> + event.getEventName() + <span class="string">" is finished verify and update continue."</span>);</span><br><span class="line">            System.out.println();</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<ul>
<li>批处理表验证任务全部完成</li>
</ul>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">TableTaskBatch</span> <span class="keyword">extends</span> <span class="title class_">Watcher</span> {</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Table table;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* 每张表存在多个验证任务 */</span></span><br><span class="line">    <span class="keyword">private</span> EventTaskBatch eventTaskBatch;</span><br><span class="line"></span><br><span class="line">    TableTaskBatch(EventTaskBatch eventTaskBatch, Table table, <span class="type">int</span> taskSize) {</span><br><span class="line">        <span class="built_in">super</span>(<span class="keyword">new</span> <span class="title class_">CountDownLatch</span>(taskSize));</span><br><span class="line">        <span class="built_in">this</span>.table = table;</span><br><span class="line">        <span class="built_in">this</span>.eventTaskBatch = eventTaskBatch;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">done</span><span class="params">()</span> {</span><br><span class="line">        countDownLatch.countDown();</span><br><span class="line">        <span class="keyword">if</span> (countDownLatch.getCount() == <span class="number">0</span>) {</span><br><span class="line">            <span class="comment">// Table相关所有任务完成</span></span><br><span class="line">            System.out.println(<span class="string">"All tasks of "</span> + table.getTableName() + <span class="string">" is finished verify and update continue."</span>);</span><br><span class="line">            eventTaskBatch.done();</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<ul>
<li>表数据验证行为</li>
</ul>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">abstract</span> <span class="keyword">class</span> <span class="title class_">TableVerify</span> <span class="keyword">implements</span> <span class="title class_">Runnable</span> {</span><br><span class="line"></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">final</span> Table table;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">final</span> TableTaskBatch tableTaskBatch;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">TableVerify</span><span class="params">(Table table, TableTaskBatch tableTaskBatch)</span> {</span><br><span class="line">        <span class="built_in">this</span>.table = table;</span><br><span class="line">        <span class="built_in">this</span>.tableTaskBatch = tableTaskBatch;</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<p>​		a) 验证1：验证数据量</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">TrustSourceRecordCount</span> <span class="keyword">extends</span> <span class="title class_">TableVerify</span>{</span><br><span class="line">    TrustSourceRecordCount(Table table, TableTaskBatch tableTaskBatch) {</span><br><span class="line">        <span class="built_in">super</span>(table, tableTaskBatch);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> {</span><br><span class="line">        TaskFactory.spend(ThreadLocalRandom.current().nextInt(<span class="number">10</span>), TimeUnit.SECONDS);</span><br><span class="line">        <span class="comment">// 设置传输完成之后的数据量</span></span><br><span class="line">        table.setTargetCount(table.getSourceRecordCount());</span><br><span class="line">        <span class="comment">// 完成一次一张表的验证完成计数</span></span><br><span class="line">        tableTaskBatch.done();</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<p>​		b) 验证2：验证表结构</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">TrustSourceColumns</span> <span class="keyword">extends</span> <span class="title class_">TableVerify</span> {</span><br><span class="line">    TrustSourceColumns(Table table, TableTaskBatch tableTaskBatch) {</span><br><span class="line">        <span class="built_in">super</span>(table, tableTaskBatch);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> {</span><br><span class="line">        TaskFactory.spend(ThreadLocalRandom.current().nextInt(<span class="number">10</span>), TimeUnit.SECONDS);</span><br><span class="line">        table.setTargetColumnSchema(table.getSourceColumnSchema());</span><br><span class="line">        <span class="comment">// 完成一次一张表的验证完成计数</span></span><br><span class="line">        tableTaskBatch.done();</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<ul>
<li>测试类</li>
</ul>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CountDownLatchTest</span> {</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> {</span><br><span class="line">        <span class="type">ExecutorService</span> <span class="variable">executorService</span> <span class="operator">=</span> Executors.newFixedThreadPool(<span class="number">10</span>);</span><br><span class="line">        <span class="keyword">try</span> {</span><br><span class="line">            <span class="comment">// 不同数据源的数据，批处理</span></span><br><span class="line">            Event[] events = {<span class="keyword">new</span> <span class="title class_">Event</span>(<span class="string">"Event-1"</span>), <span class="keyword">new</span> <span class="title class_">Event</span>(<span class="string">"Event-2"</span>)};</span><br><span class="line">            <span class="keyword">for</span> (Event event : events) {</span><br><span class="line">                <span class="comment">// 获取数据源表资源概况</span></span><br><span class="line">                List&lt;Table&gt; tables = capture(event);</span><br><span class="line">                <span class="type">EventTaskBatch</span> <span class="variable">eventTaskBatch</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">EventTaskBatch</span>(event, tables.size());</span><br><span class="line">                <span class="keyword">for</span> (Table table : tables) {</span><br><span class="line">                    <span class="comment">// 与Table相关的任务技术监控。</span></span><br><span class="line">                    <span class="type">TableTaskBatch</span> <span class="variable">tableTaskBatch</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TableTaskBatch</span>(eventTaskBatch, table, <span class="number">2</span>);</span><br><span class="line">                    executorService.submit(<span class="keyword">new</span> <span class="title class_">TrustSourceRecordCount</span>(table, tableTaskBatch));</span><br><span class="line">                    executorService.submit(<span class="keyword">new</span> <span class="title class_">TrustSourceColumns</span>(table, tableTaskBatch));</span><br><span class="line">                }</span><br><span class="line">            }</span><br><span class="line">        } <span class="keyword">finally</span> {</span><br><span class="line">            executorService.shutdown();</span><br><span class="line">        }</span><br><span class="line"></span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> List&lt;Table&gt; <span class="title function_">capture</span><span class="params">(Event event)</span> {</span><br><span class="line">        List&lt;Table&gt; list = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; <span class="number">10</span>; i++) {</span><br><span class="line">            list.add(<span class="keyword">new</span> <span class="title class_">Table</span>(event.getEventName() + <span class="string">"-Table-"</span> + i, i * <span class="number">1000</span>));</span><br><span class="line">        }</span><br><span class="line">        <span class="keyword">return</span> list;</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<p>测试结果</p>
<figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">All tasks of Event-1-Table-3 is finished verify and update continue.</span><br><span class="line">All tasks of Event-1-Table-1 is finished verify and update continue.</span><br><span class="line">All tasks of Event-1-Table-4 is finished verify and update continue.</span><br><span class="line">All tasks of Event-1-Table-6 is finished verify and update continue.</span><br><span class="line">All tasks of Event-1-Table-5 is finished verify and update continue.</span><br><span class="line">All tasks of Event-1-Table-2 is finished verify and update continue.</span><br><span class="line">All tasks of Event-1-Table-0 is finished verify and update continue.</span><br><span class="line">All tasks of Event-1-Table-7 is finished verify and update continue.</span><br><span class="line">All tasks of Event-1-Table-8 is finished verify and update continue.</span><br><span class="line">All tasks of Event-2-Table-4 is finished verify and update continue.</span><br><span class="line">All tasks of Event-2-Table-2 is finished verify and update continue.</span><br><span class="line">All tasks of Event-2-Table-6 is finished verify and update continue.</span><br><span class="line">All tasks of Event-2-Table-3 is finished verify and update continue.</span><br><span class="line">All tasks of Event-2-Table-0 is finished verify and update continue.</span><br><span class="line">All tasks of Event-1-Table-9 is finished verify and update continue.</span><br><span class="line">All table of event Event-1 is finished verify and update continue.</span><br><span class="line"></span><br><span class="line">All tasks of Event-2-Table-1 is finished verify and update continue.</span><br><span class="line">All tasks of Event-2-Table-7 is finished verify and update continue.</span><br><span class="line">All tasks of Event-2-Table-9 is finished verify and update continue.</span><br><span class="line">All tasks of Event-2-Table-8 is finished verify and update continue.</span><br><span class="line">All tasks of Event-2-Table-5 is finished verify and update continue.</span><br><span class="line">All table of event Event-2 is finished verify and update continue.</span><br></pre></td></tr></tbody></table></figure>
<p>结果分析</p>
<ol>
<li>每个<strong>table</strong>的所有验证完成，执行<code>TableTaskBatch</code>的<code>done</code>中的后续操作</li>
<li>每个<strong>event</strong>的所有<strong>table</strong>的验证完成，执行<code>EventTaskBatch</code>的<code>done</code>中的后续操作</li>
</ol>
<h1>CyclicBarrier</h1>
<figure class="highlight tex"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">A synchronization aid that allows a set of threads to all wait for each other to reach a common barrier point. </span><br><span class="line">“允许一组线程互相等待到达一个共同的屏障点”的同步算法</span><br></pre></td></tr></tbody></table></figure>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CyclicBarrierExample1</span> {</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> {</span><br><span class="line">        <span class="type">CyclicBarrier</span> <span class="variable">barrier</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">CyclicBarrier</span>(<span class="number">4</span>, () -&gt; {</span><br><span class="line">            System.out.println(<span class="string">"All parties action finished"</span>);</span><br><span class="line">        });</span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">Thread</span>(<span class="keyword">new</span> <span class="title class_">ActionRunnable</span>(barrier), <span class="string">"T1"</span>).start();</span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">Thread</span>(<span class="keyword">new</span> <span class="title class_">ActionRunnable</span>(barrier), <span class="string">"T2"</span>).start();</span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">Thread</span>(<span class="keyword">new</span> <span class="title class_">ActionRunnable</span>(barrier), <span class="string">"T3"</span>).start();</span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">Thread</span>(<span class="keyword">new</span> <span class="title class_">ActionRunnable</span>(barrier), <span class="string">"T4"</span>).start();</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">ActionRunnable</span> <span class="keyword">implements</span> <span class="title class_">Runnable</span> {</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">final</span> CyclicBarrier barrier;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> <span class="title function_">ActionRunnable</span><span class="params">(CyclicBarrier barrier)</span> {</span><br><span class="line">            <span class="built_in">this</span>.barrier = barrier;</span><br><span class="line">        }</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> {</span><br><span class="line">            <span class="keyword">try</span> {</span><br><span class="line">                TaskFactory.spend(ThreadLocalRandom.current().nextInt(<span class="number">10</span>), TimeUnit.SECONDS, <span class="literal">false</span>, <span class="literal">true</span>);</span><br><span class="line">                barrier.await();</span><br><span class="line">                System.out.println(Thread.currentThread().getName() + <span class="string">"- await finished"</span>);</span><br><span class="line">            } <span class="keyword">catch</span> (InterruptedException e) {</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            } <span class="keyword">catch</span> (BrokenBarrierException e) {</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            }</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<p>测试结果：</p>
<figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">T1 finnish task（1651682474323）</span><br><span class="line">T4 finnish task（1651682475329）</span><br><span class="line">T3 finnish task（1651682480338）</span><br><span class="line">T2 finnish task（1651682482329）</span><br><span class="line">All parties action finished</span><br><span class="line">T2- await finished</span><br><span class="line">T1- await finished</span><br><span class="line">T4- await finished</span><br><span class="line">T3- await finished</span><br></pre></td></tr></tbody></table></figure>
<h2 id="示例2：使用reset-重置">示例2：使用reset()重置</h2>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> {</span><br><span class="line">    <span class="type">CyclicBarrier</span> <span class="variable">barrier</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">CyclicBarrier</span>(<span class="number">2</span>, () -&gt; {</span><br><span class="line">        System.out.println(<span class="string">"All parties action finished"</span>);</span><br><span class="line">    });</span><br><span class="line">    <span class="keyword">new</span> <span class="title class_">Thread</span>(<span class="keyword">new</span> <span class="title class_">ActionRunnable</span>(barrier), <span class="string">"T1"</span>).start();</span><br><span class="line">    <span class="keyword">new</span> <span class="title class_">Thread</span>(<span class="keyword">new</span> <span class="title class_">ActionRunnable</span>(barrier), <span class="string">"T2"</span>).start();</span><br><span class="line"></span><br><span class="line">    TaskFactory.spendSeconds(<span class="number">6</span>);</span><br><span class="line">    System.out.println(barrier.getNumberWaiting());</span><br><span class="line"></span><br><span class="line">    barrier.reset();</span><br><span class="line">    TaskFactory.spendSeconds(<span class="number">2</span>);</span><br><span class="line">    System.out.println(barrier.getNumberWaiting());</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<h2 id="CountDownLatch-和-CyclicBarrier-的区别">CountDownLatch 和 CyclicBarrier 的区别</h2>
<table>
<thead>
<tr>
<th>CountDownLatch</th>
<th>CyclicBarrier</th>
</tr>
</thead>
<tbody>
<tr>
<td>不可 reset</td>
<td>可以循环使用的</td>
</tr>
<tr>
<td>CountDownLatch工作线程之间互不关心</td>
<td>工作线程互相等待到达一个共同的屏障点</td>
</tr>
</tbody>
</table>
<h1>Exchanger</h1>
<ol>
<li>需要成对出现，否则单出来的一个线程同样会进入阻塞状态</li>
<li>如果成对的线程，其中一个无法到达“<code>交换点（Exchange Point）</code>”，另一个会一直等待，直到超时/一直阻塞。</li>
<li><strong>线程对之间交换的对象，是同一个地址的引用，会存在线程不安全的问题</strong>，可以考虑使用Atomic包装。</li>
</ol>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">一个同步点，在这个同步点上，线程之间可以组队并互相交换数据。每个线程会在进入交换方法时提供给伙伴线程匹配一些对象，并在返回时接收其伙伴的提供的对象。一个交换器可以被看作是一个同步队列的双向形式。交换器在遗传算法和流水线设计等应用中可能是有用的。</span><br></pre></td></tr></tbody></table></figure>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> java.util.concurrent.Exchanger;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.TimeUnit;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ExchangerText</span> {</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> {</span><br><span class="line">        <span class="keyword">final</span> Exchanger&lt;String&gt; exchanger = <span class="keyword">new</span> <span class="title class_">Exchanger</span>&lt;&gt;();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">Thread</span>(() -&gt; {</span><br><span class="line">            TaskFactory.spend(<span class="number">3</span>, TimeUnit.SECONDS, <span class="literal">true</span>);</span><br><span class="line">            <span class="keyword">try</span> {</span><br><span class="line">                <span class="comment">// 交换点，成对的线程同时达到这个交换点才会交换数据</span></span><br><span class="line">                <span class="type">String</span> <span class="variable">msg</span> <span class="operator">=</span> exchanger.exchange(<span class="string">"（message from "</span> + Thread.currentThread().getName() + <span class="string">".）"</span>);</span><br><span class="line">                System.out.println(Thread.currentThread().getName() + <span class="string">" got "</span> + msg + <span class="string">"["</span> + System.currentTimeMillis() + <span class="string">"]"</span>);</span><br><span class="line">            } <span class="keyword">catch</span> (InterruptedException e) {</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(e);</span><br><span class="line">            }</span><br><span class="line">        }, <span class="string">"T-A"</span>).start();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">Thread</span>(() -&gt; {</span><br><span class="line">            TaskFactory.spend(<span class="number">10</span>, TimeUnit.SECONDS, <span class="literal">true</span>);</span><br><span class="line">            <span class="keyword">try</span> {</span><br><span class="line">                <span class="comment">// 交换点，成对的线程同时达到这个交换点才会交换数据</span></span><br><span class="line">                <span class="type">String</span> <span class="variable">msg</span> <span class="operator">=</span> exchanger.exchange(<span class="string">"（message from "</span> + Thread.currentThread().getName() + <span class="string">".）"</span>);</span><br><span class="line">                System.out.println(Thread.currentThread().getName() + <span class="string">" got "</span> + msg + <span class="string">"["</span> + System.currentTimeMillis() + <span class="string">"]"</span>);</span><br><span class="line">            } <span class="keyword">catch</span> (InterruptedException e) {</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(e);</span><br><span class="line">            }</span><br><span class="line">        }, <span class="string">"T-B"</span>).start();</span><br><span class="line">    }</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line">输出结果：</span><br><span class="line">T-A finnish task（<span class="number">1651715733432</span>）</span><br><span class="line">T-B finnish task（<span class="number">1651715740432</span>）</span><br><span class="line">T-B got （message from T-A.）[<span class="number">1651715740432</span>]</span><br><span class="line">T-A got （message from T-B.）[<span class="number">1651715740432</span>]</span><br></pre></td></tr></tbody></table></figure>
<h1>Semaphore</h1>
<p>注册/回收许可证</p>
<ol>
<li>
<p><code>acquire()/release()</code> ： 相当于 acquire(1)/release(1)</p>
</li>
<li>
<p><code>acquire(int permits) /release(int permits)</code></p>
</li>
<li>
<p><code>acquireUninterruptibly()/acquireUninterruptibly(int permits) </code> 不可打断，不会抛出InterruptedException异常</p>
</li>
<li>
<p><code>drainPermits()</code> 获取所有的许可证</p>
</li>
<li>
<p><code>tryAcquire()/tryAcquire(int permits)</code>  不可打断，不会抛出InterruptedException异常，拿不到许可证，不会阻塞，放弃获取，继续执行</p>
</li>
<li>
<p><code>getQueueLength()</code> 返回等待获取的线程数的评估值</p>
</li>
<li>
<p><code>availablePermits()</code>返回此信号量中可用的当前许可数（评估值）</p>
</li>
</ol>
<ul>
<li>DEMO-1：可中断的许可证请求（会抛出InterruptedException）</li>
</ul>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SemaphoreExample</span> {</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> {</span><br><span class="line">        <span class="keyword">final</span> <span class="type">Semaphore</span> <span class="variable">semaphore</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Semaphore</span>(<span class="number">1</span>);</span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">Thread</span>(<span class="keyword">new</span> <span class="title class_">TaskRunnable</span>(semaphore), <span class="string">"T1"</span>).start();</span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">Thread</span>(<span class="keyword">new</span> <span class="title class_">TaskRunnable</span>(semaphore), <span class="string">"T2"</span>).start();</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">TaskRunnable</span> <span class="keyword">implements</span> <span class="title class_">Runnable</span> {</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">final</span> Semaphore semaphore;</span><br><span class="line">        TaskRunnable(Semaphore semaphore) {</span><br><span class="line">            <span class="built_in">this</span>.semaphore = semaphore;</span><br><span class="line">        }</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> {</span><br><span class="line">            <span class="keyword">try</span> {</span><br><span class="line">                System.out.println(Thread.currentThread().getName() +  <span class="string">" ask for permits"</span>);</span><br><span class="line">                <span class="comment">// 请求执行许可证</span></span><br><span class="line">                semaphore.acquire();</span><br><span class="line">                System.out.println(Thread.currentThread().getName() +  <span class="string">" got permits"</span>);</span><br><span class="line">                TaskFactory.spend(<span class="number">10</span>, TimeUnit.SECONDS, <span class="literal">true</span>);</span><br><span class="line">            } <span class="keyword">catch</span> (InterruptedException e) {</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(e);</span><br><span class="line">            } <span class="keyword">finally</span> {</span><br><span class="line">                <span class="comment">// 释放许可证</span></span><br><span class="line">                semaphore.release();</span><br><span class="line">            }</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line">}</span><br><span class="line"></span><br></pre></td></tr></tbody></table></figure>
<figure class="highlight tcl"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">T1 ask <span class="keyword">for</span> permits</span><br><span class="line">T1 got permits</span><br><span class="line">T2 ask <span class="keyword">for</span> permits</span><br><span class="line">T1 finnish task [<span class="number">1651772544344</span>]</span><br><span class="line">T2 got permits</span><br><span class="line">T2 finnish task [<span class="number">1651772549361</span>]</span><br></pre></td></tr></tbody></table></figure>
<ul>
<li>DEMO-2</li>
</ul>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SemaphoreExample2</span> {</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> {</span><br><span class="line">        <span class="keyword">final</span> <span class="type">Semaphore</span> <span class="variable">semaphore</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Semaphore</span>(<span class="number">1</span>);</span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">Thread</span>(<span class="keyword">new</span> <span class="title class_">TaskRunnable</span>(semaphore), <span class="string">"T1"</span>).start();</span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">Thread</span>(<span class="keyword">new</span> <span class="title class_">TaskRunnable</span>(semaphore), <span class="string">"T2"</span>).start();</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">TaskRunnable</span> <span class="keyword">implements</span> <span class="title class_">Runnable</span> {</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">final</span> Semaphore semaphore;</span><br><span class="line">        TaskRunnable(Semaphore semaphore) {</span><br><span class="line">            <span class="built_in">this</span>.semaphore = semaphore;</span><br><span class="line">        }</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> {</span><br><span class="line">            <span class="keyword">try</span> {</span><br><span class="line">                <span class="comment">// 请求执行许可证</span></span><br><span class="line">                System.out.println(Thread.currentThread().getName() +  <span class="string">" ask for permits"</span>);</span><br><span class="line">                <span class="type">boolean</span> <span class="variable">tryResult</span> <span class="operator">=</span> semaphore.tryAcquire();</span><br><span class="line">                System.out.println(Thread.currentThread().getName() +  (tryResult ? <span class="string">" got permits"</span> : <span class="string">" ignore permits and continue"</span>));</span><br><span class="line">                TaskFactory.spend(<span class="number">2</span>, TimeUnit.SECONDS, <span class="literal">true</span>);</span><br><span class="line">            } <span class="keyword">finally</span> {</span><br><span class="line">                <span class="comment">// 释放许可证</span></span><br><span class="line">                semaphore.release();</span><br><span class="line">            }</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">T2 ask for permits</span><br><span class="line">T1 ask for permits</span><br><span class="line">T2 got permits</span><br><span class="line">T1 ignore permits and continue</span><br><span class="line">T1 finnish task [1651774206609]</span><br><span class="line">T2 finnish task [1651774206609]</span><br></pre></td></tr></tbody></table></figure>
<h1>Lock包</h1>
<blockquote>
<blockquote>
<p>java中常见锁分类</p>
</blockquote>
<ul>
<li>
<p>公平锁和非公平锁</p>
<p>根据多线程竞争时是否排队依次获取锁，synchronized和ReentrantLock实现默认都是非公平锁，非公平锁可以提高效率，避免线程唤醒带来的空档期</p>
</li>
<li>
<p>可重入锁和不可重复锁</p>
<p>根据同一个线程是否能重复获取同一把锁</p>
</li>
<li>
<p>共享锁和独占锁(排他锁)</p>
<p>根据多线程是否能共享一把锁，典型的比如ReentrantReadWriteLock，其中读锁是共享锁，写锁是排他锁</p>
</li>
<li>
<p>可中断锁和不可中断锁</p>
<p>根据正在尝试获取锁的线程是否可中断</p>
</li>
<li>
<p>悲观锁和乐观锁</p>
<p>根据线程是否锁住共享资源</p>
</li>
<li>
<p>自旋锁和阻塞锁</p>
<p>根据线程等待的过程</p>
</li>
</ul>
</blockquote>
<h2 id="ReentrantLock">ReentrantLock</h2>
<p>ReentrantLock特点：作用同Synchronized，但是拥有一些独有的特性</p>
<ul>
<li>
<p>可重入：ReentrantLock同步块对同一条线程来说是可重入的，不会出现自己把自己锁死的问题</p>
</li>
<li>
<p>阻塞同步：在成功获取锁的线程执行完之前，会阻塞后面其它线程进入</p>
</li>
<li>
<p><font color="red">等待可中断</font>：持有锁的线程长期不释放锁时，正在等待获取锁的线程可以选择放弃等待，改为处理其它事情，主要是tryLock(time)、lockInterruptibly()方法响应支持</p>
</li>
<li>
<p><font color="red">实现公平锁</font>：通过new ReentrantLock(true)可以实现多线程在等待同一个锁时，严格按照申请锁的顺序来依次获取锁</p>
</li>
<li>
<p><font color="red">锁可以绑定多个条件</font>：一个ReentrantLock对象锁可以同时绑定多个Condition对象</p>
</li>
</ul>
<p>ReentrantLock核心方法解析</p>
<ul>
<li>lock()：尝试获取锁，如果锁已被其它线程获取则等待，lock()方法不能被中断，在死锁情况下会无限等待</li>
<li>tryLock()：尝试获取锁，如果锁已被其它线程获取则放弃，立即返回boolean类型标识位</li>
<li>tryLock(long var1, TimeUnit var3)：尝试获取锁，如果锁已被其它线程持有则等待var1时间，超时再放弃</li>
<li>lockInterruptibly()：相当于把tryLock(long var1, TimeUnit var3)的时间设置成了无限长，但是在等待获取锁的过程中，线程可以被中断</li>
<li>unlock()：释放锁</li>
</ul>
<p>ReentrantLock注意事项</p>
<ul>
<li>ReentrantLock在异常发生时候不会像synchronized锁一样自动释放锁，所以在使用ReentrantLock时候一定要配合try finally使用来进行释放锁（lock.unlock()）</li>
<li><font color="red">tryLock()方法自带插队属性</font>，也就是说即使设置了new ReentrantLock(true)，使用tryLock()方法获取锁仍然是不公平的</li>
</ul>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ReentrantLockTest</span> {</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">ReentrantLock</span> <span class="variable">lock</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ReentrantLock</span>();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> {</span><br><span class="line">        IntStream.rangeClosed(<span class="number">1</span>, <span class="number">2</span>).forEach(i -&gt; <span class="keyword">new</span> <span class="title class_">Thread</span>(() -&gt; needLock()).start());</span><br><span class="line">        System.out.println(<span class="string">"-----------------------------------"</span>);</span><br><span class="line">        TaskFactory.spend(<span class="number">10</span>, TimeUnit.SECONDS);</span><br><span class="line">        System.out.println(<span class="string">"-----------------------------------"</span>);</span><br><span class="line">        IntStream.rangeClosed(<span class="number">1</span>, <span class="number">2</span>).forEach(i -&gt; <span class="keyword">new</span> <span class="title class_">Thread</span>(() -&gt; tryLock()).start());</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">needLock</span><span class="params">()</span> {</span><br><span class="line">        <span class="comment">// 不允许打断</span></span><br><span class="line">        lock.lock();</span><br><span class="line">        <span class="keyword">try</span> {</span><br><span class="line">            TaskFactory.spend(<span class="number">2</span>, TimeUnit.SECONDS, <span class="literal">true</span>);</span><br><span class="line">            System.out.println(Thread.currentThread().getName() + <span class="string">" - 取得锁 ："</span> + lock.isHeldByCurrentThread());</span><br><span class="line">        } <span class="keyword">finally</span> {</span><br><span class="line">            lock.unlock();</span><br><span class="line">            System.out.println(Thread.currentThread().getName() + <span class="string">" - 释放锁资源："</span> + !lock.isLocked());</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">tryLock</span><span class="params">()</span> {</span><br><span class="line">        <span class="keyword">if</span> (lock.tryLock()) {</span><br><span class="line">            <span class="comment">// got the lock</span></span><br><span class="line">            <span class="keyword">try</span> {</span><br><span class="line">                TaskFactory.spend(<span class="number">5</span>, TimeUnit.SECONDS, <span class="literal">true</span>);</span><br><span class="line">                System.out.println(Thread.currentThread().getName() + <span class="string">" - 取得锁 ："</span> + lock.isHeldByCurrentThread());</span><br><span class="line">            } <span class="keyword">finally</span> {</span><br><span class="line">                lock.unlock();</span><br><span class="line">                System.out.println(Thread.currentThread().getName() + <span class="string">" - 释放锁资源："</span> + !lock.isLocked());</span><br><span class="line">            }</span><br><span class="line">        } <span class="keyword">else</span> {</span><br><span class="line">            <span class="comment">// do other things</span></span><br><span class="line">            System.out.println(Thread.currentThread().getName() + <span class="string">" - 未取得锁."</span>);</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">-----------------------------------</span><br><span class="line">Thread-0 finnish task [1652021430165]</span><br><span class="line">Thread-0 - 取得锁 ：true</span><br><span class="line">Thread-0 - 释放锁资源：true</span><br><span class="line">Thread-1 finnish task [1652021432181]</span><br><span class="line">Thread-1 - 取得锁 ：true</span><br><span class="line">Thread-1 - 释放锁资源：true</span><br><span class="line">-----------------------------------</span><br><span class="line">Thread-3 - 未取得锁.</span><br><span class="line">Thread-2 finnish task [1652021443166]</span><br><span class="line">Thread-2 - 取得锁 ：true</span><br><span class="line">Thread-2 - 释放锁资源：true</span><br><span class="line"></span><br><span class="line">Process finished with exit code 0</span><br></pre></td></tr></tbody></table></figure>
<h2 id="ReadWriteLock">ReadWriteLock</h2>
<p>需要解决同时读的排他性</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ReentrantReadWriteLockExample</span> {</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">ReentrantReadWriteLock</span> <span class="variable">lock</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ReentrantReadWriteLock</span>();</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> ReentrantReadWriteLock.<span class="type">ReadLock</span> <span class="variable">readLock</span> <span class="operator">=</span> lock.readLock();</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> ReentrantReadWriteLock.<span class="type">WriteLock</span> <span class="variable">writeLock</span> <span class="operator">=</span> lock.writeLock();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> {</span><br><span class="line">        <span class="comment">// new Thread(ReadWriteLockExample::doWriteAction, "A1").start();</span></span><br><span class="line">        <span class="comment">// 同时读，不会排他</span></span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">Thread</span>(ReentrantReadWriteLockExample::readFiles, <span class="string">"A1"</span>).start();</span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">Thread</span>(ReentrantReadWriteLockExample::readFiles, <span class="string">"A2"</span>).start();</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">readFiles</span><span class="params">()</span> {</span><br><span class="line">        <span class="keyword">try</span> {</span><br><span class="line">            readLock.lock();</span><br><span class="line">            TaskFactory.spend(<span class="number">5</span>, TimeUnit.SECONDS, <span class="literal">true</span>);</span><br><span class="line">            System.out.println(Thread.currentThread().getName() + <span class="string">" 开始读操作"</span>);</span><br><span class="line">            TaskFactory.spend(<span class="number">3</span>, TimeUnit.SECONDS);</span><br><span class="line">        } <span class="keyword">finally</span> {</span><br><span class="line">            readLock.unlock();</span><br><span class="line">            System.out.println(Thread.currentThread().getName() + <span class="string">" 完成读操作"</span>);</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">writeFiles</span><span class="params">()</span> {</span><br><span class="line">        <span class="keyword">try</span> {</span><br><span class="line">            writeLock.lock();</span><br><span class="line">            System.out.println(Thread.currentThread().getName() + <span class="string">" 开始写操作"</span>);</span><br><span class="line">            TaskFactory.spend(<span class="number">3</span>, TimeUnit.SECONDS);</span><br><span class="line">        } <span class="keyword">finally</span> {</span><br><span class="line">            writeLock.unlock();</span><br><span class="line">            System.out.println(Thread.currentThread().getName() + <span class="string">" 完成写操作"</span>);</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<h2 id="Condition">Condition</h2>
<p>作用：monitor对象的wait、notify</p>
<p>使用：condition.await()/ condition.signal()，需要配合lock使用</p>
<h3 id="当个等待锁队列">当个等待锁队列</h3>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> hots.utils.condition;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.Optional;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.TimeUnit;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.locks.Condition;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.locks.ReentrantLock;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span>: DH</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span>: 2022/3/5</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@desc</span>:</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ConditionExample</span> {</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">static</span> <span class="type">ReentrantLock</span> <span class="variable">sourceLock</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ReentrantLock</span>();</span><br><span class="line">    <span class="comment">//  condition 是由lock创建</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">static</span> <span class="type">Condition</span> <span class="variable">condition</span> <span class="operator">=</span> sourceLock.newCondition();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="type">int</span> <span class="variable">data</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="type">boolean</span> <span class="variable">isUsed</span> <span class="operator">=</span> <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> {</span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">Thread</span>(() -&gt; {</span><br><span class="line">            <span class="keyword">while</span> (<span class="literal">true</span>) {</span><br><span class="line">                buildData();</span><br><span class="line">            }</span><br><span class="line">        }).start();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">Thread</span>(() -&gt; {</span><br><span class="line">            <span class="keyword">while</span> (<span class="literal">true</span>) {</span><br><span class="line">                useData();</span><br><span class="line">            }</span><br><span class="line">        }).start();</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">buildData</span><span class="params">()</span> {</span><br><span class="line">        <span class="keyword">try</span> {</span><br><span class="line">            sourceLock.lock(); <span class="comment">// synchronized 关键词 (monitor enter)</span></span><br><span class="line">            <span class="keyword">while</span> (!isUsed) {</span><br><span class="line">                condition.await();　<span class="comment">// monitor await</span></span><br><span class="line">            }</span><br><span class="line"></span><br><span class="line">            TimeUnit.SECONDS.sleep(<span class="number">1</span>);	</span><br><span class="line">            data++;</span><br><span class="line">            Optional.of(<span class="string">"P："</span> + data).ifPresent(System.out::println);</span><br><span class="line">            isUsed = <span class="literal">false</span>;</span><br><span class="line">            condition.signal(); <span class="comment">// monitor notify</span></span><br><span class="line">        } <span class="keyword">catch</span> (InterruptedException e) {</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        } <span class="keyword">finally</span> {</span><br><span class="line">            sourceLock.unlock(); <span class="comment">// monitor end</span></span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">useData</span><span class="params">()</span> {</span><br><span class="line">        <span class="keyword">try</span> {</span><br><span class="line">            sourceLock.lock();</span><br><span class="line">            <span class="keyword">while</span> (isUsed) {</span><br><span class="line">                condition.await();</span><br><span class="line">            }</span><br><span class="line">            TimeUnit.SECONDS.sleep(<span class="number">1</span>);</span><br><span class="line">            Optional.of(<span class="string">"C："</span> + data).ifPresent(System.out::println);</span><br><span class="line">            isUsed = <span class="literal">true</span>;</span><br><span class="line">            condition.signal();</span><br><span class="line">        } <span class="keyword">catch</span> (InterruptedException e) {</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        } <span class="keyword">finally</span> {</span><br><span class="line">            sourceLock.unlock();</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<h3 id="多个等待锁队列">多个等待锁队列</h3>
<figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br></pre></td><td class="code"><pre><span class="line">package practice.util.lock.condition;</span><br><span class="line"></span><br><span class="line">import practice.common.TaskFactory;</span><br><span class="line"></span><br><span class="line">import java.util.LinkedList;</span><br><span class="line">import java.util.concurrent.TimeUnit;</span><br><span class="line">import java.util.concurrent.locks.Condition;</span><br><span class="line">import java.util.concurrent.locks.Lock;</span><br><span class="line">import java.util.concurrent.locks.ReentrantLock;</span><br><span class="line">import java.util.stream.IntStream;</span><br><span class="line"></span><br><span class="line">/**</span><br><span class="line"> * 多线程生产、多线程消费</span><br><span class="line"> *</span><br><span class="line"> * @author: DH</span><br><span class="line"> * @date: 2022/6/12</span><br><span class="line"> * @desc:</span><br><span class="line"> */</span><br><span class="line">public class ConditionExample3 {</span><br><span class="line"></span><br><span class="line">    private static Lock lock = new ReentrantLock();</span><br><span class="line"></span><br><span class="line">    private static final Condition PRODUCE_COND = lock.newCondition();</span><br><span class="line"></span><br><span class="line">    private static final Condition CONSUMER_COND = lock.newCondition();</span><br><span class="line"></span><br><span class="line">    private static final LinkedList&lt;Long&gt; TIMESTAMP_POOL = new LinkedList&lt;&gt;();</span><br><span class="line"></span><br><span class="line">    private static final int MAX_SIZE = 100;</span><br><span class="line"></span><br><span class="line">    public static void main(String[] args) {</span><br><span class="line">        // 包装多名生产者</span><br><span class="line">        IntStream.rangeClosed(1, 5).boxed().forEach(ConditionExample3::doBuildData);</span><br><span class="line">        // 包装多名消费者</span><br><span class="line">        IntStream.rangeClosed(1, 8).boxed().forEach(ConditionExample3::doConsumeData);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    private static void doBuildData(int index) {</span><br><span class="line">        // 生产者不间断生产数据</span><br><span class="line">        new Thread(() -&gt; {</span><br><span class="line">            while (true) {</span><br><span class="line">                buildData();</span><br><span class="line">                TaskFactory.spend(1, TimeUnit.SECONDS);</span><br><span class="line">            }</span><br><span class="line">        }, "P(" + index + ")").start();</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    private static void doConsumeData(int index) {</span><br><span class="line">        // 消费者不间断消费数据</span><br><span class="line">        new Thread(() -&gt; {</span><br><span class="line">            while (true) {</span><br><span class="line">                useData();</span><br><span class="line">                TaskFactory.spend(1, TimeUnit.SECONDS);</span><br><span class="line">            }</span><br><span class="line">        }, "C(" + index + ")").start();</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    private static void buildData() {</span><br><span class="line">        try {</span><br><span class="line">            lock.lock();</span><br><span class="line">            while (TIMESTAMP_POOL.size() &gt; MAX_SIZE) {</span><br><span class="line">                PRODUCE_COND.await();</span><br><span class="line">            }</span><br><span class="line">            TaskFactory.spend(1, TimeUnit.SECONDS);</span><br><span class="line">            long value = System.currentTimeMillis();</span><br><span class="line">            TIMESTAMP_POOL.addLast(value);</span><br><span class="line">            System.out.println(Thread.currentThread() + "-&gt;" + value);</span><br><span class="line">            CONSUMER_COND.signalAll();</span><br><span class="line">        } catch (InterruptedException e) {</span><br><span class="line">            throw new RuntimeException(e);</span><br><span class="line">        } finally {</span><br><span class="line">            lock.unlock();</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    private static void useData() {</span><br><span class="line">        try {</span><br><span class="line">            lock.lock();</span><br><span class="line">            while (TIMESTAMP_POOL.isEmpty()) {</span><br><span class="line">                CONSUMER_COND.await();</span><br><span class="line">            }</span><br><span class="line">            TaskFactory.spend(1, TimeUnit.SECONDS);</span><br><span class="line">            long value = TIMESTAMP_POOL.removeFirst();</span><br><span class="line">            System.out.println(Thread.currentThread() + "-&gt;" + value);</span><br><span class="line">            PRODUCE_COND.signalAll();</span><br><span class="line">        } catch (InterruptedException e) {</span><br><span class="line">            throw new RuntimeException(e);</span><br><span class="line">        } finally {</span><br><span class="line">            lock.unlock();</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<h2 id="StampedLock">StampedLock</h2>
<h3 id="产生背景">产生背景</h3>
<p>ReentrantReadWriteLock使得多个读线程同时持有读锁（只要写锁未被占用），而写锁是独占的。</p>
<p>但是，读写锁如果使用不当，很容易产生<font color="red"><strong>“写饥饿”</strong></font>问题</p>
<p>比如在读线程非常多，写线程很少的情况下，很容易导致写线程“饥饿”，虽然使用“公平”策略可以一定程度上缓解这个问题，但是“公平”策略是以牺牲系统吞吐量为代价的。</p>
<h3 id="StampedLock的主要特点">StampedLock的主要特点</h3>
<ol>
<li>
<p>所有获取锁的方法，都返回一个邮戳（Stamp），Stamp为0表示获取失败，其余都表示成功；</p>
</li>
<li>
<p>所有释放锁的方法，都需要一个邮戳（Stamp），这个Stamp必须是和成功获取锁时得到的Stamp一致；</p>
</li>
<li>
<p>StampedLock是不可重入的；（如果一个线程已经持有了写锁，再去获取写锁的话就会造成死锁）</p>
</li>
<li>
<p>StampedLock有三种访问模式：</p>
<p>① Reading（读模式）：功能和ReentrantReadWriteLock的读锁类似</p>
<p>② Writing（写模式）：功能和ReentrantReadWriteLock的写锁类似</p>
<p>③ Optimistic reading（乐观读模式）：这是一种优化的读模式。</p>
<p>​	我们知道，在ReentrantReadWriteLock中，当读锁被使用时，如果有线程尝试获取写锁，该写线程会阻塞。</p>
<p>​	但是，在Optimistic reading中，即使读线程获取到了读锁，写线程尝试获取写锁也不会阻塞，这相当于对读模式的优化，但是可能会导致数据不一致的问题。</p>
<p>​	所以，<strong>当使用Optimistic reading获取到读锁时，必须对获取结果进行校验</strong>。</p>
</li>
<li>
<p>StampedLock支持读锁和写锁的相互转换</p>
<p>我们知道RRW中，当线程获取到写锁后，可以降级为读锁，但是读锁是不能直接升级为写锁的。<br>
StampedLock提供了读锁和写锁相互转换的功能，使得该类支持更多的应用场景。</p>
</li>
<li>
<p>无论写锁还是读锁，都不支持Conditon等待</p>
</li>
</ol>
<h3 id="悲观读（读锁和写锁互斥）">悲观读（读锁和写锁互斥）</h3>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> practice.util.lock.stamp;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> practice.common.TaskFactory;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.LinkedList;</span><br><span class="line"><span class="keyword">import</span> java.util.Optional;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.ExecutorService;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.Executors;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.TimeUnit;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.locks.StampedLock;</span><br><span class="line"><span class="keyword">import</span> java.util.stream.Collectors;</span><br><span class="line"><span class="keyword">import</span> java.util.stream.IntStream;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span>: DH</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">StampedLockTest</span> {</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">StampedLock</span> <span class="variable">STAMPED_LOCK</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">StampedLock</span>();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> LinkedList&lt;Long&gt; DATA = <span class="keyword">new</span> <span class="title class_">LinkedList</span>&lt;&gt;();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> {</span><br><span class="line">        <span class="keyword">final</span> <span class="type">ExecutorService</span> <span class="variable">executorService</span> <span class="operator">=</span> Executors.newFixedThreadPool(<span class="number">10</span>);</span><br><span class="line"></span><br><span class="line">        IntStream.rangeClosed(<span class="number">1</span>, <span class="number">10</span>).forEach(index -&gt; {</span><br><span class="line">            <span class="keyword">if</span> (index % <span class="number">9</span> == <span class="number">0</span>) {</span><br><span class="line">                <span class="comment">// 写数据</span></span><br><span class="line">                executorService.submit(() -&gt; {</span><br><span class="line">                    <span class="keyword">while</span> (<span class="literal">true</span>) {</span><br><span class="line">                        write();</span><br><span class="line">                    }</span><br><span class="line">                });</span><br><span class="line">            } <span class="keyword">else</span> {</span><br><span class="line">                <span class="comment">// 读数据</span></span><br><span class="line">                executorService.submit(() -&gt; {</span><br><span class="line">                    <span class="keyword">while</span> (<span class="literal">true</span>) {</span><br><span class="line">                        read();</span><br><span class="line">                    }</span><br><span class="line">                });</span><br><span class="line">            }</span><br><span class="line">        });</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">read</span><span class="params">()</span> {</span><br><span class="line">        <span class="type">long</span> <span class="variable">stamp</span> <span class="operator">=</span> -<span class="number">1</span>;</span><br><span class="line">        <span class="keyword">try</span> {</span><br><span class="line">            <span class="comment">// 获取锁，并获取时间戳</span></span><br><span class="line">            stamp = STAMPED_LOCK.readLock();</span><br><span class="line">            Optional.of(DATA.stream().map(String::valueOf).collect(Collectors.joining(<span class="string">"、"</span>, <span class="string">"R-"</span>, <span class="string">""</span>)))</span><br><span class="line">                    .ifPresent(System.out::println);</span><br><span class="line"></span><br><span class="line">            TaskFactory.spend(<span class="number">1</span>, TimeUnit.SECONDS);</span><br><span class="line">        } <span class="keyword">finally</span> {</span><br><span class="line">            <span class="comment">// 按照时间戳释放锁</span></span><br><span class="line">            STAMPED_LOCK.unlockRead(stamp);</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">write</span><span class="params">()</span> {</span><br><span class="line">        <span class="type">long</span> <span class="variable">stamp</span> <span class="operator">=</span> -<span class="number">1</span>;</span><br><span class="line">        <span class="keyword">try</span> {</span><br><span class="line">            stamp = STAMPED_LOCK.writeLock();</span><br><span class="line">            <span class="type">long</span> <span class="variable">value</span> <span class="operator">=</span> System.currentTimeMillis();</span><br><span class="line">            DATA.addLast(value);</span><br><span class="line">            System.out.println(<span class="string">"C:"</span> + value);</span><br><span class="line">        } <span class="keyword">finally</span> {</span><br><span class="line">            STAMPED_LOCK.unlockWrite(stamp);</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<h3 id="乐观读：Optimistic-reading">乐观读：Optimistic reading</h3>
<p>“Optimistic reading”的使用必须遵循以下模式：</p>
<figure class="highlight csharp"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">long</span> stamp = <span class="keyword">lock</span>.tryOptimisticRead();  <span class="comment">// 非阻塞获取版本信息</span></span><br><span class="line">copyVaraibale2ThreadMemory();           <span class="comment">// 拷贝变量到线程本地堆栈</span></span><br><span class="line"><span class="keyword">if</span>(!<span class="keyword">lock</span>.validate(stamp)){              <span class="comment">// 校验在拷贝过程中有没有排他锁抢占，如果有则悲观读</span></span><br><span class="line">    <span class="built_in">long</span> stamp = <span class="keyword">lock</span>.readLock();       <span class="comment">// 获取读锁</span></span><br><span class="line">    <span class="keyword">try</span> {</span><br><span class="line">        copyVaraibale2ThreadMemory();   <span class="comment">// 拷贝变量到线程本地堆栈</span></span><br><span class="line">     } <span class="keyword">finally</span> {</span><br><span class="line">       <span class="keyword">lock</span>.unlock(stamp);              <span class="comment">// 释放悲观锁</span></span><br><span class="line">    }</span><br><span class="line">}</span><br><span class="line">useThreadMemoryVarables();              <span class="comment">// 使用线程本地堆栈里的数据进行操作</span></span><br></pre></td></tr></tbody></table></figure>
<p>以下为乐观读DEMO：</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> practice.util.lock.stamp;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> practice.common.TaskFactory;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.ArrayList;</span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"><span class="keyword">import</span> java.util.Optional;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.ExecutorService;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.Executors;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.TimeUnit;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.locks.StampedLock;</span><br><span class="line"><span class="keyword">import</span> java.util.stream.Collectors;</span><br><span class="line"><span class="keyword">import</span> java.util.stream.IntStream;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 乐观读</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span>: DH</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span>: 2022/6/12</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@desc</span>:</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">StampedLockOptimisticTest</span> {</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">StampedLock</span> <span class="variable">stampedLock</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">StampedLock</span>();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> List&lt;Long&gt; DATA = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> {</span><br><span class="line">        <span class="keyword">final</span> <span class="type">ExecutorService</span> <span class="variable">executorService</span> <span class="operator">=</span> Executors.newFixedThreadPool(<span class="number">10</span>);</span><br><span class="line">        IntStream.rangeClosed(<span class="number">1</span>, <span class="number">10</span>).forEach(index -&gt; {</span><br><span class="line">            <span class="keyword">if</span> (index % <span class="number">8</span> == <span class="number">0</span>) {</span><br><span class="line">                <span class="comment">// 写数据</span></span><br><span class="line">                executorService.submit(() -&gt; {</span><br><span class="line">                    <span class="keyword">while</span> (<span class="literal">true</span>) {</span><br><span class="line">                        write();</span><br><span class="line">                    }</span><br><span class="line">                });</span><br><span class="line">            } <span class="keyword">else</span> {</span><br><span class="line">                <span class="comment">// 读数据</span></span><br><span class="line">                executorService.submit(() -&gt; {</span><br><span class="line">                    <span class="keyword">while</span> (<span class="literal">true</span>) {</span><br><span class="line">                        optimisticRead();</span><br><span class="line">                    }</span><br><span class="line">                });</span><br><span class="line">            }</span><br><span class="line">        });</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">optimisticRead</span><span class="params">()</span> {</span><br><span class="line">        <span class="comment">// 获取锁，并获取时间戳</span></span><br><span class="line">        <span class="type">long</span> <span class="variable">stamp</span> <span class="operator">=</span> stampedLock.tryOptimisticRead();</span><br><span class="line">        <span class="comment">// 乐观读，必须先拷贝一份数据到在方法中</span></span><br><span class="line">        List&lt;Long&gt; local = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">        local.addAll(DATA);</span><br><span class="line">        <span class="comment">// 检查在拷贝过程中有没有排他锁抢占，如果有则悲观读</span></span><br><span class="line">        <span class="keyword">if</span> (!stampedLock.validate(stamp)) {</span><br><span class="line">            stamp = stampedLock.readLock();</span><br><span class="line">            <span class="keyword">try</span> {</span><br><span class="line">                System.out.println(<span class="string">"&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt; 重新读取数据到本地 &gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;"</span>);</span><br><span class="line">                local.clear();</span><br><span class="line">                local.addAll(DATA);</span><br><span class="line">            } <span class="keyword">finally</span> {</span><br><span class="line">                stampedLock.unlockRead(stamp);</span><br><span class="line">            }</span><br><span class="line">        }</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 使用数据</span></span><br><span class="line">        Optional.of(local.stream().map(String::valueOf).collect(Collectors.joining(<span class="string">"、"</span>, <span class="string">"R-"</span>, <span class="string">""</span>)))</span><br><span class="line">                .ifPresent(System.out::println);</span><br><span class="line">        TaskFactory.spend(<span class="number">1</span>, TimeUnit.SECONDS);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">write</span><span class="params">()</span> {</span><br><span class="line">        <span class="type">long</span> <span class="variable">stamp</span> <span class="operator">=</span> stampedLock.writeLock();</span><br><span class="line">        <span class="keyword">try</span> {</span><br><span class="line">            <span class="type">long</span> <span class="variable">value</span> <span class="operator">=</span> System.currentTimeMillis();</span><br><span class="line">            System.out.println(<span class="string">"W-"</span> + value);</span><br><span class="line">            System.out.println();</span><br><span class="line">            DATA.add(value);</span><br><span class="line">        } <span class="keyword">finally</span> {</span><br><span class="line">            stampedLock.unlockWrite(stamp);</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<h1>Fork/Join框架</h1>
<ol>
<li>
<p>Fork/Join任务的原理：判断一个任务是否足够小，如果是，直接计算，否则，就分拆成几个小任务分别计算。这个过程可以反复“裂变”成一系列小任务。</p>
</li>
<li>
<p>基于工作窃取算法（work-stealing）</p>
</li>
<li>
<p>Fork/Join机制可能只能在单个jvm上运行</p>
</li>
</ol>
<h2 id="RecursiveTask：有返回">RecursiveTask：有返回</h2>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">class</span> <span class="title class_">RecursiveTask</span>&lt;V&gt; <span class="keyword">extends</span> <span class="title class_">ForkJoinTask</span>&lt;V&gt;</span><br></pre></td></tr></tbody></table></figure>
<p>实验demo : 1~10000 求和</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> java.util.concurrent.ExecutionException;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.ForkJoinPool;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.ForkJoinTask;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.RecursiveTask;</span><br><span class="line"><span class="keyword">import</span> java.util.stream.IntStream;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span>: DH</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span>: 2022/6/20</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@desc</span>:</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">RecursiveTaskDemo</span> {</span><br><span class="line">    <span class="comment">// 可执行容量</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">int</span> <span class="variable">TASK_CAPACITY</span> <span class="operator">=</span> <span class="number">3</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> {</span><br><span class="line">        <span class="keyword">final</span> <span class="type">ForkJoinPool</span> <span class="variable">forkJoinPool</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ForkJoinPool</span>();</span><br><span class="line">        ForkJoinTask&lt;Integer&gt; future = forkJoinPool.submit(<span class="keyword">new</span> <span class="title class_">CalculateRecursiveTask</span>(<span class="number">1</span>, <span class="number">100</span>));</span><br><span class="line">        System.out.println(<span class="string">"================== other tasks ===================="</span>);</span><br><span class="line">        <span class="keyword">try</span> {</span><br><span class="line">            System.out.println(<span class="string">"================== action results "</span> + future.get());</span><br><span class="line">        } <span class="keyword">catch</span> (InterruptedException e) {</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        } <span class="keyword">catch</span> (ExecutionException e) {</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        } <span class="keyword">finally</span> {</span><br><span class="line">            forkJoinPool.shutdown();</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 计算</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">CalculateRecursiveTask</span> <span class="keyword">extends</span> <span class="title class_">RecursiveTask</span>&lt;Integer&gt; {</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">final</span> <span class="type">int</span> start;</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">final</span> <span class="type">int</span> end;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> <span class="title function_">CalculateRecursiveTask</span><span class="params">(<span class="type">int</span> start, <span class="type">int</span> end)</span> {</span><br><span class="line">            <span class="keyword">if</span> (end &gt;= start) {</span><br><span class="line">                <span class="built_in">this</span>.start = start;</span><br><span class="line">                <span class="built_in">this</span>.end = end;</span><br><span class="line">            } <span class="keyword">else</span> {</span><br><span class="line">                <span class="built_in">this</span>.end = start;</span><br><span class="line">                <span class="built_in">this</span>.start = end;</span><br><span class="line">            }</span><br><span class="line">        }</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">protected</span> Integer <span class="title function_">compute</span><span class="params">()</span> {</span><br><span class="line">            <span class="keyword">if</span> (end - start &lt;= TASK_CAPACITY) {</span><br><span class="line">                <span class="comment">// 执行任务</span></span><br><span class="line">                <span class="keyword">return</span> IntStream.rangeClosed(start, end).sum();</span><br><span class="line">            } <span class="keyword">else</span> {</span><br><span class="line">                <span class="comment">// 拆分任务</span></span><br><span class="line">                <span class="type">int</span> <span class="variable">middle</span> <span class="operator">=</span> (end + start) / <span class="number">2</span>;</span><br><span class="line">                <span class="type">CalculateRecursiveTask</span> <span class="variable">taskLeft</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">CalculateRecursiveTask</span>(start, middle);</span><br><span class="line">                <span class="type">CalculateRecursiveTask</span> <span class="variable">taskRight</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">CalculateRecursiveTask</span>(middle + <span class="number">1</span>, end);</span><br><span class="line">                <span class="comment">// 加入ForkJoinPool.WorkQueue </span></span><br><span class="line">                taskLeft.fork();</span><br><span class="line">                <span class="comment">// 加入ForkJoinPool.WorkQueue </span></span><br><span class="line">                taskRight.fork();</span><br><span class="line"></span><br><span class="line">                <span class="comment">// 等待任务执行完成并返回</span></span><br><span class="line">                <span class="keyword">return</span> taskLeft.join() + taskRight.join();</span><br><span class="line">            }</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line">}</span><br><span class="line"></span><br></pre></td></tr></tbody></table></figure>
<h2 id="RecursiveAction：无返回">RecursiveAction：无返回</h2>
<p>如果有返回值，需要构造一个共同访问区域。</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> java.util.Optional;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.ForkJoinPool;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.RecursiveAction;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.TimeUnit;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.atomic.AtomicInteger;</span><br><span class="line"><span class="keyword">import</span> java.util.stream.IntStream;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span>: DH</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span>: 2022/6/20</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@desc</span>:</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">RecursiveActionDemo</span> {</span><br><span class="line">    <span class="comment">//  线程共享</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">AtomicInteger</span> <span class="variable">SUM_RESULT</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">AtomicInteger</span>();</span><br><span class="line">    <span class="comment">// 可执行容量</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">int</span> <span class="variable">TASK_CAPACITY</span> <span class="operator">=</span> <span class="number">3</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> {</span><br><span class="line">        <span class="keyword">final</span> <span class="type">ForkJoinPool</span> <span class="variable">forkJoinPool</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ForkJoinPool</span>();</span><br><span class="line">        <span class="keyword">try</span> {</span><br><span class="line">            forkJoinPool.submit(<span class="keyword">new</span> <span class="title class_">CalculateRecursiveActon</span>(<span class="number">1</span>, <span class="number">100</span>));</span><br><span class="line">            <span class="keyword">while</span> (forkJoinPool.getActiveThreadCount() &gt; <span class="number">0</span>) {</span><br><span class="line">                <span class="comment">// 等待执行完成</span></span><br><span class="line">                System.out.println(forkJoinPool.getActiveThreadCount());</span><br><span class="line">                TaskFactory.spend(<span class="number">1</span>, TimeUnit.NANOSECONDS);</span><br><span class="line">            }</span><br><span class="line">            Optional.of(SUM_RESULT).ifPresent(System.out::println);</span><br><span class="line">        } <span class="keyword">finally</span> {</span><br><span class="line">            forkJoinPool.shutdown();</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">CalculateRecursiveActon</span> <span class="keyword">extends</span> <span class="title class_">RecursiveAction</span> {</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">final</span> <span class="type">int</span> start;</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">final</span> <span class="type">int</span> end;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> <span class="title function_">CalculateRecursiveActon</span><span class="params">(<span class="type">int</span> start, <span class="type">int</span> end)</span> {</span><br><span class="line">            <span class="keyword">if</span> (end &gt;= start) {</span><br><span class="line">                <span class="built_in">this</span>.start = start;</span><br><span class="line">                <span class="built_in">this</span>.end = end;</span><br><span class="line">            } <span class="keyword">else</span> {</span><br><span class="line">                <span class="built_in">this</span>.end = start;</span><br><span class="line">                <span class="built_in">this</span>.start = end;</span><br><span class="line">            }</span><br><span class="line"></span><br><span class="line">        }</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">compute</span><span class="params">()</span> {</span><br><span class="line">            <span class="keyword">if</span> (end - start &lt;= TASK_CAPACITY) {</span><br><span class="line">                SUM_RESULT.getAndAdd(IntStream.rangeClosed(start, end).sum());</span><br><span class="line">            } <span class="keyword">else</span> {</span><br><span class="line">                <span class="type">int</span> <span class="variable">middle</span> <span class="operator">=</span> (end + start) / <span class="number">2</span>;</span><br><span class="line">                <span class="comment">// 任务拆分</span></span><br><span class="line">                <span class="type">CalculateRecursiveActon</span> <span class="variable">left</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">CalculateRecursiveActon</span>(start, middle);</span><br><span class="line">                <span class="type">CalculateRecursiveActon</span> <span class="variable">right</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">CalculateRecursiveActon</span>(middle + <span class="number">1</span>, end);</span><br><span class="line">                <span class="comment">// 任务入池</span></span><br><span class="line">                left.fork();</span><br><span class="line">                right.fork();</span><br><span class="line">            }</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<h1>Phaser</h1>
<h2 id="监控方法">监控方法</h2>
<ul>
<li><code>public int getRegisteredParties()</code>返回在当前phase上注册的party数目</li>
<li><code>public int getArrivedParties()</code>返回已经到达当前phase的party的数量，如果这个phaser已经终止，返回值是无意义和任意的</li>
<li><code>public int getUnarrivedParties()</code>返回还未到达当前phase的party的数量，如果这个phaser已经终止，返回值是无意义和任意的</li>
<li><code>public final int getPhase()</code>返回当前阶段号, 最大值是Integer.MAX_VALUE，到达最大值之后，从0重新计数</li>
</ul>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">PhaserExample4</span> {</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> {</span><br><span class="line">        <span class="keyword">final</span> <span class="type">Phaser</span> <span class="variable">phaser</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Phaser</span>(<span class="number">5</span>);</span><br><span class="line">        phaser.bulkRegister(<span class="number">5</span>);</span><br><span class="line">        monitor(<span class="number">1</span>, <span class="string">"phaser.getRegisteredParties"</span>, phaser.getRegisteredParties());</span><br><span class="line">        monitor(<span class="number">1</span>, <span class="string">"phaser.getArrivedParties"</span>, phaser.getArrivedParties());</span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">Thread</span>(phaser::arriveAndAwaitAdvance).start();</span><br><span class="line">        monitor(<span class="number">2</span>, <span class="string">"phaser.getArrivedParties"</span>, phaser.getArrivedParties());</span><br><span class="line">        monitor(<span class="number">2</span>, <span class="string">"phaser.getUnarrivedParties"</span>, phaser.getUnarrivedParties());</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">monitor</span><span class="params">(<span class="type">int</span> index, String item, Object object)</span> {</span><br><span class="line">        System.out.printf(<span class="string">"【%s】【monitor-%d】【%30s】%s\n"</span>, Thread.currentThread().getName(), index, item, object);</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<h2 id="动态注册特性">动态注册特性</h2>
<p><code>public int register()</code> 动态注册</p>
<p><code>public int bulkRegister(int parties)</code>批量注册</p>
<p><code>public int arriveAndAwaitAdvance()</code> 类似CyclicBarrier 的await方法</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> practice.common.TaskFactory;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.Phaser;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.TimeUnit;</span><br><span class="line"><span class="keyword">import</span> java.util.stream.IntStream;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">PhaserExample1</span> {</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> {</span><br><span class="line">        <span class="keyword">final</span> <span class="type">Phaser</span> <span class="variable">phaser</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Phaser</span>();</span><br><span class="line">        IntStream.rangeClosed(<span class="number">1</span>, <span class="number">5</span>).boxed().map(i -&gt; phaser).forEach(Task::<span class="keyword">new</span>);</span><br><span class="line">        System.out.println(<span class="string">"【BEGIN-RegisteredParties】"</span> + phaser.getRegisteredParties());</span><br><span class="line">        <span class="comment">// 注册main线程</span></span><br><span class="line">        phaser.register();</span><br><span class="line">        <span class="comment">// 到达并且等待前行</span></span><br><span class="line">        phaser.arriveAndAwaitAdvance();</span><br><span class="line">        <span class="comment">// 等待所有线程全部到达隔离点之后执行</span></span><br><span class="line">        System.out.println(<span class="string">"【END-RegisteredParties】"</span> + phaser.getRegisteredParties());</span><br><span class="line"></span><br><span class="line">        System.out.println(<span class="string">"【"</span> + Thread.currentThread().getName() + <span class="string">" 】 all threads finished the work."</span>);</span><br><span class="line"></span><br><span class="line">        System.out.println(<span class="string">"【other work】"</span>);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">Task</span> <span class="keyword">extends</span> <span class="title class_">Thread</span> {</span><br><span class="line">        <span class="keyword">private</span> Phaser phaser;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> <span class="title function_">Task</span><span class="params">(Phaser phaser)</span> {</span><br><span class="line">            <span class="built_in">this</span>.phaser = phaser;</span><br><span class="line">            <span class="comment">// 动态追加party</span></span><br><span class="line">            <span class="built_in">this</span>.phaser.register();</span><br><span class="line">            <span class="built_in">this</span>.start();</span><br><span class="line">        }</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> {</span><br><span class="line">            TaskFactory.spend(<span class="number">2</span>, TimeUnit.SECONDS);</span><br><span class="line">            System.out.println(Thread.currentThread().getName() + <span class="string">"：finished and continue"</span>);</span><br><span class="line">            <span class="comment">// 到达并且等待前行</span></span><br><span class="line">            <span class="built_in">this</span>.phaser.arriveAndAwaitAdvance();</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line">}</span><br><span class="line"></span><br></pre></td></tr></tbody></table></figure>
<p>输出结果</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">Thread-<span class="number">2</span>：finished and <span class="keyword">continue</span></span><br><span class="line">Thread-<span class="number">3</span>：finished and <span class="keyword">continue</span></span><br><span class="line">Thread-<span class="number">4</span>：finished and <span class="keyword">continue</span></span><br><span class="line">Thread-<span class="number">0</span>：finished and <span class="keyword">continue</span></span><br><span class="line">Thread-<span class="number">1</span>：finished and <span class="keyword">continue</span></span><br><span class="line">【END-RegisteredParties】<span class="number">6</span></span><br><span class="line">【main 】 all threads finished the work.</span><br><span class="line">【other work】</span><br></pre></td></tr></tbody></table></figure>
<h2 id="重复使用计数器">重复使用计数器</h2>
<p><code>public final int getPhase()</code> ：获取已执行阶段数（从0开始，每执行一轮，计数器加1）</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> practice.util.phaser;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> practice.common.TaskFactory;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.Random;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.Phaser;</span><br><span class="line"><span class="keyword">import</span> java.util.stream.IntStream;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">PhaserExample2</span> {</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">Random</span> <span class="variable">random</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Random</span>(System.currentTimeMillis());</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> {</span><br><span class="line">        <span class="comment">// 监控5个运动员（指定parties）</span></span><br><span class="line">        <span class="keyword">final</span> <span class="type">Phaser</span> <span class="variable">phaser</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Phaser</span>(<span class="number">5</span>);</span><br><span class="line">        IntStream.rangeClosed(<span class="number">1</span>, <span class="number">5</span>).boxed().map(i -&gt; phaser).forEach(Athlete::<span class="keyword">new</span>);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">Athlete</span> <span class="keyword">extends</span> <span class="title class_">Thread</span> {</span><br><span class="line">        <span class="comment">// 运动员编号</span></span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">final</span> Phaser phaser;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> <span class="title function_">Athlete</span><span class="params">(Phaser phaser)</span> {</span><br><span class="line">            <span class="built_in">this</span>.phaser = phaser;</span><br><span class="line">            <span class="built_in">this</span>.start();</span><br><span class="line">        }</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> {</span><br><span class="line">            <span class="comment">// step1: 游泳</span></span><br><span class="line">            monitor(<span class="number">0</span>, <span class="string">"phaser.getPhase"</span>, phaser.getPhase());</span><br><span class="line">            actionDeal(<span class="string">"swimming"</span>);</span><br><span class="line">            <span class="comment">// 等待所有运动员完成游泳任务，继续执行</span></span><br><span class="line">            phaser.arriveAndAwaitAdvance();</span><br><span class="line">            <span class="comment">// step2: 自行车</span></span><br><span class="line">            monitor(<span class="number">1</span>, <span class="string">"phaser.getPhase"</span>, phaser.getPhase());</span><br><span class="line">            actionDeal(<span class="string">"bicycle"</span>);</span><br><span class="line">            <span class="comment">// 等待所有运动员完成自行车任务，继续执行</span></span><br><span class="line">            phaser.arriveAndAwaitAdvance();</span><br><span class="line">            <span class="comment">// step3: 长跑</span></span><br><span class="line">            monitor(<span class="number">2</span>, <span class="string">"phaser.getPhase"</span>, phaser.getPhase());</span><br><span class="line">            actionDeal(<span class="string">"running"</span>);</span><br><span class="line">            <span class="comment">// 等待所有运动员完成长跑任务，继续执行</span></span><br><span class="line">            phaser.arriveAndAwaitAdvance();</span><br><span class="line"></span><br><span class="line">            System.out.println(<span class="string">"【"</span> + Thread.currentThread().getName() + <span class="string">"】 finish all tasks."</span>);</span><br><span class="line">        }</span><br><span class="line"></span><br><span class="line">        <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">monitor</span><span class="params">(<span class="type">int</span> index, String item, Object object)</span> {</span><br><span class="line">            System.out.printf(<span class="string">"\t【monitor】【%s】【%d】【%s】%s\n"</span>, Thread.currentThread().getName(), index, item, object);</span><br><span class="line">        }</span><br><span class="line"></span><br><span class="line">        <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">actionDeal</span><span class="params">(String taskName)</span> {</span><br><span class="line">            TaskFactory.spendSeconds(random.nextInt(<span class="number">6</span>));</span><br><span class="line">            System.out.println(<span class="string">"【"</span> + Thread.currentThread().getName() + <span class="string">"】 finish  "</span> + taskName + <span class="string">"."</span>);</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<p>执行结果</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">	【monitor】【Thread-<span class="number">0</span>】【<span class="number">0</span>】【phaser.getPhase】<span class="number">0</span></span><br><span class="line">	【monitor】【Thread-<span class="number">4</span>】【<span class="number">0</span>】【phaser.getPhase】<span class="number">0</span></span><br><span class="line">	【monitor】【Thread-<span class="number">3</span>】【<span class="number">0</span>】【phaser.getPhase】<span class="number">0</span></span><br><span class="line">	【monitor】【Thread-<span class="number">1</span>】【<span class="number">0</span>】【phaser.getPhase】<span class="number">0</span></span><br><span class="line">	【monitor】【Thread-<span class="number">2</span>】【<span class="number">0</span>】【phaser.getPhase】<span class="number">0</span></span><br><span class="line">【Thread-<span class="number">0</span>】 finish  swimming.</span><br><span class="line">【Thread-<span class="number">2</span>】 finish  swimming.</span><br><span class="line">【Thread-<span class="number">1</span>】 finish  swimming.</span><br><span class="line">【Thread-<span class="number">3</span>】 finish  swimming.</span><br><span class="line">【Thread-<span class="number">4</span>】 finish  swimming.</span><br><span class="line">	【monitor】【Thread-<span class="number">2</span>】【<span class="number">1</span>】【phaser.getPhase】<span class="number">1</span></span><br><span class="line">	【monitor】【Thread-<span class="number">0</span>】【<span class="number">1</span>】【phaser.getPhase】<span class="number">1</span></span><br><span class="line">	【monitor】【Thread-<span class="number">3</span>】【<span class="number">1</span>】【phaser.getPhase】<span class="number">1</span></span><br><span class="line">	【monitor】【Thread-<span class="number">1</span>】【<span class="number">1</span>】【phaser.getPhase】<span class="number">1</span></span><br><span class="line">	【monitor】【Thread-<span class="number">4</span>】【<span class="number">1</span>】【phaser.getPhase】<span class="number">1</span></span><br><span class="line">【Thread-<span class="number">0</span>】 finish  bicycle.</span><br><span class="line">【Thread-<span class="number">2</span>】 finish  bicycle.</span><br><span class="line">【Thread-<span class="number">4</span>】 finish  bicycle.</span><br><span class="line">【Thread-<span class="number">3</span>】 finish  bicycle.</span><br><span class="line">【Thread-<span class="number">1</span>】 finish  bicycle.</span><br><span class="line">	【monitor】【Thread-<span class="number">1</span>】【<span class="number">2</span>】【phaser.getPhase】<span class="number">2</span></span><br><span class="line">	【monitor】【Thread-<span class="number">3</span>】【<span class="number">2</span>】【phaser.getPhase】<span class="number">2</span></span><br><span class="line">	【monitor】【Thread-<span class="number">2</span>】【<span class="number">2</span>】【phaser.getPhase】<span class="number">2</span></span><br><span class="line">	【monitor】【Thread-<span class="number">4</span>】【<span class="number">2</span>】【phaser.getPhase】<span class="number">2</span></span><br><span class="line">	【monitor】【Thread-<span class="number">0</span>】【<span class="number">2</span>】【phaser.getPhase】<span class="number">2</span></span><br><span class="line">【Thread-<span class="number">0</span>】 finish  running.</span><br><span class="line">【Thread-<span class="number">2</span>】 finish  running.</span><br><span class="line">【Thread-<span class="number">3</span>】 finish  running.</span><br><span class="line">【Thread-<span class="number">1</span>】 finish  running.</span><br><span class="line">【Thread-<span class="number">4</span>】 finish  running.</span><br><span class="line">【Thread-<span class="number">4</span>】 finish all tasks.</span><br><span class="line">【Thread-<span class="number">2</span>】 finish all tasks.</span><br><span class="line">【Thread-<span class="number">3</span>】 finish all tasks.</span><br><span class="line">【Thread-<span class="number">1</span>】 finish all tasks.</span><br><span class="line">【Thread-<span class="number">0</span>】 finish all tasks.</span><br></pre></td></tr></tbody></table></figure>
<h2 id="减少计数器（动态销户）">减少计数器（动态销户）</h2>
<p>需要注意：销户之后的<font color="red">return</font>，否则仍然会参与后续流程的计数</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> practice.common.TaskFactory;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.Random;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.Phaser;</span><br><span class="line"><span class="keyword">import</span> java.util.stream.IntStream;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Phaser 减少计数器（动态销户）</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">PhaserExample3</span> {</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">Random</span> <span class="variable">random</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Random</span>(System.currentTimeMillis());</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> {</span><br><span class="line">        <span class="comment">// 监控5个运动员</span></span><br><span class="line">        <span class="keyword">final</span> <span class="type">Phaser</span> <span class="variable">phaser</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Phaser</span>(<span class="number">5</span>);</span><br><span class="line">        IntStream.rangeClosed(<span class="number">1</span>, <span class="number">5</span>).boxed().map(i -&gt; phaser).forEach(Athlete::<span class="keyword">new</span>);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">Athlete</span> <span class="keyword">extends</span> <span class="title class_">Thread</span> {</span><br><span class="line">        <span class="comment">// 运动员编号</span></span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">final</span> Phaser phaser;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> <span class="title function_">Athlete</span><span class="params">(Phaser phaser)</span> {</span><br><span class="line">            <span class="built_in">this</span>.phaser = phaser;</span><br><span class="line">            <span class="built_in">this</span>.start();</span><br><span class="line">        }</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> {</span><br><span class="line">            <span class="comment">// step1: 游泳</span></span><br><span class="line">            monitor(<span class="number">0</span>, phaser);</span><br><span class="line">            actionDeal(<span class="string">"swimming"</span>);</span><br><span class="line">            phaser.arriveAndAwaitAdvance();</span><br><span class="line">            <span class="comment">// step2: 自行车</span></span><br><span class="line">            <span class="keyword">if</span> (Thread.currentThread().getName().endsWith(<span class="string">"2"</span>)) {</span><br><span class="line">                monitor(<span class="number">1</span>, phaser);</span><br><span class="line">                actionFailed(<span class="string">"bicycle"</span>);</span><br><span class="line">                <span class="comment">// 运动员退出比赛（退出计数）</span></span><br><span class="line">                phaser.arriveAndDeregister();</span><br><span class="line">                <span class="comment">// 退出计数之后，后续流程不在参与重新参与计数</span></span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            } <span class="keyword">else</span> {</span><br><span class="line">                monitor(<span class="number">1</span>, phaser);</span><br><span class="line">                actionDeal(<span class="string">"bicycle"</span>);</span><br><span class="line">                phaser.arriveAndAwaitAdvance();</span><br><span class="line">            }</span><br><span class="line">            <span class="comment">// step3: 长跑</span></span><br><span class="line">            monitor(<span class="number">2</span>, phaser);</span><br><span class="line">            actionDeal(<span class="string">"running"</span>);</span><br><span class="line">            phaser.arriveAndAwaitAdvance();</span><br><span class="line"></span><br><span class="line">            System.out.println(<span class="string">"【"</span> + Thread.currentThread().getName() + <span class="string">"】 finish all tasks."</span>);</span><br><span class="line">        }</span><br><span class="line"></span><br><span class="line">        <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">monitor</span><span class="params">(<span class="type">int</span> index, Phaser phaser)</span> {</span><br><span class="line">            <span class="type">String</span> <span class="variable">formatter</span> <span class="operator">=</span> <span class="string">"\t【monitor】【%s】【%d】【%s】%s\n"</span>;</span><br><span class="line">            <span class="type">String</span> <span class="variable">threadName</span> <span class="operator">=</span> Thread.currentThread().getName();</span><br><span class="line">            System.out.printf(formatter, threadName, index, <span class="string">"RegisteredParties"</span>, phaser.getRegisteredParties());</span><br><span class="line">        }</span><br><span class="line"></span><br><span class="line">        <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">actionDeal</span><span class="params">(String taskName)</span> {</span><br><span class="line">            TaskFactory.spendSeconds(random.nextInt(<span class="number">6</span>));</span><br><span class="line">            System.out.println(<span class="string">"【"</span> + Thread.currentThread().getName() + <span class="string">"】 finish  "</span> + taskName + <span class="string">"."</span>);</span><br><span class="line">        }</span><br><span class="line"></span><br><span class="line">        <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">actionFailed</span><span class="params">(String taskName)</span> {</span><br><span class="line">            System.out.println(<span class="string">"【"</span> + Thread.currentThread().getName() + <span class="string">"】 failed  "</span> + taskName + <span class="string">"."</span>);</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<p>输出结果</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">【monitor】【Thread-<span class="number">0</span>】【<span class="number">0</span>】【RegisteredParties】<span class="number">5</span></span><br><span class="line">	【monitor】【Thread-<span class="number">3</span>】【<span class="number">0</span>】【RegisteredParties】<span class="number">5</span></span><br><span class="line">	【monitor】【Thread-<span class="number">4</span>】【<span class="number">0</span>】【RegisteredParties】<span class="number">5</span></span><br><span class="line">	【monitor】【Thread-<span class="number">2</span>】【<span class="number">0</span>】【RegisteredParties】<span class="number">5</span></span><br><span class="line">	【monitor】【Thread-<span class="number">1</span>】【<span class="number">0</span>】【RegisteredParties】<span class="number">5</span></span><br><span class="line">【Thread-<span class="number">2</span>】 finish  swimming.</span><br><span class="line">【Thread-<span class="number">3</span>】 finish  swimming.</span><br><span class="line">【Thread-<span class="number">1</span>】 finish  swimming.</span><br><span class="line">【Thread-<span class="number">0</span>】 finish  swimming.</span><br><span class="line">【Thread-<span class="number">4</span>】 finish  swimming.</span><br><span class="line">	【monitor】【Thread-<span class="number">4</span>】【<span class="number">1</span>】【RegisteredParties】<span class="number">5</span></span><br><span class="line">	【monitor】【Thread-<span class="number">0</span>】【<span class="number">1</span>】【RegisteredParties】<span class="number">5</span></span><br><span class="line">	【monitor】【Thread-<span class="number">3</span>】【<span class="number">1</span>】【RegisteredParties】<span class="number">5</span></span><br><span class="line">	【monitor】【Thread-<span class="number">1</span>】【<span class="number">1</span>】【RegisteredParties】<span class="number">5</span></span><br><span class="line">	【monitor】【Thread-<span class="number">2</span>】【<span class="number">1</span>】【RegisteredParties】<span class="number">5</span></span><br><span class="line">【Thread-<span class="number">2</span>】 failed  bicycle.</span><br><span class="line">【Thread-<span class="number">2</span>】 withdrew the game.</span><br><span class="line">【Thread-<span class="number">4</span>】 finish  bicycle.</span><br><span class="line">【Thread-<span class="number">3</span>】 finish  bicycle.</span><br><span class="line">【Thread-<span class="number">1</span>】 finish  bicycle.</span><br><span class="line">【Thread-<span class="number">0</span>】 finish  bicycle.</span><br><span class="line">	【monitor】【Thread-<span class="number">0</span>】【<span class="number">2</span>】【RegisteredParties】<span class="number">4</span></span><br><span class="line">	【monitor】【Thread-<span class="number">4</span>】【<span class="number">2</span>】【RegisteredParties】<span class="number">4</span></span><br><span class="line">【Thread-<span class="number">4</span>】 finish  running.</span><br><span class="line">	【monitor】【Thread-<span class="number">3</span>】【<span class="number">2</span>】【RegisteredParties】<span class="number">4</span></span><br><span class="line">	【monitor】【Thread-<span class="number">1</span>】【<span class="number">2</span>】【RegisteredParties】<span class="number">4</span></span><br><span class="line">【Thread-<span class="number">0</span>】 finish  running.</span><br><span class="line">【Thread-<span class="number">1</span>】 finish  running.</span><br><span class="line">【Thread-<span class="number">3</span>】 finish  running.</span><br><span class="line">【Thread-<span class="number">3</span>】 finish all tasks.</span><br><span class="line">【Thread-<span class="number">0</span>】 finish all tasks.</span><br><span class="line">【Thread-<span class="number">1</span>】 finish all tasks.</span><br><span class="line">【Thread-<span class="number">4</span>】 finish all tasks.</span><br></pre></td></tr></tbody></table></figure>
<h2 id="人为控制Phase的终结：onAdvance">人为控制Phase的终结：onAdvance</h2>
<ol>
<li>
<p>使用方法：覆写<code>onAdvance</code>方法</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">final</span> <span class="type">Phaser</span> <span class="variable">phaser</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Phaser</span>(<span class="number">2</span>) {</span><br><span class="line">  <span class="meta">@Override</span></span><br><span class="line">  <span class="keyword">protected</span> <span class="type">boolean</span> <span class="title function_">onAdvance</span><span class="params">(<span class="type">int</span> phase, <span class="type">int</span> registeredParties)</span> {</span><br><span class="line">    <span class="comment">// return registeredParties == 0; 原始写法</span></span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span>; </span><br><span class="line">  }</span><br><span class="line">};</span><br></pre></td></tr></tbody></table></figure>
</li>
<li>
<p><code>onAdvance </code>的返回结果直接设置为<code>returen true</code> ，则<code>arriveAndAwaitAdvance</code>不会阻塞等待所有的<code>parties</code></p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> practice.util.phaser;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> practice.common.TaskFactory;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.Phaser;</span><br><span class="line"><span class="keyword">import</span> java.util.stream.IntStream;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 人为控制phase的终结：onAdvance</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">PhaserExample5</span> {</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> {</span><br><span class="line">        <span class="keyword">final</span> <span class="type">Phaser</span> <span class="variable">phaser</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Phaser</span>(<span class="number">2</span>) {</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">protected</span> <span class="type">boolean</span> <span class="title function_">onAdvance</span><span class="params">(<span class="type">int</span> phase, <span class="type">int</span> registeredParties)</span> {</span><br><span class="line">                <span class="comment">// 无论执行情况，都默认，phase 执行结束。</span></span><br><span class="line">                <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">            }</span><br><span class="line">        };</span><br><span class="line">        IntStream.rangeClosed(<span class="number">1</span>, <span class="number">2</span>).boxed().map(i -&gt; phaser).forEach(OnAdvanceTask::<span class="keyword">new</span>);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">OnAdvanceTask</span> <span class="keyword">extends</span> <span class="title class_">Thread</span> {</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">final</span> Phaser phaser;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> <span class="title function_">OnAdvanceTask</span><span class="params">(Phaser phaser)</span> {</span><br><span class="line">            <span class="built_in">this</span>.phaser = phaser;</span><br><span class="line">            <span class="built_in">this</span>.start();</span><br><span class="line">        }</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> {</span><br><span class="line">            System.out.println(<span class="string">"【"</span> + <span class="built_in">this</span>.getName() + <span class="string">"】 arrived part one"</span>);</span><br><span class="line">            phaser.arriveAndAwaitAdvance();</span><br><span class="line">            System.out.println(<span class="string">"【"</span> + <span class="built_in">this</span>.getName() + <span class="string">"】 passed part one"</span>);</span><br><span class="line">            TaskFactory.spendSeconds(<span class="number">1</span>);</span><br><span class="line">            monitor(<span class="number">1</span>, phaser);</span><br><span class="line">            <span class="keyword">if</span> (<span class="built_in">this</span>.getName().endsWith(<span class="string">"1"</span>)) {</span><br><span class="line">                System.out.println(<span class="string">"【"</span> + <span class="built_in">this</span>.getName() + <span class="string">"】 arrived part two"</span>);</span><br><span class="line">                <span class="comment">// onAdvance 设置为true，arriveAndAwaitAdvance不会阻塞</span></span><br><span class="line">                <span class="comment">// onAdvance 设置false/ 使用默认的onAdvance，Thread-1 会阻塞在此处</span></span><br><span class="line">                phaser.arriveAndAwaitAdvance();</span><br><span class="line">                System.out.println(<span class="string">"【"</span> + <span class="built_in">this</span>.getName() + <span class="string">"】 passed part two"</span>);</span><br><span class="line">            }</span><br><span class="line">            monitor(<span class="number">2</span>, phaser);</span><br><span class="line">            <span class="comment">// onAdvance 设置false/ 使用默认的onAdvance，Thread-0 会阻塞在此处</span></span><br><span class="line">            phaser.arriveAndAwaitAdvance();</span><br><span class="line">            monitor(<span class="number">3</span>, phaser);</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">monitor</span><span class="params">(<span class="type">int</span> index, Phaser phaser)</span> {</span><br><span class="line">        <span class="type">String</span> <span class="variable">template</span> <span class="operator">=</span> <span class="string">"\t【%s】【monitor-%d】【%30s】%s\n"</span>;</span><br><span class="line">        <span class="type">String</span> <span class="variable">actionName</span> <span class="operator">=</span> Thread.currentThread().getName();</span><br><span class="line">        System.out.printf(template, actionName, index, <span class="string">"phaser.getPhase"</span>, phaser.getPhase());</span><br><span class="line">        System.out.printf(template, actionName, index, <span class="string">"phaser.getRegisteredParties"</span>, phaser.getRegisteredParties());</span><br><span class="line">        System.out.printf(template, actionName, index, <span class="string">"phaser.getArrivedParties"</span>, phaser.getArrivedParties());</span><br><span class="line">        System.out.printf(template, actionName, index, <span class="string">"phaser.getUnarrivedParties"</span>, phaser.getUnarrivedParties());</span><br><span class="line">        System.out.printf(template, actionName, index, <span class="string">"phaser.isTerminated"</span>, phaser.isTerminated());</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<p>输出结果</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">【Thread-<span class="number">0</span>】 arrived part one</span><br><span class="line">【Thread-<span class="number">1</span>】 arrived part one</span><br><span class="line">【Thread-<span class="number">1</span>】 passed part one</span><br><span class="line">【Thread-<span class="number">0</span>】 passed part one</span><br><span class="line">	【Thread-<span class="number">0</span>】【monitor-<span class="number">1</span>】【               phaser.getPhase】-<span class="number">2147483647</span></span><br><span class="line">	【Thread-<span class="number">1</span>】【monitor-<span class="number">1</span>】【               phaser.getPhase】-<span class="number">2147483647</span></span><br><span class="line">	【Thread-<span class="number">0</span>】【monitor-<span class="number">1</span>】【   phaser.getRegisteredParties】<span class="number">2</span></span><br><span class="line">	【Thread-<span class="number">1</span>】【monitor-<span class="number">1</span>】【   phaser.getRegisteredParties】<span class="number">2</span></span><br><span class="line">	【Thread-<span class="number">1</span>】【monitor-<span class="number">1</span>】【      phaser.getArrivedParties】<span class="number">2</span></span><br><span class="line">	【Thread-<span class="number">0</span>】【monitor-<span class="number">1</span>】【      phaser.getArrivedParties】<span class="number">2</span></span><br><span class="line">	【Thread-<span class="number">0</span>】【monitor-<span class="number">1</span>】【    phaser.getUnarrivedParties】<span class="number">0</span></span><br><span class="line">	【Thread-<span class="number">1</span>】【monitor-<span class="number">1</span>】【    phaser.getUnarrivedParties】<span class="number">0</span></span><br><span class="line">	【Thread-<span class="number">1</span>】【monitor-<span class="number">1</span>】【           phaser.isTerminated】<span class="literal">true</span></span><br><span class="line">	【Thread-<span class="number">0</span>】【monitor-<span class="number">1</span>】【           phaser.isTerminated】<span class="literal">true</span></span><br><span class="line">【Thread-<span class="number">1</span>】 arrived part two</span><br><span class="line">	【Thread-<span class="number">0</span>】【monitor-<span class="number">2</span>】【               phaser.getPhase】-<span class="number">2147483647</span></span><br><span class="line">	【Thread-<span class="number">0</span>】【monitor-<span class="number">2</span>】【   phaser.getRegisteredParties】<span class="number">2</span></span><br><span class="line">	【Thread-<span class="number">0</span>】【monitor-<span class="number">2</span>】【      phaser.getArrivedParties】<span class="number">2</span></span><br><span class="line">	【Thread-<span class="number">0</span>】【monitor-<span class="number">2</span>】【    phaser.getUnarrivedParties】<span class="number">0</span></span><br><span class="line">	【Thread-<span class="number">0</span>】【monitor-<span class="number">2</span>】【           phaser.isTerminated】<span class="literal">true</span></span><br><span class="line">	【Thread-<span class="number">0</span>】【monitor-<span class="number">3</span>】【               phaser.getPhase】-<span class="number">2147483647</span></span><br><span class="line">	【Thread-<span class="number">0</span>】【monitor-<span class="number">3</span>】【   phaser.getRegisteredParties】<span class="number">2</span></span><br><span class="line">	【Thread-<span class="number">0</span>】【monitor-<span class="number">3</span>】【      phaser.getArrivedParties】<span class="number">2</span></span><br><span class="line">	【Thread-<span class="number">0</span>】【monitor-<span class="number">3</span>】【    phaser.getUnarrivedParties】<span class="number">0</span></span><br><span class="line">	【Thread-<span class="number">0</span>】【monitor-<span class="number">3</span>】【           phaser.isTerminated】<span class="literal">true</span></span><br><span class="line">【Thread-<span class="number">1</span>】 passed part two</span><br><span class="line">	【Thread-<span class="number">1</span>】【monitor-<span class="number">2</span>】【               phaser.getPhase】-<span class="number">2147483647</span></span><br><span class="line">	【Thread-<span class="number">1</span>】【monitor-<span class="number">2</span>】【   phaser.getRegisteredParties】<span class="number">2</span></span><br><span class="line">	【Thread-<span class="number">1</span>】【monitor-<span class="number">2</span>】【      phaser.getArrivedParties】<span class="number">2</span></span><br><span class="line">	【Thread-<span class="number">1</span>】【monitor-<span class="number">2</span>】【    phaser.getUnarrivedParties】<span class="number">0</span></span><br><span class="line">	【Thread-<span class="number">1</span>】【monitor-<span class="number">2</span>】【           phaser.isTerminated】<span class="literal">true</span></span><br><span class="line">	【Thread-<span class="number">1</span>】【monitor-<span class="number">3</span>】【               phaser.getPhase】-<span class="number">2147483647</span></span><br><span class="line">	【Thread-<span class="number">1</span>】【monitor-<span class="number">3</span>】【   phaser.getRegisteredParties】<span class="number">2</span></span><br><span class="line">	【Thread-<span class="number">1</span>】【monitor-<span class="number">3</span>】【      phaser.getArrivedParties】<span class="number">2</span></span><br><span class="line">	【Thread-<span class="number">1</span>】【monitor-<span class="number">3</span>】【    phaser.getUnarrivedParties】<span class="number">0</span></span><br><span class="line">	【Thread-<span class="number">1</span>】【monitor-<span class="number">3</span>】【           phaser.isTerminated】<span class="literal">true</span></span><br></pre></td></tr></tbody></table></figure>
</li>
</ol>
<h2 id="到达之后，不阻塞等待：arrive">到达之后，不阻塞等待：arrive</h2>
<p><code>public int arrive()</code></p>
<p>使用场景：仅==监控线程==关心任务完成，执行线程无需相互等待</p>
<p><img src="https://hmxyl-image.oss-cn-hangzhou.aliyuncs.com/note/arrive.drawio-1667231117133-89.png" alt="arrive.drawio"></p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> practice.common.TaskFactory;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.Phaser;</span><br><span class="line"><span class="keyword">import</span> java.util.stream.IntStream;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span>: DH</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span>: 2022/6/28</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@desc</span>:</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">PhaserExample6</span> {</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> {</span><br><span class="line">        <span class="keyword">final</span> <span class="type">Phaser</span> <span class="variable">phaser</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Phaser</span>(<span class="number">3</span>);</span><br><span class="line">        IntStream.rangeClosed(<span class="number">1</span>, <span class="number">2</span>).boxed().map(i -&gt; phaser).forEach(ArriveTask::<span class="keyword">new</span>);</span><br><span class="line">        <span class="comment">// 此处main线程会阻塞，等待part one全部完成</span></span><br><span class="line">        phaser.arriveAndAwaitAdvance();</span><br><span class="line">        System.out.println(<span class="string">"【"</span> + Thread.currentThread().getName() + <span class="string">"】 part one all done"</span>);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">ArriveTask</span> <span class="keyword">extends</span> <span class="title class_">Thread</span> {</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">final</span> Phaser phaser;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> <span class="title function_">ArriveTask</span><span class="params">(Phaser phaser)</span> {</span><br><span class="line">            <span class="built_in">this</span>.phaser = phaser;</span><br><span class="line">            <span class="built_in">this</span>.start();</span><br><span class="line">        }</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> {</span><br><span class="line">            TaskFactory.spendSecondsRandom(<span class="number">10</span>, <span class="literal">true</span>, <span class="literal">true</span>);</span><br><span class="line">            monitor(<span class="number">1</span>, phaser);</span><br><span class="line">            <span class="comment">// parties 参与计数，但是不会阻塞等待</span></span><br><span class="line">            phaser.arrive();</span><br><span class="line">            System.out.println(<span class="string">"【"</span> + Thread.currentThread().getName() + <span class="string">"】 part one all done"</span>);</span><br><span class="line">            TaskFactory.spendSecondsRandom(<span class="number">2</span>, <span class="literal">true</span>, <span class="literal">true</span>);</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">monitor</span><span class="params">(<span class="type">int</span> index, Phaser phaser)</span> {</span><br><span class="line">        <span class="type">String</span> <span class="variable">template</span> <span class="operator">=</span> <span class="string">"\t【%s】【monitor-%d】【%30s】%s\n"</span>;</span><br><span class="line">        <span class="type">String</span> <span class="variable">actionName</span> <span class="operator">=</span> Thread.currentThread().getName();</span><br><span class="line">        System.out.printf(template, actionName, index, <span class="string">"phaser.getPhase"</span>, phaser.getPhase());</span><br><span class="line">        System.out.printf(template, actionName, index, <span class="string">"phaser.getRegisteredParties"</span>, phaser.getRegisteredParties());</span><br><span class="line">        System.out.printf(template, actionName, index, <span class="string">"phaser.getArrivedParties"</span>, phaser.getArrivedParties());</span><br><span class="line">        System.out.printf(template, actionName, index, <span class="string">"phaser.getUnarrivedParties"</span>, phaser.getUnarrivedParties());</span><br><span class="line">        System.out.printf(template, actionName, index, <span class="string">"phaser.isTerminated"</span>, phaser.isTerminated());</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<p>输出结果</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">	【Thread-<span class="number">1</span>】【monitor-<span class="number">1</span>】【               phaser.getPhase】<span class="number">0</span></span><br><span class="line">	【Thread-<span class="number">1</span>】【monitor-<span class="number">1</span>】【   phaser.getRegisteredParties】<span class="number">3</span></span><br><span class="line">	【Thread-<span class="number">1</span>】【monitor-<span class="number">1</span>】【      phaser.getArrivedParties】<span class="number">1</span></span><br><span class="line">	【Thread-<span class="number">1</span>】【monitor-<span class="number">1</span>】【    phaser.getUnarrivedParties】<span class="number">2</span></span><br><span class="line">	【Thread-<span class="number">1</span>】【monitor-<span class="number">1</span>】【           phaser.isTerminated】<span class="literal">false</span></span><br><span class="line">【Thread-<span class="number">1</span>】 part one all done</span><br><span class="line">	【Thread-<span class="number">0</span>】【monitor-<span class="number">1</span>】【               phaser.getPhase】<span class="number">0</span></span><br><span class="line">	【Thread-<span class="number">0</span>】【monitor-<span class="number">1</span>】【   phaser.getRegisteredParties】<span class="number">3</span></span><br><span class="line">	【Thread-<span class="number">0</span>】【monitor-<span class="number">1</span>】【      phaser.getArrivedParties】<span class="number">2</span></span><br><span class="line">	【Thread-<span class="number">0</span>】【monitor-<span class="number">1</span>】【    phaser.getUnarrivedParties】<span class="number">1</span></span><br><span class="line">	【Thread-<span class="number">0</span>】【monitor-<span class="number">1</span>】【           phaser.isTerminated】<span class="literal">false</span></span><br><span class="line">【Thread-<span class="number">0</span>】 part one all done</span><br><span class="line">【main】 part one all done</span><br><span class="line"></span><br></pre></td></tr></tbody></table></figure>
<h2 id="仅完成监控任务：awaitAdvance">仅完成监控任务：awaitAdvance</h2>
<p>awaitAdvance方法 不占用 <code>party</code> 数量，在所有parties全部完成后执行</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 仅完成监控任务：awaitAdvance</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">PhaserExample7</span> {</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> {</span><br><span class="line">        <span class="comment">// 若将phaser的parties注册为3，程序会加入阻塞状态</span></span><br><span class="line">        <span class="keyword">final</span> <span class="type">Phaser</span> <span class="variable">phaser</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Phaser</span>(<span class="number">2</span>);</span><br><span class="line">        actionArriveAndAwaitAdvance(phaser).start();</span><br><span class="line">        actionArriveAndAwaitAdvance(phaser).start();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">Thread</span>(() -&gt; {</span><br><span class="line">            phaser.awaitAdvance(phaser.getPhase());</span><br><span class="line">            <span class="comment">// 监听到指定phase的parties全部完成后执行</span></span><br><span class="line">            System.out.println(<span class="string">"all parties finished："</span> + phaser.getPhase());</span><br><span class="line">        }).start();</span><br><span class="line"></span><br><span class="line">        TaskFactory.spendSeconds(<span class="number">12</span>);</span><br><span class="line"></span><br><span class="line">        actionArriveAndAwaitAdvance(phaser).start();</span><br><span class="line">        actionArriveAndAwaitAdvance(phaser).start();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">Thread</span>(() -&gt; {</span><br><span class="line">            phaser.awaitAdvance(phaser.getPhase());</span><br><span class="line">            <span class="comment">// 监听到指定phase的parties全部完成后执行</span></span><br><span class="line">            System.out.println(<span class="string">"all parties finished："</span> + phaser.getPhase());</span><br><span class="line">        }).start();</span><br><span class="line"></span><br><span class="line">        TaskFactory.spendSeconds(<span class="number">12</span>);</span><br><span class="line">        System.out.println(<span class="string">"\t【"</span> + Thread.currentThread().getName() + <span class="string">"】"</span> + <span class="string">" done"</span>);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> Thread <span class="title function_">actionArriveAndAwaitAdvance</span><span class="params">(Phaser phaser)</span> {</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Thread</span>(() -&gt; {</span><br><span class="line">            TaskFactory.spendSecondsRandom(<span class="number">5</span>);</span><br><span class="line">            phaser.arriveAndAwaitAdvance();</span><br><span class="line">            TaskFactory.spendSeconds(<span class="number">1</span>);</span><br><span class="line">            System.out.println(<span class="string">"\t【"</span> + Thread.currentThread().getName() + <span class="string">"】"</span> + <span class="string">" done"</span>);</span><br><span class="line">        });</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<p>输出结果</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">all parties finished：<span class="number">1</span></span><br><span class="line">	【Thread-<span class="number">0</span>】 done</span><br><span class="line">	【Thread-<span class="number">1</span>】 done</span><br><span class="line">all parties finished：<span class="number">2</span></span><br><span class="line">	【Thread-<span class="number">4</span>】 done</span><br><span class="line">	【Thread-<span class="number">3</span>】 done</span><br></pre></td></tr></tbody></table></figure>
<ul>
<li>配合<code>arrive</code>使用</li>
</ul>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> practice.util.phaser;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> practice.common.TaskFactory;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.Phaser;</span><br><span class="line"><span class="keyword">import</span> java.util.stream.IntStream;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 测试 利用 {<span class="doctag">@link</span> java.util.concurrent.Phaser#awaitAdvance} 监控所有party完成指定任务，才允许后续操作</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">PhaserExample8</span> {</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> InterruptedException {</span><br><span class="line">        <span class="keyword">final</span> <span class="type">Phaser</span> <span class="variable">phaser</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Phaser</span>(<span class="number">3</span>);</span><br><span class="line">        IntStream.rangeClosed(<span class="number">1</span>, <span class="number">2</span>).boxed().map(i -&gt; phaser).forEach(AwaitAdvanceTask::<span class="keyword">new</span>);</span><br><span class="line">        phaser.awaitAdvance(phaser.getPhase());</span><br><span class="line">        System.out.println(<span class="string">"【"</span> + Thread.currentThread().getName() + <span class="string">"】 all part one finished."</span>);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">AwaitAdvanceTask</span> <span class="keyword">extends</span> <span class="title class_">Thread</span> {</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">final</span> Phaser phaser;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> <span class="title function_">AwaitAdvanceTask</span><span class="params">(Phaser phaser)</span> {</span><br><span class="line">            <span class="built_in">this</span>.phaser = phaser;</span><br><span class="line">            <span class="built_in">this</span>.start();</span><br><span class="line">        }</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> {</span><br><span class="line">            <span class="comment">// 需要监控完成的工作</span></span><br><span class="line">            actionDeal(<span class="string">"part one"</span>, <span class="number">2</span>);</span><br><span class="line">            phaser.arrive();</span><br><span class="line">            <span class="comment">// 非阻塞等待，完成其他工作</span></span><br><span class="line">            actionDeal(<span class="string">"part two"</span>, <span class="number">4</span>);</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">actionDeal</span><span class="params">(String actionName, <span class="type">int</span> seconds)</span> {</span><br><span class="line">        System.out.println(<span class="string">"【"</span> + Thread.currentThread().getName() + <span class="string">"】 start "</span> + actionName + <span class="string">"."</span>);</span><br><span class="line">        TaskFactory.spendSeconds(seconds);</span><br><span class="line">        System.out.println(<span class="string">"\t【"</span> + Thread.currentThread().getName() + <span class="string">"】 finish  "</span> + actionName + <span class="string">"."</span>);</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<p>输出结果</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">【Thread-<span class="number">1</span>】 start part one.</span><br><span class="line">【Thread-<span class="number">0</span>】 start part one.</span><br><span class="line">	【Thread-<span class="number">1</span>】 finish  part one.</span><br><span class="line">【Thread-<span class="number">1</span>】 start part two.</span><br><span class="line">	【Thread-<span class="number">0</span>】 finish  part one.</span><br><span class="line">【Thread-<span class="number">0</span>】 start part two.</span><br><span class="line">【main】 all part one finished.</span><br><span class="line">	【Thread-<span class="number">0</span>】 finish  part two.</span><br><span class="line">	【Thread-<span class="number">1</span>】 finish  part two.</span><br></pre></td></tr></tbody></table></figure>
<h2 id="打断-超时-终止：awaitAdvanceInterruptibly">打断/超时 终止：awaitAdvanceInterruptibly</h2>
<p>等待此Phaser的阶段从给定的phase值前进，如果在等待期间被中断，则抛出 InterruptedException，或者如果当前phase不等于给定的phase值或此Phaser终止，则立即返回。</p>
<p><code>Phaser.awaitAdvanceInterruptibly(int)</code> ，调用interrupt，抛出InterruptedException</p>
<p><code>Phaser.awaitAdvanceInterruptibly(int, long, TimeUnit)</code>: 调用interrupt/给定超时时间，抛出InterruptedException</p>
<ul>
<li>
<p>不占用 <code>party</code> 数量，在所有parties全部完成后执行</p>
</li>
<li>
<p>打断了其中一个<code>party</code>，其他的 party 仍然能够继续执行</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> practice.common.TaskFactory;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.Phaser;</span><br><span class="line"><span class="keyword">import</span> java.util.stream.IntStream;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">PhaserExample9</span> {</span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">static</span> <span class="type">int</span> <span class="variable">finishTime</span> <span class="operator">=</span> <span class="number">2</span>;</span><br><span class="line">    <span class="comment">// phase未结束，可以被打断，其他的 party 仍然能够继续执行</span></span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">static</span> <span class="type">int</span> <span class="variable">waitTimeBeforeInterrupt</span> <span class="operator">=</span> <span class="number">1</span>;</span><br><span class="line">    <span class="comment">// phase已结束，不会抛出打断异常</span></span><br><span class="line">    <span class="comment">//final static int waitTimeBeforeInterrupt = 4;</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> {</span><br><span class="line">        <span class="keyword">final</span> <span class="type">Phaser</span> <span class="variable">phaser</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Phaser</span>(<span class="number">2</span>);</span><br><span class="line">        IntStream.rangeClosed(<span class="number">1</span>, <span class="number">2</span>).forEach(i -&gt; {</span><br><span class="line">            <span class="keyword">new</span> <span class="title class_">Thread</span>(() -&gt; {</span><br><span class="line">                TaskFactory.spendSeconds(finishTime);</span><br><span class="line">                phaser.arriveAndAwaitAdvance();</span><br><span class="line">                System.out.println(Thread.currentThread().getName() + <span class="string">": continue."</span>);</span><br><span class="line">            }).start();</span><br><span class="line">        });</span><br><span class="line"></span><br><span class="line">        <span class="type">Thread</span> <span class="variable">thread</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Thread</span>(() -&gt; {</span><br><span class="line">            <span class="keyword">try</span> {</span><br><span class="line">                <span class="comment">// 允许被打断的await</span></span><br><span class="line">                phaser.awaitAdvanceInterruptibly(phaser.getPhase());</span><br><span class="line">                System.out.println(Thread.currentThread().getName() + <span class="string">": continue."</span>);</span><br><span class="line">            } <span class="keyword">catch</span> (InterruptedException e) {</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">                System.out.println(Thread.currentThread().getName() + <span class="string">": 未完成party数："</span> + phaser.getUnarrivedParties());</span><br><span class="line">            }</span><br><span class="line">        });</span><br><span class="line">        thread.start();</span><br><span class="line">        TaskFactory.spendSeconds(waitTimeBeforeInterrupt);</span><br><span class="line">        thread.interrupt();</span><br><span class="line">        System.out.println(<span class="string">"================================="</span>);</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<p>输出结果</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">=================================</span><br><span class="line">Thread-<span class="number">2</span>: 未完成party数：<span class="number">2</span></span><br><span class="line">java.lang.InterruptedException</span><br><span class="line">	at java.util.concurrent.Phaser.awaitAdvanceInterruptibly(Phaser.java:<span class="number">760</span>)</span><br><span class="line">	at practice.util.phaser.PhaserExample9.lambda$main$<span class="number">2</span>(PhaserExample9.java:<span class="number">28</span>)</span><br><span class="line">	at java.lang.Thread.run(Thread.java:<span class="number">748</span>)</span><br><span class="line">Thread-<span class="number">1</span>: <span class="keyword">continue</span>.</span><br><span class="line">Thread-<span class="number">0</span>: <span class="keyword">continue</span>.</span><br></pre></td></tr></tbody></table></figure>
</li>
</ul>
<h2 id="强制销毁：forceTermination">强制销毁：forceTermination</h2>
<p>强制此Phaser进入终止状态。注册方的数量不受影响。如果此Phaser是分层Phaser集的成员，则该集中的所有Phaser都将终止。如果此Phaser已终止，则此方法无效。</p>
<p>此方法可用于在一个或多个任务遇到意外异常后协调恢复。</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> practice.common.TaskFactory;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.Phaser;</span><br><span class="line"><span class="keyword">import</span> java.util.stream.IntStream;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">PhaserExample10</span> {</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> {</span><br><span class="line">        <span class="keyword">final</span> <span class="type">Phaser</span> <span class="variable">phaser</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Phaser</span>(<span class="number">2</span>);</span><br><span class="line">        IntStream.rangeClosed(<span class="number">1</span>, <span class="number">1</span>).forEach(i -&gt; {</span><br><span class="line">            <span class="keyword">new</span> <span class="title class_">Thread</span>(() -&gt; {</span><br><span class="line">                TaskFactory.spendSeconds(<span class="number">5</span>);</span><br><span class="line">                phaser.arriveAndAwaitAdvance();</span><br><span class="line">                monitor(<span class="number">1</span>, phaser);</span><br><span class="line">                System.out.println(Thread.currentThread().getName() + <span class="string">": continue."</span>);</span><br><span class="line">            }).start();</span><br><span class="line">        });</span><br><span class="line">        phaser.forceTermination();</span><br><span class="line">        monitor(<span class="number">1</span>, phaser);</span><br><span class="line">        TaskFactory.spendSeconds(<span class="number">6</span>);</span><br><span class="line">        System.out.println(<span class="string">"&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;"</span>);</span><br><span class="line">        IntStream.rangeClosed(<span class="number">1</span>, <span class="number">2</span>).forEach(i -&gt; {</span><br><span class="line">            <span class="keyword">new</span> <span class="title class_">Thread</span>(() -&gt; {</span><br><span class="line">                TaskFactory.spendSeconds(<span class="number">5</span>);</span><br><span class="line">                phaser.arriveAndAwaitAdvance();</span><br><span class="line">                monitor(<span class="number">1</span>, phaser);</span><br><span class="line">                System.out.println(Thread.currentThread().getName() + <span class="string">": continue."</span>);</span><br><span class="line">            }).start();</span><br><span class="line">        });</span><br><span class="line">        monitor(<span class="number">1</span>, phaser);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">monitor</span><span class="params">(<span class="type">int</span> index, Phaser phaser)</span> {</span><br><span class="line">        <span class="type">String</span> <span class="variable">template</span> <span class="operator">=</span> <span class="string">"\t【%s】【monitor-%d】【%30s】%s\n"</span>;</span><br><span class="line">        <span class="type">String</span> <span class="variable">actionName</span> <span class="operator">=</span> Thread.currentThread().getName();</span><br><span class="line">        System.out.printf(template, actionName, index, <span class="string">"phaser.getPhase"</span>, phaser.getPhase());</span><br><span class="line">        System.out.printf(template, actionName, index, <span class="string">"phaser.getRegisteredParties"</span>, phaser.getRegisteredParties());</span><br><span class="line">        System.out.printf(template, actionName, index, <span class="string">"phaser.getArrivedParties"</span>, phaser.getArrivedParties());</span><br><span class="line">        System.out.printf(template, actionName, index, <span class="string">"phaser.getUnarrivedParties"</span>, phaser.getUnarrivedParties());</span><br><span class="line">        System.out.printf(template, actionName, index, <span class="string">"phaser.isTerminated"</span>, phaser.isTerminated());</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<p>输出结果</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">	【main】【monitor-<span class="number">1</span>】【               phaser.getPhase】-<span class="number">2147483648</span></span><br><span class="line">	【main】【monitor-<span class="number">1</span>】【   phaser.getRegisteredParties】<span class="number">2</span></span><br><span class="line">	【main】【monitor-<span class="number">1</span>】【      phaser.getArrivedParties】<span class="number">0</span></span><br><span class="line">	【main】【monitor-<span class="number">1</span>】【    phaser.getUnarrivedParties】<span class="number">2</span></span><br><span class="line">	【main】【monitor-<span class="number">1</span>】【           phaser.isTerminated】<span class="literal">true</span></span><br><span class="line">	【Thread-<span class="number">0</span>】【monitor-<span class="number">1</span>】【               phaser.getPhase】-<span class="number">2147483648</span></span><br><span class="line">	【Thread-<span class="number">0</span>】【monitor-<span class="number">1</span>】【   phaser.getRegisteredParties】<span class="number">2</span></span><br><span class="line">	【Thread-<span class="number">0</span>】【monitor-<span class="number">1</span>】【      phaser.getArrivedParties】<span class="number">0</span></span><br><span class="line">	【Thread-<span class="number">0</span>】【monitor-<span class="number">1</span>】【    phaser.getUnarrivedParties】<span class="number">2</span></span><br><span class="line">	【Thread-<span class="number">0</span>】【monitor-<span class="number">1</span>】【           phaser.isTerminated】<span class="literal">true</span></span><br><span class="line">Thread-<span class="number">0</span>: <span class="keyword">continue</span>.</span><br><span class="line">&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;</span><br><span class="line">	【main】【monitor-<span class="number">1</span>】【               phaser.getPhase】-<span class="number">2147483648</span></span><br><span class="line">	【main】【monitor-<span class="number">1</span>】【   phaser.getRegisteredParties】<span class="number">2</span></span><br><span class="line">	【main】【monitor-<span class="number">1</span>】【      phaser.getArrivedParties】<span class="number">0</span></span><br><span class="line">	【main】【monitor-<span class="number">1</span>】【    phaser.getUnarrivedParties】<span class="number">2</span></span><br><span class="line">	【main】【monitor-<span class="number">1</span>】【           phaser.isTerminated】<span class="literal">true</span></span><br><span class="line">	【Thread-<span class="number">2</span>】【monitor-<span class="number">1</span>】【               phaser.getPhase】-<span class="number">2147483648</span></span><br><span class="line">	【Thread-<span class="number">2</span>】【monitor-<span class="number">1</span>】【   phaser.getRegisteredParties】<span class="number">2</span></span><br><span class="line">	【Thread-<span class="number">2</span>】【monitor-<span class="number">1</span>】【      phaser.getArrivedParties】<span class="number">0</span></span><br><span class="line">	【Thread-<span class="number">2</span>】【monitor-<span class="number">1</span>】【    phaser.getUnarrivedParties】<span class="number">2</span></span><br><span class="line">	【Thread-<span class="number">2</span>】【monitor-<span class="number">1</span>】【           phaser.isTerminated】<span class="literal">true</span></span><br><span class="line">Thread-<span class="number">2</span>: <span class="keyword">continue</span>.</span><br><span class="line">	【Thread-<span class="number">1</span>】【monitor-<span class="number">1</span>】【               phaser.getPhase】-<span class="number">2147483648</span></span><br><span class="line">	【Thread-<span class="number">1</span>】【monitor-<span class="number">1</span>】【   phaser.getRegisteredParties】<span class="number">2</span></span><br><span class="line">	【Thread-<span class="number">1</span>】【monitor-<span class="number">1</span>】【      phaser.getArrivedParties】<span class="number">0</span></span><br><span class="line">	【Thread-<span class="number">1</span>】【monitor-<span class="number">1</span>】【    phaser.getUnarrivedParties】<span class="number">2</span></span><br><span class="line">	【Thread-<span class="number">1</span>】【monitor-<span class="number">1</span>】【           phaser.isTerminated】<span class="literal">true</span></span><br><span class="line">Thread-<span class="number">1</span>: <span class="keyword">continue</span>.</span><br><span class="line"></span><br><span class="line">Process finished with exit code <span class="number">0</span></span><br></pre></td></tr></tbody></table></figure>
<p>[Toc]</p>
<h1>Executor框架</h1>
<h2 id="ExecutorService接口">ExecutorService接口</h2>
<h3 id="ExecutorService-继承树">ExecutorService 继承树</h3>
<p><img src="https://hmxyl-image.oss-cn-hangzhou.aliyuncs.com/note/Executor%E6%A1%86%E6%9E%B6-16588299109821-1667231117133-88.png" alt="Executor框架"></p>
<h3 id="ExecutorService的创建">ExecutorService的创建</h3>
<p>创建一个什么样的ExecutorService的实例（即线程池）需要g根据具体应用场景而定，不过Java给我们提供了一个Executors工厂类，它可以帮助我们很方便的创建各种类型ExecutorService线程池，Executors一共可以创建下面这四类线程池</p>
<ul>
<li>ThreadPoolExecutor 核心构造函数</li>
</ul>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line">  <span class="keyword">import</span> java.util.concurrent.*;</span><br><span class="line"><span class="keyword">import</span> java.util.stream.IntStream;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 测试ThreadPoolExecutor</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ThreadPoolExecutorBuild</span> {</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> {</span><br><span class="line">        <span class="type">ThreadPoolExecutor</span> <span class="variable">threadPoolExecutor</span> <span class="operator">=</span> (ThreadPoolExecutor) buildThreadPoolExecutor();</span><br><span class="line"></span><br><span class="line">        IntStream.rangeClosed(<span class="number">1</span>, <span class="number">50</span>).forEach(index -&gt; threadPoolExecutor.submit(() -&gt; {</span><br><span class="line">            doAction(<span class="number">3</span>);</span><br><span class="line">            monitorThreadPool(threadPoolExecutor, index);</span><br><span class="line">            System.out.println();</span><br><span class="line">            System.out.println();</span><br><span class="line">        }));</span><br><span class="line"></span><br><span class="line">        threadPoolExecutor.shutdown();</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="comment">/** </span></span><br><span class="line"><span class="comment">    * ThreadPoolExecutor 核心构造函数</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> ExecutorService <span class="title function_">buildThreadPoolExecutor</span><span class="params">()</span> {</span><br><span class="line">        <span class="type">int</span> <span class="variable">corePoolSize</span> <span class="operator">=</span> <span class="number">2</span>;</span><br><span class="line">        <span class="type">int</span> <span class="variable">maximumPoolSize</span> <span class="operator">=</span> <span class="number">10</span>;</span><br><span class="line">        <span class="comment">// 当线程数大于核心时，这是多余的空闲线程在终止前等待新任务的最长时间</span></span><br><span class="line">        <span class="type">long</span> <span class="variable">keepAliveTime</span> <span class="operator">=</span> <span class="number">1</span>;</span><br><span class="line">        <span class="type">TimeUnit</span> <span class="variable">timeUnit</span> <span class="operator">=</span> TimeUnit.SECONDS;</span><br><span class="line">        <span class="comment">// 用于在任务完成之前保存任务的队列</span></span><br><span class="line">        BlockingQueue&lt;Runnable&gt; blockingQueue = <span class="keyword">new</span> <span class="title class_">ArrayBlockingQueue</span>&lt;&gt;(<span class="number">30</span>);</span><br><span class="line">        <span class="comment">// 线程创建工厂</span></span><br><span class="line">        <span class="type">ThreadFactory</span> <span class="variable">threadFactory</span> <span class="operator">=</span> r -&gt; <span class="keyword">new</span> <span class="title class_">Thread</span>(r);</span><br><span class="line">        <span class="comment">// 拒绝策略</span></span><br><span class="line">        <span class="type">RejectedExecutionHandler</span> <span class="variable">rejectedExecutionHandler</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ThreadPoolExecutor</span>.AbortPolicy();</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">ThreadPoolExecutor</span>(corePoolSize, maximumPoolSize, keepAliveTime, timeUnit, blockingQueue,</span><br><span class="line">                threadFactory, rejectedExecutionHandler);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">monitorThreadPool</span><span class="params">(ThreadPoolExecutor threadPoolExecutor, <span class="type">int</span> index)</span> {</span><br><span class="line">        System.out.println(index + <span class="string">"【getPoolSize】:"</span> + threadPoolExecutor.getPoolSize());</span><br><span class="line">        System.out.println(index + <span class="string">"【getActiveCount】:"</span> + threadPoolExecutor.getActiveCount());</span><br><span class="line">        System.out.println(index + <span class="string">"【getMaximumPoolSize】:"</span> + threadPoolExecutor.getMaximumPoolSize());</span><br><span class="line">        System.out.println(index + <span class="string">"【getCompletedTaskCount】:"</span> + threadPoolExecutor.getCompletedTaskCount());</span><br><span class="line">        System.out.println(index + <span class="string">"【getCorePoolSize】:"</span> + threadPoolExecutor.getCorePoolSize());</span><br><span class="line">        System.out.println(index + <span class="string">"【getLargestPoolSize】:"</span> + threadPoolExecutor.getLargestPoolSize());</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">doAction</span><span class="params">(<span class="type">int</span> seconds)</span> {</span><br><span class="line">        <span class="keyword">try</span> {</span><br><span class="line">            TimeUnit.SECONDS.sleep(seconds);</span><br><span class="line">        } <span class="keyword">catch</span> (InterruptedException e) {</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(e);</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<p>Executors只是一个工厂类，它所有的方法返回的都是ThreadPoolExecutor、ScheduledThreadPoolExecutor这两个类的实例</p>
<h3 id="ExecutorService的执行">ExecutorService的执行</h3>
<p>ExecutorService有如下几个执行方法：</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">- execute(Runnable)</span><br><span class="line">- submit(Runnable)</span><br><span class="line">- submit(Callable)</span><br><span class="line">- invokeAny(...)</span><br><span class="line">- invokeAll(...)</span><br></pre></td></tr></tbody></table></figure>
<ul>
<li>execute(Runnable)</li>
</ul>
<p>这个方法接收一个Runnable实例，并且异步的执行，请看下面的实例：</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">ExecutorService</span> <span class="variable">executorService</span> <span class="operator">=</span> Executors.newSingleThreadExecutor();</span><br><span class="line"></span><br><span class="line">executorService.execute(<span class="keyword">new</span> <span class="title class_">Runnable</span>() {</span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> {</span><br><span class="line">     System.out.println(<span class="string">"Asynchronous task"</span>);</span><br><span class="line">  }</span><br><span class="line">});</span><br><span class="line"></span><br><span class="line">executorService.shutdown();</span><br></pre></td></tr></tbody></table></figure>
<p>这个方法有个问题，就是没有办法获知task的执行结果。</p>
<ul>
<li>submit(Runnable)</li>
</ul>
<p>submit(Runnable)和execute(Runnable)</p>
<p>区别是前者可以返回一个Future对象，通过返回的Future对象，我们可以检查提交的任务是否执行完毕</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">Future</span> <span class="variable">future</span> <span class="operator">=</span> executorService.submit(<span class="keyword">new</span> <span class="title class_">Runnable</span>() {</span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> {</span><br><span class="line">      System.out.println(<span class="string">"Asynchronous task"</span>);</span><br><span class="line">  }</span><br><span class="line">});</span><br><span class="line">future.get();  <span class="comment">//returns null if the task has finished correctly.</span></span><br></pre></td></tr></tbody></table></figure>
<p>如果任务执行完成，future.get()方法会返回一个null。注意，future.get()方法会产生阻塞。</p>
<ul>
<li>submit(Callable)</li>
</ul>
<p>submit(Callable) 和submit(Runnable)类似，也会返回一个Future对象，但是除此之外，submit(Callable)接收的是一个Callable的实现，Callable接口中的call()方法有一个返回值，可以返回任务的执行结果，而Runnable接口中的run()方法是void的，没有返回值。</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">Future</span> <span class="variable">future</span> <span class="operator">=</span> executorService.submit(<span class="keyword">new</span> <span class="title class_">Callable</span>(){</span><br><span class="line">	<span class="keyword">public</span> Object <span class="title function_">call</span><span class="params">()</span> <span class="keyword">throws</span> Exception {</span><br><span class="line">    	System.out.println(<span class="string">"Asynchronous Callable"</span>);</span><br><span class="line">    	<span class="keyword">return</span> <span class="string">"Callable Result"</span>;</span><br><span class="line">	}</span><br><span class="line">});</span><br><span class="line"></span><br><span class="line">System.out.println(<span class="string">"future.get() = "</span> + future.get());</span><br></pre></td></tr></tbody></table></figure>
<p>future.get()方法会返回Callable任务的执行结果。注意，future.get()方法会产生阻塞。</p>
<ul>
<li>invokeAny(…)</li>
</ul>
<p>invokeAny(…)方法接收的是一个Callable的集合，执行这个方法不会返回Future，但是会返回所有Callable任务中其中一个任务的执行结果。这个方法也无法保证返回的是哪个任务的执行结果，反正是其中的某一个</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">ExecutorService</span> <span class="variable">executorService</span> <span class="operator">=</span> Executors.newSingleThreadExecutor();</span><br><span class="line"></span><br><span class="line">Set&lt;Callable&lt;String&gt;&gt; callables = <span class="keyword">new</span> <span class="title class_">HashSet</span>&lt;Callable&lt;String&gt;&gt;();</span><br><span class="line"></span><br><span class="line">callables.add(<span class="keyword">new</span> <span class="title class_">Callable</span>&lt;String&gt;() {</span><br><span class="line">	<span class="keyword">public</span> String <span class="title function_">call</span><span class="params">()</span> <span class="keyword">throws</span> Exception {</span><br><span class="line"> 	   <span class="keyword">return</span> <span class="string">"Task 1"</span>;</span><br><span class="line">	}</span><br><span class="line">});</span><br><span class="line">callables.add(<span class="keyword">new</span> <span class="title class_">Callable</span>&lt;String&gt;() {</span><br><span class="line">	<span class="keyword">public</span> String <span class="title function_">call</span><span class="params">()</span> <span class="keyword">throws</span> Exception {</span><br><span class="line">	    <span class="keyword">return</span> <span class="string">"Task 2"</span>;</span><br><span class="line">	}</span><br><span class="line">});</span><br><span class="line">callables.add(<span class="keyword">new</span> <span class="title class_">Callable</span>&lt;String&gt;() {</span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">call</span><span class="params">()</span> <span class="keyword">throws</span> Exception {</span><br><span class="line">    <span class="keyword">return</span> <span class="string">"Task 3"</span>;</span><br><span class="line">	}</span><br><span class="line">});</span><br><span class="line"></span><br><span class="line"><span class="type">String</span> <span class="variable">result</span> <span class="operator">=</span> executorService.invokeAny(callables);</span><br><span class="line">System.out.println(<span class="string">"result = "</span> + result);</span><br><span class="line">executorService.shutdown();</span><br></pre></td></tr></tbody></table></figure>
<p>每次执行都会返回一个结果，并且返回的结果是变化的，可能会返回“Task2”也可是“Task1”或者其它。</p>
<ul>
<li>nvokeAll(…)</li>
</ul>
<p>invokeAll(…)与 invokeAny(…)类似也是接收一个Callable集合，但是前者执行之后会返回一个Future的List，其中对应着每个Callable任务执行后的Future对象</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">ExecutorService</span> <span class="variable">executorService</span> <span class="operator">=</span> Executors.newSingleThreadExecutor();</span><br><span class="line"></span><br><span class="line">List&lt;Callable&lt;String&gt;&gt; callables = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;Callable&lt;String&gt;&gt;();</span><br><span class="line"></span><br><span class="line">callables.add(<span class="keyword">new</span> <span class="title class_">Callable</span>&lt;String&gt;() {</span><br><span class="line"><span class="keyword">public</span> String <span class="title function_">call</span><span class="params">()</span> <span class="keyword">throws</span> Exception {</span><br><span class="line">    <span class="keyword">return</span> <span class="string">"Task 1"</span>;</span><br><span class="line">}</span><br><span class="line">});</span><br><span class="line">callables.add(<span class="keyword">new</span> <span class="title class_">Callable</span>&lt;String&gt;() {</span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">call</span><span class="params">()</span> <span class="keyword">throws</span> Exception {</span><br><span class="line">    <span class="keyword">return</span> <span class="string">"Task 2"</span>;</span><br><span class="line">}</span><br><span class="line">});</span><br><span class="line">callables.add(<span class="keyword">new</span> <span class="title class_">Callable</span>&lt;String&gt;() {</span><br><span class="line"><span class="keyword">public</span> String <span class="title function_">call</span><span class="params">()</span> <span class="keyword">throws</span> Exception {</span><br><span class="line">    <span class="keyword">return</span> <span class="string">"Task 3"</span>;</span><br><span class="line">}</span><br><span class="line">});</span><br><span class="line"></span><br><span class="line">List&lt;Future&lt;String&gt;&gt; futures = executorService.invokeAll(callables);</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span>(Future&lt;String&gt; future : futures){</span><br><span class="line">System.out.println(<span class="string">"future.get = "</span> + future.get());</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line">executorService.shutdown();</span><br></pre></td></tr></tbody></table></figure>
<p><code>List&lt;Callable&lt;String&gt;&gt; callables</code> 返回的结果集是无序的。</p>
<h3 id="ExecutorService的关闭">ExecutorService的关闭</h3>
<p>当我们使用完成ExecutorService之后应该关闭它，否则它里面的线程会一直处于运行状态。</p>
<ul>
<li>
<p>void shutdown()</p>
</li>
<li>
<p>List<runnable> shutdownNow()</runnable></p>
</li>
</ul>
<p><img src="https://hmxyl-image.oss-cn-hangzhou.aliyuncs.com/note/image-20220725112237287-1667231117133-90.png" alt="image-20220725112237287"></p>
<h2 id="Executors工具">Executors工具</h2>
<p><strong>利用：ThreadPoolExecutor(int corePoolSize, int maximumPoolSize,  long keepAliveTime, TimeUnit unit, BlockingQueue<runnable> workQueue,  ThreadFactory threadFactory, RejectedExecutionHandler handler)</runnable></strong></p>
<table>
<thead>
<tr>
<th>Executors模板方法</th>
<th>特性</th>
<th>corePoolSize</th>
<th>maximumPoolSize</th>
<th>keepAliveTime</th>
<th>unit</th>
<th>workQueue</th>
<th>threadFactory</th>
<th>handler</th>
</tr>
</thead>
<tbody>
<tr>
<td>newFixedThreadPool(int  nThreads)</td>
<td>线程池中的线程不会被销毁</td>
<td>nThreads</td>
<td>nThreads</td>
<td>0L</td>
<td>TimeUnit.MILLISECONDS</td>
<td><font color="red"> new LinkedBlockingQueue<runnable>(Integer.MAX_VALUE)</runnable></font></td>
<td>Executors.defaultThreadFactory()</td>
<td>defaultHandler（new  AbortPolicy()）</td>
</tr>
<tr>
<td>newFixedThreadPool(int  nThreads, ThreadFactory threadFactory)</td>
<td>线程池中的线程不会被销毁</td>
<td>nThreads</td>
<td>nThreads</td>
<td>0L</td>
<td>TimeUnit.MILLISECONDS</td>
<td>new LinkedBlockingQueue<runnable>(Integer.MAX_VALUE)</runnable></td>
<td>Executors.defaultThreadFactory()</td>
<td>defaultHandler（new  AbortPolicy()）</td>
</tr>
<tr>
<td>newSingleThreadExecutor</td>
<td>可以保留单线程需要执行的任务队列,并且将ThreadPoolExecutor中的方法屏蔽</td>
<td>1</td>
<td>1</td>
<td>0L</td>
<td>TimeUnit.MILLISECONDS</td>
<td>new LinkedBlockingQueue<runnable>(Integer.MAX_VALUE)</runnable></td>
<td>Executors.defaultThreadFactory()</td>
<td>defaultHandler（new  AbortPolicy()）</td>
</tr>
<tr>
<td>newSingleThreadExecutor(ThreadFactory  threadFactory)</td>
<td>可以保留单线程需要执行的任务队列,并且将ThreadPoolExecutor中的方法屏蔽</td>
<td>1</td>
<td>1</td>
<td>0L</td>
<td>TimeUnit.MILLISECONDS</td>
<td>new LinkedBlockingQueue<runnable>(Integer.MAX_VALUE)</runnable></td>
<td>threadFactory</td>
<td>defaultHandler（new  AbortPolicy()）</td>
</tr>
<tr>
<td>newCachedThreadPool()</td>
<td>每提交一个任务,创建一个线程</td>
<td>0</td>
<td>Integer.MAX_VALUE</td>
<td>60L</td>
<td>TimeUnit.SECONDS</td>
<td><font color="red">new SynchronousQueue<runnable>()</runnable></font></td>
<td>Executors.defaultThreadFactory()</td>
<td>defaultHandler（new  AbortPolicy()）</td>
</tr>
<tr>
<td>newCachedThreadPool(ThreadFactory  threadFactory)</td>
<td>每提交一个任务,创建一个线程</td>
<td>0</td>
<td>Integer.MAX_VALUE</td>
<td>60L</td>
<td>TimeUnit.SECONDS</td>
<td>new SynchronousQueue<runnable>()</runnable></td>
<td>threadFactory</td>
<td>defaultHandler（new  AbortPolicy()）</td>
</tr>
<tr>
<td>newSingleThreadScheduledExecutor()</td>
<td></td>
<td>0</td>
<td>Integer.MAX_VALUE</td>
<td>60L</td>
<td>TimeUnit.SECONDS</td>
<td>new DelayedWorkQueue()</td>
<td>Executors.defaultThreadFactory()</td>
<td>defaultHandler（new  AbortPolicy()）</td>
</tr>
<tr>
<td>newSingleThreadScheduledExecutor(ThreadFactory  threadFactory)</td>
<td></td>
<td>0</td>
<td>Integer.MAX_VALUE</td>
<td>60L</td>
<td>TimeUnit.SECONDS</td>
<td><font color="red">new DelayedWorkQueue()</font></td>
<td>threadFactory</td>
<td>defaultHandler（new  AbortPolicy()）</td>
</tr>
<tr>
<td>newScheduledThreadPool(int  corePoolSize)</td>
<td></td>
<td>corePoolSize</td>
<td>Integer.MAX_VALUE</td>
<td>0</td>
<td>TimeUnit.NANOSECONDS</td>
<td>new DelayedWorkQueue()</td>
<td>Executors.defaultThreadFactory()</td>
<td>defaultHandler（new  AbortPolicy()）</td>
</tr>
<tr>
<td>newScheduledThreadPool(int  corePoolSize, ThreadFactory threadFactory)</td>
<td></td>
<td>corePoolSize</td>
<td>Integer.MAX_VALUE</td>
<td>0</td>
<td>TimeUnit.NANOSECONDS</td>
<td>new DelayedWorkQueue()</td>
<td>threadFactory</td>
<td>defaultHandler（new  AbortPolicy()）</td>
</tr>
</tbody>
</table>
<p><strong>利用ForkJoinPool(int parallelism,  ForkJoinWorkerThreadFactory factory,  UncaughtExceptionHandler handler,  boolean asyncMode)</strong></p>
<table>
<thead>
<tr>
<th>Executors模板方法</th>
<th>int parallelism</th>
<th>ForkJoinWorkerThreadFactory  factory</th>
<th>UncaughtExceptionHandler handler</th>
<th>boolean asyncMode</th>
</tr>
</thead>
<tbody>
<tr>
<td>newWorkStealingPool()</td>
<td>Runtime.getRuntime().availableProcessors()</td>
<td>ForkJoinPool.defaultForkJoinWorkerThreadFactory</td>
<td>null</td>
<td>TRUE</td>
</tr>
<tr>
<td>newWorkStealingPool(int  parallelism)</td>
<td>parallelism</td>
<td>ForkJoinPool.defaultForkJoinWorkerThreadFactory</td>
<td>null</td>
<td>TRUE</td>
</tr>
</tbody>
</table>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> hots.utils.executor;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.Callable;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.ExecutorService;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.Executors;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.TimeUnit;</span><br><span class="line"><span class="keyword">import</span> java.util.stream.Collectors;</span><br><span class="line"><span class="keyword">import</span> java.util.stream.IntStream;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ExecutorsExample</span> {</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> InterruptedException {</span><br><span class="line">        <span class="type">ExecutorService</span> <span class="variable">executorService</span> <span class="operator">=</span> Executors.newWorkStealingPool();</span><br><span class="line">        List&lt;Future&lt;String&gt;&gt; futures = executorService.invokeAll(getTasks());</span><br><span class="line">        executorService.shutdown();</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="keyword">static</span> List&lt;Callable&lt;String&gt;&gt; <span class="title function_">getTasks</span><span class="params">()</span> {</span><br><span class="line">        <span class="keyword">return</span> IntStream.rangeClosed(<span class="number">0</span>, <span class="number">20</span>).boxed().map(i -&gt; {</span><br><span class="line">            Callable&lt;String&gt; stringCallable = () -&gt; {</span><br><span class="line">                System.out.println(Thread.currentThread().getName());</span><br><span class="line">                doAction(<span class="number">1</span>);</span><br><span class="line">                <span class="keyword">return</span> <span class="string">"Task:"</span> + i;</span><br><span class="line">            };</span><br><span class="line">            <span class="keyword">return</span> stringCallable;</span><br><span class="line">        }).collect(Collectors.toList());</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">doAction</span><span class="params">(<span class="type">int</span> seconds)</span> {</span><br><span class="line">        <span class="keyword">try</span> {</span><br><span class="line">            TimeUnit.SECONDS.sleep(seconds);</span><br><span class="line">        } <span class="keyword">catch</span> (InterruptedException e) {</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(e);</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<h2 id="ThreadPoolExecutor">ThreadPoolExecutor</h2>
<h3 id="四个内置拒绝策略">四个内置拒绝策略</h3>
<ul>
<li>继承自RejectedExecutionHandler</li>
</ul>
<p><img src="https://hmxyl-image.oss-cn-hangzhou.aliyuncs.com/note/image-20220725171152798-1667231117133-91.png" alt="image-20220725171152798"></p>
<table>
<thead>
<tr>
<th>策略</th>
<th>说明</th>
</tr>
</thead>
<tbody>
<tr>
<td>AbortPolicy</td>
<td>抛出RejectedExecutionException异常</td>
</tr>
<tr>
<td>DiscardPolicy</td>
<td>默默地丢弃被拒绝的任务</td>
</tr>
<tr>
<td>DiscardOldestPolicy</td>
<td>丢弃最早的未处理请求，然后重试执行请求任务。若任务已被关闭，则丢弃任务</td>
</tr>
<tr>
<td>CallerRunsPolicy</td>
<td>直接在执行方法的调用线程中运行被拒绝的任务。若任务已被关闭，则丢弃任务</td>
</tr>
</tbody>
</table>
<h3 id="自定义ThreadFactory">自定义ThreadFactory</h3>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> lombok.Data;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.ArrayList;</span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.ThreadFactory;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.atomic.AtomicInteger;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MyThreadFactory</span> <span class="keyword">implements</span> <span class="title class_">ThreadFactory</span> {</span><br><span class="line">    <span class="keyword">private</span> <span class="type">AtomicInteger</span> <span class="variable">SEQ</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">AtomicInteger</span>();</span><br><span class="line">    <span class="keyword">private</span> List&lt;FailedAction&gt; failed = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Thread <span class="title function_">newThread</span><span class="params">(Runnable r)</span> {</span><br><span class="line">        <span class="type">Thread</span> <span class="variable">thread</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Thread</span>(r);</span><br><span class="line">        thread.setName(<span class="string">"Factory-"</span> + SEQ.getAndIncrement());</span><br><span class="line">        thread.setUncaughtExceptionHandler((t, e) -&gt; {</span><br><span class="line">            <span class="comment">// 保留异常信息</span></span><br><span class="line">            failed.add(<span class="keyword">new</span> <span class="title class_">FailedAction</span>(t, e));</span><br><span class="line">        });</span><br><span class="line">        <span class="keyword">return</span> thread;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Data</span></span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">FailedAction</span> {</span><br><span class="line">        <span class="keyword">private</span> Thread thread;</span><br><span class="line">        <span class="keyword">private</span> Throwable throwable;</span><br><span class="line"></span><br><span class="line">        FailedAction(Thread t, Throwable e) {</span><br><span class="line">            <span class="built_in">this</span>.thread = t;</span><br><span class="line">            <span class="built_in">this</span>.throwable = e;</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> java.util.concurrent.ExecutorService;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.Executors;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MyThreadFactoryTest</span> {</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> {</span><br><span class="line">        <span class="type">MyThreadFactory</span> <span class="variable">myThreadFactory</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">MyThreadFactory</span>();</span><br><span class="line">        <span class="type">ExecutorService</span> <span class="variable">executorService</span> <span class="operator">=</span> Executors.newFixedThreadPool(<span class="number">1</span>, myThreadFactory);</span><br><span class="line">        executorService.execute(() -&gt; System.out.println(<span class="number">1</span> / <span class="number">0</span>));</span><br><span class="line">        myThreadFactory.getFailed().stream().map(e -&gt; e.getThrowable()).forEach(e -&gt; e.printStackTrace());</span><br><span class="line">        executorService.shutdown();</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<h3 id="允许回收执行线程：allowCoreThreadTimeOut">允许回收执行线程：allowCoreThreadTimeOut</h3>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">volatile</span> <span class="type">boolean</span> allowCoreThreadTimeOut;</span><br></pre></td></tr></tbody></table></figure>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">AllowCoreThreadTimeOutTest</span> {</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> {</span><br><span class="line">        <span class="type">ThreadPoolExecutor</span> <span class="variable">executorService</span> <span class="operator">=</span> (ThreadPoolExecutor) Executors.newFixedThreadPool(<span class="number">2</span>);</span><br><span class="line">        executorService.setKeepAliveTime(<span class="number">10</span>, TimeUnit.SECONDS);</span><br><span class="line">        executorService.submit(() -&gt; System.out.println(Thread.currentThread().getName()));</span><br><span class="line">        executorService.allowCoreThreadTimeOut(<span class="literal">true</span>);</span><br><span class="line">    }</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"># <span class="number">10</span>秒后线程池被销毁，测试进程退出</span><br></pre></td></tr></tbody></table></figure>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">AllowCoreThreadTimeOutTest</span> {</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> {</span><br><span class="line">        <span class="type">ThreadPoolExecutor</span> <span class="variable">executorService</span> <span class="operator">=</span> (ThreadPoolExecutor) Executors.newFixedThreadPool(<span class="number">2</span>);</span><br><span class="line">        executorService.setKeepAliveTime(<span class="number">10</span>, TimeUnit.SECONDS);</span><br><span class="line">        executorService.submit(() -&gt; System.out.println(Thread.currentThread().getName()));</span><br><span class="line">        executorService.allowCoreThreadTimeOut(<span class="literal">false</span>);</span><br><span class="line">    }</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"># 测试进程无法退出，executorService保有<span class="number">2</span>个活跃的执行线程</span><br></pre></td></tr></tbody></table></figure>
<h3 id="删除任务：remove">删除任务：remove</h3>
<p>适用于<code>executorService.execute(e) </code>提交的任务，而<code>executorService.submit(e)</code> 提交的任务，无法移除。submit 提交的任务</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">RemoveTest</span> {</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> {</span><br><span class="line">        <span class="type">ThreadPoolExecutor</span> <span class="variable">executorService</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ThreadPoolExecutor</span>(<span class="number">2</span>, <span class="number">2</span>, <span class="number">0</span>, TimeUnit.SECONDS,</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">ArrayBlockingQueue</span>&lt;&gt;(<span class="number">2</span>));</span><br><span class="line"></span><br><span class="line">        List&lt;Runnable&gt; runnableList = IntStream.rangeClosed(<span class="number">0</span>, <span class="number">3</span>).boxed().map(i -&gt; (Runnable) () -&gt; {</span><br><span class="line">                    sleep(<span class="number">5</span>);</span><br><span class="line">                    System.out.println(<span class="string">"task:"</span> + i + <span class="string">" with "</span> + Thread.currentThread().getName());</span><br><span class="line">                }</span><br><span class="line">        ).collect(Collectors.toList());</span><br><span class="line">        runnableList.stream().forEach(e -&gt; executorService.execute(e));</span><br><span class="line"></span><br><span class="line">        sleep(<span class="number">1</span>);</span><br><span class="line">        <span class="type">boolean</span> <span class="variable">result</span> <span class="operator">=</span> executorService.remove(runnableList.get(<span class="number">2</span>));</span><br><span class="line">        System.out.println(<span class="string">"remove result : "</span> + result);</span><br><span class="line"></span><br><span class="line">        sleep(<span class="number">6</span>);</span><br><span class="line">        executorService.shutdown();</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">sleep</span><span class="params">(<span class="type">int</span> seconds)</span> {</span><br><span class="line">        <span class="keyword">try</span> {</span><br><span class="line">            TimeUnit.SECONDS.sleep(seconds);</span><br><span class="line">        } <span class="keyword">catch</span> (Exception e) {</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<h3 id="prestartCoreThread-：-启动一个执行线程">prestartCoreThread ： 启动一个执行线程</h3>
<h3 id="prestartAllCoreThreads：启动所有执行线程">prestartAllCoreThreads：启动所有执行线程</h3>
<h3 id="beforeExecute-afterExecute">beforeExecute/afterExecute</h3>
<p>自定义ThreadPoolExecutor的子类，覆写。</p>
<h2 id="Future与FutureTask">Future与FutureTask</h2>
<h3 id="Future-接口">Future 接口</h3>
<table>
<thead>
<tr>
<th>接口方法</th>
</tr>
</thead>
<tbody>
<tr>
<td>V get() throws InterruptedException, ExecutionException;</td>
</tr>
<tr>
<td>V get(long timeout, TimeUnit unit)     throws InterruptedException, ExecutionException, TimeoutException;</td>
</tr>
<tr>
<td>boolean isDone();</td>
</tr>
<tr>
<td>boolean cancel(boolean mayInterruptIfRunning);</td>
</tr>
<tr>
<td>boolean isCancelled();</td>
</tr>
</tbody>
</table>
<ul>
<li><code>cancel</code>：取消任务，如果取消任务成功则返回true，如果取消任务失败则返回false。参数<code>mayInterruptIfRunning</code>表示是否允许取消正在执行却没有执行完毕的任务：
<ol>
<li>如果设置true，则表示可以取消正在执行过程中的任务</li>
<li>如果任务已经完成，则无论mayInterruptIfRunning为true还是false，此方法肯定返回false</li>
<li>如果任务正在执行，若mayInterruptIfRunning设置为true，则返回true，若mayInterruptIfRunning设置为false，则返回false</li>
<li>如果任务还没有执行，则无论mayInterruptIfRunning为true还是false，肯定返回true</li>
</ol>
</li>
<li><code>isCancelled</code>：方法表示任务是否被取消成功，如果在任务正常完成前被取消成功，则返回 true</li>
<li><code>isDone</code>：判断任务是否已经完成，已完成则返回true；</li>
<li><code>get()</code>：获取执行结果，这个方法会产生阻塞，会一直等到任务执行完毕才返回；</li>
<li><code> get(long timeout, TimeUnit unit)</code>：用来获取执行结果，如果在指定时间内，还没获取到结果，就直接返回null</li>
</ul>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> java.util.concurrent.ExecutorService;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.Executors;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.Future;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.TimeUnit;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * boolean cancel(boolean mayInterruptIfRunning);</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">FutureExample</span> {</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> InterruptedException {</span><br><span class="line">        <span class="type">ExecutorService</span> <span class="variable">executorService</span> <span class="operator">=</span> Executors.newSingleThreadExecutor();</span><br><span class="line">        Future&lt;String&gt; result = executorService.submit(() -&gt; {</span><br><span class="line">            <span class="keyword">while</span> (!Thread.currentThread().isInterrupted()) {</span><br><span class="line">            }</span><br><span class="line">            <span class="keyword">return</span> <span class="string">"done"</span>;</span><br><span class="line">        });</span><br><span class="line"></span><br><span class="line">        sleep(<span class="number">1</span>);</span><br><span class="line">        System.out.println(result.cancel(<span class="literal">true</span>));</span><br><span class="line"></span><br><span class="line">        executorService.shutdown();</span><br><span class="line">        System.out.println(<span class="string">"all done"</span>);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">sleep</span><span class="params">(<span class="type">int</span> seconds)</span> {</span><br><span class="line">        <span class="keyword">try</span> {</span><br><span class="line">            TimeUnit.SECONDS.sleep(seconds);</span><br><span class="line">        } <span class="keyword">catch</span> (Exception e) {</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line">}</span><br><span class="line"></span><br></pre></td></tr></tbody></table></figure>
<h3 id="FutureTask类">FutureTask类</h3>
<p>FutureTask类实现了RunnableFuture接口，RunnableFuture接口又继承了Runable和Future，可见，FutureTask既可以作为Runnable被线程执行，又可以作为Future得到Callable的返回值。</p>
<p>FutureTask类图如下</p>
<p><img src="https://hmxyl-image.oss-cn-hangzhou.aliyuncs.com/note/1620-1667231117133-93.png" alt="img"></p>
<p>FutureTask两个构造函数：</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">FutureTask(Callable&lt;V&gt; callable);</span><br><span class="line">FutureTask(Runnable runnable, V result);</span><br></pre></td></tr></tbody></table></figure>
<p>使用FutureTask来实现Future多线程获取任务结果的场景</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> java.util.Date;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.*;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">FutureTaskTest</span> {</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> {</span><br><span class="line">        <span class="type">ExecutorService</span> <span class="variable">executor</span> <span class="operator">=</span> Executors.newCachedThreadPool();</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; <span class="number">3</span>; i++) {</span><br><span class="line">            Callable&lt;String&gt; callable = <span class="keyword">new</span> <span class="title class_">Task</span>(<span class="number">8</span> - i);</span><br><span class="line">            <span class="type">MyFutureTask</span> <span class="variable">task</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">MyFutureTask</span>(callable);</span><br><span class="line">            executor.submit(task);</span><br><span class="line">        }</span><br><span class="line">        executor.shutdown();</span><br><span class="line">    }</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">MyFutureTask</span> <span class="keyword">extends</span> <span class="title class_">FutureTask</span>&lt;String&gt; {</span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">MyFutureTask</span><span class="params">(Callable&lt;String&gt; callable)</span> {</span><br><span class="line">        <span class="built_in">super</span>(callable);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">done</span><span class="params">()</span> {</span><br><span class="line">        <span class="keyword">try</span> {</span><br><span class="line">            System.out.println(get() + <span class="string">"完成："</span> + <span class="keyword">new</span> <span class="title class_">Date</span>());</span><br><span class="line">        } <span class="keyword">catch</span> (InterruptedException | ExecutionException e) {</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Task</span> <span class="keyword">implements</span> <span class="title class_">Callable</span>&lt;String&gt; {</span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> time;</span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">Task</span><span class="params">(<span class="type">int</span> time)</span> {</span><br><span class="line">        <span class="built_in">this</span>.time = time;</span><br><span class="line">    }</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">call</span><span class="params">()</span> <span class="keyword">throws</span> InterruptedException {</span><br><span class="line">        <span class="type">String</span> <span class="variable">name</span> <span class="operator">=</span> Thread.currentThread().getName();</span><br><span class="line">        System.out.println(name + <span class="string">"启动："</span> + <span class="keyword">new</span> <span class="title class_">Date</span>());</span><br><span class="line">        TimeUnit.SECONDS.sleep(time);</span><br><span class="line">        <span class="keyword">return</span> name;</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<p>输出结果：</p>
<figure class="highlight javascript"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">pool-<span class="number">1</span>-thread-<span class="number">1</span>启动：<span class="title class_">Fri</span> <span class="title class_">Nov</span> <span class="number">08</span> <span class="number">17</span>:<span class="number">35</span>:<span class="number">26</span> <span class="variable constant_">CST</span> <span class="number">2019</span></span><br><span class="line">pool-<span class="number">1</span>-thread-<span class="number">3</span>启动：<span class="title class_">Fri</span> <span class="title class_">Nov</span> <span class="number">08</span> <span class="number">17</span>:<span class="number">35</span>:<span class="number">26</span> <span class="variable constant_">CST</span> <span class="number">2019</span></span><br><span class="line">pool-<span class="number">1</span>-thread-<span class="number">2</span>启动：<span class="title class_">Fri</span> <span class="title class_">Nov</span> <span class="number">08</span> <span class="number">17</span>:<span class="number">35</span>:<span class="number">26</span> <span class="variable constant_">CST</span> <span class="number">2019</span></span><br><span class="line">pool-<span class="number">1</span>-thread-<span class="number">3</span>完成：<span class="title class_">Fri</span> <span class="title class_">Nov</span> <span class="number">08</span> <span class="number">17</span>:<span class="number">35</span>:<span class="number">32</span> <span class="variable constant_">CST</span> <span class="number">2019</span></span><br><span class="line">pool-<span class="number">1</span>-thread-<span class="number">2</span>完成：<span class="title class_">Fri</span> <span class="title class_">Nov</span> <span class="number">08</span> <span class="number">17</span>:<span class="number">35</span>:<span class="number">33</span> <span class="variable constant_">CST</span> <span class="number">2019</span></span><br><span class="line">pool-<span class="number">1</span>-thread-<span class="number">1</span>完成：<span class="title class_">Fri</span> <span class="title class_">Nov</span> <span class="number">08</span> <span class="number">17</span>:<span class="number">35</span>:<span class="number">34</span> <span class="variable constant_">CST</span> <span class="number">2019</span></span><br></pre></td></tr></tbody></table></figure>
<h2 id="CompletionService接口">CompletionService接口</h2>
<p>我们知道，通过 Future 和 FutureTask 可以获得线程任务的执行结果，但它们有一定的缺陷：</p>
<ul>
<li>Future：多个线程任务的执行结果，我们可以通过轮询的方式去获取，但普通轮询会有被阻塞的可能，升级轮询会非常消耗cpu</li>
<li>FutureTask：虽然我们可以调用 done 方法，在线程任务执行结束后立即返回或做其他处理，但对批量线程任务结果的管理方面有所不足</li>
</ul>
<p>为了更好地应对大量线程任务结果处理的问题，JDK提供了功能强大的 CompletionService。CompletionService是一个接口，使用创建时提供的 Executor 对象（通常是线程池）来执行任务，并在内部维护了一个阻塞队列<code>QueueingFuture</code>，当任务执行结束就把任务的执行结果的<code>Future</code>对象加入到阻塞队列中。</p>
<p>该接口只有一个实现类： <code>ExecutorCompletionService</code></p>
<blockquote>
<p>ExecutorCompletionService  的构造函数</p>
</blockquote>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Creates an ExecutorCompletionService using the supplied</span></span><br><span class="line"><span class="comment"> * executor for base task execution and a</span></span><br><span class="line"><span class="comment"> * {<span class="doctag">@link</span> LinkedBlockingQueue} as a completion queue.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> executor the executor to use</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@throws</span> NullPointerException if executor is {<span class="doctag">@code</span> null}</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="title function_">ExecutorCompletionService</span><span class="params">(Executor executor)</span> {</span><br><span class="line">	<span class="keyword">if</span> (executor == <span class="literal">null</span>)</span><br><span class="line">		<span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">NullPointerException</span>();</span><br><span class="line">	<span class="built_in">this</span>.executor = executor;</span><br><span class="line">	<span class="built_in">this</span>.aes = (executor <span class="keyword">instanceof</span> AbstractExecutorService) ?</span><br><span class="line">		(AbstractExecutorService) executor : <span class="literal">null</span>;</span><br><span class="line">	<span class="built_in">this</span>.completionQueue = <span class="keyword">new</span> <span class="title class_">LinkedBlockingQueue</span>&lt;Future&lt;V&gt;&gt;();</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Creates an ExecutorCompletionService using the supplied</span></span><br><span class="line"><span class="comment"> * executor for base task execution and the supplied queue as its</span></span><br><span class="line"><span class="comment"> * completion queue.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> executor the executor to use</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> completionQueue the queue to use as the completion queue</span></span><br><span class="line"><span class="comment"> *        normally one dedicated for use by this service. This</span></span><br><span class="line"><span class="comment"> *        queue is treated as unbounded -- failed attempted</span></span><br><span class="line"><span class="comment"> *        {<span class="doctag">@code</span> Queue.add} operations for completed tasks cause</span></span><br><span class="line"><span class="comment"> *        them not to be retrievable.</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@throws</span> NullPointerException if executor or completionQueue are {<span class="doctag">@code</span> null}</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="title function_">ExecutorCompletionService</span><span class="params">(Executor executor,</span></span><br><span class="line"><span class="params">								 BlockingQueue&lt;Future&lt;V&gt;&gt; completionQueue)</span> {</span><br><span class="line">	<span class="keyword">if</span> (executor == <span class="literal">null</span> || completionQueue == <span class="literal">null</span>)</span><br><span class="line">		<span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">NullPointerException</span>();</span><br><span class="line">	<span class="built_in">this</span>.executor = executor;</span><br><span class="line">	<span class="built_in">this</span>.aes = (executor <span class="keyword">instanceof</span> AbstractExecutorService) ?</span><br><span class="line">		(AbstractExecutorService) executor : <span class="literal">null</span>;</span><br><span class="line">	<span class="built_in">this</span>.completionQueue = completionQueue;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<p>这两个构造方法都需要传入一个线程池，如果不指定 <code>completionQueue</code>，那么默认会使用无界的 <code>LinkedBlockingQueue</code>。任务执行结果的 Future 对象就是加入到 completionQueue 中。</p>
<blockquote>
<p>CompletionService 接口方法</p>
</blockquote>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">CompletionService</span>&lt;V&gt; {</span><br><span class="line">    <span class="comment">//提交线程任务</span></span><br><span class="line">    Future&lt;V&gt; <span class="title function_">submit</span><span class="params">(Callable&lt;V&gt; task)</span>;</span><br><span class="line">    <span class="comment">//提交线程任务</span></span><br><span class="line">    Future&lt;V&gt; <span class="title function_">submit</span><span class="params">(Runnable task, V result)</span>;</span><br><span class="line">    <span class="comment">//阻塞等待</span></span><br><span class="line">    Future&lt;V&gt; <span class="title function_">take</span><span class="params">()</span> <span class="keyword">throws</span> InterruptedException;</span><br><span class="line">    <span class="comment">//非阻塞等待</span></span><br><span class="line">    Future&lt;V&gt; <span class="title function_">poll</span><span class="params">()</span>;</span><br><span class="line">    <span class="comment">//带时间的非阻塞等待</span></span><br><span class="line">    Future&lt;V&gt; <span class="title function_">poll</span><span class="params">(<span class="type">long</span> timeout, TimeUnit unit)</span> <span class="keyword">throws</span> InterruptedException;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<ul>
<li>submit(Callable task)：提交线程任务，交由 Executor 对象去执行，并将结果放入阻塞队列；</li>
<li>take()：在阻塞队列中获取并移除一个元素，该方法是阻塞的，即获取不到的话线程会一直阻塞；</li>
<li>poll()：在阻塞队列中获取并移除一个元素，该方法是非阻塞的，获取不到即返回 null ；</li>
<li>poll(long timeout, TimeUnit unit)：从阻塞队列中非阻塞地获取并移除一个元素，在设置的超时时间内获取不到即返回 null ；</li>
</ul>
<p>接下来，我们重点看一下submit 的源码：</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> Future&lt;V&gt; <span class="title function_">submit</span><span class="params">(Callable&lt;V&gt; task)</span> {</span><br><span class="line">   <span class="keyword">if</span> (task == <span class="literal">null</span>) <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">NullPointerException</span>();</span><br><span class="line">   RunnableFuture&lt;V&gt; f = newTaskFor(task);</span><br><span class="line">   executor.execute(<span class="keyword">new</span> <span class="title class_">QueueingFuture</span>(f));</span><br><span class="line">   <span class="keyword">return</span> f;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<p>从submit 方法的源码中可以确认两点：</p>
<ol>
<li>线程任务确实是由 Executor 对象执行的；</li>
<li>提交某个任务时，该任务首先将被包装为一个QueueingFuture。</li>
</ol>
<p>继续追查 <code>QueueingFuture</code>，可以发现： 该类重写了 FutureTask 的done方法，当计算完成时，把Executor执行的计算结果放入BlockingQueue中，而==放入结果是按任务完成顺序来进行==的，即先完成的任务先放入阻塞队列。</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"> <span class="comment">/** </span></span><br><span class="line"><span class="comment">  * FutureTask extension to enqueue upon completion </span></span><br><span class="line"><span class="comment">  */</span>  </span><br><span class="line"><span class="keyword">private</span> <span class="keyword">class</span> <span class="title class_">QueueingFuture</span> <span class="keyword">extends</span> <span class="title class_">FutureTask</span>&lt;Void&gt; {  </span><br><span class="line">    QueueingFuture(RunnableFuture&lt;V&gt; task) {  </span><br><span class="line">        <span class="built_in">super</span>(task, <span class="literal">null</span>);  </span><br><span class="line">        <span class="built_in">this</span>.task = task;  </span><br><span class="line">    }  </span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">done</span><span class="params">()</span> { completionQueue.add(task); }  </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Future&lt;V&gt; task;  </span><br><span class="line">}  </span><br></pre></td></tr></tbody></table></figure>
<p>由此，CompletionService 实现了生产者提交任务和消费者获取结果的解耦，任务的完成顺序由 CompletionService 来保证，消费者一定是按照任务完成的先后顺序来获取执行结果。</p>
<blockquote>
<p>CompletionService 使用示例</p>
</blockquote>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> java.util.Date;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.*;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CompletionServiceTest</span> {</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> {</span><br><span class="line">        <span class="type">ExecutorService</span> <span class="variable">executor</span> <span class="operator">=</span> Executors.newCachedThreadPool();</span><br><span class="line">        CompletionService&lt;String&gt; cs = <span class="keyword">new</span> <span class="title class_">ExecutorCompletionService</span>&lt;&gt;(executor);</span><br><span class="line">        <span class="comment">// 此线程池运行5个线程</span></span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; <span class="number">5</span>; i++) {</span><br><span class="line">            <span class="keyword">final</span> <span class="type">int</span> <span class="variable">index</span> <span class="operator">=</span> i;</span><br><span class="line">            cs.submit(() -&gt; {</span><br><span class="line">                <span class="type">String</span> <span class="variable">name</span> <span class="operator">=</span> Thread.currentThread().getName();</span><br><span class="line">                System.out.println(name + <span class="string">" 启动："</span> + <span class="keyword">new</span> <span class="title class_">Date</span>());</span><br><span class="line">                TimeUnit.SECONDS.sleep(<span class="number">10</span> - index * <span class="number">2</span>);</span><br><span class="line">                <span class="keyword">return</span> name;</span><br><span class="line">            });</span><br><span class="line">        }</span><br><span class="line">        executor.shutdown();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; <span class="number">5</span>; i++) {</span><br><span class="line">            <span class="keyword">try</span> {</span><br><span class="line">                System.out.println(cs.take().get() + <span class="string">" 结果："</span> + <span class="keyword">new</span> <span class="title class_">Date</span>());</span><br><span class="line">            } <span class="keyword">catch</span> (Exception e) {</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            }</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">pool-<span class="number">1</span>-thread-<span class="number">2</span> 启动：Sun Nov <span class="number">10</span> <span class="number">11</span>:<span class="number">34</span>:<span class="number">13</span> CST <span class="number">2019</span></span><br><span class="line">pool-<span class="number">1</span>-thread-<span class="number">4</span> 启动：Sun Nov <span class="number">10</span> <span class="number">11</span>:<span class="number">34</span>:<span class="number">13</span> CST <span class="number">2019</span></span><br><span class="line">pool-<span class="number">1</span>-thread-<span class="number">3</span> 启动：Sun Nov <span class="number">10</span> <span class="number">11</span>:<span class="number">34</span>:<span class="number">13</span> CST <span class="number">2019</span></span><br><span class="line">pool-<span class="number">1</span>-thread-<span class="number">5</span> 启动：Sun Nov <span class="number">10</span> <span class="number">11</span>:<span class="number">34</span>:<span class="number">13</span> CST <span class="number">2019</span></span><br><span class="line">pool-<span class="number">1</span>-thread-<span class="number">1</span> 启动：Sun Nov <span class="number">10</span> <span class="number">11</span>:<span class="number">34</span>:<span class="number">13</span> CST <span class="number">2019</span></span><br><span class="line">pool-<span class="number">1</span>-thread-<span class="number">5</span> 结果：Sun Nov <span class="number">10</span> <span class="number">11</span>:<span class="number">34</span>:<span class="number">15</span> CST <span class="number">2019</span></span><br><span class="line">pool-<span class="number">1</span>-thread-<span class="number">4</span> 结果：Sun Nov <span class="number">10</span> <span class="number">11</span>:<span class="number">34</span>:<span class="number">17</span> CST <span class="number">2019</span></span><br><span class="line">pool-<span class="number">1</span>-thread-<span class="number">3</span> 结果：Sun Nov <span class="number">10</span> <span class="number">11</span>:<span class="number">34</span>:<span class="number">19</span> CST <span class="number">2019</span></span><br><span class="line">pool-<span class="number">1</span>-thread-<span class="number">2</span> 结果：Sun Nov <span class="number">10</span> <span class="number">11</span>:<span class="number">34</span>:<span class="number">21</span> CST <span class="number">2019</span></span><br><span class="line">pool-<span class="number">1</span>-thread-<span class="number">1</span> 结果：Sun Nov <span class="number">10</span> <span class="number">11</span>:<span class="number">34</span>:<span class="number">23</span> CST <span class="number">2019</span></span><br></pre></td></tr></tbody></table></figure>
<h2 id="ScheduledExecutorService">ScheduledExecutorService</h2>
<p><img src="https://hmxyl-image.oss-cn-hangzhou.aliyuncs.com/note/image-20220726163319524-1667231117133-92.png" alt="image-20220726163319524"></p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">* 1秒后开始执行任务，每2秒执行一回</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ScheduledExecutorServiceTest</span> {</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> {</span><br><span class="line">        <span class="type">ScheduledExecutorService</span> <span class="variable">scheduledExecutorService</span> <span class="operator">=</span> Executors.newScheduledThreadPool(<span class="number">2</span>);</span><br><span class="line">        <span class="comment">//scheduledExecutorService.schedule(() -&gt; System.out.println(Thread.currentThread().getName()), 1, TimeUnit.SECONDS);</span></span><br><span class="line">        <span class="type">AtomicLong</span> <span class="variable">time</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">AtomicLong</span>(-<span class="number">1</span>);</span><br><span class="line">        scheduledExecutorService.scheduleAtFixedRate(() -&gt; {</span><br><span class="line">            sleep(<span class="number">5</span>);</span><br><span class="line">            <span class="keyword">if</span> (time.get() &gt; <span class="number">0</span>) {</span><br><span class="line">                System.out.println(Thread.currentThread().getName() + <span class="string">": "</span> + (System.currentTimeMillis() - time.get()));</span><br><span class="line">            }</span><br><span class="line"></span><br><span class="line">            time.set(System.currentTimeMillis());</span><br><span class="line">        }, <span class="number">1</span>, <span class="number">2</span>, TimeUnit.SECONDS);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">sleep</span><span class="params">(<span class="type">int</span> time)</span> {</span><br><span class="line">        <span class="keyword">try</span> {</span><br><span class="line">            TimeUnit.SECONDS.sleep(time);</span><br><span class="line">        } <span class="keyword">catch</span> (Exception e) {</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">pool-<span class="number">1</span>-thread-<span class="number">1</span>: <span class="number">5001</span></span><br><span class="line">pool-<span class="number">1</span>-thread-<span class="number">1</span>: <span class="number">5001</span></span><br><span class="line">pool-<span class="number">1</span>-thread-<span class="number">1</span>: <span class="number">5000</span></span><br><span class="line">pool-<span class="number">1</span>-thread-<span class="number">2</span>: <span class="number">5001</span></span><br><span class="line">pool-<span class="number">1</span>-thread-<span class="number">2</span>: <span class="number">5000</span></span><br><span class="line">pool-<span class="number">1</span>-thread-<span class="number">2</span>: <span class="number">5001</span></span><br><span class="line">pool-<span class="number">1</span>-thread-<span class="number">2</span>: <span class="number">5001</span></span><br><span class="line">pool-<span class="number">1</span>-thread-<span class="number">2</span>: <span class="number">5000</span></span><br><span class="line">pool-<span class="number">1</span>-thread-<span class="number">1</span>: <span class="number">5001</span></span><br><span class="line">pool-<span class="number">1</span>-thread-<span class="number">1</span>: <span class="number">5000</span></span><br><span class="line">...</span><br></pre></td></tr></tbody></table></figure>
<blockquote>
<p><code>ScheduledThreadPoolExecutor </code>特殊参数说明</p>
</blockquote>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 允许现有周期性任务在Shutdown之后继续执行</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">volatile</span> <span class="type">boolean</span> continueExistingPeriodicTasksAfterShutdown;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 允许现有延时任务在Shutdown之后继续执行</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">volatile</span> <span class="type">boolean</span> <span class="variable">executeExistingDelayedTasksAfterShutdown</span> <span class="operator">=</span> <span class="literal">true</span>;</span><br></pre></td></tr></tbody></table></figure>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ScheduledExecutorServiceTest</span> {</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> {</span><br><span class="line">        <span class="type">ScheduledThreadPoolExecutor</span> <span class="variable">scheduledThreadPool</span> <span class="operator">=</span> (ScheduledThreadPoolExecutor) Executors.newScheduledThreadPool(<span class="number">2</span>);</span><br><span class="line">        scheduledThreadPool.setExecuteExistingDelayedTasksAfterShutdownPolicy(<span class="literal">false</span>);</span><br><span class="line">        <span class="comment">//scheduledThreadPool.setContinueExistingPeriodicTasksAfterShutdownPolicy(true);</span></span><br><span class="line">        <span class="keyword">final</span> <span class="type">AtomicLong</span> <span class="variable">time</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">AtomicLong</span>(-<span class="number">1</span>);</span><br><span class="line">        scheduledThreadPool.scheduleAtFixedRate(() -&gt; {</span><br><span class="line">            sleep(<span class="number">3</span>);</span><br><span class="line">            <span class="keyword">if</span> (time.get() &gt; <span class="number">0</span>) {</span><br><span class="line">                System.out.println(Thread.currentThread().getName() + <span class="string">": "</span> + (System.currentTimeMillis() - time.get()));</span><br><span class="line">            }</span><br><span class="line">            time.set(System.currentTimeMillis());</span><br><span class="line">        }, <span class="number">1</span>, <span class="number">2</span>, TimeUnit.SECONDS);</span><br><span class="line">        scheduledThreadPool.shutdown();</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">sleep</span><span class="params">(<span class="type">int</span> time)</span> {</span><br><span class="line">        <span class="keyword">try</span> {</span><br><span class="line">            TimeUnit.SECONDS.sleep(time);</span><br><span class="line">        } <span class="keyword">catch</span> (Exception e) {</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<h1>CompletableFuture</h1>
<h3 id="创建对象">创建对象</h3>
<h4 id="runAsync">runAsync</h4>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> CompletableFuture&lt;Void&gt; <span class="title function_">runAsync</span><span class="params">(Runnable runnable)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> CompletableFuture&lt;Void&gt; <span class="title function_">runAsync</span><span class="params">(Runnable runnable, Executor executor)</span></span><br></pre></td></tr></tbody></table></figure>
<h4 id="supplyAsync">supplyAsync</h4>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> &lt;U&gt; CompletableFuture&lt;U&gt; <span class="title function_">supplyAsync</span><span class="params">(Supplier&lt;U&gt; supplier)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> &lt;U&gt; CompletableFuture&lt;U&gt; <span class="title function_">supplyAsync</span><span class="params">(Supplier&lt;U&gt; supplier, Executor executor)</span></span><br></pre></td></tr></tbody></table></figure>
<p>runAsync 方法以Runnable函数式接口类型为参数，没有返回结果，</p>
<p>supplyAsync 方法Supplier函数式接口类型为参数，返回结果类型为U；</p>
<p>没有指定Executor的方法会使用ForkJoinPool.commonPool() 作为它的线程池执行异步代码。如果指定线程池，则使用指定的线程池运行</p>
<h3 id="结果处理">结果处理</h3>
<blockquote>
<p>当CompletableFuture的计算结果完成，或者抛出异常的时候，我们可以执行特定的 Action</p>
</blockquote>
<h4 id="whenComplete">whenComplete</h4>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> CompletableFuture&lt;T&gt; <span class="title function_">whenComplete</span><span class="params">(BiConsumer&lt;? <span class="built_in">super</span> T,? <span class="built_in">super</span> Throwable&gt; action)</span></span><br><span class="line"><span class="keyword">public</span> CompletableFuture&lt;T&gt; <span class="title function_">whenCompleteAsync</span><span class="params">(BiConsumer&lt;? <span class="built_in">super</span> T,? <span class="built_in">super</span> Throwable&gt; action)</span></span><br><span class="line"><span class="keyword">public</span> CompletableFuture&lt;T&gt; <span class="title function_">whenCompleteAsync</span><span class="params">(BiConsumer&lt;? <span class="built_in">super</span> T,? <span class="built_in">super</span> Throwable&gt; action, Executor executor)</span></span><br></pre></td></tr></tbody></table></figure>
<h4 id="exceptionally">exceptionally</h4>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> CompletableFuture&lt;T&gt; <span class="title function_">exceptionally</span><span class="params">(Function&lt;Throwable,? extends T&gt; fn)</span></span><br></pre></td></tr></tbody></table></figure>
<ul>
<li>Action的类型是BiConsumer&lt;? super T,? super Throwable&gt;，它可以处理正常的计算结果，或者异常情况。</li>
<li>方法不以Async结尾，意味着Action使用相同的线程执行，而Async可能会使用其它的线程去执行(如果使用相同的线程池，也可能会被同一个线程选中执行。</li>
<li><strong>这几个方法都会返回CompletableFuture。当Action执行完毕后，<font color="red">返回原始的CompletableFuture的计算结果或者返回异常</font>。</strong></li>
</ul>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CompletableFutureExample2</span> {</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> {</span><br><span class="line">        CompletableFuture&lt;Void&gt; future = CompletableFuture.runAsync(() -&gt; {</span><br><span class="line">            sleep(<span class="number">1</span>);</span><br><span class="line">            <span class="type">int</span> <span class="variable">data</span> <span class="operator">=</span> ThreadLocalRandom.current().nextInt(<span class="number">20</span>);</span><br><span class="line">            <span class="keyword">if</span> (data % <span class="number">2</span> == <span class="number">0</span>) {</span><br><span class="line">                System.out.println(Thread.currentThread().getName() + <span class="string">"：数据-"</span> + data);</span><br><span class="line">                <span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">12</span> / <span class="number">0</span>;</span><br><span class="line">            }</span><br><span class="line">            System.out.println(Thread.currentThread().getName() + <span class="string">"：执行结束"</span>);</span><br><span class="line">        });</span><br><span class="line">        future.whenComplete(<span class="keyword">new</span> <span class="title class_">BiConsumer</span>&lt;Void, Throwable&gt;() {</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">accept</span><span class="params">(Void t, Throwable action)</span> {</span><br><span class="line">                System.out.println(Thread.currentThread().getName() + <span class="string">"：执行完成"</span>);</span><br><span class="line">            }</span><br><span class="line">        });</span><br><span class="line">        future.exceptionally(<span class="keyword">new</span> <span class="title class_">Function</span>&lt;Throwable, Void&gt;() {</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">public</span> Void <span class="title function_">apply</span><span class="params">(Throwable t)</span> {</span><br><span class="line">                System.out.println(Thread.currentThread().getName() + <span class="string">"：执行失败，"</span> + t.getMessage());</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">            }</span><br><span class="line">        }).join();</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">sleep</span><span class="params">(<span class="type">int</span> seconds)</span> {</span><br><span class="line">        <span class="keyword">try</span> {</span><br><span class="line">            TimeUnit.SECONDS.sleep(seconds);</span><br><span class="line">        } <span class="keyword">catch</span> (Exception e) {</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<p>正常执行结束</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ForkJoinPool.commonPool-worker-<span class="number">1</span>：执行结束</span><br><span class="line">ForkJoinPool.commonPool-worker-<span class="number">1</span>：执行完成</span><br></pre></td></tr></tbody></table></figure>
<p>抛出异常</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">ForkJoinPool.commonPool-worker-<span class="number">1</span>：数据-<span class="number">6</span></span><br><span class="line">ForkJoinPool.commonPool-worker-<span class="number">1</span>：执行失败，java.lang.ArithmeticException: / by zero</span><br><span class="line">ForkJoinPool.commonPool-worker-<span class="number">1</span>：执行完成</span><br></pre></td></tr></tbody></table></figure>
<h4 id="handle">handle</h4>
<ul>
<li>当原先的CompletableFuture的值计算完成或者抛出异常的时候，由BiFunction参数计算，<font color="red">产生新的CompletableFuture</font></li>
</ul>
<p>这组方法兼有whenComplete和转换的两个功能（whenComplete and reture）</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> &lt;U&gt; CompletableFuture&lt;U&gt; <span class="title function_">handle</span><span class="params">(BiFunction&lt;? <span class="built_in">super</span> T,Throwable,? extends U&gt; fn)</span></span><br><span class="line"><span class="keyword">public</span> &lt;U&gt; CompletableFuture&lt;U&gt; <span class="title function_">handleAsync</span><span class="params">(BiFunction&lt;? <span class="built_in">super</span> T,Throwable,? extends U&gt; fn)</span></span><br><span class="line"><span class="keyword">public</span> &lt;U&gt; CompletableFuture&lt;U&gt; <span class="title function_">handleAsync</span><span class="params">(BiFunction&lt;? <span class="built_in">super</span> T,Throwable,? extends U&gt; fn, Executor executor)</span></span><br></pre></td></tr></tbody></table></figure>
<p>测试DEMO：</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> ExecutionException, InterruptedException {</span><br><span class="line">	CompletableFuture&lt;Integer&gt; future = CompletableFuture.supplyAsync(() -&gt; {</span><br><span class="line">		<span class="type">int</span> <span class="variable">result</span> <span class="operator">=</span> <span class="number">100</span>;</span><br><span class="line">		System.out.println(<span class="string">"一阶段："</span> + result);</span><br><span class="line">		<span class="keyword">return</span> result;</span><br><span class="line">	}).handle((number, exception) -&gt; {</span><br><span class="line">		<span class="type">int</span> <span class="variable">result</span> <span class="operator">=</span> number * <span class="number">3</span>;</span><br><span class="line">		System.out.println(<span class="string">"二阶段："</span> + result);</span><br><span class="line">		<span class="keyword">return</span> result;</span><br><span class="line">	});</span><br><span class="line">	System.out.println(<span class="string">"最终结果："</span> + future.get());</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">一阶段：<span class="number">100</span></span><br><span class="line">二阶段：<span class="number">300</span></span><br><span class="line">最终结果：<span class="number">300</span></span><br></pre></td></tr></tbody></table></figure>
<h3 id="结果转换（Function）">结果转换（Function）</h3>
<p>所谓结果转换，就是将上一段任务的执行结果作为下一阶段任务的入参参与重新计算，<font color="red">产生新的结果</font></p>
<h4 id="thenApply">thenApply</h4>
<ol>
<li>
<p><code>thenApply</code> 接收一个函数作为参数，使用该函数处理上一个CompletableFuture 调用的结果，并返回一个具有处理结果的Future对象。</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> &lt;U&gt; CompletableFuture&lt;U&gt; <span class="title function_">thenApply</span><span class="params">(Function&lt;? <span class="built_in">super</span> T,? extends U&gt; fn)</span></span><br><span class="line"><span class="keyword">public</span> &lt;U&gt; CompletableFuture&lt;U&gt; <span class="title function_">thenApplyAsync</span><span class="params">(Function&lt;? <span class="built_in">super</span> T,? extends U&gt; fn)</span></span><br><span class="line"><span class="keyword">public</span> &lt;U&gt; CompletableFuture&lt;U&gt; <span class="title function_">thenApplyAsync</span><span class="params">(Function&lt;? <span class="built_in">super</span> T,? extends U&gt; fn, Executor executor)</span></span><br></pre></td></tr></tbody></table></figure>
<p><strong>示例：</strong></p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> ExecutionException, InterruptedException {</span><br><span class="line">    CompletableFuture&lt;Integer&gt; future = CompletableFuture.supplyAsync(() -&gt; {</span><br><span class="line">    <span class="type">int</span> <span class="variable">result</span> <span class="operator">=</span> <span class="number">100</span>;</span><br><span class="line">    System.out.println(<span class="string">"一阶段："</span> + result);</span><br><span class="line">        <span class="keyword">return</span> result;</span><br><span class="line">    }).thenApply(number -&gt; {</span><br><span class="line">        <span class="type">int</span> <span class="variable">result</span> <span class="operator">=</span> number * <span class="number">3</span>;</span><br><span class="line">        System.out.println(<span class="string">"二阶段："</span> + result);</span><br><span class="line">        <span class="keyword">return</span> result;</span><br><span class="line">    });</span><br><span class="line">    System.out.println(<span class="string">"最终结果："</span> + future.get());</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">一阶段：<span class="number">100</span></span><br><span class="line">二阶段：<span class="number">300</span></span><br><span class="line">最终结果：<span class="number">300</span></span><br></pre></td></tr></tbody></table></figure>
</li>
</ol>
<h4 id="thenCompose">thenCompose</h4>
<ol>
<li>
<p><code>thenCompose</code>的参数为一个返回 CompletableFuture 实例的函数，该函数的参数是先前计算步骤的结果。</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> &lt;U&gt; CompletableFuture&lt;U&gt; <span class="title function_">thenCompose</span><span class="params">(Function&lt;? <span class="built_in">super</span> T, ? extends CompletionStage&lt;U&gt;&gt; fn)</span>;</span><br><span class="line"><span class="keyword">public</span> &lt;U&gt; CompletableFuture&lt;U&gt; <span class="title function_">thenComposeAsync</span><span class="params">(Function&lt;? <span class="built_in">super</span> T, ? extends CompletionStage&lt;U&gt;&gt; fn)</span> ;</span><br><span class="line"><span class="keyword">public</span> &lt;U&gt; CompletableFuture&lt;U&gt; <span class="title function_">thenComposeAsync</span><span class="params">(Function&lt;? <span class="built_in">super</span> T, ? extends CompletionStage&lt;U&gt;&gt; fn, Executor executor)</span> ;</span><br></pre></td></tr></tbody></table></figure>
<p>示例</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> InterruptedException, ExecutionException {</span><br><span class="line">    CompletableFuture&lt;Integer&gt; future = CompletableFuture.supplyAsync(<span class="keyword">new</span> <span class="title class_">Supplier</span>&lt;Integer&gt;() {</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> Integer <span class="title function_">get</span><span class="params">()</span> {</span><br><span class="line">            <span class="type">int</span> <span class="variable">number</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Random</span>().nextInt(<span class="number">3</span>);</span><br><span class="line">            System.out.println(<span class="string">"第一阶段："</span> + number);</span><br><span class="line">            <span class="keyword">return</span> number;</span><br><span class="line">        }</span><br><span class="line">    }).thenCompose(<span class="keyword">new</span> <span class="title class_">Function</span>&lt;Integer, CompletionStage&lt;Integer&gt;&gt;() {</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> CompletionStage&lt;Integer&gt; <span class="title function_">apply</span><span class="params">(Integer param)</span> {</span><br><span class="line">            <span class="keyword">return</span> CompletableFuture.supplyAsync(<span class="keyword">new</span> <span class="title class_">Supplier</span>&lt;Integer&gt;() {</span><br><span class="line">                <span class="meta">@Override</span></span><br><span class="line">                <span class="keyword">public</span> Integer <span class="title function_">get</span><span class="params">()</span> {</span><br><span class="line">                    <span class="type">int</span> <span class="variable">number</span> <span class="operator">=</span> param * <span class="number">2</span>;</span><br><span class="line">                    System.out.println(<span class="string">"第二阶段："</span> + number);</span><br><span class="line">                    <span class="keyword">return</span> number;</span><br><span class="line">                }</span><br><span class="line">            });</span><br><span class="line">        }</span><br><span class="line">    });</span><br><span class="line">    System.out.println(<span class="string">"最终结果: "</span> + future.get());</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<p>那么 <code>thenApply </code>和<code>thenCompose </code>有何区别呢：</p>
<ul>
<li><code>thenApply </code>转换的是泛型中的类型，返回的是同一个CompletableFuture；</li>
<li><code>thenCompose</code> 使用上一个CompletableFutre 调用的结果在下一步的 CompletableFuture 调用中进行运算，是生成一个内部构造的新的CompletableFuture。</li>
</ul>
<p>下面用一个例子对对比：</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> InterruptedException, ExecutionException {</span><br><span class="line">    CompletableFuture&lt;String&gt; future = CompletableFuture.supplyAsync(() -&gt; <span class="string">"Hello"</span>);</span><br><span class="line"></span><br><span class="line">    CompletableFuture&lt;String&gt; result1 = future.thenApply(param -&gt; param + <span class="string">" World"</span>);</span><br><span class="line">    CompletableFuture&lt;String&gt; result2 = future.thenCompose(param -&gt; CompletableFuture.supplyAsync(() -&gt; param + <span class="string">" World"</span>));</span><br><span class="line"></span><br><span class="line">    System.out.println(result1.get());</span><br><span class="line">    System.out.println(result2.get());</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
</li>
</ol>
<h3 id="结果消费（Consumer）">结果消费（Consumer）</h3>
<p>与结果处理和结果转换系列函数返回一个新的 CompletableFuture 不同，结果消费系列函数只对结果执行Action，而<font color="red">不返回新的计算值</font>。</p>
<p>根据对结果的处理方式，结果消费函数又分为：</p>
<ul>
<li><code>thenAccept</code>系列：对单个结果进行消费</li>
<li><code>thenAcceptBoth</code>系列：对两个结果进行消费</li>
<li><code>thenRun</code>系列：不关心结果，只对结果执行Action</li>
</ul>
<h4 id="thenAccept">thenAccept</h4>
<p>通过观察该系列函数的参数类型可知，它们是函数式接口Consumer，这个接口只有输入，没有返回值。</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> CompletionStage&lt;Void&gt; <span class="title function_">thenAccept</span><span class="params">(Consumer&lt;? <span class="built_in">super</span> T&gt; action)</span>;</span><br><span class="line"><span class="keyword">public</span> CompletionStage&lt;Void&gt; <span class="title function_">thenAcceptAsync</span><span class="params">(Consumer&lt;? <span class="built_in">super</span> T&gt; action)</span>;</span><br><span class="line"><span class="keyword">public</span> CompletionStage&lt;Void&gt; <span class="title function_">thenAcceptAsync</span><span class="params">(Consumer&lt;? <span class="built_in">super</span> T&gt; action,Executor executor)</span>;</span><br></pre></td></tr></tbody></table></figure>
<p>示例</p>
<figure class="highlight csharp"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span>(<span class="params">String[] <span class="keyword">args</span></span>) throws ExecutionException, InterruptedException</span> {</span><br><span class="line">    CompletableFuture&lt;Void&gt; future = CompletableFuture.supplyAsync(() -&gt; {</span><br><span class="line">        <span class="built_in">int</span> number = <span class="keyword">new</span> Random().nextInt(<span class="number">10</span>);</span><br><span class="line">        System.<span class="keyword">out</span>.println(<span class="string">"第一阶段："</span> + number);</span><br><span class="line">        <span class="keyword">return</span> number;</span><br><span class="line">    }).thenAccept(number -&gt; System.<span class="keyword">out</span>.println(<span class="string">"第二阶段："</span> + number * <span class="number">5</span>));</span><br><span class="line">    System.<span class="keyword">out</span>.println(<span class="string">"最终结果："</span> + future.<span class="keyword">get</span>());</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<h4 id="thenAcceptBoth">thenAcceptBoth</h4>
<p>thenAcceptBoth 函数的作用是，当两个 CompletionStage 都正常完成计算的时候，就会执行提供的action，消费两个异步的结果。没有返回值。</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> &lt;U&gt; CompletionStage&lt;Void&gt; <span class="title function_">thenAcceptBoth</span><span class="params">(CompletionStage&lt;? extends U&gt; other,BiConsumer&lt;? <span class="built_in">super</span> T, ? <span class="built_in">super</span> U&gt; action)</span>;</span><br><span class="line"><span class="keyword">public</span> &lt;U&gt; CompletionStage&lt;Void&gt; <span class="title function_">thenAcceptBothAsync</span><span class="params">(CompletionStage&lt;? extends U&gt; other,BiConsumer&lt;? <span class="built_in">super</span> T, ? <span class="built_in">super</span> U&gt; action)</span>;</span><br><span class="line"><span class="keyword">public</span> &lt;U&gt; CompletionStage&lt;Void&gt; <span class="title function_">thenAcceptBothAsync</span><span class="params">(CompletionStage&lt;? extends U&gt; other,BiConsumer&lt;? <span class="built_in">super</span> T, ? <span class="built_in">super</span> U&gt; action, Executor executor)</span>;</span><br></pre></td></tr></tbody></table></figure>
<p>示例</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> ExecutionException, InterruptedException {</span><br><span class="line">    CompletableFuture&lt;Integer&gt; futrue1 = CompletableFuture.supplyAsync(<span class="keyword">new</span> <span class="title class_">Supplier</span>&lt;Integer&gt;() {</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> Integer <span class="title function_">get</span><span class="params">()</span> {</span><br><span class="line">            <span class="type">int</span> <span class="variable">number</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Random</span>().nextInt(<span class="number">3</span>) + <span class="number">1</span>;</span><br><span class="line">            <span class="keyword">try</span> {</span><br><span class="line">                TimeUnit.SECONDS.sleep(number);</span><br><span class="line">            } <span class="keyword">catch</span> (InterruptedException e) {</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            }</span><br><span class="line">            System.out.println(<span class="string">"第一阶段："</span> + number);</span><br><span class="line">            <span class="keyword">return</span> number;</span><br><span class="line">        }</span><br><span class="line">    });</span><br><span class="line"></span><br><span class="line">    CompletableFuture&lt;Integer&gt; future2 = CompletableFuture.supplyAsync(<span class="keyword">new</span> <span class="title class_">Supplier</span>&lt;Integer&gt;() {</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> Integer <span class="title function_">get</span><span class="params">()</span> {</span><br><span class="line">            <span class="type">int</span> <span class="variable">number</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Random</span>().nextInt(<span class="number">3</span>) + <span class="number">1</span>;</span><br><span class="line">            <span class="keyword">try</span> {</span><br><span class="line">                TimeUnit.SECONDS.sleep(number);</span><br><span class="line">            } <span class="keyword">catch</span> (InterruptedException e) {</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            }</span><br><span class="line">            System.out.println(<span class="string">"第二阶段："</span> + number);</span><br><span class="line">            <span class="keyword">return</span> number;</span><br><span class="line">        }</span><br><span class="line">    });</span><br><span class="line"></span><br><span class="line">    futrue1.thenAcceptBoth(future2, <span class="keyword">new</span> <span class="title class_">BiConsumer</span>&lt;Integer, Integer&gt;() {</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">accept</span><span class="params">(Integer x, Integer y)</span> {</span><br><span class="line">            System.out.println(<span class="string">"最终结果："</span> + (x + y));</span><br><span class="line">        }</span><br><span class="line">    }).join();</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<h4 id="thenRun">thenRun</h4>
<p>thenRun 也是对线程任务结果的一种消费函数，与thenAccept不同的是，thenRun 会在上一阶段 CompletableFuture 计算完成的时候执行一个Runnable，但是不使用该 CompletableFuture 计算的结果。</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> CompletionStage&lt;Void&gt; <span class="title function_">thenRun</span><span class="params">(Runnable action)</span>;</span><br><span class="line"><span class="keyword">public</span> CompletionStage&lt;Void&gt; <span class="title function_">thenRunAsync</span><span class="params">(Runnable action)</span>;</span><br><span class="line"><span class="keyword">public</span> CompletionStage&lt;Void&gt; <span class="title function_">thenRunAsync</span><span class="params">(Runnable action,Executor executor)</span>;</span><br></pre></td></tr></tbody></table></figure>
<p>示例</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> ExecutionException, InterruptedException {</span><br><span class="line">    CompletableFuture&lt;Void&gt; future = CompletableFuture.supplyAsync(() -&gt; {</span><br><span class="line">        <span class="type">int</span> <span class="variable">number</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Random</span>().nextInt(<span class="number">10</span>);</span><br><span class="line">        System.out.println(<span class="string">"第一阶段："</span> + number);</span><br><span class="line">        <span class="keyword">return</span> number;</span><br><span class="line">    }).thenRun(() -&gt; System.out.println(<span class="string">"thenRun 执行"</span>));</span><br><span class="line">    System.out.println(<span class="string">"最终结果："</span> + future.get());</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<h3 id="结果组合">结果组合</h3>
<h4 id="thenCombine">thenCombine</h4>
<p>thenCombine 方法，合并两个线程任务的结果，并进一步处理。</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> &lt;U,V&gt; CompletionStage&lt;V&gt; <span class="title function_">thenCombine</span><span class="params">(CompletionStage&lt;? extends U&gt; other, BiFunction&lt;? <span class="built_in">super</span> T,? <span class="built_in">super</span> U,? extends V&gt; fn)</span>;</span><br><span class="line"><span class="keyword">public</span> &lt;U,V&gt; CompletionStage&lt;V&gt; <span class="title function_">thenCombineAsync</span><span class="params">(CompletionStage&lt;? extends U&gt; other, BiFunction&lt;? <span class="built_in">super</span> T,? <span class="built_in">super</span> U,? extends V&gt; fn)</span>;</span><br><span class="line"><span class="keyword">public</span> &lt;U,V&gt; CompletionStage&lt;V&gt; <span class="title function_">thenCombineAsync</span><span class="params">(CompletionStage&lt;? extends U&gt; other, BiFunction&lt;? <span class="built_in">super</span> T,? <span class="built_in">super</span> U,? extends V&gt; fn,Executor executor)</span>;</span><br></pre></td></tr></tbody></table></figure>
<p>示例</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> ExecutionException, InterruptedException {</span><br><span class="line">    CompletableFuture&lt;Integer&gt; future1 = CompletableFuture.supplyAsync(<span class="keyword">new</span> <span class="title class_">Supplier</span>&lt;Integer&gt;() {</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> Integer <span class="title function_">get</span><span class="params">()</span> {</span><br><span class="line">            <span class="type">int</span> <span class="variable">number</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Random</span>().nextInt(<span class="number">10</span>);</span><br><span class="line">            System.out.println(<span class="string">"第一阶段："</span> + number);</span><br><span class="line">            <span class="keyword">return</span> number;</span><br><span class="line">        }</span><br><span class="line">    });</span><br><span class="line">  </span><br><span class="line">    CompletableFuture&lt;Integer&gt; future2 = CompletableFuture.supplyAsync(<span class="keyword">new</span> <span class="title class_">Supplier</span>&lt;Integer&gt;() {</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> Integer <span class="title function_">get</span><span class="params">()</span> {</span><br><span class="line">            <span class="type">int</span> <span class="variable">number</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Random</span>().nextInt(<span class="number">10</span>);</span><br><span class="line">            System.out.println(<span class="string">"第二阶段："</span> + number);</span><br><span class="line">            <span class="keyword">return</span> number;</span><br><span class="line">        }</span><br><span class="line">    });</span><br><span class="line">  </span><br><span class="line">    CompletableFuture&lt;Integer&gt; result = future1.thenCombine(future2, <span class="keyword">new</span> <span class="title class_">BiFunction</span>&lt;Integer, Integer, Integer&gt;() {</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> Integer <span class="title function_">apply</span><span class="params">(Integer x, Integer y)</span> {</span><br><span class="line">            <span class="keyword">return</span> x + y;</span><br><span class="line">        }</span><br><span class="line">    });</span><br><span class="line">    System.out.println(<span class="string">"最终结果："</span> + result.get());</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<h3 id="任务交互">任务交互</h3>
<p>线程交互，是指将两个线程任务获取结果的速度相比较，按一定的规则进行下一步处理。</p>
<h4 id="applyToEither（转换）">applyToEither（转换）</h4>
<p>两个线程任务相比较，先获得执行结果的，就对该结果进行下一步的转换操作。</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> &lt;U&gt; CompletionStage&lt;U&gt; <span class="title function_">applyToEither</span><span class="params">(CompletionStage&lt;? extends T&gt; other,Function&lt;? <span class="built_in">super</span> T, U&gt; fn)</span>;</span><br><span class="line"><span class="keyword">public</span> &lt;U&gt; CompletionStage&lt;U&gt; <span class="title function_">applyToEitherAsync</span><span class="params">(CompletionStage&lt;? extends T&gt; other,Function&lt;? <span class="built_in">super</span> T, U&gt; fn)</span>;</span><br><span class="line"><span class="keyword">public</span> &lt;U&gt; CompletionStage&lt;U&gt; <span class="title function_">applyToEitherAsync</span><span class="params">(CompletionStage&lt;? extends T&gt; other,Function&lt;? <span class="built_in">super</span> T, U&gt; fn,Executor executor)</span>;</span><br></pre></td></tr></tbody></table></figure>
<p>示例</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> ExecutionException, InterruptedException {</span><br><span class="line">    CompletableFuture&lt;Integer&gt; future1 = CompletableFuture.supplyAsync(<span class="keyword">new</span> <span class="title class_">Supplier</span>&lt;Integer&gt;() {</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> Integer <span class="title function_">get</span><span class="params">()</span> {</span><br><span class="line">            <span class="type">int</span> <span class="variable">number</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Random</span>().nextInt(<span class="number">3</span>);</span><br><span class="line">            <span class="keyword">try</span> {</span><br><span class="line">                TimeUnit.SECONDS.sleep(number);</span><br><span class="line">            } <span class="keyword">catch</span> (InterruptedException e) {</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            }</span><br><span class="line">            System.out.println(<span class="string">"第一阶段："</span> + number);</span><br><span class="line">            <span class="keyword">return</span> number;</span><br><span class="line">        }</span><br><span class="line">    });</span><br><span class="line">    CompletableFuture&lt;Integer&gt; future2 = CompletableFuture.supplyAsync(<span class="keyword">new</span> <span class="title class_">Supplier</span>&lt;Integer&gt;() {</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> Integer <span class="title function_">get</span><span class="params">()</span> {</span><br><span class="line">            <span class="type">int</span> <span class="variable">number</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Random</span>().nextInt(<span class="number">3</span>);</span><br><span class="line">            <span class="keyword">try</span> {</span><br><span class="line">                TimeUnit.SECONDS.sleep(number);</span><br><span class="line">            } <span class="keyword">catch</span> (InterruptedException e) {</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            }</span><br><span class="line">            System.out.println(<span class="string">"第二阶段："</span> + number);</span><br><span class="line">            <span class="keyword">return</span> number;</span><br><span class="line">        }</span><br><span class="line">    });</span><br><span class="line"></span><br><span class="line">    future1.applyToEither(future2, <span class="keyword">new</span> <span class="title class_">Function</span>&lt;Integer, Integer&gt;() {</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> Integer <span class="title function_">apply</span><span class="params">(Integer number)</span> {</span><br><span class="line">            System.out.println(<span class="string">"最快结果："</span> + number);</span><br><span class="line">            <span class="keyword">return</span> number * <span class="number">2</span>;</span><br><span class="line">        }</span><br><span class="line">    }).join();</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<h4 id="acceptEither（消费）">acceptEither（消费）</h4>
<p>两个线程任务相比较，先获得执行结果的，就对该结果进行下一步的消费操作。</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> CompletionStage&lt;Void&gt; <span class="title function_">acceptEither</span><span class="params">(CompletionStage&lt;? extends T&gt; other,Consumer&lt;? <span class="built_in">super</span> T&gt; action)</span>;</span><br><span class="line"><span class="keyword">public</span> CompletionStage&lt;Void&gt; <span class="title function_">acceptEitherAsync</span><span class="params">(CompletionStage&lt;? extends T&gt; other,Consumer&lt;? <span class="built_in">super</span> T&gt; action)</span>;</span><br><span class="line"><span class="keyword">public</span> CompletionStage&lt;Void&gt; <span class="title function_">acceptEitherAsync</span><span class="params">(CompletionStage&lt;? extends T&gt; other,Consumer&lt;? <span class="built_in">super</span> T&gt; action,Executor executor)</span>;</span><br></pre></td></tr></tbody></table></figure>
<p>示例</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> {</span><br><span class="line">    CompletableFuture&lt;Integer&gt; future1 = CompletableFuture.supplyAsync(<span class="keyword">new</span> <span class="title class_">Supplier</span>&lt;Integer&gt;() {</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> Integer <span class="title function_">get</span><span class="params">()</span> {</span><br><span class="line">            <span class="type">int</span> <span class="variable">number</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Random</span>().nextInt(<span class="number">3</span>) + <span class="number">1</span>;</span><br><span class="line">            <span class="keyword">try</span> {</span><br><span class="line">                TimeUnit.SECONDS.sleep(number);</span><br><span class="line">            } <span class="keyword">catch</span> (InterruptedException e) {</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            }</span><br><span class="line">            System.out.println(<span class="string">"第一阶段："</span> + number);</span><br><span class="line">            <span class="keyword">return</span> number;</span><br><span class="line">        }</span><br><span class="line">    });</span><br><span class="line"></span><br><span class="line">    CompletableFuture&lt;Integer&gt; future2 = CompletableFuture.supplyAsync(<span class="keyword">new</span> <span class="title class_">Supplier</span>&lt;Integer&gt;() {</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> Integer <span class="title function_">get</span><span class="params">()</span> {</span><br><span class="line">            <span class="type">int</span> <span class="variable">number</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Random</span>().nextInt(<span class="number">3</span>) + <span class="number">1</span>;</span><br><span class="line">            <span class="keyword">try</span> {</span><br><span class="line">                TimeUnit.SECONDS.sleep(number);</span><br><span class="line">            } <span class="keyword">catch</span> (InterruptedException e) {</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            }</span><br><span class="line">            System.out.println(<span class="string">"第二阶段："</span> + number);</span><br><span class="line">            <span class="keyword">return</span> number;</span><br><span class="line">        }</span><br><span class="line">    });</span><br><span class="line"></span><br><span class="line">    future1.acceptEither(future2, <span class="keyword">new</span> <span class="title class_">Consumer</span>&lt;Integer&gt;() {</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">accept</span><span class="params">(Integer number)</span> {</span><br><span class="line">            System.out.println(<span class="string">"最快结果："</span> + number);</span><br><span class="line">        }</span><br><span class="line">    }).join();</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<h4 id="runAfterEither">runAfterEither</h4>
<p>两个线程任务相比较，有任何一个执行完成，就进行下一步操作，不关心运行结果。</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> CompletionStage&lt;Void&gt; <span class="title function_">runAfterEither</span><span class="params">(CompletionStage&lt;?&gt; other,Runnable action)</span>;</span><br><span class="line"><span class="keyword">public</span> CompletionStage&lt;Void&gt; <span class="title function_">runAfterEitherAsync</span><span class="params">(CompletionStage&lt;?&gt; other,Runnable action)</span>;</span><br><span class="line"><span class="keyword">public</span> CompletionStage&lt;Void&gt; <span class="title function_">runAfterEitherAsync</span><span class="params">(CompletionStage&lt;?&gt; other,Runnable action,Executor executor)</span>;</span><br></pre></td></tr></tbody></table></figure>
<p>示例</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> java.util.Random;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.CompletableFuture;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.TimeUnit;</span><br><span class="line"><span class="keyword">import</span> java.util.function.Supplier;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CompletableFutureTest</span> {</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> {</span><br><span class="line">        CompletableFuture&lt;Integer&gt; future1 = CompletableFuture.supplyAsync(<span class="keyword">new</span> <span class="title class_">Supplier</span>&lt;Integer&gt;() {</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">public</span> Integer <span class="title function_">get</span><span class="params">()</span> {</span><br><span class="line">                <span class="type">int</span> <span class="variable">number</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Random</span>().nextInt(<span class="number">5</span>);</span><br><span class="line">                <span class="keyword">try</span> {</span><br><span class="line">                    TimeUnit.SECONDS.sleep(number);</span><br><span class="line">                } <span class="keyword">catch</span> (InterruptedException e) {</span><br><span class="line">                    e.printStackTrace();</span><br><span class="line">                }</span><br><span class="line">                System.out.println(<span class="string">"第一阶段："</span> + number);</span><br><span class="line">                <span class="keyword">return</span> number;</span><br><span class="line">            }</span><br><span class="line">        });</span><br><span class="line"></span><br><span class="line">        CompletableFuture&lt;Integer&gt; future2 = CompletableFuture.supplyAsync(<span class="keyword">new</span> <span class="title class_">Supplier</span>&lt;Integer&gt;() {</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">public</span> Integer <span class="title function_">get</span><span class="params">()</span> {</span><br><span class="line">                <span class="type">int</span> <span class="variable">number</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Random</span>().nextInt(<span class="number">5</span>);</span><br><span class="line">                <span class="keyword">try</span> {</span><br><span class="line">                    TimeUnit.SECONDS.sleep(number);</span><br><span class="line">                } <span class="keyword">catch</span> (InterruptedException e) {</span><br><span class="line">                    e.printStackTrace();</span><br><span class="line">                }</span><br><span class="line">                System.out.println(<span class="string">"第二阶段："</span> + number);</span><br><span class="line">                <span class="keyword">return</span> number;</span><br><span class="line">            }</span><br><span class="line">        });</span><br><span class="line"></span><br><span class="line">        future1.runAfterEither(future2, <span class="keyword">new</span> <span class="title class_">Runnable</span>() {</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> {</span><br><span class="line">                System.out.println(<span class="string">"已经有一个任务完成了"</span>);</span><br><span class="line">            }</span><br><span class="line">        }).join();</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<h4 id="runAfterBoth">runAfterBoth</h4>
<p>两个线程任务相比较，两个全部执行完成，才进行下一步操作，不关心运行结果。</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> CompletionStage&lt;Void&gt; <span class="title function_">runAfterBoth</span><span class="params">(CompletionStage&lt;?&gt; other,Runnable action)</span>;</span><br><span class="line"><span class="keyword">public</span> CompletionStage&lt;Void&gt; <span class="title function_">runAfterBothAsync</span><span class="params">(CompletionStage&lt;?&gt; other,Runnable action)</span>;</span><br><span class="line"><span class="keyword">public</span> CompletionStage&lt;Void&gt; <span class="title function_">runAfterBothAsync</span><span class="params">(CompletionStage&lt;?&gt; other,Runnable action,Executor executor)</span>;</span><br></pre></td></tr></tbody></table></figure>
<p>示例</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> java.util.concurrent.CompletableFuture;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.TimeUnit;</span><br><span class="line"><span class="keyword">import</span> java.util.function.Supplier;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CompletableFutureTest</span> {</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> {</span><br><span class="line">        CompletableFuture&lt;Integer&gt; future1 = CompletableFuture.supplyAsync(<span class="keyword">new</span> <span class="title class_">Supplier</span>&lt;Integer&gt;() {</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">public</span> Integer <span class="title function_">get</span><span class="params">()</span> {</span><br><span class="line">                <span class="keyword">try</span> {</span><br><span class="line">                    TimeUnit.SECONDS.sleep(<span class="number">1</span>);</span><br><span class="line">                } <span class="keyword">catch</span> (InterruptedException e) {</span><br><span class="line">                    e.printStackTrace();</span><br><span class="line">                }</span><br><span class="line">                System.out.println(<span class="string">"第一阶段：1"</span>);</span><br><span class="line">                <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">            }</span><br><span class="line">        });</span><br><span class="line"></span><br><span class="line">        CompletableFuture&lt;Integer&gt; future2 = CompletableFuture.supplyAsync(<span class="keyword">new</span> <span class="title class_">Supplier</span>&lt;Integer&gt;() {</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">public</span> Integer <span class="title function_">get</span><span class="params">()</span> {</span><br><span class="line">                <span class="keyword">try</span> {</span><br><span class="line">                    TimeUnit.SECONDS.sleep(<span class="number">2</span>);</span><br><span class="line">                } <span class="keyword">catch</span> (InterruptedException e) {</span><br><span class="line">                    e.printStackTrace();</span><br><span class="line">                }</span><br><span class="line">                System.out.println(<span class="string">"第二阶段：2"</span>);</span><br><span class="line">                <span class="keyword">return</span> <span class="number">2</span>;</span><br><span class="line">            }</span><br><span class="line">        });</span><br><span class="line"></span><br><span class="line">        future1.runAfterBoth(future2, <span class="keyword">new</span> <span class="title class_">Runnable</span>() {</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> {</span><br><span class="line">                System.out.println(<span class="string">"上面两个任务都执行完成了。"</span>);</span><br><span class="line">            }</span><br><span class="line">        }).get();</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<h4 id="anyOf">anyOf</h4>
<p>anyOf 方法的参数是多个给定的 CompletableFuture，当其中的任何一个完成时，返回这个任务的 CompletableFuture</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> ExecutionException, InterruptedException {</span><br><span class="line">    <span class="type">Random</span> <span class="variable">random</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Random</span>();</span><br><span class="line">    CompletableFuture&lt;String&gt; future1 = CompletableFuture.supplyAsync(() -&gt; {</span><br><span class="line">        <span class="keyword">try</span> {</span><br><span class="line">            TimeUnit.SECONDS.sleep(random.nextInt(<span class="number">5</span>));</span><br><span class="line">        } <span class="keyword">catch</span> (InterruptedException e) {</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        }</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"hello"</span>;</span><br><span class="line">    });</span><br><span class="line">    </span><br><span class="line">    CompletableFuture&lt;String&gt; future2 = CompletableFuture.supplyAsync(() -&gt; {</span><br><span class="line">        <span class="keyword">try</span> {</span><br><span class="line">            TimeUnit.SECONDS.sleep(random.nextInt(<span class="number">1</span>));</span><br><span class="line">        } <span class="keyword">catch</span> (InterruptedException e) {</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        }</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"world"</span>;</span><br><span class="line">    });</span><br><span class="line">    CompletableFuture&lt;Object&gt; result = CompletableFuture.anyOf(future1, future2);</span><br><span class="line">    System.out.println(result.get());</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<h4 id="allOf">allOf</h4>
<p>allOf方法用来实现监听 多个 CompletableFuture 的全部完成。</p>
<p>示例</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> {</span><br><span class="line">    CompletableFuture&lt;String&gt; future1 = CompletableFuture.supplyAsync(() -&gt; {</span><br><span class="line">        <span class="keyword">try</span> {</span><br><span class="line">            TimeUnit.SECONDS.sleep(<span class="number">2</span>);</span><br><span class="line">        } <span class="keyword">catch</span> (InterruptedException e) {</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        }</span><br><span class="line">        System.out.println(<span class="string">"future1完成！"</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"future1完成！"</span>;</span><br><span class="line">    });</span><br><span class="line">    </span><br><span class="line">    CompletableFuture&lt;String&gt; future2 = CompletableFuture.supplyAsync(() -&gt; {</span><br><span class="line">        System.out.println(<span class="string">"future2完成！"</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"future2完成！"</span>;</span><br><span class="line">    });</span><br><span class="line">    </span><br><span class="line">    CompletableFuture&lt;Void&gt; combindFuture = CompletableFuture.allOf(future1, future2);</span><br><span class="line">    <span class="keyword">try</span> {</span><br><span class="line">        combindFuture.get();</span><br><span class="line">    } <span class="keyword">catch</span> (InterruptedException e) {</span><br><span class="line">        e.printStackTrace();</span><br><span class="line">    } <span class="keyword">catch</span> (ExecutionException e) {</span><br><span class="line">        e.printStackTrace();</span><br><span class="line">    }</span><br><span class="line">    System.out.println(<span class="string">"future1: "</span> + future1.isDone() + <span class="string">"，future2: "</span> + future2.isDone());</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<h3 id="CompletableFuture：其他">CompletableFuture：其他</h3>
<h4 id="getNow：提交任务继续运行">getNow：提交任务继续运行</h4>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> T <span class="title function_">getNow</span><span class="params">(T valueIfAbsent)</span></span><br></pre></td></tr></tbody></table></figure>
<p>示例：</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CompletableFutureExample4</span> {</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> InterruptedException {</span><br><span class="line">        <span class="type">String</span> <span class="variable">result</span> <span class="operator">=</span> CompletableFuture.supplyAsync(() -&gt; {</span><br><span class="line">            sleep(<span class="number">3</span>);</span><br><span class="line">            System.out.println(System.currentTimeMillis() + <span class="string">" 任务继续执行"</span>);</span><br><span class="line">            <span class="keyword">return</span> System.currentTimeMillis() + <span class="string">" HELLO"</span>;</span><br><span class="line">        }).getNow(System.currentTimeMillis() + <span class="string">" WORLD"</span>);</span><br><span class="line">        System.out.println(result);</span><br><span class="line">        sleep(<span class="number">5</span>);</span><br><span class="line">        System.out.println(System.currentTimeMillis() + <span class="string">" main exit."</span>);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">sleep</span><span class="params">(<span class="type">int</span> seconds)</span> {</span><br><span class="line">        <span class="keyword">try</span> {</span><br><span class="line">            TimeUnit.SECONDS.sleep(seconds);</span><br><span class="line">        } <span class="keyword">catch</span> (Exception e) {</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"># Console输出</span><br><span class="line"><span class="number">1659410799621</span> WORLD</span><br><span class="line"><span class="number">1659410802622</span> 任务继续执行</span><br><span class="line"><span class="number">1659411545079</span> main exit.</span><br></pre></td></tr></tbody></table></figure>
<h4 id="complete：提交任务不会继续运行">complete：提交任务不会继续运行</h4>
<p>如果尚未完成，则将 get() 和相关方法返回的值设置为给定值</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">complete</span><span class="params">(T value)</span></span><br></pre></td></tr></tbody></table></figure>
<p>示例：</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CompletableFutureExample5</span> {</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> ExecutionException, InterruptedException {</span><br><span class="line">        CompletableFuture&lt;String&gt; result = CompletableFuture.supplyAsync(() -&gt; {</span><br><span class="line">            sleep(<span class="number">3</span>);</span><br><span class="line">            System.out.println(System.currentTimeMillis() + <span class="string">" 任务继续执行"</span>);</span><br><span class="line">            <span class="keyword">return</span> System.currentTimeMillis() + <span class="string">" HELLO"</span>;</span><br><span class="line">        });</span><br><span class="line">        <span class="type">boolean</span> <span class="variable">status</span> <span class="operator">=</span> result.complete(System.currentTimeMillis() + <span class="string">" WORLD"</span>);</span><br><span class="line">        System.out.println(System.currentTimeMillis() + <span class="string">" "</span> + status);</span><br><span class="line">        System.out.println(result.get());</span><br><span class="line">        sleep(<span class="number">5</span>);</span><br><span class="line">        System.out.println(System.currentTimeMillis() + <span class="string">" main exit."</span>);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">sleep</span><span class="params">(<span class="type">int</span> seconds)</span> {</span><br><span class="line">        <span class="keyword">try</span> {</span><br><span class="line">            TimeUnit.SECONDS.sleep(seconds);</span><br><span class="line">        } <span class="keyword">catch</span> (Exception e) {</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line">}</span><br><span class="line"># Console输出</span><br><span class="line"><span class="number">1659410986243</span> <span class="literal">true</span></span><br><span class="line"><span class="number">1659410986243</span> WORLD</span><br><span class="line"><span class="number">1659410991249</span> main exit. </span><br></pre></td></tr></tbody></table></figure>
<h4 id="completeExceptionally">completeExceptionally</h4>
<p>如果任务尚未完成，则导致调用 get() 和相关方法抛出给定的异常</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">completeExceptionally</span><span class="params">(Throwable ex)</span></span><br></pre></td></tr></tbody></table></figure>
<p>示例</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CompletableFutureExample6</span> {</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> ExecutionException, InterruptedException {</span><br><span class="line">        CompletableFuture&lt;String&gt; result = CompletableFuture.supplyAsync(() -&gt; {</span><br><span class="line">            sleep(<span class="number">3</span>);</span><br><span class="line">            System.out.println(System.currentTimeMillis() + <span class="string">" 任务继续执行"</span>);</span><br><span class="line">            <span class="keyword">return</span> System.currentTimeMillis() + <span class="string">" HELLO"</span>;</span><br><span class="line">        });</span><br><span class="line">        <span class="type">boolean</span> <span class="variable">status</span> <span class="operator">=</span> result.completeExceptionally(<span class="keyword">new</span> <span class="title class_">RuntimeException</span>(<span class="string">"等不及返回结果"</span>));</span><br><span class="line">        System.out.println(System.currentTimeMillis() + <span class="string">" "</span> + status);</span><br><span class="line">        <span class="comment">// 抛出异常</span></span><br><span class="line">        System.out.println(result.get());</span><br><span class="line">        <span class="comment">// 不会执行</span></span><br><span class="line">        <span class="comment">//result.thenAccept((e) -&gt; {</span></span><br><span class="line">        <span class="comment">//    System.out.println("-------------");</span></span><br><span class="line">        <span class="comment">//});</span></span><br><span class="line">        <span class="comment">// 不会执行</span></span><br><span class="line">        <span class="comment">//result.thenApply(e -&gt; "-----");</span></span><br><span class="line">        sleep(<span class="number">5</span>);</span><br><span class="line">        System.out.println(System.currentTimeMillis() + <span class="string">" main exit."</span>);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">sleep</span><span class="params">(<span class="type">int</span> seconds)</span> {</span><br><span class="line">        <span class="keyword">try</span> {</span><br><span class="line">            TimeUnit.SECONDS.sleep(seconds);</span><br><span class="line">        } <span class="keyword">catch</span> (Exception e) {</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">1659412396003</span> <span class="literal">true</span></span><br><span class="line">Exception in thread <span class="string">"main"</span> java.util.concurrent.ExecutionException: java.lang.RuntimeException: 等不及返回结果</span><br><span class="line">	at java.util.concurrent.CompletableFuture.reportGet(CompletableFuture.java:<span class="number">357</span>)</span><br><span class="line">	at java.util.concurrent.CompletableFuture.get(CompletableFuture.java:<span class="number">1895</span>)</span><br><span class="line">	at hots.utils.executor.future.CompletableFutureExample6.main(CompletableFutureExample6.java:<span class="number">22</span>)</span><br><span class="line">Caused by: java.lang.RuntimeException: 等不及返回结果</span><br><span class="line">	at hots.utils.executor.future.CompletableFutureExample6.main(CompletableFutureExample6.java:<span class="number">19</span>)</span><br><span class="line"> </span><br></pre></td></tr></tbody></table></figure>
<h1>并发集合</h1>
<p>JDK中并发队列提供了两种实现,一种是高性能队列ConcurrentLinkedQueue,一种是阻塞队列BlockingQueue,两种都继承自Queue:</p>
<h2 id="BlockingQueue集合类关系图">BlockingQueue集合类关系图</h2>
<p><img src="https://hmxyl-image.oss-cn-hangzhou.aliyuncs.com/note/BlockingDeque-1667231117133-94.png" alt="BlockingDeque"></p>
<h2 id="BlockingQueue的7个子类">BlockingQueue的7个子类</h2>
<ul>
<li>Queue 方法概述</li>
</ul>
<table>
<thead>
<tr>
<th></th>
<th>Throws exception</th>
<th>Returns special value</th>
<th></th>
</tr>
</thead>
<tbody>
<tr>
<td>Insert</td>
<td>add(e)</td>
<td>offer(e)：【@return：true if the element was added to this queue, else false】</td>
<td></td>
</tr>
<tr>
<td>Remove</td>
<td>remove()</td>
<td>poll()：【@return：the head of this queue, or null if the specified waiting time elapses before an element is available】</td>
<td></td>
</tr>
<tr>
<td>Examine</td>
<td>element()</td>
<td>peek()：【@return：the head of this queue, or null if this queue is empty】</td>
<td></td>
</tr>
</tbody>
</table>
<ul>
<li>BlockingQueue 方法概述</li>
</ul>
<table>
<thead>
<tr>
<th></th>
<th>Throws exception</th>
<th>Returns special value</th>
<th>Blocks</th>
<th>Times out</th>
</tr>
</thead>
<tbody>
<tr>
<td>Insert</td>
<td>add(e)</td>
<td>offer(e)</td>
<td>put(e)</td>
<td>offer(e, time, unit)</td>
</tr>
<tr>
<td>Remove</td>
<td>remove()</td>
<td>poll()</td>
<td>take()</td>
<td>poll(time, unit)</td>
</tr>
<tr>
<td>Examine</td>
<td>element()</td>
<td>peek()</td>
<td>—</td>
<td>—</td>
</tr>
</tbody>
</table>
<ul>
<li>说明</li>
</ul>
<ol>
<li>
<p>ArrayBlockingQueue</p>
<p>​		 <strong>基于数组的阻塞队列实现</strong>，在ArrayBlockingQueue内部，维护了一个定长数组，以便缓存队列中的数据对象，这是一个常用的阻塞队列，除了一个定长数组外，ArrayBlockingQueue内部还保存着两个整形变量，分别标识着队列的头部和尾部在数组中的位置。<strong>ArrayBlockingQueue在生产者放入数据和消费者获取数据，都是共用同一个锁对象</strong>，<strong>由此也意味着两者无法真正并行运行，这点尤其不同于LinkedBlockingQueue；</strong> 按照实现原理来分析，ArrayBlockingQueue完全可以采用分离锁，从而实现生产者和消费者操作的完全并行运行。Doug Lea之所以没这样去做，也许是因为ArrayBlockingQueue的数据写入和获取操作已经足够轻巧，以至于引入独立的锁机制，除了给代码带来额外的复杂性外，其在性能上完全占不到任何便宜。  <strong>ArrayBlockingQueue和LinkedBlockingQueue间还有一个明显的不同之处在于，前者在插入或删除元素时不会产生或销毁任何额外的对象实例，而后者则会生成一个额外的Node对象。这在长时间内需要高效并发地处理大批量数据的系统中，其对于GC的影响还是存在一定的区别。而在创建ArrayBlockingQueue时，我们还可以控制对象的内部锁是否采用公平锁，默认采用非公平锁。</strong></p>
</li>
<li>
<p>LinkedBlockingQueue</p>
<ul>
<li><strong>基于链表的阻塞队列</strong>，同ArrayBlockingQueue类似，其内部也维持着一个数据缓冲队列（该队列由一个链表构成）。当生产者往队列中放入一个数据时，队列会从生产者手中获取数据，并缓存在队列内部，而生产者立即返回；只有当队列缓冲区达到最大值缓存容量时（LinkedBlockingQueue可以通过构造函数指定该值），才会阻塞生产者队列，直到消费者从队列中消费掉一份数据，生产者线程会被唤醒，反之对于消费者这端的处理也基于同样的原理。而LinkedBlockingQueue之所以能够高效的处理并发数据，<strong>还因为其对于生产者端和消费者端分别采用了独立的锁来控制数据同步，这也意味着在高并发的情况下生产者和消费者可以并行地操作队列中的数据，以此来提高整个队列的并发性能。</strong></li>
<li><strong>作为开发者，我们需要注意的是，如果构造一个LinkedBlockingQueue对象，而没有指定其容量大小，LinkedBlockingQueue会默认一个类似无限大小的容量（Integer.MAX_VALUE），这样的话，如果生产者的速度一旦大于消费者的速度，也许还没有等到队列满阻塞产生，系统内存就有可能已被消耗殆尽了</strong></li>
<li>ArrayBlockingQueue和LinkedBlockingQueue是两个最普通也是最常用的阻塞队列，一般情况下，在处理多线程间的生产者消费者问题，使用这两个类足以</li>
</ul>
</li>
<li>
<p>PriorityBlockingQueue</p>
<p>​		基于优先级的阻塞队列（优先级的判断通过构造函数传入的Compator对象来决定），但需要注意的是PriorityBlockingQueue并不会阻塞数据生产者，而只会在没有可消费的数据时，阻塞数据的消费者。因此使用的时候要特别注意，生产者生产数据的速度绝对不能快于消费者消费数据的速度，否则时间一长，会最终耗尽所有的可用堆内存空间。在实现PriorityBlockingQueue时，<strong>内部控制线程同步的锁采用的是公平锁</strong></p>
</li>
<li>
<p>DelayQueue</p>
<p>​		DelayQueue中的元素只有当其指定的延迟时间到了，才能够从队列中获取到该元素。DelayQueue是一个没有大小限制的队列，因此往队列中插入数据的操作（生产者）永远不会被阻塞，而只有获取数据的操作（消费者）才会被阻塞。</p>
<p>​		DelayQueue使用场景较少，但都相当巧妙，常见的例子比如使用一个DelayQueue来管理一个超时未响应的连接队列。</p>
</li>
<li>
<p>SynchronousQueue</p>
<p>​		一种无缓冲的等待队列，生产者产生的数据直接会被消费者获取并消费， 类似于无中介的直接交易，有点像原始社会中的生产者和消费者，生产者拿着产品去集市销售给产品的最终消费者，而消费者必须亲自去集市找到所要商品的直接生产者，如果一方没有找到合适的目标，那么对不起，大家都在集市等待。相对于有缓冲的BlockingQueue来说，少了一个中间经销商的环节（缓冲区），如果有经销商，生产者直接把产品批发给经销商，而无需在意经销商最终会将这些产品卖给那些消费者，由于经销商可以库存一部分商品，因此相对于直接交易模式，总体来说采用中间经销商的模式会吞吐量高一些（可以批量买卖）；但另一方面，又因为经销商的引入，使得产品从生产者到消费者中间增加了额外的交易环节，单个产品的及时响应性能可能会降低。</p>
<p>​		声明一个SynchronousQueue有两种不同的方式，它们之间有着不太一样的行为。</p>
<p>公平模式和非公平模式的区别:</p>
<ul>
<li>
<p>如果采用公平模式：SynchronousQueue会采用公平锁，并<strong>配合一个FIFO队列</strong>来阻塞多余的生产者和消费者，从而体系整体的公平策略；</p>
</li>
<li>
<p>但如果是非公平模式（SynchronousQueue默认）：SynchronousQueue采用非公平锁，同时<strong>配合一个LIFO队列</strong>来管理多余的生产者和消费者，而后一种模式，如果生产者和消费者的处理速度有差距，则很容易出现饥渴的情况，即可能有某些生产者或者是消费者的数据永远都得不到处理。</p>
</li>
</ul>
</li>
<li>
<p>LinkedTransferQueue</p>
<p>传入的数据，需要担保被使用了。否则放入失败/阻塞</p>
<figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">private static final int NOW   = 0; // for untimed poll, tryTransfer</span><br><span class="line">private static final int ASYNC = 1; // for offer, put, add</span><br><span class="line">private static final int SYNC  = 2; // for transfer, take</span><br><span class="line">private static final int TIMED = 3; // for timed poll, tryTransfer</span><br></pre></td></tr></tbody></table></figure>
</li>
</ol>
<table>
<thead>
<tr>
<th></th>
<th>ArrayBlockingQueue</th>
<th>PriorityBlockingQueue</th>
<th>LinkedBlockingQueue</th>
<th>LinkedBlockingDeque</th>
<th>SynchronousQueue</th>
<th>DelayQueue</th>
<th>LinkedTransferQueue</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>bounded（边界）</strong></td>
<td>Y</td>
<td>N</td>
<td>Optional</td>
<td>Optional</td>
<td>Y</td>
<td>N</td>
<td>N</td>
</tr>
<tr>
<td><strong>add</strong></td>
<td>添加成功：返回<code>true</code>；<br>添加失败（已满）：抛出<code>IllegalStateException</code><br></td>
<td>调用<code>offer</code>，返回结果同offer</td>
<td>调用<code>offer</code><br>添加成功：返回<code>true</code>；<br>添加失败（false）：抛出<code>IllegalStateException</code><br></td>
<td><font color="orange"><strong>由<code>addLast</code>执行</strong></font><br><br>调用<code>offerLast</code><br>添加成功：返回<code>true</code>；<br>添加失败（false）：抛出<code>IllegalStateException</code><br></td>
<td>调用<code>offer</code><br>添加成功：返回<code>true</code>；<br>添加失败（已满）：抛出<code>IllegalStateException</code><br></td>
<td>同<code>offer</code></td>
<td>在尾部插入元素<br>无边界Queue，不会抛出IllegalStateException，或者false。<br>添加成功：返回<code>true</code>；<br></td>
</tr>
<tr>
<td><font color="red"><strong>offer</strong></font></td>
<td>添加成功：返回<code>true</code>；<br>添加失败(已满)：返回<code>false</code><br></td>
<td>添加成功，返回<code>true</code>；<br>无边界，不存在已满<br>抛出异常：元素无法compare<br></td>
<td>队尾添加成功：返回<code>true</code>；<br>添加失败(已满)：返回<code>false</code><br></td>
<td><font color="orange"><strong>同<code>offerLast</code></strong></font><br><br>队尾添加成功：返回<code>true</code>；<br>添加失败(已满)：返回<code>false</code><br></td>
<td>如果另一个线程正在等待接收，则将指定元素插入此队列，返回<code>true</code>;<br>没有接收线程，返回<code>false</code></td>
<td>在尾部插入元素<br>添加成功，返回<code>true</code>；<br>无边界Queue，不存在已满<br></td>
<td>同 <code>add</code></td>
</tr>
<tr>
<td><font color="blue"><strong>put（阻塞）</strong></font></td>
<td>将指定元素插入此队列的==尾部==，如果队列已满，则==等待空间可用==</td>
<td>同<code>offer</code>。无边界，无需阻塞。</td>
<td>在此队列的尾部插入指定元素，如有必要，则==等待空间可用==。</td>
<td><font color="orange"><strong>同<code>putLast</code></strong></font><br><br>在此队列的尾部插入指定元素，如有必要，则==等待空间可用==。</td>
<td>将指定元素添加到此队列中，阻塞，等待另一个线程接收它。</td>
<td>同<code>offer</code></td>
<td>同<code>add</code></td>
</tr>
<tr>
<td><strong>remove</strong></td>
<td><code>poll</code>头部元素，如果为null，则会抛出异常</td>
<td><code>poll</code>头部元素，如果为null，则会抛出异常</td>
<td><code>poll</code>头部元素，如果为null，则会抛出异常</td>
<td><font color="orange"> <strong>同<code>removeFirst</code></strong> </font> <br><br><code>pollFirst</code>头部元素，如果为null，则会抛出异常</td>
<td><code>poll</code>头部元素，如果为null，则会抛出异常</td>
<td><code>poll</code>头部元素，如果为null，则会抛出异常</td>
<td><code>poll</code>头部元素，如果为null，则会抛出异常</td>
</tr>
<tr>
<td><font color="red"><strong>poll</strong></font></td>
<td>移除头部元素并返回<br>无元素返回<code>null</code></td>
<td>移除头部元素并返回<br>无元素返回<code>null</code></td>
<td>移除头部元素并返回<br>无元素返回<code>null</code></td>
<td><font color="orange"> <strong>同<code>pollFirst</code></strong> </font> <br><br>移除头部元素并返回<br>无元素返回<code>null</code></td>
<td>移除头部元素并返回<br>如果没有可用元素，则返回 <code>null</code><br>无元素返回<code>null</code></td>
<td>移除头部元素并返回<br>如果此队列没有具有过期延迟的元素，则返回<code>null</code><br>无元素返回<code>null</code></td>
<td>移除头部元素并返回<br>无元素返回<code>null</code></td>
</tr>
<tr>
<td><strong>element</strong></td>
<td><code>peek </code>头部元素<br>若结果为null，则抛出异常<code>NoSuchElementException</code></td>
<td><code>peek </code>头部元素<br>若结果为null，则抛出异常<code>NoSuchElementException</code></td>
<td><code>peek </code>头部元素<br>若结果为null，则抛出异常<code>NoSuchElementException</code></td>
<td>**<code>peekFirst</code>**头部元素<br><br>若结果为null，则抛出异常<code>NoSuchElementException</code></td>
<td><code>peek </code>头部元素<br>永远抛出<code>NoSuchElementException</code></td>
<td><code>peek </code>头部元素<br>若结果为null，则抛出异常<code>NoSuchElementException</code></td>
<td><code>peek </code>头部元素<br>若结果为null，则抛出异常<code>NoSuchElementException</code></td>
</tr>
<tr>
<td><strong>peek</strong></td>
<td>获取头部元素<br>不会删除元素</td>
<td>获取头部元素<br>不会删除元素</td>
<td>获取头部元素<br>不会删除元素</td>
<td>**<code>peekFirst</code>**头部元素<br><br>获取头部元素<br>不会删除元素</td>
<td>直接 <code>return null</code></td>
<td>获取头部元素<br>不会删除元素</td>
<td>获取头部元素<br>不会删除元素</td>
</tr>
<tr>
<td><font color="blue"><strong>take（阻塞）</strong></font></td>
<td>移除头部元素并返回<br>队列无元素，则阻塞等待<br></td>
<td>移除头部元素并返回<br>队列无元素，则阻塞等待<br></td>
<td>移除头部元素并返回<br>队列无元素，则阻塞等待<br></td>
<td>同**<code>takeFirst</code>**<br><br>移除头部元素并返回<br>队列无元素，则阻塞等待<br></td>
<td>一直等待，直到有另一个线程<code>transfer</code>元素</td>
<td>一直等待，直到有线程放进元素，且头部元素过期</td>
<td>一直等待，直到有线程放进元素</td>
</tr>
<tr>
<td><strong>transfer</strong></td>
<td>无</td>
<td>无</td>
<td>无</td>
<td>无</td>
<td>无</td>
<td>无</td>
<td>在队列尾部插入元素，若没有被消费，则一直等待</td>
</tr>
</tbody>
</table>
<ul>
<li>
<p>ConcurrentHashMap</p>
</li>
<li>
<p>ConcurrentSkipListMap</p>
</li>
<li>
<p>ConcurrentSkipListSet</p>
</li>
<li>
<p>ConcurrentLinkedQueue</p>
</li>
<li>
<p>ConcurrentLinkedDeque</p>
</li>
<li>
<p>CopyOnWriteArrayList</p>
</li>
<li>
<p>CopyOnWriteArraySet</p>
</li>
</ul>

    </div>

    
    
    

    <footer class="post-footer">
          <div class="post-tags">
              <a href="/tags/Java/" rel="tag"># Java</a>
          </div>

        

          <div class="post-nav">
            <div class="post-nav-item">
                <a href="/20221031/c5d54bc1.html" rel="prev" title="MongoDB安装">
                  <i class="fa fa-angle-left"></i> MongoDB安装
                </a>
            </div>
            <div class="post-nav-item">
                <a href="/20221101/8c062783.html" rel="next" title="多线程设计模式">
                  多线程设计模式 <i class="fa fa-angle-right"></i>
                </a>
            </div>
          </div>
    </footer>
  </article>
</div>






</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">

  <div class="copyright">
    &copy; 
    <span itemprop="copyrightYear">2025</span>
    <span class="with-love">
      <i class="fa fa-heart"></i>
    </span>
    <span class="author" itemprop="copyrightHolder">Alisa</span>
  </div>

    </div>
  </footer>

  
  <div class="toggle sidebar-toggle" role="button">
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
  </div>
  <div class="sidebar-dimmer"></div>
  <div class="back-to-top" role="button" aria-label="返回顶部">
    <i class="fa fa-arrow-up fa-lg"></i>
    <span>0%</span>
  </div>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>

</body>
</html>
