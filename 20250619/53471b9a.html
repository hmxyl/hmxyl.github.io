<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="theme-color" content="#222"><meta name="generator" content="Hexo 7.3.0">

  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">



<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.7.2/css/all.min.css" integrity="sha256-dABdfBfUoC8vJUBOwGVdm8L9qlMWaHTIfXt+7GnZCIo=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/3.1.1/animate.min.css" integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin="anonymous">

<script class="next-config" data-name="main" type="application/json">{"hostname":"hmxyl.github.io","root":"/","images":"/images","scheme":"Muse","darkmode":false,"version":"8.23.1","exturl":false,"sidebar":{"position":"left","width_expanded":320,"width_dual_column":240,"display":"post","padding":18,"offset":12},"hljswrap":true,"codeblock":{"theme":{"light":"default","dark":"stackoverflow-dark"},"prism":{"light":"prism","dark":"prism-dark"},"copy_button":{"enable":false,"style":null},"fold":{"enable":false,"height":500},"language":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"stickytabs":false,"motion":{"enable":true,"async":false,"duration":200,"transition":{"menu_item":"fadeInDown","post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"i18n":{"placeholder":"搜索...","empty":"没有找到任何搜索结果：${query}","hits_time":"找到 ${hits} 个搜索结果（用时 ${time} 毫秒）","hits":"找到 ${hits} 个搜索结果"},"path":"/search.xml","localsearch":{"enable":true,"top_n_per_article":1,"unescape":false,"preload":false}}</script><script src="/js/config.js" defer></script>

    <meta name="description" content="多线程基础">
<meta property="og:type" content="article">
<meta property="og:title" content="多线程基础">
<meta property="og:url" content="https://hmxyl.github.io/20250619/53471b9a.html">
<meta property="og:site_name" content="Alisa&#39;s Home">
<meta property="og:description" content="多线程基础">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://hmxyl-image.oss-cn-hangzhou.aliyuncs.com/note/image-20211227170019463.png">
<meta property="og:image" content="https://hmxyl-image.oss-cn-hangzhou.aliyuncs.com/note/image-20211227170133400.png">
<meta property="og:image" content="https://hmxyl-image.oss-cn-hangzhou.aliyuncs.com/note/image-20211228162829691.png">
<meta property="article:published_time" content="2025-06-19T08:57:01.000Z">
<meta property="article:modified_time" content="2025-06-20T12:49:16.381Z">
<meta property="article:author" content="Alisa">
<meta property="article:tag" content="Java">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://hmxyl-image.oss-cn-hangzhou.aliyuncs.com/note/image-20211227170019463.png">


<link rel="canonical" href="https://hmxyl.github.io/20250619/53471b9a.html">


<script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":false,"isPost":true,"lang":"zh-CN","comments":true,"permalink":"https://hmxyl.github.io/20250619/53471b9a.html","path":"20250619/53471b9a.html","title":"多线程基础"}</script>

<script class="next-config" data-name="calendar" type="application/json">""</script>
<title>多线程基础 | Alisa's Home</title>
  








  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous" defer></script>
<script src="/js/utils.js" defer></script><script src="/js/motion.js" defer></script><script src="/js/sidebar.js" defer></script><script src="/js/next-boot.js" defer></script>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/hexo-generator-searchdb/1.4.1/search.js" integrity="sha256-1kfA5uHPf65M5cphT2dvymhkuyHPQp5A53EGZOnOLmc=" crossorigin="anonymous" defer></script>
<script src="/js/third-party/search/local-search.js" defer></script>







  





  <noscript>
    <link rel="stylesheet" href="/css/noscript.css">
  </noscript>

<style>.github-emoji { position: relative; display: inline-block; width: 1.2em; min-height: 1.2em; overflow: hidden; vertical-align: top; color: transparent; }  .github-emoji > span { position: relative; z-index: 10; }  .github-emoji img, .github-emoji .fancybox { margin: 0 !important; padding: 0 !important; border: none !important; outline: none !important; text-decoration: none !important; user-select: none !important; cursor: auto !important; }  .github-emoji img { height: 1.2em !important; width: 1.2em !important; position: absolute !important; left: 50% !important; top: 50% !important; transform: translate(-50%, -50%) !important; user-select: none !important; cursor: auto !important; } .github-emoji-fallback { color: inherit; } .github-emoji-fallback img { opacity: 0 !important; }</style>
</head>

<body itemscope itemtype="http://schema.org/WebPage" class="use-motion">
  <div class="headband"></div>

  <main class="main">
    <div class="column">
      <header class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏" role="button">
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <p class="site-title">Alisa's Home</p>
      <i class="logo-line"></i>
    </a>
      <p class="site-subtitle" itemprop="description">Alisa's Home</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger" aria-label="搜索" role="button">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>



<nav class="site-nav">
  <ul class="main-menu menu"><li class="menu-item menu-item-home"><a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a></li><li class="menu-item menu-item-tags"><a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>标签</a></li><li class="menu-item menu-item-categories"><a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>分类</a></li><li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档</a></li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>搜索
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup">
      <div class="search-header">
        <span class="search-icon">
          <i class="fa fa-search"></i>
        </span>
        <div class="search-input-container">
          <input autocomplete="off" autocapitalize="off" maxlength="80"
                placeholder="搜索..." spellcheck="false"
                type="search" class="search-input">
        </div>
        <span class="popup-btn-close" role="button">
          <i class="fa fa-times-circle"></i>
        </span>
      </div>
      <div class="search-result-container">
        <div class="search-result-icon">
          <i class="fa fa-spinner fa-pulse fa-5x"></i>
        </div>
      </div>
    </div>
  </div>

</header>
        
  
  <aside class="sidebar">

    <div class="sidebar-inner sidebar-nav-active sidebar-toc-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
            <div class="post-toc animated"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#Chapter1%EF%BC%9A%E5%BF%AB%E9%80%9F%E8%AE%A4%E8%AF%86%E7%BA%BF%E7%A8%8B"><span class="nav-number">1.</span> <span class="nav-text">Chapter1：快速认识线程</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%BB%A7%E6%89%BFThread%E7%B1%BB%E5%88%9B%E5%BB%BA%E7%BA%BF%E7%A8%8B%E7%B1%BB%EF%BC%88%E6%A8%A1%E6%9D%BF%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F%EF%BC%89"><span class="nav-number">1.1.</span> <span class="nav-text">继承Thread类创建线程类（模板设计模式）</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E9%80%9A%E8%BF%87Runnable%E6%8E%A5%E5%8F%A3%E5%88%9B%E5%BB%BA%E7%BA%BF%E7%A8%8B%E7%B1%BB%EF%BC%88%E7%AD%96%E7%95%A5%E6%A8%A1%E5%BC%8F%E7%9A%84%E5%BA%94%E7%94%A8%EF%BC%89"><span class="nav-number">1.2.</span> <span class="nav-text">通过Runnable接口创建线程类（策略模式的应用）</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Chapter2%EF%BC%9A%E6%B7%B1%E5%85%A5%E7%90%86%E8%A7%A3Thread%E7%9A%84%E6%9E%84%E9%80%A0%E5%87%BD%E6%95%B0"><span class="nav-number">2.</span> <span class="nav-text">Chapter2：深入理解Thread的构造函数</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Thread%E5%91%BD%E5%90%8D"><span class="nav-number">2.1.</span> <span class="nav-text">Thread命名</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Thread%E5%92%8CThreadGroup"><span class="nav-number">2.2.</span> <span class="nav-text">Thread和ThreadGroup</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Thread%E5%92%8CstackSize"><span class="nav-number">2.3.</span> <span class="nav-text">Thread和stackSize</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%AE%88%E6%8A%A4%E7%BA%BF%E7%A8%8B"><span class="nav-number">2.4.</span> <span class="nav-text">守护线程</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Chapter3%EF%BC%9A-Thread-API"><span class="nav-number">3.</span> <span class="nav-text">Chapter3： Thread API</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#join"><span class="nav-number">3.1.</span> <span class="nav-text">join()</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#interrupt"><span class="nav-number">3.2.</span> <span class="nav-text">interrupt()</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%90%88%E7%90%86%E5%85%B3%E9%97%AD%E4%B8%80%E4%B8%AA%E7%BA%BF%E7%A8%8B"><span class="nav-number">3.3.</span> <span class="nav-text">合理关闭一个线程</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Chapter4%EF%BC%9A%E7%BA%BF%E7%A8%8B%E5%AE%89%E5%85%A8%E4%B8%8E%E6%95%B0%E6%8D%AE%E5%90%8C%E6%AD%A5"><span class="nav-number">4.</span> <span class="nav-text">Chapter4：线程安全与数据同步</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#synchronized%E5%85%B3%E9%94%AE%E5%AD%97"><span class="nav-number">4.1.</span> <span class="nav-text">synchronized关键字</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#this-monitor-%E5%92%8C-class-monitor"><span class="nav-number">4.2.</span> <span class="nav-text">this monitor 和 class monitor</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Chapter5%EF%BC%9A%E7%BA%BF%E7%A8%8B%E4%B9%8B%E9%97%B4%E7%9A%84%E9%80%9A%E4%BF%A1"><span class="nav-number">5.</span> <span class="nav-text">Chapter5：线程之间的通信</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#wait-%E5%92%8C-sleep%E5%92%8C%E5%8C%BA%E5%88%AB"><span class="nav-number">5.1.</span> <span class="nav-text">wait 和 sleep和区别</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%8D%95%E7%BA%BF%E7%A8%8B%E9%80%9A%E4%BF%A1"><span class="nav-number">5.2.</span> <span class="nav-text">单线程通信</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%A4%9A%E7%BA%BF%E7%A8%8B%E9%80%9A%E4%BF%A1"><span class="nav-number">5.3.</span> <span class="nav-text">多线程通信</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E8%87%AA%E5%AE%9A%E4%B9%89%E6%98%BE%E7%A4%BA%E9%94%81"><span class="nav-number">5.4.</span> <span class="nav-text">自定义显示锁</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Chapter6%EF%BC%9AThread-Group"><span class="nav-number">6.</span> <span class="nav-text">Chapter6：Thread Group</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Thread-%E4%B8%8E-ThreadGroup"><span class="nav-number">6.1.</span> <span class="nav-text">Thread 与 ThreadGroup</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%9F%BA%E6%9C%AC%E6%93%8D%E4%BD%9C"><span class="nav-number">6.2.</span> <span class="nav-text">基本操作</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%AE%88%E6%8A%A4ThreadGroup"><span class="nav-number">6.3.</span> <span class="nav-text">守护ThreadGroup</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Chapter7%EF%BC%9AHook%E7%BA%BF%E7%A8%8B%E4%BB%A5%E5%8F%8A%E6%8D%95%E8%8E%B7%E7%BA%BF%E7%A8%8B%E6%89%A7%E8%A1%8C%E5%BC%82%E5%B8%B8"><span class="nav-number">7.</span> <span class="nav-text">Chapter7：Hook线程以及捕获线程执行异常</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E8%8E%B7%E5%8F%96%E7%BA%BF%E7%A8%8B%E8%BF%90%E8%A1%8C%E6%97%B6%E5%BC%82%E5%B8%B8"><span class="nav-number">7.1.</span> <span class="nav-text">获取线程运行时异常</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%A4%84%E7%90%86Thread%E8%BF%90%E8%A1%8C%E6%97%B6%E5%BC%82%E5%B8%B8API%EF%BC%8C%E6%9C%89%E5%9B%9B%E4%B8%AA"><span class="nav-number">7.1.1.</span> <span class="nav-text">处理Thread运行时异常API，有四个</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#UncaughtExceptionHandler%E5%AE%9E%E4%BE%8B"><span class="nav-number">7.1.2.</span> <span class="nav-text">UncaughtExceptionHandler实例</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#UncaughtExceptionHandler%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90"><span class="nav-number">7.1.3.</span> <span class="nav-text">UncaughtExceptionHandler源码分析</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%B3%A8%E5%85%A5Hook%E7%BA%BF%E7%A8%8B"><span class="nav-number">7.2.</span> <span class="nav-text">注入Hook线程</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#Hook%E7%BA%BF%E7%A8%8B%E6%A6%82%E5%BF%B5"><span class="nav-number">7.2.1.</span> <span class="nav-text">Hook线程概念</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Linux-%E6%A8%A1%E6%8B%9FHook%E7%AE%80%E5%8D%95%E8%B0%83%E7%94%A8"><span class="nav-number">7.2.2.</span> <span class="nav-text">Linux 模拟Hook简单调用</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Hook%E7%BA%BF%E7%A8%8B%E5%AE%9E%E9%99%85%E5%BA%94%E7%94%A8%E4%B8%BE%E4%BE%8B"><span class="nav-number">7.2.3.</span> <span class="nav-text">Hook线程实际应用举例</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Chapter8%EF%BC%9A%E7%BA%BF%E7%A8%8B%E6%B1%A0%E5%8E%9F%E7%90%86%E4%BB%A5%E5%8F%8A%E8%87%AA%E5%AE%9A%E4%B9%89%E7%BA%BF%E7%A8%8B%E6%B1%A0"><span class="nav-number">8.</span> <span class="nav-text">Chapter8：线程池原理以及自定义线程池</span></a></li></ol></div>
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-author animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">Alisa</p>
  <div class="site-description" itemprop="description">学习笔记、工作心得</div>
</div>
<div class="site-state-wrap animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
        <a href="/archives/">
          <span class="site-state-item-count">101</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
          <a href="/categories/">
        <span class="site-state-item-count">45</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
      <div class="site-state-item site-state-tags">
          <a href="/tags/">
        <span class="site-state-item-count">39</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>

        </div>
      </div>
    </div>

    
  </aside>


    </div>

    <div class="main-inner post posts-expand">


  


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://hmxyl.github.io/20250619/53471b9a.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Alisa">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Alisa's Home">
      <meta itemprop="description" content="学习笔记、工作心得">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="多线程基础 | Alisa's Home">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          多线程基础
        </h1>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2025-06-19 16:57:01" itemprop="dateCreated datePublished" datetime="2025-06-19T16:57:01+08:00">2025-06-19</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2025-06-20 20:49:16" itemprop="dateModified" datetime="2025-06-20T20:49:16+08:00">2025-06-20</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E5%90%8E%E7%AB%AF/" itemprop="url" rel="index"><span itemprop="name">后端</span></a>
        </span>
          ，
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E5%90%8E%E7%AB%AF/Java/" itemprop="url" rel="index"><span itemprop="name">Java</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody"><h2 id="Chapter1：快速认识线程">Chapter1：快速认识线程</h2>
<h3 id="继承Thread类创建线程类（模板设计模式）">继承Thread类创建线程类（模板设计模式）</h3>
<p>（1）定义Thread类的子类，并重写该类的run方法，该run方法的方法体就代表了线程要完成的任务。因此把run()方法称为执行体。</p>
<p>（2）创建Thread子类的实例，即创建了线程对象。</p>
<p>（3）调用线程对象的start()方法来启动该线程。</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> java.util.concurrent.atomic.AtomicInteger;</span><br><span class="line"><span class="comment">// 定义Thread类的子类，并重写该类的run方法</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">TicketWindow</span> <span class="keyword">extends</span> <span class="title class_">Thread</span> {</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="type">int</span> <span class="variable">MAX</span> <span class="operator">=</span> <span class="number">50</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="type">AtomicInteger</span> <span class="variable">index</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">AtomicInteger</span>(<span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> String name;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">TicketWindow</span><span class="params">(String name)</span> {</span><br><span class="line">        <span class="built_in">this</span>.name = name;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> {</span><br><span class="line">        <span class="keyword">while</span> (index.get() &lt;= MAX) {</span><br><span class="line">            System.out.println(<span class="string">"柜台："</span> + name + <span class="string">"当前的号码是："</span> + index.addAndGet(<span class="number">1</span>));</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">bankTest1</span><span class="params">()</span> {</span><br><span class="line">  <span class="comment">// step2：创建Thread子类的实例，即创建了线程对象</span></span><br><span class="line">  <span class="type">TicketWindow</span> <span class="variable">ticketWindow1</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TicketWindow</span>(<span class="string">"一号"</span>);</span><br><span class="line">  <span class="comment">// step3: 调用线程对象的start()方法来启动该线程</span></span><br><span class="line">  ticketWindow1.start();</span><br><span class="line">  <span class="type">TicketWindow</span> <span class="variable">ticketWindow2</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TicketWindow</span>(<span class="string">"二号"</span>);</span><br><span class="line">  ticketWindow2.start();</span><br><span class="line">  <span class="type">TicketWindow</span> <span class="variable">ticketWindow3</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TicketWindow</span>(<span class="string">"三号"</span>);</span><br><span class="line">  ticketWindow3.start();</span><br><span class="line">  <span class="type">TicketWindow</span> <span class="variable">ticketWindow4</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TicketWindow</span>(<span class="string">"四号"</span>);</span><br><span class="line">  ticketWindow4.start();</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<h3 id="通过Runnable接口创建线程类（策略模式的应用）">通过Runnable接口创建线程类（策略模式的应用）</h3>
<p>为了将可执行的控制单元和线程控制分割开来</p>
<p>（1）定义runnable接口的实现类，并重写该接口的run()方法，该run()方法的方法体同样是该线程的线程执行体。</p>
<p>（2）创建 Runnable实现类的实例，并依此实例作为Thread的target来创建Thread对象，该Thread对象才是真正的线程对象。</p>
<p>（3）调用线程对象的start()方法来启动该线程。</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">TickWindowRunnable</span> <span class="keyword">implements</span> <span class="title class_">Runnable</span> {</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="type">int</span> <span class="variable">MAX</span> <span class="operator">=</span> <span class="number">50</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> <span class="variable">index</span> <span class="operator">=</span> <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> {</span><br><span class="line">        <span class="keyword">while</span> (index &lt;= MAX) {</span><br><span class="line">            System.out.println(Thread.currentThread().getName() + <span class="string">"的号码是："</span> + index++);</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">bankTest2</span><span class="params">()</span> {</span><br><span class="line">  <span class="type">TickWindowRunnable</span> <span class="variable">ticketWindowRunnable</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TickWindowRunnable</span>();</span><br><span class="line">  <span class="type">Thread</span> <span class="variable">ticketWindow1</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Thread</span>(ticketWindowRunnable, <span class="string">"一号"</span>);</span><br><span class="line">  <span class="type">Thread</span> <span class="variable">ticketWindow2</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Thread</span>(ticketWindowRunnable, <span class="string">"二号"</span>);</span><br><span class="line">  <span class="type">Thread</span> <span class="variable">ticketWindow3</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Thread</span>(ticketWindowRunnable, <span class="string">"三号"</span>);</span><br><span class="line">  <span class="type">Thread</span> <span class="variable">ticketWindow4</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Thread</span>(ticketWindowRunnable, <span class="string">"四号"</span>);</span><br><span class="line"></span><br><span class="line">  ticketWindow1.start();</span><br><span class="line">  ticketWindow2.start();</span><br><span class="line">  ticketWindow3.start();</span><br><span class="line">  ticketWindow4.start();</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">//java8改造</span></span><br><span class="line"> <span class="meta">@Test</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">bankTest3</span><span class="params">()</span> {</span><br><span class="line">  <span class="keyword">final</span> <span class="type">int</span> <span class="variable">MAX</span> <span class="operator">=</span> <span class="number">50</span>;</span><br><span class="line">  <span class="keyword">final</span> <span class="type">AtomicInteger</span> <span class="variable">index</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">AtomicInteger</span>(<span class="number">0</span>);</span><br><span class="line">  <span class="keyword">final</span> <span class="type">Runnable</span> <span class="variable">runnable</span> <span class="operator">=</span> () -&gt; {</span><br><span class="line">    <span class="keyword">while</span> (index.get() &lt;= MAX) {</span><br><span class="line">      System.out.println(Thread.currentThread().getName() + <span class="string">"的号码是："</span> + index.addAndGet(<span class="number">1</span>));</span><br><span class="line">    }</span><br><span class="line">  };</span><br><span class="line"></span><br><span class="line">  <span class="type">Thread</span> <span class="variable">ticketWindow1</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Thread</span>(runnable, <span class="string">"一号"</span>);</span><br><span class="line">  <span class="type">Thread</span> <span class="variable">ticketWindow2</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Thread</span>(runnable, <span class="string">"二号"</span>);</span><br><span class="line">  <span class="type">Thread</span> <span class="variable">ticketWindow3</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Thread</span>(runnable, <span class="string">"三号"</span>);</span><br><span class="line">  <span class="type">Thread</span> <span class="variable">ticketWindow4</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Thread</span>(runnable, <span class="string">"四号"</span>);</span><br><span class="line"></span><br><span class="line">  ticketWindow1.start();</span><br><span class="line">  ticketWindow2.start();</span><br><span class="line">  ticketWindow3.start();</span><br><span class="line">  ticketWindow4.start();</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<h2 id="Chapter2：深入理解Thread的构造函数">Chapter2：深入理解Thread的构造函数</h2>
<table>
<thead>
<tr>
<th style="text-align:left">序号</th>
<th style="text-align:left">方法</th>
<th>说明</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">1</td>
<td style="text-align:left">Thread()</td>
<td>Allocates a new Thread object.</td>
</tr>
<tr>
<td style="text-align:left">2</td>
<td style="text-align:left">Thread(Runnable target)</td>
<td>Allocates a new Thread object.</td>
</tr>
<tr>
<td style="text-align:left">3</td>
<td style="text-align:left">Thread(Runnable target, String name)</td>
<td>Allocates a new Thread object.</td>
</tr>
<tr>
<td style="text-align:left">4</td>
<td style="text-align:left">Thread(String name)</td>
<td>Allocates a new Thread object.</td>
</tr>
<tr>
<td style="text-align:left">5</td>
<td style="text-align:left">Thread(ThreadGroup group, Runnable  target)</td>
<td>Allocates a new Thread object.</td>
</tr>
<tr>
<td style="text-align:left">6</td>
<td style="text-align:left">Thread(ThreadGroup group, Runnable  target, String name)</td>
<td>Allocates a new Thread object so that it has target as its run object,  has the specified name as its name, and belongs to the thread group referred  to by group.</td>
</tr>
<tr>
<td style="text-align:left">7</td>
<td style="text-align:left">Thread(ThreadGroup group, Runnable  target, String name, long stackSize)</td>
<td>Allocates a new Thread object so that it has target as its run object,  has the specified name as its name, and belongs to the thread group referred  to by group, and has the specified stack size.</td>
</tr>
<tr>
<td style="text-align:left">8</td>
<td style="text-align:left">Thread(ThreadGroup group, String  name)</td>
<td>Allocates a new Thread object.</td>
</tr>
</tbody>
</table>
<h3 id="Thread命名">Thread命名</h3>
<ol>
<li>
<p>默认线程名称，按照编号，从0开始递增。线程一旦启动，线程名不可再进行更改。</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="title function_">Thread</span><span class="params">()</span> {</span><br><span class="line">  init(<span class="literal">null</span>, <span class="literal">null</span>, <span class="string">"Thread-"</span> + nextThreadNum(), <span class="number">0</span>);</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
</li>
</ol>
<h3 id="Thread和ThreadGroup">Thread和ThreadGroup</h3>
<ol>
<li>main线程所在的ThreadGroup称为main</li>
<li>构造一个线程如果没有显示的指定ThreadGroup，他将和父线程在同一个ThreadGroup</li>
</ol>
<h3 id="Thread和stackSize">Thread和stackSize</h3>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">* 测试默认栈深度 </span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">TestStack</span> {</span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> <span class="variable">counter</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">recur</span><span class="params">()</span> {</span><br><span class="line">        counter++;</span><br><span class="line">        recur();<span class="comment">//递归</span></span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">getStackDepth</span><span class="params">()</span> {</span><br><span class="line">        <span class="keyword">try</span> {</span><br><span class="line">            recur();</span><br><span class="line">        } <span class="keyword">catch</span> (Throwable t) {</span><br><span class="line">            System.out.println(<span class="string">"栈最大深度："</span> + counter);</span><br><span class="line">            t.printStackTrace();</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> {</span><br><span class="line">        <span class="type">TestStack</span> <span class="variable">stack</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TestStack</span>();</span><br><span class="line">        stack.getStackDepth();</span><br><span class="line">    }</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">结果：<span class="number">18368</span>  </span><br><span class="line"></span><br><span class="line"># 查看配置</span><br><span class="line">jinfo -flag ThreadStackSize  <span class="number">16320</span></span><br></pre></td></tr></tbody></table></figure>
<h3 id="守护线程">守护线程</h3>
<p>设置守护线程的方法很简单，调用<strong>setDaemon</strong>方法即可，true代表守护线程，false代表正常线程。</p>
<p>线程是否为守护线程和它的父线程有很大的关系，如果父线程是正常线程，则子线程也是正常线程，反之亦然，如果你想要修改它的特性则可以借助方法。<br>
<strong>isDaemon</strong>方法可以判断该线程是不是守护线程。</p>
<p>另外需要注意的就是，<strong>setDaemon方法只在线程启动之前才能生效</strong>，如果一个线程已经死亡，那么再设置setDaemon则会抛出<strong>IllegalThreadStateException</strong>异常。</p>
<h2 id="Chapter3：-Thread-API">Chapter3： Thread API</h2>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title function_">setName</span><span class="params">(String name)</span> <span class="comment">// 设置线程名称</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title function_">setPriority</span><span class="params">(<span class="type">int</span> newPriority)</span> <span class="comment">// 设置线程优先级</span></span><br></pre></td></tr></tbody></table></figure>
<h3 id="join">join()</h3>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title function_">join</span><span class="params">()</span></span><br><span class="line">  </span><br><span class="line"><span class="comment">// 主线程等待线程threadTest1、threadTest2执行完成</span></span><br><span class="line"><span class="comment">// threadTest1、threadTest2 交替执行</span></span><br><span class="line">threadTest1.join();</span><br><span class="line">threadTest2.join();</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">// 以下写法，main 线程等待main 线程结束，所有程序一直处于等待状态，无法终止。</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception{</span><br><span class="line">  Thread.currentThread().join();</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<h3 id="interrupt">interrupt()</h3>
<p>如下方法的调用会使得当前线程进人阻塞状态，而调用当前线程的interrupt方法，就可以打断阻塞。</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">join()、sleep()、wait()...</span><br></pre></td></tr></tbody></table></figure>
<p>上述若干方法都会使得当前线程进人阻塞状态，若另外的一个线程调用被阻塞线程的<strong>interrupt</strong>方法，则会打断这种阻塞，因此这种方法有时会被称为可中断方法。</p>
<p>==打断一个线程并不等于该线程的生命周期结束，仅仅是打断了当前线程的阻塞状态==。</p>
<p>一旦线程在阻塞的情况下被打断，都会抛出一个称为<strong>InterruptedException</strong>的异常，这个异常就像一个signal（信号）一样通知当前线程被打断了。</p>
<h3 id="合理关闭一个线程">合理关闭一个线程</h3>
<ol>
<li>
<p>利用中断信号</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> InterruptedException {</span><br><span class="line">	<span class="type">Thread</span> <span class="variable">t1</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Thread</span>() {</span><br><span class="line">		<span class="meta">@Override</span></span><br><span class="line">		<span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> {</span><br><span class="line">			System.out.println(<span class="string">"I will start work."</span>);</span><br><span class="line">			<span class="keyword">while</span> (!isInterrupted()) {</span><br><span class="line">				<span class="comment">// working</span></span><br><span class="line">			}</span><br><span class="line">			System.out.println(<span class="string">"I will be exiting."</span>);</span><br><span class="line">		}</span><br><span class="line">	};</span><br><span class="line">	t1.start();</span><br><span class="line">	TimeUnit.MINUTES.sleep(<span class="number">1</span>);</span><br><span class="line">	System.out.println(<span class="string">"System will be shutdown"</span>);</span><br><span class="line">	t1.interrupt();</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
</li>
<li>
<p>利用Volatile开关变量控制</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">StopThread</span> {</span><br><span class="line"></span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">MyThread</span> <span class="keyword">extends</span> <span class="title class_">Thread</span> {</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">volatile</span> <span class="type">boolean</span> <span class="variable">shutdown</span> <span class="operator">=</span> <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> {</span><br><span class="line">            System.out.println(<span class="string">"I will start work."</span>);</span><br><span class="line">            <span class="keyword">while</span> (!shutdown) {</span><br><span class="line">                <span class="comment">// working</span></span><br><span class="line">            }</span><br><span class="line">            System.out.println(<span class="string">"I will be exiting."</span>);</span><br><span class="line">        }</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">shutdown</span><span class="params">()</span> {</span><br><span class="line">            <span class="built_in">this</span>.shutdown = <span class="literal">true</span>;</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> InterruptedException {</span><br><span class="line">        <span class="type">MyThread</span> <span class="variable">t1</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">MyThread</span>();</span><br><span class="line">        t1.start();</span><br><span class="line">        TimeUnit.SECONDS.sleep(<span class="number">10</span>);</span><br><span class="line">        System.out.println(<span class="string">"System will be shutdown"</span>);</span><br><span class="line">        t1.shutdown();</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
</li>
<li>
<p>耗时时间过长，强制退出线程（将执行程序设置为守护线程）</p>
<ul>
<li>使用执行线程的守护线程执行程序任务</li>
</ul>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ThreadService</span> {</span><br><span class="line">  <span class="keyword">private</span> Thread executeThead;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">private</span> <span class="type">boolean</span> <span class="variable">finished</span> <span class="operator">=</span> <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">execute</span><span class="params">(Runnable task)</span> {</span><br><span class="line">    executeThead = <span class="keyword">new</span> <span class="title class_">Thread</span>() {</span><br><span class="line">      <span class="meta">@Override</span></span><br><span class="line">      <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> {</span><br><span class="line">        <span class="type">Thread</span> <span class="variable">runner</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Thread</span>(task);</span><br><span class="line">        runner.setDaemon(<span class="literal">true</span>);</span><br><span class="line">        runner.start();</span><br><span class="line">        <span class="keyword">try</span> {</span><br><span class="line">          <span class="comment">// 等待runner执行完成</span></span><br><span class="line">          runner.join();</span><br><span class="line">          finished = <span class="literal">true</span>;</span><br><span class="line">        } <span class="keyword">catch</span> (InterruptedException e) {</span><br><span class="line">          <span class="comment">// 执行被打断</span></span><br><span class="line">          System.out.println(<span class="string">"执行任务的守护线程被打断"</span>);</span><br><span class="line">          e.printStackTrace();</span><br><span class="line">        }</span><br><span class="line">      }</span><br><span class="line">    };</span><br><span class="line">    executeThead.start();</span><br><span class="line">  }</span><br><span class="line"></span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">shutdown</span><span class="params">(<span class="type">long</span> miles)</span> {</span><br><span class="line">    <span class="type">long</span> <span class="variable">currentTime</span> <span class="operator">=</span> System.currentTimeMillis();</span><br><span class="line">    <span class="keyword">while</span> (!finished) {</span><br><span class="line">      <span class="keyword">if</span> (System.currentTimeMillis() - currentTime &gt;= miles) {</span><br><span class="line">        System.out.println(<span class="string">"执行任务超时"</span>);</span><br><span class="line">        executeThead.interrupt();</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      }</span><br><span class="line"></span><br><span class="line">      <span class="keyword">try</span> {</span><br><span class="line">        <span class="comment">// 短暂休眠，减少执行次数</span></span><br><span class="line">        Thread.sleep(<span class="number">1</span>);</span><br><span class="line">      } <span class="keyword">catch</span> (InterruptedException e) {</span><br><span class="line">        System.out.println(<span class="string">"执行线程被打断"</span>);</span><br><span class="line">        e.printStackTrace();</span><br><span class="line">      }</span><br><span class="line">    }</span><br><span class="line">  }</span><br><span class="line">}</span><br><span class="line"></span><br></pre></td></tr></tbody></table></figure>
<ul>
<li>调用执行线程</li>
</ul>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ThreadCloseForce</span> {</span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> {</span><br><span class="line">    <span class="type">ThreadService</span> <span class="variable">threadService</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ThreadService</span>();</span><br><span class="line">    <span class="type">long</span> <span class="variable">start</span> <span class="operator">=</span> System.currentTimeMillis();</span><br><span class="line">    <span class="comment">// 启动执行线程</span></span><br><span class="line">    threadService.execute(() -&gt; {</span><br><span class="line">      <span class="keyword">while</span> (<span class="literal">true</span>) {</span><br><span class="line">        <span class="comment">// 模拟线程阻塞</span></span><br><span class="line">      }</span><br><span class="line">    });</span><br><span class="line">    <span class="comment">// 超时验证</span></span><br><span class="line">    threadService.shutdown(<span class="number">10_000</span>);</span><br><span class="line">    <span class="type">long</span> <span class="variable">end</span> <span class="operator">=</span> System.currentTimeMillis();</span><br><span class="line">    System.out.println(end - start);</span><br><span class="line">  }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<ul>
<li>执行结果</li>
</ul>
<figure class="highlight txt"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">执行任务超时</span><br><span class="line">10117</span><br><span class="line">执行任务的守护线程被打断</span><br><span class="line">java.lang.InterruptedException</span><br><span class="line">	at java.lang.Object.wait(Native Method)</span><br><span class="line">	at java.lang.Thread.join(Thread.java:1252)</span><br><span class="line">	at java.lang.Thread.join(Thread.java:1326)</span><br><span class="line">	at com.hots.part1.chapter3.ThreadService$1.run(ThreadService.java:16)</span><br><span class="line"></span><br><span class="line">Process finished with exit code 0</span><br></pre></td></tr></tbody></table></figure>
</li>
</ol>
<h2 id="Chapter4：线程安全与数据同步">Chapter4：线程安全与数据同步</h2>
<h3 id="synchronized关键字">synchronized关键字</h3>
<blockquote>
<p>使用synchronized需要注意的问题</p>
<ol>
<li>
<p>与monitor关联的对象不可为空</p>
</li>
<li>
<p>synchronized的作用域不可太大（降低执行效率）</p>
</li>
<li>
<p>不同的monitor企图锁住相同的方法</p>
</li>
<li>
<p>多个锁导致死锁</p>
</li>
</ol>
</blockquote>
<h3 id="this-monitor-和-class-monitor"><code>this</code> monitor 和 <code>class</code> monitor</h3>
<ol>
<li>
<p>使用synchronized同步一个类的不同方法，争抢的是同一个锁（方法所属的对象的锁）：synchronied(this)</p>
<p>官方说明：</p>
<figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">When a thread invokes a synchronized method, it automatically acquires the intrinsic lock for that method's object and releases it when the method returns. </span><br><span class="line"></span><br><span class="line">The lock release occurs even if the return vas caused by an uncaught exception.</span><br></pre></td></tr></tbody></table></figure>
</li>
<li>
<p>使用synchronized同步一个类的不同静态方法，争抢的是同一个锁（类的<strong>class锁</strong>）：synchronied(Test.class)</p>
<p>官方说明：</p>
<figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">since a static method is associated with a class, not an object.</span><br><span class="line">In this case, the thread acquires the intrinsic lock for the Class object associated with the class. </span><br><span class="line">Thus access to class'S static fields is controlled by a lock that's distinct from the lock for any instance of the class.</span><br></pre></td></tr></tbody></table></figure>
</li>
</ol>
<h2 id="Chapter5：线程之间的通信">Chapter5：线程之间的通信</h2>
<p>wait 、notify、notifyAll</p>
<h3 id="wait-和-sleep和区别">wait 和 sleep和区别</h3>
<p>从表面上看，wait和sleep方法都可以使当前线程进人阻塞状态，但是两者之间存在着本质的区别，下面我们将总结两者的区别和相似之处</p>
<ul>
<li>wait和sleep方法都可以使线程进人阻塞状态</li>
<li>wait和sleep方法均是可中断方法，被中断后都会收到中断异常。</li>
<li><strong>wait是Object的方法，而sleep是Thread特有的方法</strong></li>
<li>wait方法的执行必须在同步方法中进行，而sleep则不需要。</li>
<li>线程在同步方法中执行sleep方法时，并不会释放的锁，而wait方法则会释放monitor的锁</li>
<li>sleep方法短暂休眠之后会主动退出阻塞，而wait方法（没有指定wait时间）则需要被其他线程中断后才能退出阻塞。</li>
</ul>
<h3 id="单线程通信">单线程通信</h3>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ProducerAndConsumerVersion1</span> {</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">volatile</span> <span class="type">boolean</span> <span class="variable">isProduced</span> <span class="operator">=</span> <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="type">Object</span> <span class="variable">LOCK</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Object</span>();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">produce</span><span class="params">()</span> {</span><br><span class="line">        <span class="keyword">synchronized</span> (LOCK) {</span><br><span class="line">            <span class="keyword">if</span> (isProduced) {</span><br><span class="line">                <span class="keyword">try</span> {</span><br><span class="line">                    LOCK.wait();</span><br><span class="line">                } <span class="keyword">catch</span> (InterruptedException e) {</span><br><span class="line">                    e.printStackTrace();</span><br><span class="line">                }</span><br><span class="line">            } <span class="keyword">else</span> {</span><br><span class="line">                ++i;</span><br><span class="line">                System.out.println(Thread.currentThread().getName() + <span class="string">"：produced-&gt;"</span> + i);</span><br><span class="line">                LOCK.notify();</span><br><span class="line">                isProduced = <span class="literal">true</span>;</span><br><span class="line">            }</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">consume</span><span class="params">()</span> {</span><br><span class="line">        <span class="keyword">synchronized</span> (LOCK) {</span><br><span class="line">            <span class="keyword">if</span> (isProduced) {</span><br><span class="line">                System.out.println(Thread.currentThread().getName() + <span class="string">"：consumed-&gt;"</span> + i);</span><br><span class="line">                LOCK.notify();</span><br><span class="line">                isProduced = <span class="literal">false</span>;</span><br><span class="line">            } <span class="keyword">else</span> {</span><br><span class="line">                <span class="keyword">try</span> {</span><br><span class="line">                    LOCK.wait();</span><br><span class="line">                } <span class="keyword">catch</span> (InterruptedException e) {</span><br><span class="line">                    e.printStackTrace();</span><br><span class="line">                }</span><br><span class="line">            }</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> {</span><br><span class="line">        <span class="type">ProducerAndConsumerVersion1</span> <span class="variable">producerAndConsumerVersion1</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ProducerAndConsumerVersion1</span>();</span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">Thread</span>(<span class="string">"P1"</span>) {</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> {</span><br><span class="line">                <span class="keyword">while</span> (<span class="literal">true</span>) {</span><br><span class="line">                    producerAndConsumerVersion1.produce();</span><br><span class="line">                }</span><br><span class="line">            }</span><br><span class="line">        }.start();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">Thread</span>(<span class="string">"C1"</span>) {</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> {</span><br><span class="line">                <span class="keyword">while</span> (<span class="literal">true</span>) {</span><br><span class="line">                    producerAndConsumerVersion1.consume();</span><br><span class="line">                }</span><br><span class="line">            }</span><br><span class="line">        }.start();</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<h3 id="多线程通信">多线程通信</h3>
<p><img src="https://hmxyl-image.oss-cn-hangzhou.aliyuncs.com/note/image-20211227170019463.png" alt="image-20211227170019463"></p>
<p><img src="https://hmxyl-image.oss-cn-hangzhou.aliyuncs.com/note/image-20211227170133400.png" alt="image-20211227170133400"></p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Demo</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ProducerAndConsumerVersion3</span> {</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">volatile</span> <span class="type">boolean</span> <span class="variable">isProduced</span> <span class="operator">=</span> <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="type">Object</span> <span class="variable">LOCK</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Object</span>();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">produce</span><span class="params">()</span> {</span><br><span class="line">        <span class="keyword">synchronized</span> (LOCK) {</span><br><span class="line">            <span class="keyword">while</span> (isProduced) {</span><br><span class="line">                <span class="keyword">try</span> {</span><br><span class="line">                    LOCK.wait();</span><br><span class="line">                    System.out.println(Thread.currentThread().getName() + <span class="string">"：wait"</span>);</span><br><span class="line">                } <span class="keyword">catch</span> (InterruptedException e) {</span><br><span class="line">                    e.printStackTrace();</span><br><span class="line">                }</span><br><span class="line">            }</span><br><span class="line">            ++i;</span><br><span class="line">            System.out.println(Thread.currentThread().getName() + <span class="string">"：produced-&gt;"</span> + i);</span><br><span class="line">            isProduced = <span class="literal">true</span>;</span><br><span class="line">            LOCK.notifyAll();</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">consume</span><span class="params">()</span> {</span><br><span class="line">        <span class="keyword">synchronized</span> (LOCK) {</span><br><span class="line">            <span class="keyword">while</span> (!isProduced) {</span><br><span class="line">                <span class="keyword">try</span> {</span><br><span class="line">                    LOCK.wait();</span><br><span class="line">                    System.out.println(Thread.currentThread().getName() + <span class="string">"：wait"</span>);</span><br><span class="line">                } <span class="keyword">catch</span> (InterruptedException e) {</span><br><span class="line">                    e.printStackTrace();</span><br><span class="line">                }</span><br><span class="line">            }</span><br><span class="line"></span><br><span class="line">            System.out.println(Thread.currentThread().getName() + <span class="string">"：consumed-&gt;"</span> + i);</span><br><span class="line">            isProduced = <span class="literal">false</span>;</span><br><span class="line">            LOCK.notifyAll();</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> {</span><br><span class="line">        <span class="type">ProducerAndConsumerVersion3</span> <span class="variable">producerAndConsumerVersion3</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ProducerAndConsumerVersion3</span>();</span><br><span class="line">        Stream.of(<span class="string">"P1"</span>, <span class="string">"P2"</span>).forEach(name -&gt; {</span><br><span class="line">            <span class="keyword">new</span> <span class="title class_">Thread</span>(name) {</span><br><span class="line">                <span class="meta">@Override</span></span><br><span class="line">                <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> {</span><br><span class="line">                    <span class="keyword">while</span> (<span class="literal">true</span>) {</span><br><span class="line">                        producerAndConsumerVersion3.produce();</span><br><span class="line">                        <span class="keyword">try</span> {</span><br><span class="line">                            Thread.sleep(<span class="number">10</span>);</span><br><span class="line">                        } <span class="keyword">catch</span> (Exception e) {</span><br><span class="line">                            e.printStackTrace();</span><br><span class="line">                        }</span><br><span class="line">                    }</span><br><span class="line">                }</span><br><span class="line">            }.start();</span><br><span class="line">        });</span><br><span class="line"></span><br><span class="line">        Stream.of(<span class="string">"C1"</span>, <span class="string">"C2"</span>, <span class="string">"C3"</span>, <span class="string">"C4"</span>).forEach(name -&gt; {</span><br><span class="line">            <span class="keyword">new</span> <span class="title class_">Thread</span>(name) {</span><br><span class="line">                <span class="meta">@Override</span></span><br><span class="line">                <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> {</span><br><span class="line">                    <span class="keyword">while</span> (<span class="literal">true</span>) {</span><br><span class="line">                        producerAndConsumerVersion3.consume();</span><br><span class="line">                        <span class="keyword">try</span> {</span><br><span class="line">                            Thread.sleep(<span class="number">100</span>);</span><br><span class="line">                        } <span class="keyword">catch</span> (Exception e) {</span><br><span class="line">                            e.printStackTrace();</span><br><span class="line">                        }</span><br><span class="line">                    }</span><br><span class="line">                }</span><br><span class="line">            }.start();</span><br><span class="line">        });</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<h3 id="自定义显示锁">自定义显示锁</h3>
<ol>
<li>Lock接口</li>
</ol>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> java.util.Collection;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">Lock</span> {</span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">lock</span><span class="params">()</span> <span class="keyword">throws</span> InterruptedException;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">lock</span><span class="params">(<span class="type">long</span> mills)</span> <span class="keyword">throws</span> InterruptedException, TimeoutException;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">unLock</span><span class="params">()</span>;</span><br><span class="line"></span><br><span class="line">    Collection&lt;Thread&gt; <span class="title function_">getBlockedThread</span><span class="params">()</span>;</span><br><span class="line"></span><br><span class="line">    <span class="type">int</span> <span class="title function_">getBlockedSize</span><span class="params">()</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">class</span> <span class="title class_">TimeoutException</span> <span class="keyword">extends</span> <span class="title class_">Exception</span> {</span><br><span class="line">        <span class="keyword">public</span> <span class="title function_">TimeoutException</span><span class="params">(String message)</span> {</span><br><span class="line">            <span class="built_in">super</span>(message);</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<ol start="2">
<li>接口实现</li>
</ol>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> java.util.ArrayList;</span><br><span class="line"><span class="keyword">import</span> java.util.Collection;</span><br><span class="line"><span class="keyword">import</span> java.util.Collections;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">BooleanLock</span> <span class="keyword">implements</span> <span class="title class_">Lock</span> {</span><br><span class="line">    <span class="keyword">private</span> <span class="type">boolean</span> <span class="variable">initValue</span> <span class="operator">=</span> <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> Thread currentThread;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> Collection&lt;Thread&gt; blockedThreadCollection = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title function_">lock</span><span class="params">()</span> <span class="keyword">throws</span> InterruptedException {</span><br><span class="line">        <span class="keyword">while</span> (initValue) {</span><br><span class="line">            blockedThreadCollection.add(Thread.currentThread());</span><br><span class="line">            <span class="built_in">this</span>.wait();</span><br><span class="line">        }</span><br><span class="line">        initValue = <span class="literal">true</span>;</span><br><span class="line">        currentThread = Thread.currentThread();</span><br><span class="line">        blockedThreadCollection.remove(Thread.currentThread());</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title function_">lock</span><span class="params">(<span class="type">long</span> mills)</span> <span class="keyword">throws</span> InterruptedException, TimeoutException {</span><br><span class="line">        <span class="keyword">if</span> (mills &lt;= <span class="number">0</span>) {</span><br><span class="line">            lock();</span><br><span class="line">        }</span><br><span class="line">        <span class="type">long</span> <span class="variable">waitMills</span> <span class="operator">=</span> mills;</span><br><span class="line">        <span class="type">long</span> <span class="variable">endTime</span> <span class="operator">=</span> System.currentTimeMillis() + waitMills;</span><br><span class="line">        <span class="keyword">while</span> (initValue) {</span><br><span class="line">            <span class="keyword">if</span> (waitMills &lt;= <span class="number">0</span>) {</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">TimeoutException</span>(Thread.currentThread().getName() + <span class="string">" waiting timeout"</span>);</span><br><span class="line">            }</span><br><span class="line">            <span class="comment">// 重新设置等待时间</span></span><br><span class="line">            <span class="built_in">this</span>.wait(waitMills);</span><br><span class="line">            waitMills = endTime - System.currentTimeMillis();</span><br><span class="line">        }</span><br><span class="line"></span><br><span class="line">        <span class="built_in">this</span>.initValue = <span class="literal">true</span>;</span><br><span class="line">        <span class="built_in">this</span>.currentThread = Thread.currentThread();</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title function_">unLock</span><span class="params">()</span> {</span><br><span class="line">        <span class="keyword">if</span> (Thread.currentThread() == currentThread) {</span><br><span class="line">            initValue = <span class="literal">false</span>;</span><br><span class="line">            System.out.println(Thread.currentThread().getName() + <span class="string">" release the monitor"</span>);</span><br><span class="line">            <span class="built_in">this</span>.notifyAll();</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Collection&lt;Thread&gt; <span class="title function_">getBlockedThread</span><span class="params">()</span> {</span><br><span class="line">        <span class="keyword">return</span> Collections.unmodifiableCollection(blockedThreadCollection);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">int</span> <span class="title function_">getBlockedSize</span><span class="params">()</span> {</span><br><span class="line">        <span class="keyword">return</span> blockedThreadCollection.size();</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<ol start="3">
<li>调用</li>
</ol>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> java.util.Arrays;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">BooleanLockTest</span> {</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> {</span><br><span class="line">        <span class="keyword">final</span> <span class="type">BooleanLock</span> <span class="variable">booleanLock</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">BooleanLock</span>();</span><br><span class="line"></span><br><span class="line">        Arrays.asList(<span class="string">"W1"</span>, <span class="string">"W2"</span>, <span class="string">"W3"</span>).stream()</span><br><span class="line">                .forEach(name -&gt; {</span><br><span class="line">                    <span class="keyword">new</span> <span class="title class_">Thread</span>(() -&gt; {</span><br><span class="line">                        <span class="keyword">try</span> {</span><br><span class="line">                            booleanLock.lock(<span class="number">5_000</span>);</span><br><span class="line">                            System.out.println(Thread.currentThread().getName() + <span class="string">" got the lock"</span>);</span><br><span class="line">                            work();</span><br><span class="line">                        } <span class="keyword">catch</span> (InterruptedException | Lock.TimeoutException e) {</span><br><span class="line">                            e.printStackTrace();</span><br><span class="line">                        } <span class="keyword">finally</span> {</span><br><span class="line">                            booleanLock.unLock();</span><br><span class="line">                        }</span><br><span class="line">                    }, name).start();</span><br><span class="line">                });</span><br><span class="line"></span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">work</span><span class="params">()</span> <span class="keyword">throws</span> InterruptedException {</span><br><span class="line">        System.out.println(Thread.currentThread().getName() + <span class="string">" is working..."</span>);</span><br><span class="line">        Thread.sleep(<span class="number">10_000</span>);</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<h2 id="Chapter6：Thread-Group">Chapter6：Thread Group</h2>
<h3 id="Thread-与-ThreadGroup">Thread 与 ThreadGroup</h3>
<p><img src="https://hmxyl-image.oss-cn-hangzhou.aliyuncs.com/note/image-20211228162829691.png" alt="image-20211228162829691"></p>
<h3 id="基本操作">基本操作</h3>
<table>
<thead>
<tr>
<th>方法</th>
<th>说明</th>
</tr>
</thead>
<tbody>
<tr>
<td>activeCount()</td>
<td>用于获取group中活跃的线程，这只是个估计值，并不能百分之百地保证数字一定正确，原因前面已经分析过，该方法会递归获取其他子group中的活跃线程。</td>
</tr>
<tr>
<td>activeGroupCount()</td>
<td>用于获取group中活跃的子group，这也是一个近似估值，该方法也会递归获取所有的子group。</td>
</tr>
<tr>
<td>getMaxPriority()</td>
<td>用于获取group的优先级，默认情况下，Group的优先级为10，在该group中，所有线程的优先级都不能大于group的优先级</td>
</tr>
<tr>
<td>getName()</td>
<td>用于获取group的名字。</td>
</tr>
<tr>
<td>getParent()</td>
<td>用于获取group的父group，如果父group不存在，则会返回null，比如systemgroup的父group就为null。</td>
</tr>
<tr>
<td>list()</td>
<td>该方法没有返回值，执行该方法会将group中所有的活跃线程信息全部输出到控制台，也就是System.out0</td>
</tr>
<tr>
<td>parentOf(ThreadGroup g)</td>
<td>会判断当前group是不是给定group的父group，另外如果给定的group就是自己本身，那么该方法也会返回true。</td>
</tr>
<tr>
<td>setMaxPriority(int pri)</td>
<td>会指定group的最大优先级，最大优先级不能超过父group的最大优先级，执行该方法不仅会改变当前group的最大优先级，还会改变所有子group的最大优先级</td>
</tr>
</tbody>
</table>
<h3 id="守护ThreadGroup">守护ThreadGroup</h3>
<p><code>public final void setDaemon(boolean daemon)</code></p>
<figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">First, the checkAccess method of this thread group is called with no arguments; </span><br><span class="line">this may result in a security exception.</span><br><span class="line">A daemon thread group is automatically destroyed when its last thread is stopped or its last thread group is destroyed</span><br></pre></td></tr></tbody></table></figure>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Demo</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ThreadGroupApi</span> {</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> InterruptedException {</span><br><span class="line">        <span class="type">ThreadGroup</span> <span class="variable">tg1</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ThreadGroup</span>(<span class="string">"group1"</span>);</span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">Thread</span>(tg1, () -&gt; {</span><br><span class="line">            <span class="keyword">try</span> {</span><br><span class="line">                Thread.sleep(<span class="number">1_000</span>);</span><br><span class="line">            } <span class="keyword">catch</span> (InterruptedException e) {</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            }</span><br><span class="line">        }, <span class="string">"group1-t1"</span>).start();</span><br><span class="line"></span><br><span class="line">        <span class="type">ThreadGroup</span> <span class="variable">tg2</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ThreadGroup</span>(<span class="string">"group2"</span>);</span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">Thread</span>(tg2, () -&gt; {</span><br><span class="line">            <span class="keyword">try</span> {</span><br><span class="line">                Thread.sleep(<span class="number">1_000</span>);</span><br><span class="line">            } <span class="keyword">catch</span> (InterruptedException e) {</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            }</span><br><span class="line">        }, <span class="string">"group2-t1"</span>).start();</span><br><span class="line">        tg2.setDaemon(<span class="literal">true</span>);</span><br><span class="line"></span><br><span class="line">        Thread.sleep(<span class="number">1_000</span>);</span><br><span class="line"></span><br><span class="line">        System.out.println(tg1.getName() + <span class="string">" -- "</span> + tg1.isDestroyed());<span class="comment">// false</span></span><br><span class="line">        System.out.println(tg2.getName() + <span class="string">" -- "</span> + tg2.isDestroyed());<span class="comment">// true</span></span><br><span class="line">      </span><br><span class="line">        tg1.destroy(); <span class="comment">// 显示销毁</span></span><br><span class="line"></span><br><span class="line">        System.out.println(tg1.getName() + <span class="string">" -- "</span> + tg1.isDestroyed());<span class="comment">// true</span></span><br><span class="line">        System.out.println(tg2.getName() + <span class="string">" -- "</span> + tg2.isDestroyed());<span class="comment">// true</span></span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<h2 id="Chapter7：Hook线程以及捕获线程执行异常">Chapter7：Hook线程以及捕获线程执行异常</h2>
<h3 id="获取线程运行时异常">获取线程运行时异常</h3>
<h4 id="处理Thread运行时异常API，有四个">处理Thread运行时异常API，有四个</h4>
<table>
<thead>
<tr>
<th>方法</th>
<th>说明</th>
</tr>
</thead>
<tbody>
<tr>
<td>public static void  <strong>setDefaultUncaughtExceptionHandler</strong>(Thread.UncaughtExceptionHandler eh)</td>
<td>设置全局的UncaughtExceptionHandler</td>
</tr>
<tr>
<td>public static  Thread.UncaughtExceptionHandler <strong>getDefaultUncaughtExceptionHandler</strong>()</td>
<td>获取全局的UncaughtExceptionHandler</td>
</tr>
<tr>
<td>public void  setUncaughtExceptionHandler(Thread.UncaughtExceptionHandler eh)</td>
<td>为某个特定线程指定UncaughtExceptionHandler</td>
</tr>
<tr>
<td>public Thread.UncaughtExceptionHandler  getUncaughtExceptionHandler()</td>
<td>获取某个特定线程指定UncaughtExceptionHandler</td>
</tr>
</tbody>
</table>
<p>其中UncaughtExceptionHandler 是一个FunctionalInterface接口，仅包含一个抽象方法。</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@FunctionalInterface</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">UncaughtExceptionHandler</span> {</span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * Method invoked when the given thread terminates due to the</span></span><br><span class="line"><span class="comment">         * given uncaught exception.</span></span><br><span class="line"><span class="comment">         * &lt;p&gt;Any exception thrown by this method will be ignored by the</span></span><br><span class="line"><span class="comment">         * Java Virtual Machine.</span></span><br><span class="line"><span class="comment">         * <span class="doctag">@param</span> t the thread</span></span><br><span class="line"><span class="comment">         * <span class="doctag">@param</span> e the exception</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">  <span class="keyword">void</span> <span class="title function_">uncaughtException</span><span class="params">(Thread t, Throwable e)</span>;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<p>该回调接口会被<code>Thread</code>和<code>dispatchUncaughtException</code>调用。</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Dispatch an uncaught exception to the handler. This method is</span></span><br><span class="line"><span class="comment"> * intended to be called only by the JVM.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">dispatchUncaughtException</span><span class="params">(Throwable e)</span> {</span><br><span class="line">  getUncaughtExceptionHandler().uncaughtException(<span class="built_in">this</span>, e);</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<h4 id="UncaughtExceptionHandler实例">UncaughtExceptionHandler实例</h4>
<p>测试类</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CaptureThreadException</span> {</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> {</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 1. 设置回调接口</span></span><br><span class="line">        Thread.setDefaultUncaughtExceptionHandler((t, e) -&gt; {</span><br><span class="line">            System.out.println(t.getName() + <span class="string">" ----- occur exception："</span> + e.getMessage());</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        });</span><br><span class="line"></span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">Thread</span>(() -&gt; {</span><br><span class="line">            <span class="keyword">try</span> {</span><br><span class="line">                Thread.sleep(<span class="number">1_000</span>);</span><br><span class="line">            } <span class="keyword">catch</span> (InterruptedException e) {</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            }</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 2. 抛出运行时异常</span></span><br><span class="line">            System.out.println(<span class="number">1</span> / <span class="number">0</span>);</span><br><span class="line">        }).start();</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<p>输出结果</p>
<figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">Thread-0 ----- occur exception：/ by zero</span><br><span class="line">java.lang.ArithmeticException: / by zero</span><br><span class="line">	at com.hots.chapter7.CaptureThreadException.lambda$main<span class="variable">$1</span>(CaptureThreadException.java:20)</span><br><span class="line">	at java.lang.Thread.run(Thread.java:748)</span><br><span class="line"></span><br><span class="line">Process finished with <span class="built_in">exit</span> code 0</span><br></pre></td></tr></tbody></table></figure>
<h4 id="UncaughtExceptionHandler源码分析">UncaughtExceptionHandler源码分析</h4>
<ol>
<li>
<p>获取Thread的UncaughtExceptionHandler</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">dispatchUncaughtException</span><span class="params">(Throwable e)</span> {</span><br><span class="line">  getUncaughtExceptionHandler().uncaughtException(<span class="built_in">this</span>, e);</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
</li>
<li>
<p>Thread未设置UncaughtExceptionHandler，则找ThreadGroup获取</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> UncaughtExceptionHandler <span class="title function_">getUncaughtExceptionHandler</span><span class="params">()</span> {</span><br><span class="line">  <span class="keyword">return</span> uncaughtExceptionHandler != <span class="literal">null</span> ?</span><br><span class="line">    uncaughtExceptionHandler : group;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<blockquote>
<p>ThreadGroup 是 Thread.UncaughtExceptionHandler 的实现类</p>
</blockquote>
</li>
<li>
<p>ThreadGroup的uncaughtException</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">uncaughtException</span><span class="params">(Thread t, Throwable e)</span> {</span><br><span class="line">	<span class="keyword">if</span> (parent != <span class="literal">null</span>) {</span><br><span class="line">		parent.uncaughtException(t, e); <span class="comment">// 调用父ThreadGroup的uncaughtException</span></span><br><span class="line">	} <span class="keyword">else</span> {</span><br><span class="line">		Thread.<span class="type">UncaughtExceptionHandler</span> <span class="variable">ueh</span> <span class="operator">=</span></span><br><span class="line">			Thread.getDefaultUncaughtExceptionHandler(); </span><br><span class="line">		<span class="keyword">if</span> (ueh != <span class="literal">null</span>) {</span><br><span class="line">			ueh.uncaughtException(t, e); <span class="comment">// 调用全局默认的UncaughtExceptionHandler</span></span><br><span class="line">		} <span class="keyword">else</span> <span class="keyword">if</span> (!(e <span class="keyword">instanceof</span> ThreadDeath)) {</span><br><span class="line">			System.err.print(<span class="string">"Exception in thread \""</span> + t.getName() + <span class="string">"\" "</span>);</span><br><span class="line">			e.printStackTrace(System.err);<span class="comment">// 将异常的堆栈信息定向到System.err中</span></span><br><span class="line">		}</span><br><span class="line">	}</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
</li>
</ol>
<pre class="mermaid">   graph LR
   A[线程异常] --&gt;  B(MainGroup) --&gt; C(System Group) --&gt; D[System.err]</pre>
<h3 id="注入Hook线程">注入Hook线程</h3>
<h4 id="Hook线程概念">Hook线程概念</h4>
<p>JVM进程的退出是由于JVM进程中没<strong>有活跃的非守护线程</strong>，或者收到了<strong>系统中断信号</strong>。</p>
<p><strong>向JVM程序注入一个Hook线程，在JVM进程退出的时候，Hook线程会启动执行。</strong></p>
<p>通过Runtime可以为JVM注人多个Hook线程。</p>
<h4 id="Linux-模拟Hook简单调用">Linux 模拟Hook简单调用</h4>
<p>==Runtime.getRuntime().addShutdownHook(Thread hook));==</p>
<figure class="highlight sh"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@hots java]# <span class="built_in">mkdir</span> /root/java</span><br><span class="line">[root@hots java]# vi ExitCapture.java <span class="comment">#内容如下</span></span><br></pre></td></tr></tbody></table></figure>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ExitCapture</span>{</span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span>{</span><br><span class="line">    </span><br><span class="line">		Runtime.getRuntime().addShutdownHook(<span class="keyword">new</span> <span class="title class_">Thread</span>(() -&gt; {</span><br><span class="line">			System.out.println(Thread.currentThread().getName() + <span class="string">" exiting......"</span>);</span><br><span class="line">      <span class="comment">// 进程down之前的安全处理措施</span></span><br><span class="line">			notifyAndRelease();</span><br><span class="line">		}));</span><br><span class="line">    </span><br><span class="line">		<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line">		<span class="keyword">while</span>(<span class="literal">true</span>){</span><br><span class="line">			++i;</span><br><span class="line">			<span class="keyword">try</span>{</span><br><span class="line">				Thread.sleep(<span class="number">1_000L</span>);</span><br><span class="line">				System.out.println(Thread.currentThread().getName() + <span class="string">" working...."</span>);</span><br><span class="line">			} <span class="keyword">catch</span> (Throwable e) {</span><br><span class="line">			}</span><br><span class="line">			<span class="keyword">if</span> (i &gt; <span class="number">10</span>) {</span><br><span class="line">				<span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(Thread.currentThread().getName() + <span class="string">" error"</span>);</span><br><span class="line">			}</span><br><span class="line">		}</span><br><span class="line">	}</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">notifyAndRelease</span><span class="params">()</span>{</span><br><span class="line">		System.out.println(Thread.currentThread().getName() + <span class="string">" notify other matchine and release resource"</span>);</span><br><span class="line">		<span class="keyword">try</span> {</span><br><span class="line">			Thread.sleep(<span class="number">1_000L</span>);</span><br><span class="line">		} <span class="keyword">catch</span>(Exception e) {	</span><br><span class="line">		}</span><br><span class="line">		System.out.println(Thread.currentThread().getName() + <span class="string">"finish exit."</span>);</span><br><span class="line">	}</span><br><span class="line">}  </span><br></pre></td></tr></tbody></table></figure>
<figure class="highlight sh"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@hots java]# javac ExitCapture.java</span><br><span class="line">[root@hots java]# java ExitCapture</span><br></pre></td></tr></tbody></table></figure>
<blockquote>
<p># 后台运行，日志记录到nohup.out文件</p>
<p>nohup java -cp . ExitCapture &amp;</p>
</blockquote>
<p>10秒后程序退出 / Ctrl+C 退出程序 / kill 进程号</p>
<figure class="highlight sh"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">[root@hots java]# java ExitCapture  </span><br><span class="line">main working....</span><br><span class="line">main working....</span><br><span class="line">main working....</span><br><span class="line">main working....</span><br><span class="line">main working....</span><br><span class="line">main working....</span><br><span class="line">^CThread-0 exiting......</span><br><span class="line">Thread-0 notify other matchine and release resource</span><br><span class="line">main working....</span><br><span class="line">Thread-0finish <span class="built_in">exit</span>.</span><br><span class="line">[1]+  Exit 1              </span><br></pre></td></tr></tbody></table></figure>
<blockquote>
<p>kill -9 进程号 会直接退出，钩子程序不会执行。</p>
</blockquote>
<h4 id="Hook线程实际应用举例">Hook线程实际应用举例</h4>
<p>在我们的开发中经常会遇到Hook线程，比如为了防止某个程序被重复启动，在进程启动时会创建一个文件，进程收到中断信号的时候会删除这个lock文件，我们在MySQL服务器、zookeeper、kafka等系统中都能看到lock文件的存在。</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> java.nio.file.Files;</span><br><span class="line"><span class="keyword">import</span> java.nio.file.Path;</span><br><span class="line"><span class="keyword">import</span> java.nio.file.Paths;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">PreventDuplicated</span> {</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">LOCK_PATH</span> <span class="operator">=</span> <span class="string">"E:\\Downloads"</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">LOCK_FILE</span> <span class="operator">=</span> <span class="string">".lock"</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">PERMISSIONS</span> <span class="operator">=</span> <span class="string">"rw-------"</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> {</span><br><span class="line">        Runtime.getRuntime().addShutdownHook(<span class="keyword">new</span> <span class="title class_">Thread</span>(() -&gt; {</span><br><span class="line">            <span class="comment">// 程序退出，删除lock文件</span></span><br><span class="line">            System.out.println(<span class="string">"deal program shutdown..."</span>);</span><br><span class="line">            getLockFile().toFile().delete();</span><br><span class="line">        }));</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 判断Lock文件，存在，抛重复执行异常，不存在继续</span></span><br><span class="line">        checkLockFile();</span><br><span class="line">        <span class="comment">//程序执行</span></span><br><span class="line">        <span class="keyword">try</span> {</span><br><span class="line">            Thread.sleep(<span class="number">20_000</span>);</span><br><span class="line">        } <span class="keyword">catch</span> (InterruptedException e) {</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">checkLockFile</span><span class="params">()</span> {</span><br><span class="line">        <span class="type">Path</span> <span class="variable">path</span> <span class="operator">=</span> getLockFile();</span><br><span class="line">        <span class="keyword">if</span> (path.toFile().exists()) {</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(<span class="string">"The program already running."</span>);</span><br><span class="line">        }</span><br><span class="line">        <span class="keyword">try</span> {</span><br><span class="line">            Files.createFile(path);</span><br><span class="line">        } <span class="keyword">catch</span> (IOException e) {</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> Path <span class="title function_">getLockFile</span><span class="params">()</span> {</span><br><span class="line">        <span class="keyword">return</span> Paths.get(LOCK_PATH, LOCK_FILE);</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<h2 id="Chapter8：线程池原理以及自定义线程池">Chapter8：线程池原理以及自定义线程池</h2>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> java.util.ArrayList;</span><br><span class="line"><span class="keyword">import</span> java.util.Iterator;</span><br><span class="line"><span class="keyword">import</span> java.util.LinkedList;</span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 线程池模拟类 </span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SimpleThreadPool</span> <span class="keyword">extends</span> <span class="title class_">Thread</span> {</span><br><span class="line">    <span class="comment">/* 线程池现有容量：包含FREE, RUNNING, BLOCKED 三种状态的线程 */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> poolSize;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">volatile</span> <span class="type">int</span> <span class="variable">seq</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">THREAD_PREFIX</span> <span class="operator">=</span> <span class="string">"SIMPLE_THREAD_POOL-"</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="type">int</span> queueSize;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* 默认TASK_QUEUE的阈值 */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">static</span> <span class="type">int</span> <span class="variable">DEFAULT_TASK_QUEUE_SIZE</span> <span class="operator">=</span> <span class="number">2000</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">static</span> LinkedList&lt;Runnable&gt; TASK_QUEUE = <span class="keyword">new</span> <span class="title class_">LinkedList</span>&lt;&gt;();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">static</span> <span class="type">ThreadGroup</span> <span class="variable">GROUP</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ThreadGroup</span>(<span class="string">"Pool_Group"</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">static</span> List&lt;MyThread&gt; THREAD_QUEUE = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> DiscardPolicy discardPolicy;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 线程池，无能力处理，策略</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">static</span> <span class="type">DiscardPolicy</span> <span class="variable">DEFAULT_DISCARD_POLICY</span> <span class="operator">=</span> () -&gt; {</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">DiscardException</span>(<span class="string">"Discard this task"</span>);</span><br><span class="line">    };</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 线程池，销毁标记</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">volatile</span> <span class="type">boolean</span> <span class="variable">destroy</span> <span class="operator">=</span> <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="type">int</span> minPoolSize;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">int</span> <span class="variable">DEFAULT_MIN_POOL_SIZE</span> <span class="operator">=</span> <span class="number">4</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="type">int</span> activePoolSize;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">int</span> <span class="variable">DEFAULT_ACTIVE_POOL_SIZE</span> <span class="operator">=</span> <span class="number">8</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="type">int</span> maxPoolSize;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">int</span> <span class="variable">DEFAULT_MAX_POOL_SIZE</span> <span class="operator">=</span> <span class="number">12</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">SimpleThreadPool</span><span class="params">()</span> {</span><br><span class="line">        <span class="built_in">this</span>(DEFAULT_MIN_POOL_SIZE, DEFAULT_ACTIVE_POOL_SIZE, DEFAULT_MAX_POOL_SIZE, DEFAULT_TASK_QUEUE_SIZE, DEFAULT_DISCARD_POLICY);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">SimpleThreadPool</span><span class="params">(<span class="type">int</span> minPoolSize, <span class="type">int</span> activePoolSize, <span class="type">int</span> maxPoolSize, <span class="type">int</span> queueSize, DiscardPolicy discardPolicy)</span> {</span><br><span class="line">        <span class="built_in">this</span>.minPoolSize = minPoolSize;</span><br><span class="line">        <span class="built_in">this</span>.activePoolSize = activePoolSize;</span><br><span class="line">        <span class="built_in">this</span>.maxPoolSize = maxPoolSize;</span><br><span class="line"></span><br><span class="line">        <span class="built_in">this</span>.queueSize = queueSize;</span><br><span class="line">        <span class="built_in">this</span>.discardPolicy = discardPolicy;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 初始化，最小容量线程池</span></span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; minPoolSize; i++) {</span><br><span class="line">            createMyThread();</span><br><span class="line">        }</span><br><span class="line">        <span class="comment">// 自定义线程池，同时也是一个线程，可以根据工作量，自动调整容量</span></span><br><span class="line">        <span class="built_in">this</span>.setName(THREAD_PREFIX + <span class="string">"head"</span>);</span><br><span class="line">        <span class="built_in">this</span>.start();</span><br><span class="line">        resetPoolSize();</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">createMyThread</span><span class="params">()</span> {</span><br><span class="line">        <span class="type">MyThread</span> <span class="variable">myThread</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">MyThread</span>(GROUP, THREAD_PREFIX + (seq++));</span><br><span class="line">        THREAD_QUEUE.add(myThread);</span><br><span class="line">        myThread.start();</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 获取线程池大小：每次线程池，新增/销毁线程的时候，调用</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">resetPoolSize</span><span class="params">()</span> {</span><br><span class="line">        <span class="built_in">this</span>.poolSize = THREAD_QUEUE.size();</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 线程池，根据工作量，自动调整容量</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> {</span><br><span class="line">        <span class="keyword">while</span> (!destroy) {</span><br><span class="line">            <span class="comment">// 扩展线程池</span></span><br><span class="line">            <span class="keyword">if</span> (TASK_QUEUE.size() &gt; activePoolSize &amp;&amp; poolSize &lt; activePoolSize) {</span><br><span class="line">                <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> poolSize; i &lt; activePoolSize; i++) {</span><br><span class="line">                    createMyThread();</span><br><span class="line">                }</span><br><span class="line">                System.out.println(<span class="string">"The pool increased to activePoolSize."</span>);</span><br><span class="line">                resetPoolSize();</span><br><span class="line">            }</span><br><span class="line">            <span class="keyword">if</span> (TASK_QUEUE.size() &gt; maxPoolSize &amp;&amp; poolSize &lt; maxPoolSize) {</span><br><span class="line">                <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> poolSize; i &lt; maxPoolSize; i++) {</span><br><span class="line">                    createMyThread();</span><br><span class="line">                }</span><br><span class="line">                System.out.println(<span class="string">"The pool increased to maxPoolSize."</span>);</span><br><span class="line">                resetPoolSize();</span><br><span class="line">            }</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 缩减线程池</span></span><br><span class="line">            <span class="keyword">synchronized</span> (THREAD_QUEUE) {</span><br><span class="line">                <span class="keyword">if</span> (TASK_QUEUE.isEmpty()</span><br><span class="line">                        &amp;&amp; THREAD_QUEUE.stream().filter(e -&gt; e.taskStatus == TaskStatus.RUNNING).count() == <span class="number">0</span></span><br><span class="line">                        &amp;&amp; poolSize &gt; activePoolSize) {</span><br><span class="line">                    <span class="type">int</span> <span class="variable">releaseCount</span> <span class="operator">=</span> poolSize - activePoolSize;</span><br><span class="line">                    Iterator&lt;MyThread&gt; it = THREAD_QUEUE.iterator();</span><br><span class="line">                    <span class="keyword">while</span> (it.hasNext()) {</span><br><span class="line">                        <span class="keyword">if</span> (releaseCount &lt;= <span class="number">0</span>) {</span><br><span class="line">                            <span class="keyword">break</span>;</span><br><span class="line">                        }</span><br><span class="line">                        <span class="type">MyThread</span> <span class="variable">myThread</span> <span class="operator">=</span> it.next();</span><br><span class="line">                        myThread.close();</span><br><span class="line">                        myThread.interrupt();</span><br><span class="line">                        it.remove();</span><br><span class="line">                        --releaseCount;</span><br><span class="line">                        System.out.println(myThread.getName() + <span class="string">" had been released"</span>);</span><br><span class="line">                    }</span><br><span class="line">                    resetPoolSize();</span><br><span class="line">                }</span><br><span class="line">            }</span><br><span class="line">        }</span><br><span class="line">        System.out.println(Thread.currentThread().getName() + <span class="string">"---- is dead"</span>);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">shutDown</span><span class="params">()</span> <span class="keyword">throws</span> InterruptedException {</span><br><span class="line">        <span class="comment">// 等待现有线程池中任务执行完成</span></span><br><span class="line">        <span class="keyword">while</span> (!TASK_QUEUE.isEmpty() || THREAD_QUEUE.stream().filter(e -&gt; e.taskStatus == TaskStatus.RUNNING).count() &gt; <span class="number">0</span>) {</span><br><span class="line">            Thread.sleep(<span class="number">50</span>);</span><br><span class="line">        }</span><br><span class="line"></span><br><span class="line">        <span class="keyword">synchronized</span> (THREAD_QUEUE) {</span><br><span class="line">            <span class="comment">// 进行关停销毁</span></span><br><span class="line">            System.out.println(<span class="string">"The pool is ready to destroy"</span>);</span><br><span class="line">            Iterator&lt;MyThread&gt; it = THREAD_QUEUE.iterator();</span><br><span class="line">            <span class="keyword">while</span> (it.hasNext()) {</span><br><span class="line">                <span class="type">MyThread</span> <span class="variable">myThread</span> <span class="operator">=</span> it.next();</span><br><span class="line">                <span class="keyword">if</span> (myThread.taskStatus == TaskStatus.BLOCKED) {</span><br><span class="line">                    <span class="comment">// waiting中的线程</span></span><br><span class="line">                    myThread.close();</span><br><span class="line">                    myThread.interrupt();</span><br><span class="line">                    it.remove();</span><br><span class="line">                }</span><br><span class="line">            }</span><br><span class="line">            System.out.println(<span class="string">"The thread pool disposed"</span>);</span><br><span class="line">            resetPoolSize();</span><br><span class="line">            destroy = <span class="literal">true</span>;</span><br><span class="line">        }</span><br><span class="line"></span><br><span class="line">        System.out.println(<span class="string">"All threads had been destroyed"</span>);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">submit</span><span class="params">(Runnable runnable)</span> {</span><br><span class="line">        <span class="keyword">if</span> (destroy)</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IllegalStateException</span>(<span class="string">"The thread pool already destroy and not allow submit task."</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">synchronized</span> (TASK_QUEUE) {</span><br><span class="line">            <span class="keyword">if</span> (TASK_QUEUE.size() &gt; queueSize) {</span><br><span class="line">                <span class="comment">// 处理能力之外的任务，处理措施</span></span><br><span class="line">                discardPolicy.discard();</span><br><span class="line">            }</span><br><span class="line">            TASK_QUEUE.addLast(runnable);</span><br><span class="line">            TASK_QUEUE.notifyAll();</span><br><span class="line">        }</span><br><span class="line"></span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">DiscardPolicy</span> {</span><br><span class="line">        <span class="keyword">void</span> <span class="title function_">discard</span><span class="params">()</span> <span class="keyword">throws</span> DiscardException;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">DiscardException</span> <span class="keyword">extends</span> <span class="title class_">RuntimeException</span> {</span><br><span class="line">        <span class="keyword">public</span> <span class="title function_">DiscardException</span><span class="params">(String message)</span> {</span><br><span class="line">            <span class="built_in">super</span>(message);</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">enum</span> <span class="title class_">TaskStatus</span> {</span><br><span class="line">        FREE, RUNNING, BLOCKED, DEAD;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">class</span> <span class="title class_">MyThread</span> <span class="keyword">extends</span> <span class="title class_">Thread</span> {</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">volatile</span> <span class="type">TaskStatus</span> <span class="variable">taskStatus</span> <span class="operator">=</span> TaskStatus.FREE;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> <span class="title function_">MyThread</span><span class="params">(ThreadGroup group, String name)</span> {</span><br><span class="line">            <span class="built_in">super</span>(group, name);</span><br><span class="line">        }</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> {</span><br><span class="line">            OUTER:</span><br><span class="line">            <span class="keyword">while</span> (<span class="built_in">this</span>.taskStatus != TaskStatus.DEAD) {</span><br><span class="line">                <span class="type">Runnable</span> <span class="variable">runnable</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">                <span class="keyword">synchronized</span> (TASK_QUEUE) {</span><br><span class="line">                    <span class="keyword">while</span> (TASK_QUEUE.isEmpty()) {</span><br><span class="line">                        <span class="keyword">try</span> {</span><br><span class="line">                            <span class="comment">// 任务队列为空，线程等待，让出monitor</span></span><br><span class="line">                            <span class="built_in">this</span>.taskStatus = TaskStatus.BLOCKED;</span><br><span class="line">                            TASK_QUEUE.wait();</span><br><span class="line">                        } <span class="keyword">catch</span> (InterruptedException e) {</span><br><span class="line">                            <span class="comment">// 任务队列存入数据，被唤醒，重新抢锁处理</span></span><br><span class="line">                            <span class="keyword">break</span> OUTER;</span><br><span class="line">                        }</span><br><span class="line">                    }</span><br><span class="line">                    runnable = TASK_QUEUE.removeFirst();</span><br><span class="line">                }</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> (runnable != <span class="literal">null</span>) {</span><br><span class="line">                    <span class="built_in">this</span>.taskStatus = TaskStatus.RUNNING;</span><br><span class="line">                    runnable.run();</span><br><span class="line">                    <span class="built_in">this</span>.taskStatus = TaskStatus.FREE;</span><br><span class="line">                }</span><br><span class="line">            }</span><br><span class="line">        }</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">close</span><span class="params">()</span> {</span><br><span class="line">            <span class="built_in">this</span>.taskStatus = TaskStatus.DEAD;</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> java.util.stream.IntStream;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 线程池测试类</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SimpleThreadTest</span> {</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> InterruptedException {</span><br><span class="line">        <span class="type">SimpleThreadPool</span> <span class="variable">threadPool</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SimpleThreadPool</span>();</span><br><span class="line">        IntStream.rangeClosed(<span class="number">0</span>, <span class="number">40</span>)</span><br><span class="line">                .forEach(index -&gt; {</span><br><span class="line">                    threadPool.submit(() -&gt; {</span><br><span class="line">                                <span class="keyword">try</span> {</span><br><span class="line">                                    Thread.sleep(<span class="number">1_000L</span>);</span><br><span class="line">                                    System.out.println(<span class="string">"Task "</span> + index + <span class="string">" be serviced by "</span> + Thread.currentThread().getName());</span><br><span class="line">                                } <span class="keyword">catch</span> (InterruptedException e) {</span><br><span class="line">                                    e.printStackTrace();</span><br><span class="line">                                }</span><br><span class="line">                            }</span><br><span class="line">                    );</span><br><span class="line">                });</span><br><span class="line">        <span class="comment">// Thread.sleep(10_000);</span></span><br><span class="line">        threadPool.shutDown();</span><br><span class="line">    }</span><br><span class="line">}</span><br><span class="line"></span><br></pre></td></tr></tbody></table></figure>

    </div>

    
    
    

    <footer class="post-footer">
          <div class="post-tags">
              <a href="/tags/Java/" rel="tag"># Java</a>
          </div>

        

          <div class="post-nav">
            <div class="post-nav-item">
                <a href="/20250619/f7c553a3.html" rel="prev" title="abstract class和interface的区别">
                  <i class="fa fa-angle-left"></i> abstract class和interface的区别
                </a>
            </div>
            <div class="post-nav-item">
                <a href="/20250619/c3539d05.html" rel="next" title="Java中printf的用法总结">
                  Java中printf的用法总结 <i class="fa fa-angle-right"></i>
                </a>
            </div>
          </div>
    </footer>
  </article>
</div>






</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">

  <div class="copyright">
    &copy; 
    <span itemprop="copyrightYear">2025</span>
    <span class="with-love">
      <i class="fa fa-heart"></i>
    </span>
    <span class="author" itemprop="copyrightHolder">Alisa</span>
  </div>

    </div>
  </footer>

  
  <div class="toggle sidebar-toggle" role="button">
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
  </div>
  <div class="sidebar-dimmer"></div>
  <div class="back-to-top" role="button" aria-label="返回顶部">
    <i class="fa fa-arrow-up fa-lg"></i>
    <span>0%</span>
  </div>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>

</body>
</html>
